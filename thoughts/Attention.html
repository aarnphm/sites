<!DOCTYPE html>
<!--
/*************************************************************************
* Bop got your nose !!!
*
* Hehe
*
* Anw if you see a component you like ping @aarnphm on Discord I can try
* to send it your way. Have a wonderful day!
**************************************************************************/
-->
<html lang="fr">
  <head>
    <title>
      Attention - Aaron's notes
    </title>
    <meta charset="utf-8"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains Mono&amp;family=Newsreader:wght@400;700&amp;family=Newsreader:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="true"/>
    <link rel="preconnect" href="https://plausible.io" crossorigin="true"/>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="og:site_name" content="Aaron's notes"/>
    <meta property="og:locale" content="fr-FR"/>
    <meta property="og:title" content="Attention - Aaron's notes"/>
    <meta property="og:type" content="website"/>
    <meta name="twitter:site" content="@aarnphm_"/>
    <meta name="twitter:creator" content="@aarnphm_"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Attention - Aaron's notes"/>
    <meta name="twitter:description" content="(Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{'} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests."/>
    <meta property="og:description" content="(Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{'} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests."/>
    <meta property="og:image:type" content="image/webp"/>
    <meta property="og:image:alt" content="(Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{'} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests."/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <meta property="og:width" content="1200"/>
    <meta property="og:height" content="630"/>
    <meta property="og:image" content="https://aarnphm.xyz/static/social-images/thoughts-Attention.webp"/>
    <meta property="og:url" content="https:/aarnphm.xyz/thoughts/Attention"/>
    <meta property="og:image" content="https://aarnphm.xyz/static/social-images/thoughts-Attention.webp"/>
    <meta name="twitter:image" content="https://aarnphm.xyz/static/social-images/thoughts-Attention.webp"/>
    <meta property="twitter:domain" content="https://aarnphm.xyz/"/>
    <meta property="twitter:url" content="https:/aarnphm.xyz/thoughts/Attention"/>
    <link rel="icon" href="../static/icon.webp"/>
    <link rel="canonical" href="https:/aarnphm.xyz/thoughts/Attention"/>
    <meta name="description" content="(Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{'} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests."/>
    <meta name="generator" content="Quartz"/>
    <link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/>
    <style>
      .collapsible-header {
      position: relative;
      margin-left: -9px;
      }
      .collapsible-header:first-child {
      margin-top: 1rem;
      }
      .collapsible-header:last-child {
      margin-bottom: 1rem;
      }
      .collapsible-header[data-level=&quot;2&quot;] {
      margin-left: 1rem;
      }
      .collapsible-header[data-level=&quot;3&quot;] {
      margin-left: 1.5rem;
      }
      .collapsible-header[data-level=&quot;4&quot;] {
      margin-left: 1.9rem;
      }
      .collapsible-header[data-level=&quot;5&quot;] {
      margin-left: 2.2rem;
      }
      .collapsible-header[data-level=&quot;6&quot;] {
      margin-left: 2.4rem;
      }
      .collapsible-header .collapsed-dots {
      display: none;
      }
      .collapsible-header.collapsed {
      margin-bottom: 1rem;
      }
      .collapsible-header.collapsed .collapsed-dots {
      display: block;
      }
      .collapsible-header .header-controls {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      }
      .collapsible-header .header-controls .toggle-button {
      grid-column: 1;
      }
      .collapsible-header .toggle-button {
      background-color: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      padding: 0;
      color: var(--dark);
      display: inline-flex;
      align-items: center;
      }
      .collapsible-header .toggle-button:hover .circle-icon {
      display: none;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=true] .collapse-icon {
      display: block;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=true] .expand-icon {
      display: none;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=false] .expand-icon {
      display: block;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=false] .collapse-icon {
      display: none;
      }
      .collapsible-header .toggle-icons {
      display: grid;
      grid-template-columns: 1fr;
      }
      .collapsible-header .toggle-icons .circle-icon,
      .collapsible-header .toggle-icons .expand-icon,
      .collapsible-header .toggle-icons .collapse-icon {
      opacity: 0.85;
      grid-column: 1;
      grid-row: 1;
      }
      .collapsible-header .toggle-icons .circle-icon {
      display: block;
      }
      .collapsible-header .toggle-icons .expand-icon,
      .collapsible-header .toggle-icons .collapse-icon {
      display: none;
      }
      .collapsible-header.collapsed :where(h1, h2, h3, h4, h5, h6):not(.popover *) {
      display: inline-flex;
      align-items: center;
      }
      .collapsible-header :where(h1, h2, h3, h4, h5, h6):not(.popover *) {
      margin: 0;
      }
      .collapsible-header .collapsible-header-content-outer {
      padding-left: 9px;
      padding-bottom: 9px;
      }
      .collapsible-header .collapsible-header-content-outer .collapsible-header-content {
      border-left: 1px solid var(--lightgray);
      overflow: hidden;
      padding-left: 9px;
      max-height: none;
      }
      .collapsible-header .collapsible-header-content-outer .collapsible-header-content.collapsed {
      max-height: 0 !important;
      padding-top: 0;
      padding-bottom: 0;
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/node-tikzjax@latest/css/fonts.css" rel="stylesheet" type="text/css" spa-preserve/>
    <link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/>
    <script src="../prescript.js" type="application/javascript" spa-preserve></script>
    <script type="application/javascript" spa-preserve>
      const fetchData = fetch("../static/contentIndex.json").then(data => data.json())
    </script>
    <script type="application/javascript" spa-preserve>
      var T=Object.create;var g=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var q=(e,u)=>()=>(u||e((u={exports:{}}).exports,u),u.exports);var P=(e,u,t,F)=>{if(u&&typeof u=="object"||typeof u=="function")for(let o of j(u))!O.call(e,o)&&o!==t&&g(e,o,{get:()=>u[o],enumerable:!(F=R(u,o))||F.enumerable});return e};var U=(e,u,t)=>(t=e!=null?T(k(e)):{},P(u||!e||!e.__esModule?g(t,"default",{value:e,enumerable:!0}):t,e));var m=q((X,p)=>{"use strict";p.exports=W;function A(e){return e instanceof Buffer?Buffer.from(e):new e.constructor(e.buffer.slice(),e.byteOffset,e.length)}function W(e){if(e=e||{},e.circles)return $(e);let u=new Map;if(u.set(Date,D=>new Date(D)),u.set(Map,(D,i)=>new Map(F(Array.from(D),i))),u.set(Set,(D,i)=>new Set(F(Array.from(D),i))),e.constructorHandlers)for(let D of e.constructorHandlers)u.set(D[0],D[1]);let t=null;return e.proto?l:o;function F(D,i){let n=Object.keys(D),r=new Array(n.length);for(let c=0;c<n.length;c++){let s=n[c],a=D[s];typeof a!="object"||a===null?r[s]=a:a.constructor!==Object&&(t=u.get(a.constructor))?r[s]=t(a,i):ArrayBuffer.isView(a)?r[s]=A(a):r[s]=i(a)}return r}function o(D){if(typeof D!="object"||D===null)return D;if(Array.isArray(D))return F(D,o);if(D.constructor!==Object&&(t=u.get(D.constructor)))return t(D,o);let i={};for(let n in D){if(Object.hasOwnProperty.call(D,n)===!1)continue;let r=D[n];typeof r!="object"||r===null?i[n]=r:r.constructor!==Object&&(t=u.get(r.constructor))?i[n]=t(r,o):ArrayBuffer.isView(r)?i[n]=A(r):i[n]=o(r)}return i}function l(D){if(typeof D!="object"||D===null)return D;if(Array.isArray(D))return F(D,l);if(D.constructor!==Object&&(t=u.get(D.constructor)))return t(D,l);let i={};for(let n in D){let r=D[n];typeof r!="object"||r===null?i[n]=r:r.constructor!==Object&&(t=u.get(r.constructor))?i[n]=t(r,l):ArrayBuffer.isView(r)?i[n]=A(r):i[n]=l(r)}return i}}function $(e){let u=[],t=[],F=new Map;if(F.set(Date,n=>new Date(n)),F.set(Map,(n,r)=>new Map(l(Array.from(n),r))),F.set(Set,(n,r)=>new Set(l(Array.from(n),r))),e.constructorHandlers)for(let n of e.constructorHandlers)F.set(n[0],n[1]);let o=null;return e.proto?i:D;function l(n,r){let c=Object.keys(n),s=new Array(c.length);for(let a=0;a<c.length;a++){let C=c[a],E=n[C];if(typeof E!="object"||E===null)s[C]=E;else if(E.constructor!==Object&&(o=F.get(E.constructor)))s[C]=o(E,r);else if(ArrayBuffer.isView(E))s[C]=A(E);else{let B=u.indexOf(E);B!==-1?s[C]=t[B]:s[C]=r(E)}}return s}function D(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return l(n,D);if(n.constructor!==Object&&(o=F.get(n.constructor)))return o(n,D);let r={};u.push(n),t.push(r);for(let c in n){if(Object.hasOwnProperty.call(n,c)===!1)continue;let s=n[c];if(typeof s!="object"||s===null)r[c]=s;else if(s.constructor!==Object&&(o=F.get(s.constructor)))r[c]=o(s,D);else if(ArrayBuffer.isView(s))r[c]=A(s);else{let a=u.indexOf(s);a!==-1?r[c]=t[a]:r[c]=D(s)}}return u.pop(),t.pop(),r}function i(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return l(n,i);if(n.constructor!==Object&&(o=F.get(n.constructor)))return o(n,i);let r={};u.push(n),t.push(r);for(let c in n){let s=n[c];if(typeof s!="object"||s===null)r[c]=s;else if(s.constructor!==Object&&(o=F.get(s.constructor)))r[c]=o(s,i);else if(ArrayBuffer.isView(s))r[c]=A(s);else{let a=u.indexOf(s);a!==-1?r[c]=t[a]:r[c]=i(s)}}return u.pop(),t.pop(),r}}});var J=Object.hasOwnProperty;var h=U(m(),1),eu=(0,h.default)();function y(e){return e.document.body.dataset.slug}function I(e,u=100){let t=e.getBoundingClientRect();return t.top>=-u&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)+u}function _(e,u){let t=e.getBoundingClientRect(),F=u.getBoundingClientRect(),o=e.parentElement?.getBoundingClientRect()||t;return F.top-o.top}function V(e,u){let t=e.getBoundingClientRect(),F=u.getBoundingClientRect();return{min:0,max:t.height-F.height}}function L(e,u,t){let F=_(u,e),o=V(t,u);F=Math.max(F,Math.min(o.min,o.max)),u.style.top=`${F}px`}function f(e,u){let t=e.querySelectorAll("a[data-footnote-ref]"),F=document.querySelector(".sidenotes");if(F)for(let o of t){let l=o.getAttribute("href")?.replace("#","sidebar-"),D=F.querySelector(`.sidenote-element[id="${l}"]`);D&&(u?(D.classList.remove("in-view"),o.classList.remove("active"),D.classList.add("collapsed")):I(o)?(D.classList.add("in-view"),o.classList.add("active"),D.classList.remove("collapsed"),L(o,D,F)):D.classList.remove("collapsed"))}}var S=(e,u)=>`${y(e)}-${u}`;function x(e,u){return localStorage.getItem(S(e,u))}function v(e,u,t){localStorage.setItem(S(e,u),t)}function b(e,u,t,F){e.setAttribute("aria-expanded",F?"false":"true"),u.style.maxHeight=F?"0px":"inherit",e.classList.toggle("collapsed",F),u.classList.toggle("collapsed",F),t.classList.toggle("collapsed",F),f(u,F)}function d(){let e=document.querySelector(".center"),u=document.querySelector(".sidenotes");if(!e||!u)return;let t=0,F=e.children;Array.from(F).forEach(l=>{let D=l.getBoundingClientRect();t+=D.height});let o=window.getComputedStyle(e);t+=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom)+parseFloat(o.marginTop)+parseFloat(o.marginBottom),e.style.minHeight=`${t}px`,u.style.height=`${t}px`,u.offsetHeight,requestAnimationFrame(()=>{let l=u.querySelectorAll(".sidenote-element"),D=Array.from(l).filter(i=>i.classList.contains("in-view"));for(let i of D){let n=i.id.replace("sidebar-",""),r=e.querySelector(`a[href="#${n}"]`);r&&L(r,i,u)}})}function H(e,u){let t;return(...F)=>{clearTimeout(t),t=setTimeout(()=>e(...F),u)}}var z=H(d,150);function M(e){let u=e.target;if(!u)return;let t=u.closest(".toggle-button");if(!t||u.parentElement.classList.contains("callout"))return;let F=t.id.replace("collapsible-header-","").replace("-toggle",""),o=document.querySelector(`section.collapsible-header[id="${F}"]`);if(!o)return;e.stopPropagation();let l=document.querySelector(`.collapsible-header-content[data-references="${t.id}"]`);if(!l)return;let D=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",D?"false":"true"),l.style.maxHeight=D?"0px":"inherit",l.classList.toggle("collapsed",D),o.classList.toggle("collapsed",D),t.classList.toggle("collapsed",D),f(l,D),v(window,t.id,D?"false":"true"),requestAnimationFrame(()=>{d(),z()})}function w(){let e=document.querySelectorAll(".collapsible-header");for(let t of e){let F=t.querySelector("button.toggle-button");if(F){F.addEventListener("click",M),window.addCleanup(()=>F.removeEventListener("click",M));let o=document.querySelector(`.collapsible-header-content[data-references="${F.id}"]`);if(o){let l=x(window,F.id);l&&b(F,o,t,l==="false")}}}let u=document.querySelectorAll("svg.blockquote-link");for(let t of u){let l=function(){window.spaNavigate(new URL(o,window.location.toString()))},o=t.parentElement.dataset.href;t.addEventListener("click",l),window.addCleanup(()=>t.removeEventListener("click",l))}}document.addEventListener("nav",w);window.addEventListener("resize",w);
    </script>
  </head>
  <body data-slug="thoughts/Attention" data-language="fr" data-menu="false" data-poem="false">
    <main id="quartz-root" class="page">
      <section id="quartz-body">
        <aside class="left sidebar">
          <div class="toc desktop-only" id="toc" data-layout="minimal">
            <nav id="toc-vertical">
              <button class="depth-0 toc-item" data-depth="0" data-href="#muti-head-attention" data-for="muti-head-attention" style="--animation-order:1;" aria-label="Muti-head Attention">
                <div class="fill"></div>
                <div class="indicator">
                  Muti-head Attention
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#group-query-attention" data-for="group-query-attention" style="--animation-order:2;" aria-label="Group-Query Attention">
                <div class="fill"></div>
                <div class="indicator">
                  Group-Query Attention
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#radixattention" data-for="radixattention" style="--animation-order:3;" aria-label="RadixAttention">
                <div class="fill"></div>
                <div class="indicator">
                  RadixAttention
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#cache-aware-scheduling" data-for="cache-aware-scheduling" style="--animation-order:4;" aria-label="cache-aware scheduling">
                <div class="fill"></div>
                <div class="indicator">
                  cache-aware scheduling
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#compressed-fsm-for-jump-ahead-tokens" data-for="compressed-fsm-for-jump-ahead-tokens" style="--animation-order:5;" aria-label="compressed FSM for jump-ahead tokens.">
                <div class="fill"></div>
                <div class="indicator">
                  compressed FSM for jump-ahead tokens.
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-1-fsm-based-decoding" data-for="method-1-fsm-based-decoding" style="--animation-order:6;" aria-label="Method 1: FSM-based decoding">
                <div class="fill"></div>
                <div class="indicator">
                  Method 1: FSM-based decoding
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-2-interleaved-based" data-for="method-2-interleaved-based" style="--animation-order:7;" aria-label="Method 2: Interleaved-based">
                <div class="fill"></div>
                <div class="indicator">
                  Method 2: Interleaved-based
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-3-jump-forward-decoding-with-compressed-fsm" data-for="method-3-jump-forward-decoding-with-compressed-fsm" style="--animation-order:8;" aria-label="&lt;mark>Method 3: Jump-Forward Decoding with compressed FSM&lt;/mark>">
                <div class="fill"></div>
                <div class="indicator">
                  <mark>
                    Method 3: Jump-Forward Decoding with compressed FSM
                  </mark>
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#ringattention" data-for="ringattention" style="--animation-order:9;" aria-label="RingAttention">
                <div class="fill"></div>
                <div class="indicator">
                  RingAttention
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#razorattention" data-for="razorattention" style="--animation-order:10;" aria-label="RazorAttention">
                <div class="fill"></div>
                <div class="indicator">
                  RazorAttention
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#paged-attention" data-for="paged-attention" style="--animation-order:11;" aria-label="Paged Attention">
                <div class="fill"></div>
                <div class="indicator">
                  Paged Attention
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#reference-label" data-for="reference-label" style="--animation-order:12;" aria-label="References">
                <div class="fill"></div>
                <div class="indicator">
                  References
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#footnote-label" data-for="footnote-label" style="--animation-order:13;" aria-label="Footnotes">
                <div class="fill"></div>
                <div class="indicator">
                  Footnotes
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#backlinks-label" data-for="backlinks-label" style="--animation-order:14;" aria-label="Liens retour">
                <div class="fill"></div>
                <div class="indicator">
                  Liens retour
                </div>
              </button>
            </nav>
          </div>
          <div class="toolbar">
            <div class="toolbar-content">
              <button class="toolbar-item pen-button" aria-label="Toggle toolbar" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="var(--darkgray)" viewBox="0 0 256 256" class="pen-icon">
                  <path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="reader-button" aria-label="Toggle reader mode" data-active="false">
                <span class="tooltip">
                  Reader mode
                </span>
                <svg class="reader-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="pdf-button" aria-label="Export to PDF">
                <span class="tooltip">
                  Export PDF
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
              </button>
              <button class="toolbar-item " id="graph-button" aria-label="Toggle global graph">
                <span class="tooltip">
                  Global graph
                </span>
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve">
                  <path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="skew-button" aria-label="add a tiny bit of skew, cuz why not">
                <span class="tooltip">
                  Skew page
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 4l18 16"></path>
                  <path d="M21 4H3"></path>
                  <path d="M21 20H3"></path>
                </svg>
              </button>
            </div>
          </div>
        </aside>
        <section class="center">
          <div class="page-header">
            <header>
              <nav class="breadcrumb-container" aria-label="breadcrumbs">
                <div class="breadcrumb-element">
                  <a href="../">
                    ~
                  </a>
                  <p>
                    /
                  </p>
                </div>
                <div class="breadcrumb-element">
                  <a href="../thoughts/">
                    t
                  </a>
                  <p>
                    /
                  </p>
                </div>
                <div class="breadcrumb-element">
                  <a href>
                    Attention
                  </a>
                </div>
              </nav>
              <div class="keybind" lang="fr">
                <kbd id="shortcut-key" data-mapping="[&quot;cmd--'&quot;,&quot;ctrl--'&quot;]">
                  ⌘ '
                </kbd>
                <div id="shortcut-container">
                  <div id="shortcut-space">
                    <div id="title">
                      raccourcis clavier
                    </div>
                    <ul id="shortcut-list">
                      <li>
                        <div id="shortcuts" data-key="⌘--/" data-value="recherche"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--\" data-value="page d'accueil"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--j" data-value="curius"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--b" data-value="lecteur"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--g" data-value="graphique"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--u" data-value="fausser"></div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="search">
                <button class="search-button" id="search-button">
                  <svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7">
                    <title>
                      Search
                    </title>
                    <g class="search-path" fill="none">
                      <path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path>
                      <circle cx="8" cy="8" r="7"></circle>
                    </g>
                  </svg>
                </button>
                <div id="search-container">
                  <div id="search-space">
                    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Rechercher quelque chose" placeholder="Rechercher quelque chose"/>
                    <div id="search-layout" data-preview="true"></div>
                  </div>
                </div>
              </div>
            </header>
            <div class="popover-hint">
              <hgroup>
                <h1 class="article-title">
                  Attention
                </h1>
                <p class="description">
                  (Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp;amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{&amp;#039;} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests.
                </p>
              </hgroup>
              <ul class="content-meta">
                <li>
                  <span class="page-creation" title="Date de création du contenu de la page">
                    <em>
                      06 févr. 2024
                    </em>
                  </span>
                </li>
                <li>
                  <a href="../thoughts/Attention.html.md" target="_blank" rel="noopener noreferrer" class="llm-source" style="color: inherit;font-weight: inherit;text-decoration: underline">
                    <span title="voir https://github.com/AnswerDotAI/llms-txt">
                      llms.txt
                    </span>
                  </a>
                </li>
              </ul>
              <ul class="tags">
                <li>
                  <a href="../tags/technical" class="internal tag-link">
                    technical
                  </a>
                </li>
                <li>
                  <a href="../tags/seed" class="internal tag-link">
                    seed
                  </a>
                </li>
              </ul>
              <div class="spacer"></div>
            </div>
          </div>
          <article class="popover-hint">
            <p dir="auto">
              <cite class id="citation--vaswani2023attentionneed--1">
                (
                <a href="#bib-vaswani2023attentionneed" data-no-popover data-bib class="internal alias">
                  <span class="indicator-hook"></span>
                  Vaswani et al., 2023
                </a>
                )
              </cite>
            </p>
            <p dir="auto">
              Attention operates on a sequence of query
              <span class="katex">
                <span class="katex-mathml">
                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <semantics>
                      <mrow>
                        <mi>
                          Q
                        </mi>
                      </mrow>
                      <annotation encoding="application/x-tex">
                        Q
                      </annotation>
                    </semantics>
                  </math>
                </span>
                <span class="katex-html" aria-hidden="true">
                  <span class="base">
                    <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                    <span class="mord mathnormal">
                      Q
                    </span>
                  </span>
                </span>
              </span>
              , key
              <span class="katex">
                <span class="katex-mathml">
                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <semantics>
                      <mrow>
                        <mi>
                          K
                        </mi>
                      </mrow>
                      <annotation encoding="application/x-tex">
                        K
                      </annotation>
                    </semantics>
                  </math>
                </span>
                <span class="katex-html" aria-hidden="true">
                  <span class="base">
                    <span class="strut" style="height:0.6833em;"></span>
                    <span class="mord mathnormal" style="margin-right:0.07153em;">
                      K
                    </span>
                  </span>
                </span>
              </span>
              and value
              <span class="katex">
                <span class="katex-mathml">
                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                    <semantics>
                      <mrow>
                        <mi>
                          V
                        </mi>
                      </mrow>
                      <annotation encoding="application/x-tex">
                        V
                      </annotation>
                    </semantics>
                  </math>
                </span>
                <span class="katex-html" aria-hidden="true">
                  <span class="base">
                    <span class="strut" style="height:0.6833em;"></span>
                    <span class="mord mathnormal" style="margin-right:0.22222em;">
                      V
                    </span>
                  </span>
                </span>
              </span>
              vector. Attention matrix of a sequence then computed as:
            </p>
            <span class="katex-display">
              <span class="katex">
                <span class="katex-mathml">
                  <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                    <semantics>
                      <mrow>
                        <mi>
                          A
                        </mi>
                        <mo stretchy="false">
                          (
                        </mo>
                        <mi>
                          Q
                        </mi>
                        <mo separator="true">
                          ,
                        </mo>
                        <mi>
                          K
                        </mi>
                        <mo separator="true">
                          ,
                        </mo>
                        <mi>
                          V
                        </mi>
                        <mo stretchy="false">
                          )
                        </mo>
                        <mo>
                          =
                        </mo>
                        <mtext>
                          softmax
                        </mtext>
                        <mo stretchy="false">
                          (
                        </mo>
                        <mfrac>
                          <mrow>
                            <mi>
                              Q
                            </mi>
                            <mo>
                              ⋅
                            </mo>
                            <msup>
                              <mi>
                                K
                              </mi>
                              <mi>
                                T
                              </mi>
                            </msup>
                          </mrow>
                          <msqrt>
                            <mi>
                              d
                            </mi>
                          </msqrt>
                        </mfrac>
                        <mo stretchy="false">
                          )
                        </mo>
                        <mi>
                          V
                        </mi>
                        <mtext>
                             for
                        </mtext>
                        <msub>
                          <mi>
                            Q
                          </mi>
                          <mrow>
                            <mi>
                              L
                            </mi>
                            <mo>
                              ×
                            </mo>
                            <mi>
                              d
                            </mi>
                          </mrow>
                        </msub>
                        <mo separator="true">
                          ,
                        </mo>
                        <msub>
                          <mi>
                            K
                          </mi>
                          <mrow>
                            <mi>
                              L
                            </mi>
                            <mo>
                              ×
                            </mo>
                            <mi>
                              d
                            </mi>
                          </mrow>
                        </msub>
                        <mo separator="true">
                          ,
                        </mo>
                        <msub>
                          <mi>
                            V
                          </mi>
                          <mrow>
                            <mi>
                              L
                            </mi>
                            <mo>
                              ×
                            </mo>
                            <mi>
                              d
                            </mi>
                          </mrow>
                        </msub>
                      </mrow>
                      <annotation encoding="application/x-tex">
                        A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d}
                      </annotation>
                    </semantics>
                  </math>
                </span>
                <span class="katex-html" aria-hidden="true">
                  <span class="base">
                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                    <span class="mord mathnormal">
                      A
                    </span>
                    <span class="mopen">
                      (
                    </span>
                    <span class="mord mathnormal">
                      Q
                    </span>
                    <span class="mpunct">
                      ,
                    </span>
                    <span class="mspace" style="margin-right:0.1667em;"></span>
                    <span class="mord mathnormal" style="margin-right:0.07153em;">
                      K
                    </span>
                    <span class="mpunct">
                      ,
                    </span>
                    <span class="mspace" style="margin-right:0.1667em;"></span>
                    <span class="mord mathnormal" style="margin-right:0.22222em;">
                      V
                    </span>
                    <span class="mclose">
                      )
                    </span>
                    <span class="mspace" style="margin-right:0.2778em;"></span>
                    <span class="mrel">
                      =
                    </span>
                    <span class="mspace" style="margin-right:0.2778em;"></span>
                  </span>
                  <span class="base">
                    <span class="strut" style="height:2.4483em;vertical-align:-0.93em;"></span>
                    <span class="mord text">
                      <span class="mord">
                        softmax
                      </span>
                    </span>
                    <span class="mopen">
                      (
                    </span>
                    <span class="mord">
                      <span class="mopen nulldelimiter"></span>
                      <span class="mfrac">
                        <span class="vlist-t vlist-t2">
                          <span class="vlist-r">
                            <span class="vlist" style="height:1.5183em;">
                              <span style="top:-2.1778em;">
                                <span class="pstrut" style="height:3em;"></span>
                                <span class="mord">
                                  <span class="mord sqrt">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.9322em;">
                                          <span class="svg-align" style="top:-3em;">
                                            <span class="pstrut" style="height:3em;"></span>
                                            <span class="mord" style="padding-left:0.833em;">
                                              <span class="mord mathnormal">
                                                d
                                              </span>
                                            </span>
                                          </span>
                                          <span style="top:-2.8922em;">
                                            <span class="pstrut" style="height:3em;"></span>
                                            <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                              <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                              </svg>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.1078em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span style="top:-3.23em;">
                                <span class="pstrut" style="height:3em;"></span>
                                <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                              </span>
                              <span style="top:-3.677em;">
                                <span class="pstrut" style="height:3em;"></span>
                                <span class="mord">
                                  <span class="mord mathnormal">
                                    Q
                                  </span>
                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                  <span class="mbin">
                                    ⋅
                                  </span>
                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                  <span class="mord">
                                    <span class="mord mathnormal" style="margin-right:0.07153em;">
                                      K
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.8413em;">
                                            <span style="top:-3.063em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mtight">
                                                  <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                    T
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="vlist-s">
                              ​
                            </span>
                          </span>
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.93em;">
                              <span></span>
                            </span>
                          </span>
                        </span>
                      </span>
                      <span class="mclose nulldelimiter"></span>
                    </span>
                    <span class="mclose">
                      )
                    </span>
                    <span class="mord mathnormal" style="margin-right:0.22222em;">
                      V
                    </span>
                    <span class="mspace"></span>
                    <span class="mspace"></span>
                    <span class="mord text">
                      <span class="mord">
                         for
                      </span>
                    </span>
                    <span class="mord">
                      <span class="mord mathnormal">
                        Q
                      </span>
                      <span class="msupsub">
                        <span class="vlist-t vlist-t2">
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.3361em;">
                              <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                <span class="pstrut" style="height:2.7em;"></span>
                                <span class="sizing reset-size6 size3 mtight">
                                  <span class="mord mtight">
                                    <span class="mord mathnormal mtight">
                                      L
                                    </span>
                                    <span class="mbin mtight">
                                      ×
                                    </span>
                                    <span class="mord mathnormal mtight">
                                      d
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="vlist-s">
                              ​
                            </span>
                          </span>
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.2083em;">
                              <span></span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    <span class="mpunct">
                      ,
                    </span>
                    <span class="mspace" style="margin-right:0.1667em;"></span>
                    <span class="mord">
                      <span class="mord mathnormal" style="margin-right:0.07153em;">
                        K
                      </span>
                      <span class="msupsub">
                        <span class="vlist-t vlist-t2">
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.3361em;">
                              <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                <span class="pstrut" style="height:2.7em;"></span>
                                <span class="sizing reset-size6 size3 mtight">
                                  <span class="mord mtight">
                                    <span class="mord mathnormal mtight">
                                      L
                                    </span>
                                    <span class="mbin mtight">
                                      ×
                                    </span>
                                    <span class="mord mathnormal mtight">
                                      d
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="vlist-s">
                              ​
                            </span>
                          </span>
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.2083em;">
                              <span></span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    <span class="mpunct">
                      ,
                    </span>
                    <span class="mspace" style="margin-right:0.1667em;"></span>
                    <span class="mord">
                      <span class="mord mathnormal" style="margin-right:0.22222em;">
                        V
                      </span>
                      <span class="msupsub">
                        <span class="vlist-t vlist-t2">
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.3361em;">
                              <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                <span class="pstrut" style="height:2.7em;"></span>
                                <span class="sizing reset-size6 size3 mtight">
                                  <span class="mord mtight">
                                    <span class="mord mathnormal mtight">
                                      L
                                    </span>
                                    <span class="mbin mtight">
                                      ×
                                    </span>
                                    <span class="mord mathnormal mtight">
                                      d
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="vlist-s">
                              ​
                            </span>
                          </span>
                          <span class="vlist-r">
                            <span class="vlist" style="height:0.2083em;">
                              <span></span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
              </span>
            </span>
            <section class="collapsible-header" id="muti-head-attention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-muti-head-attention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="muti-head-attention" dir="auto">
                  Muti-head Attention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#muti-head-attention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-muti-head-attention-toggle" data-level="2" data-heading-id="muti-head-attention">
                  <p dir="auto">
                    Allows the model to jointly attend to information from different representation subspaces at different positions:
                  </p>
                  <span class="katex-display">
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                          <semantics>
                            <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                              <mtr>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <mrow>
                                      <mtext>
                                        MHA
                                      </mtext>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mi>
                                        Q
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        K
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        V
                                      </mi>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                  </mstyle>
                                </mtd>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <mrow>
                                      <mrow></mrow>
                                      <mo>
                                        =
                                      </mo>
                                      <mtext>
                                        concat
                                      </mtext>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <msub>
                                        <mtext>
                                          head
                                        </mtext>
                                        <mn>
                                          1
                                        </mn>
                                      </msub>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mo>
                                        ⋯
                                      </mo>
                                      <mtext></mtext>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <msub>
                                        <mtext>
                                          head
                                        </mtext>
                                        <mi>
                                          n
                                        </mi>
                                      </msub>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                      <msup>
                                        <mi>
                                          W
                                        </mi>
                                        <mi>
                                          O
                                        </mi>
                                      </msup>
                                    </mrow>
                                  </mstyle>
                                </mtd>
                              </mtr>
                              <mtr>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <mrow></mrow>
                                  </mstyle>
                                </mtd>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <mrow>
                                      <mrow></mrow>
                                      <mtext>
                                        where
                                      </mtext>
                                      <msub>
                                        <mtext>
                                          head
                                        </mtext>
                                        <mi>
                                          i
                                        </mi>
                                      </msub>
                                      <mo>
                                        =
                                      </mo>
                                      <mtext>
                                        A
                                      </mtext>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mi>
                                        Q
                                      </mi>
                                      <msubsup>
                                        <mi>
                                          W
                                        </mi>
                                        <mi>
                                          i
                                        </mi>
                                        <mi>
                                          O
                                        </mi>
                                      </msubsup>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        K
                                      </mi>
                                      <msubsup>
                                        <mi>
                                          W
                                        </mi>
                                        <mi>
                                          i
                                        </mi>
                                        <mi>
                                          O
                                        </mi>
                                      </msubsup>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        V
                                      </mi>
                                      <msubsup>
                                        <mi>
                                          W
                                        </mi>
                                        <mi>
                                          i
                                        </mi>
                                        <mi>
                                          O
                                        </mi>
                                      </msubsup>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                  </mstyle>
                                </mtd>
                              </mtr>
                              <mtr>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <msup>
                                      <mi>
                                        W
                                      </mi>
                                      <mi>
                                        O
                                      </mi>
                                    </msup>
                                  </mstyle>
                                </mtd>
                                <mtd>
                                  <mstyle scriptlevel="0" displaystyle="true">
                                    <mrow>
                                      <mrow></mrow>
                                      <mo>
                                        ∈
                                      </mo>
                                      <msup>
                                        <mi mathvariant="double-struck">
                                          R
                                        </mi>
                                        <mrow>
                                          <mi>
                                            h
                                          </mi>
                                          <msub>
                                            <mi>
                                              d
                                            </mi>
                                            <mi>
                                              v
                                            </mi>
                                          </msub>
                                          <mo>
                                            ×
                                          </mo>
                                          <msub>
                                            <mi>
                                              d
                                            </mi>
                                            <mtext>
                                              model
                                            </mtext>
                                          </msub>
                                        </mrow>
                                      </msup>
                                    </mrow>
                                  </mstyle>
                                </mtd>
                              </mtr>
                            </mtable>
                            <annotation encoding="application/x-tex">
                              \begin{aligned}
                              \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\
                              &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\
                              W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}}
                              \end{aligned}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:4.6618em;vertical-align:-2.0809em;"></span>
                          <span class="mord">
                            <span class="mtable">
                              <span class="col-align-r">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:2.5809em;">
                                      <span style="top:-4.6896em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord">
                                          <span class="mord text">
                                            <span class="mord">
                                              MHA
                                            </span>
                                          </span>
                                          <span class="mopen">
                                            (
                                          </span>
                                          <span class="mord mathnormal">
                                            Q
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.07153em;">
                                            K
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.22222em;">
                                            V
                                          </span>
                                          <span class="mclose">
                                            )
                                          </span>
                                        </span>
                                      </span>
                                      <span style="top:-3.1382em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord"></span>
                                      </span>
                                      <span style="top:-1.5791em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord">
                                          <span class="mord">
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              W
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8913em;">
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                          O
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:2.0809em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="col-align-l">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:2.5809em;">
                                      <span style="top:-4.6896em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord">
                                          <span class="mord"></span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mrel">
                                            =
                                          </span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mord text">
                                            <span class="mord">
                                              concat
                                            </span>
                                          </span>
                                          <span class="mopen">
                                            (
                                          </span>
                                          <span class="mord">
                                            <span class="mord text">
                                              <span class="mord">
                                                head
                                              </span>
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.3011em;">
                                                    <span style="top:-2.55em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mtight">
                                                          1
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.15em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="minner">
                                            ⋯
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord">
                                            <span class="mord text">
                                              <span class="mord">
                                                head
                                              </span>
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.1514em;">
                                                    <span style="top:-2.55em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight">
                                                          n
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.15em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mclose">
                                            )
                                          </span>
                                          <span class="mord">
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              W
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8913em;">
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                          O
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span style="top:-3.1382em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord">
                                          <span class="mord"></span>
                                          <span class="mord text">
                                            <span class="mord">
                                              where
                                            </span>
                                          </span>
                                          <span class="mspace"></span>
                                          <span class="mord">
                                            <span class="mord text">
                                              <span class="mord">
                                                head
                                              </span>
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.3117em;">
                                                    <span style="top:-2.55em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight">
                                                          i
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.15em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mrel">
                                            =
                                          </span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mord text">
                                            <span class="mord">
                                              A
                                            </span>
                                          </span>
                                          <span class="mopen">
                                            (
                                          </span>
                                          <span class="mord mathnormal">
                                            Q
                                          </span>
                                          <span class="mord">
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              W
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8913em;">
                                                    <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight">
                                                          i
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                          O
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.247em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.07153em;">
                                            K
                                          </span>
                                          <span class="mord">
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              W
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8913em;">
                                                    <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight">
                                                          i
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                          O
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.247em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.22222em;">
                                            V
                                          </span>
                                          <span class="mord">
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              W
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8913em;">
                                                    <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight">
                                                          i
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                          O
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.247em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mclose">
                                            )
                                          </span>
                                        </span>
                                      </span>
                                      <span style="top:-1.5791em;">
                                        <span class="pstrut" style="height:3em;"></span>
                                        <span class="mord">
                                          <span class="mord"></span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mrel">
                                            ∈
                                          </span>
                                          <span class="mspace" style="margin-right:0.2778em;"></span>
                                          <span class="mord">
                                            <span class="mord mathbb">
                                              R
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8991em;">
                                                    <span style="top:-3.113em;margin-right:0.05em;">
                                                      <span class="pstrut" style="height:2.7em;"></span>
                                                      <span class="sizing reset-size6 size3 mtight">
                                                        <span class="mord mtight">
                                                          <span class="mord mathnormal mtight">
                                                            h
                                                          </span>
                                                          <span class="mord mtight">
                                                            <span class="mord mathnormal mtight">
                                                              d
                                                            </span>
                                                            <span class="msupsub">
                                                              <span class="vlist-t vlist-t2">
                                                                <span class="vlist-r">
                                                                  <span class="vlist" style="height:0.1645em;">
                                                                    <span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;">
                                                                      <span class="pstrut" style="height:2.5em;"></span>
                                                                      <span class="sizing reset-size3 size1 mtight">
                                                                        <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                                                          v
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                  <span class="vlist-s">
                                                                    ​
                                                                  </span>
                                                                </span>
                                                                <span class="vlist-r">
                                                                  <span class="vlist" style="height:0.143em;">
                                                                    <span></span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span class="mbin mtight">
                                                            ×
                                                          </span>
                                                          <span class="mord mtight">
                                                            <span class="mord mathnormal mtight">
                                                              d
                                                            </span>
                                                            <span class="msupsub">
                                                              <span class="vlist-t vlist-t2">
                                                                <span class="vlist-r">
                                                                  <span class="vlist" style="height:0.3448em;">
                                                                    <span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;">
                                                                      <span class="pstrut" style="height:2.5em;"></span>
                                                                      <span class="sizing reset-size3 size1 mtight">
                                                                        <span class="mord mtight">
                                                                          <span class="mord text mtight">
                                                                            <span class="mord mtight">
                                                                              model
                                                                            </span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                  <span class="vlist-s">
                                                                    ​
                                                                  </span>
                                                                </span>
                                                                <span class="vlist-r">
                                                                  <span class="vlist" style="height:0.1512em;">
                                                                    <span></span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:2.0809em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="group-query-attention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-group-query-attention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="group-query-attention" dir="auto">
                  Group-Query Attention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#group-query-attention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-group-query-attention-toggle" data-level="2" data-heading-id="group-query-attention">
                  <p dir="auto">
                    by
                    <cite class id="citation--ainslie2023gqatraininggeneralizedmultiquery--2">
                      (
                      <a href="#bib-ainslie2023gqatraininggeneralizedmultiquery" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Ainslie et al., 2023
                      </a>
                      )
                    </cite>
                  </p>
                  <p dir="auto">
                    idea: reduce number of KV heads
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  n
                                </mi>
                                <mi>
                                  k
                                </mi>
                              </msub>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              n_k
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              n
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3361em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                          k
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.15em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    to a fraction
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msubsup>
                                <mi>
                                  n
                                </mi>
                                <mi>
                                  k
                                </mi>
                                <msup>
                                  <mrow></mrow>
                                  <mo mathvariant="normal" lspace="0em" rspace="0em">
                                    ′
                                  </mo>
                                </msup>
                              </msubsup>
                              <mo>
                                =
                              </mo>
                              <mfrac>
                                <msub>
                                  <mi>
                                    n
                                  </mi>
                                  <mi>
                                    q
                                  </mi>
                                </msub>
                                <mi>
                                  k
                                </mi>
                              </mfrac>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              n_k^{'} = \frac{n_q}{k}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:1.2256em;vertical-align:-0.2831em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              n
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.9425em;">
                                    <span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                          k
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.063em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mtight">
                                            <span></span>
                                            <span class="msupsub">
                                              <span class="vlist-t">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.8278em;">
                                                    <span style="top:-2.931em;margin-right:0.0714em;">
                                                      <span class="pstrut" style="height:2.5em;"></span>
                                                      <span class="sizing reset-size3 size1 mtight">
                                                        <span class="mord mtight">
                                                          <span class="mord mtight">
                                                            ′
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2831em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:1.1537em;vertical-align:-0.345em;"></span>
                          <span class="mord">
                            <span class="mopen nulldelimiter"></span>
                            <span class="mfrac">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.8087em;">
                                    <span style="top:-2.655em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                            k
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.23em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                    </span>
                                    <span style="top:-3.5073em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mtight">
                                            <span class="mord mathnormal mtight">
                                              n
                                            </span>
                                            <span class="msupsub">
                                              <span class="vlist-t vlist-t2">
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.1645em;">
                                                    <span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;">
                                                      <span class="pstrut" style="height:2.5em;"></span>
                                                      <span class="sizing reset-size3 size1 mtight">
                                                        <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                                          q
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="vlist-s">
                                                    ​
                                                  </span>
                                                </span>
                                                <span class="vlist-r">
                                                  <span class="vlist" style="height:0.2819em;">
                                                    <span></span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.345em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mclose nulldelimiter"></span>
                          </span>
                        </span>
                      </span>
                    </span>
                    of number of query heads
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  n
                                </mi>
                                <mi>
                                  q
                                </mi>
                              </msub>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              n_q
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              n
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.1514em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                          q
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    (evenly dividing the query heads into
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  n
                                </mi>
                                <mi>
                                  k
                                </mi>
                              </msub>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              n_k
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              n
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3361em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                          k
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.15em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    groups with
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                r
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              r
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.4306em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.02778em;">
                            r
                          </span>
                        </span>
                      </span>
                    </span>
                    heads)
                  </p>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="radixattention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-radixattention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="radixattention" dir="auto">
                  RadixAttention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#radixattention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-radixattention-toggle" data-level="2" data-heading-id="radixattention">
                  <p dir="auto">
                    Implemented in
                    <cite class id="citation--zheng2024sglangefficientexecutionstructured--3">
                      (
                      <a href="#bib-zheng2024sglangefficientexecutionstructured" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Zheng et al., 2024
                      </a>
                      )
                    </cite>
                    where they maintain a LRU eviction policy to maintain relevant
                    <a href="../thoughts/KV-compression" class="internal alias" data-slug="thoughts/KV-compression">
                      <span class="indicator-hook"></span>
                      KV cache
                    </a>
                    for all requests within a
                    <a href="../thoughts/Radix-tree" class="internal alias" data-slug="thoughts/Radix-tree">
                      <span class="indicator-hook"></span>
                      radix tree
                    </a>
                  </p>
                  <p dir="auto">
                    radix tree setup:
                  </p>
                  <ul dir="auto">
                    <li>
                      key: sequence of tokens
                    </li>
                    <li>
                      value: KV cache tensor (stored in GPU in a paged layout)
                    </li>
                  </ul>
                  <p dir="auto">
                    <img src="../thoughts/images/vllm/radix-attention.webp" width="auto" height="auto" alt loading="lazy"/>
                  </p>
                  <p dir="auto">
                    <em>
                      dynamic evolution of the radix tree in response to various requests.
                    </em>
                  </p>
                  <blockquote class="callout abstract is-collapsible is-collapsed" data-callout="abstract" data-callout-fold>
                    <div class="callout-title" dir="auto">
                      <div class="callout-icon" dir="auto"></div>
                      <div class="callout-title-inner" dir="auto">
                        <p dir="auto">
                          explanation of RadixAttention with LRU eviction policy
                        </p>
                      </div>
                      <div class="fold-callout-icon" dir="auto"></div>
                    </div>
                    <div class="callout-content" dir="auto">
                      <p dir="auto">
                        These requests include two chat sessions, a batch of few-shot learning inquiries, and a self-consistency sampling. Each tree edge carries a label denoting a substring or a sequence of tokens. The nodes are color-coded to reflect different states: green for newly added nodes, blue for cached nodes accessed during the time point, and red for nodes that have been evicted.
                      </p>
                      <p dir="auto">
                        <a href="https://lmsys.org/blog/2024-01-17-sglang/#backend-automatic-kv-cache-reuse-with-radixattention" class="external alias">
                          <span class="indicator-hook"></span>
                          full explanation
                        </a>
                      </p>
                    </div>
                  </blockquote>
                  <section class="collapsible-header" id="cache-aware-scheduling" data-level="3">
                    <div class="header-controls">
                      <button id="collapsible-header-cache-aware-scheduling-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                        <div class="toggle-icons">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </div>
                      </button>
                      <h3 id="cache-aware-scheduling" dir="auto">
                        cache-aware scheduling
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                          <circle cx="6" cy="12" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="18" cy="12" r="2"></circle>
                        </svg>
                        <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#cache-aware-scheduling" class="internal">
                          <span class="indicator-hook"></span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                        </a>
                      </h3>
                    </div>
                    <div class="collapsible-header-content-outer">
                      <div class="collapsible-header-content" data-references="collapsible-header-cache-aware-scheduling-toggle" data-level="3" data-heading-id="cache-aware-scheduling">
                        <p dir="auto">
                          We define the hit rate as
                        </p>
                        <span class="katex-display">
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                                <semantics>
                                  <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                                    <mtr>
                                      <mtd>
                                        <mstyle scriptlevel="0" displaystyle="true">
                                          <mtext>
                                            hit rate
                                          </mtext>
                                        </mstyle>
                                      </mtd>
                                      <mtd>
                                        <mstyle scriptlevel="0" displaystyle="true">
                                          <mrow>
                                            <mrow></mrow>
                                            <mo>
                                              =
                                            </mo>
                                            <mfrac>
                                              <mrow>
                                                <munder>
                                                  <mo>
                                                    ∑
                                                  </mo>
                                                  <mrow>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo>
                                                      ∈
                                                    </mo>
                                                    <mi>
                                                      R
                                                    </mi>
                                                  </mrow>
                                                </munder>
                                                <mtext>
                                                  number of cached prefill tokens in
                                                </mtext>
                                                <mi>
                                                  r
                                                </mi>
                                              </mrow>
                                              <mrow>
                                                <munder>
                                                  <mo>
                                                    ∑
                                                  </mo>
                                                  <mrow>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo>
                                                      ∈
                                                    </mo>
                                                    <mi>
                                                      R
                                                    </mi>
                                                  </mrow>
                                                </munder>
                                                <mtext>
                                                  number of prefill tokens in
                                                </mtext>
                                                <mi>
                                                  r
                                                </mi>
                                              </mrow>
                                            </mfrac>
                                          </mrow>
                                        </mstyle>
                                      </mtd>
                                    </mtr>
                                    <mtr>
                                      <mtd>
                                        <mstyle scriptlevel="0" displaystyle="true">
                                          <mrow></mrow>
                                        </mstyle>
                                      </mtd>
                                      <mtd>
                                        <mstyle scriptlevel="0" displaystyle="true">
                                          <mrow>
                                            <mrow></mrow>
                                            <mo>
                                              =
                                            </mo>
                                            <mn>
                                              1
                                            </mn>
                                            <mo>
                                              −
                                            </mo>
                                            <mfrac>
                                              <mi>
                                                C
                                              </mi>
                                              <mrow>
                                                <munder>
                                                  <mo>
                                                    ∑
                                                  </mo>
                                                  <mrow>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo>
                                                      ∈
                                                    </mo>
                                                    <mi>
                                                      R
                                                    </mi>
                                                  </mrow>
                                                </munder>
                                                <mtext>
                                                  number of prefill tokens
                                                </mtext>
                                              </mrow>
                                            </mfrac>
                                          </mrow>
                                        </mstyle>
                                      </mtd>
                                    </mtr>
                                  </mtable>
                                  <annotation encoding="application/x-tex">
                                    \begin{aligned}
                                    \text{hit rate} &amp;= \frac{\sum_{r \in R} \text{number of cached prefill tokens in } r}{\sum_{r \in R} \text{number of prefill tokens in } r} \\[8pt]
                                    &amp;=1 - \frac{C}{\sum_{r \in R} \text{number of prefill tokens}}
                                    \end{aligned}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:5.6005em;vertical-align:-2.5502em;"></span>
                                <span class="mord">
                                  <span class="mtable">
                                    <span class="col-align-r">
                                      <span class="vlist-t vlist-t2">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:3.0502em;">
                                            <span style="top:-5.0502em;">
                                              <span class="pstrut" style="height:3.4671em;"></span>
                                              <span class="mord">
                                                <span class="mord text">
                                                  <span class="mord">
                                                    hit rate
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span style="top:-2.2299em;">
                                              <span class="pstrut" style="height:3.4671em;"></span>
                                              <span class="mord"></span>
                                            </span>
                                          </span>
                                          <span class="vlist-s">
                                            ​
                                          </span>
                                        </span>
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:2.5502em;">
                                            <span></span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="col-align-l">
                                      <span class="vlist-t vlist-t2">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:3.0502em;">
                                            <span style="top:-5.0502em;">
                                              <span class="pstrut" style="height:3.4671em;"></span>
                                              <span class="mord">
                                                <span class="mord"></span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  =
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mord">
                                                  <span class="mopen nulldelimiter"></span>
                                                  <span class="mfrac">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:1.4671em;">
                                                          <span style="top:-2.314em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mop">
                                                                <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                                  ∑
                                                                </span>
                                                                <span class="msupsub">
                                                                  <span class="vlist-t vlist-t2">
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.1786em;">
                                                                        <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                          <span class="pstrut" style="height:2.7em;"></span>
                                                                          <span class="sizing reset-size6 size3 mtight">
                                                                            <span class="mord mtight">
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                                r
                                                                              </span>
                                                                              <span class="mrel mtight">
                                                                                ∈
                                                                              </span>
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                                R
                                                                              </span>
                                                                            </span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                      <span class="vlist-s">
                                                                        ​
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.3271em;">
                                                                        <span></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                                              <span class="mord text">
                                                                <span class="mord">
                                                                  number of prefill tokens in
                                                                </span>
                                                              </span>
                                                              <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                                r
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.23em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                                          </span>
                                                          <span style="top:-3.7171em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mop">
                                                                <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                                  ∑
                                                                </span>
                                                                <span class="msupsub">
                                                                  <span class="vlist-t vlist-t2">
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.1786em;">
                                                                        <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                          <span class="pstrut" style="height:2.7em;"></span>
                                                                          <span class="sizing reset-size6 size3 mtight">
                                                                            <span class="mord mtight">
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                                r
                                                                              </span>
                                                                              <span class="mrel mtight">
                                                                                ∈
                                                                              </span>
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                                R
                                                                              </span>
                                                                            </span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                      <span class="vlist-s">
                                                                        ​
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.3271em;">
                                                                        <span></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                                              <span class="mord text">
                                                                <span class="mord">
                                                                  number of cached prefill tokens in
                                                                </span>
                                                              </span>
                                                              <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                                r
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:1.0131em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose nulldelimiter"></span>
                                                </span>
                                              </span>
                                            </span>
                                            <span style="top:-2.2299em;">
                                              <span class="pstrut" style="height:3.4671em;"></span>
                                              <span class="mord">
                                                <span class="mord"></span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  =
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mord">
                                                  1
                                                </span>
                                                <span class="mspace" style="margin-right:0.2222em;"></span>
                                                <span class="mbin">
                                                  −
                                                </span>
                                                <span class="mspace" style="margin-right:0.2222em;"></span>
                                                <span class="mord">
                                                  <span class="mopen nulldelimiter"></span>
                                                  <span class="mfrac">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:1.3603em;">
                                                          <span style="top:-2.314em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mop">
                                                                <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                                  ∑
                                                                </span>
                                                                <span class="msupsub">
                                                                  <span class="vlist-t vlist-t2">
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.1786em;">
                                                                        <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                          <span class="pstrut" style="height:2.7em;"></span>
                                                                          <span class="sizing reset-size6 size3 mtight">
                                                                            <span class="mord mtight">
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                                r
                                                                              </span>
                                                                              <span class="mrel mtight">
                                                                                ∈
                                                                              </span>
                                                                              <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                                R
                                                                              </span>
                                                                            </span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                      <span class="vlist-s">
                                                                        ​
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-r">
                                                                      <span class="vlist" style="height:0.3271em;">
                                                                        <span></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                                              <span class="mord text">
                                                                <span class="mord">
                                                                  number of prefill tokens
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.23em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                                          </span>
                                                          <span style="top:-3.677em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mord mathnormal" style="margin-right:0.07153em;">
                                                                C
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:1.0131em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose nulldelimiter"></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="vlist-s">
                                            ​
                                          </span>
                                        </span>
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:2.5502em;">
                                            <span></span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <p dir="auto">
                          <em>
                            in batch settings: sort requests by matching prefix length and prioritise one with longer matched prefixes instead of FIFO schedule.
                          </em>
                        </p>
                        <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                          <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                            <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                              <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                              <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                            </svg>
                            <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                              <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                            </svg>
                          </button>
                          <span class="ps-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <annotation encoding="application/x-tex">
                                  &quot;\\begin{algorithm}\n\\caption{Cache-Aware Scheduling for RadixAttention with Continuous Batching}\n\\begin{algorithmic}\n\\State \\textbf{Input:} The radix tree $T$, the memory pool $P$, the current running batch $B$, the waiting queue $Q$.\n\\State \\textbf{Output:} Finished requests and updated system state.\n\\State // Get all requests from the waiting queue\n\\State requests $\\gets Q.\\text{get\\_all\\_requests}()$\n\\State // Search for prefix matching for all waiting request\n\\For{req $\\in$ requests}\n    \\State req.prefix\\_node, req.prefix\\_len $\\gets$ T.match\\_prefix(req.input\\_tokens)\n\\EndFor\n\\State // Sort the request according to matched prefix lengths\n\\State requests.sort()\n\\State // Select requests for the next batch\n\\State available\\_size $\\gets$ T.evictable\\_size() + P.available\\_size()\n\\State current\\_size $\\gets$ 0\n\\State new\\_batch $\\gets$ []\n\\For{req $\\in$ requests}\n    \\If{req.size() + current\\_size $\\le$ available\\_size}\n        \\State new\\_batch.append(req)\n        \\State $\\delta \\gets T.\\text{increase\\_ref\\_counter}(req.\\text{prefix\\_node})$\n        \\State available\\_size $\\gets$ available\\_size + $\\delta$\n    \\EndIf\n\\EndFor\n\\State Q.remove\\_requests(new\\_batch)\n\\State // Insert requests into the current running batch\n\\State B.merge(new\\_batch)\n\\State // Allocate new memory and do eviction if necessary\n\\State needed\\_size $\\gets$ B.needed\\_size()\n\\State success, buffer $\\gets$ P.alloc(needed\\_size)\n\\If{$\\neg \\text{success}$}\n    \\State T.evict(needed\\_size)\n    \\State success, buffer $\\gets$ P.alloc(needed\\_size)\n\\EndIf\n\\State B.run(buffer)\n\\State // Process finished requests\n\\State finished\\_requests $\\gets$ B.drop\\_finished\\_requests()\n\\For{req $\\in$ finished\\_requests}\n    \\State T.decrease\\_ref\\_counter(req.prefix\\_node)\n    \\State T.insert(req)\n\\EndFor\n\\State \\Return finished\\_requests\n\\end{algorithmic}\n\\end{algorithm}&quot;
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <div class="ps-algorithm with-caption" dir="auto">
                            <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                              <span class="ps-keyword">
                                Algorithm 1
                              </span>
                              Cache-Aware Scheduling for RadixAttention with Continuous Batching
                            </p>
                            <div class="ps-algorithmic" dir="auto">
                              <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                <p class="ps-line ps-code" dir="auto">
                                  <span style="font-weight:bold;">
                                    Input:
                                  </span>
                                  The radix tree
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              T
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            T
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6833em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.13889em;">
                                          T
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  , the memory pool
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              P
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            P
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6833em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.13889em;">
                                          P
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  , the current running batch
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              B
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            B
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6833em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.05017em;">
                                          B
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  , the waiting queue
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              Q
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            Q
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                        <span class="mord mathnormal">
                                          Q
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  .
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span style="font-weight:bold;">
                                    Output:
                                  </span>
                                  Finished requests and updated system state.
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Get all requests from the waiting queue
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  requests
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                            <mi>
                                              Q
                                            </mi>
                                            <mi mathvariant="normal">
                                              .
                                            </mi>
                                            <mtext>
                                              get_all_requests
                                            </mtext>
                                            <mo stretchy="false">
                                              (
                                            </mo>
                                            <mo stretchy="false">
                                              )
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets Q.\text{get\_all\_requests}()
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                        <span class="mord mathnormal">
                                          Q
                                        </span>
                                        <span class="mord">
                                          .
                                        </span>
                                        <span class="mord text">
                                          <span class="mord">
                                            get_all_requests
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Search for prefix matching for all waiting request
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    for
                                  </span>
                                  req
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ∈
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \in
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                        <span class="mrel">
                                          ∈
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  requests
                                  <span class="ps-keyword">
                                    do
                                  </span>
                                </p>
                                <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    req.prefix_node, req.prefix_len
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mo>
                                                ←
                                              </mo>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \gets
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.3669em;"></span>
                                          <span class="mrel">
                                            ←
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    T.match_prefix(req.input_tokens)
                                  </p>
                                </div>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    end for
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Sort the request according to matched prefix lengths
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  requests.sort()
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Select requests for the next batch
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  available_size
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  T.evictable_size() + P.available_size()
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  current_size
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  0
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  new_batch
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  []
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    for
                                  </span>
                                  req
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ∈
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \in
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                        <span class="mrel">
                                          ∈
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  requests
                                  <span class="ps-keyword">
                                    do
                                  </span>
                                </p>
                                <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-keyword">
                                      if
                                    </span>
                                    req.size() + current_size
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mo>
                                                ≤
                                              </mo>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \le
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span>
                                          <span class="mrel">
                                            ≤
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    available_size
                                    <span class="ps-keyword">
                                      then
                                    </span>
                                  </p>
                                  <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                    <p class="ps-line ps-code" dir="auto">
                                      new_batch.append(req)
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  δ
                                                </mi>
                                                <mo>
                                                  ←
                                                </mo>
                                                <mi>
                                                  T
                                                </mi>
                                                <mi mathvariant="normal">
                                                  .
                                                </mi>
                                                <mtext>
                                                  increase_ref_counter
                                                </mtext>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mi>
                                                  r
                                                </mi>
                                                <mi>
                                                  e
                                                </mi>
                                                <mi>
                                                  q
                                                </mi>
                                                <mi mathvariant="normal">
                                                  .
                                                </mi>
                                                <mtext>
                                                  prefix_node
                                                </mtext>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \delta \gets T.\text{increase\_ref\_counter}(req.\text{prefix\_node})
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.6944em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                                              δ
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ←
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              T
                                            </span>
                                            <span class="mord">
                                              .
                                            </span>
                                            <span class="mord text">
                                              <span class="mord">
                                                increase_ref_counter
                                              </span>
                                            </span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mord mathnormal">
                                              re
                                            </span>
                                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                                              q
                                            </span>
                                            <span class="mord">
                                              .
                                            </span>
                                            <span class="mord text">
                                              <span class="mord">
                                                prefix_node
                                              </span>
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      available_size
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mo>
                                                  ←
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \gets
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.3669em;"></span>
                                            <span class="mrel">
                                              ←
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      available_size +
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  δ
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \delta
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.6944em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                                              δ
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                  </div>
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-keyword">
                                      end if
                                    </span>
                                  </p>
                                </div>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    end for
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  Q.remove_requests(new_batch)
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Insert requests into the current running batch
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  B.merge(new_batch)
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Allocate new memory and do eviction if necessary
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  needed_size
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  B.needed_size()
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  success, buffer
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  P.alloc(needed_size)
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    if
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi mathvariant="normal">
                                              ¬
                                            </mi>
                                            <mtext>
                                              success
                                            </mtext>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \neg \text{success}
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.4306em;"></span>
                                        <span class="mord">
                                          ¬
                                        </span>
                                        <span class="mord text">
                                          <span class="mord">
                                            success
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="ps-keyword">
                                    then
                                  </span>
                                </p>
                                <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    T.evict(needed_size)
                                  </p>
                                  <p class="ps-line ps-code" dir="auto">
                                    success, buffer
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mo>
                                                ←
                                              </mo>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \gets
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.3669em;"></span>
                                          <span class="mrel">
                                            ←
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    P.alloc(needed_size)
                                  </p>
                                </div>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    end if
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  B.run(buffer)
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  // Process finished requests
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  finished_requests
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ←
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \gets
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.3669em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  B.drop_finished_requests()
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    for
                                  </span>
                                  req
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mo>
                                              ∈
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \in
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                        <span class="mrel">
                                          ∈
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  finished_requests
                                  <span class="ps-keyword">
                                    do
                                  </span>
                                </p>
                                <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    T.decrease_ref_counter(req.prefix_node)
                                  </p>
                                  <p class="ps-line ps-code" dir="auto">
                                    T.insert(req)
                                  </p>
                                </div>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    end for
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto"></p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-keyword">
                                    return
                                  </span>
                                  finished_requests
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                        <p dir="auto">
                          We got lower bound:
                        </p>
                        <span class="katex-display">
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      C
                                    </mi>
                                    <mo>
                                      ≥
                                    </mo>
                                    <munder>
                                      <mo>
                                        ∑
                                      </mo>
                                      <mrow>
                                        <mi>
                                          e
                                        </mi>
                                        <mo>
                                          ∈
                                        </mo>
                                        <mtext>
                                          edges
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          T
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                    </munder>
                                    <mo>
                                      ∣
                                    </mo>
                                    <mi>
                                      e
                                    </mi>
                                    <mo>
                                      ∣
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    C \ge \sum_{e \in \text{edges}(T)} \mid e \mid
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.07153em;">
                                  C
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ≥
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:2.566em;vertical-align:-1.516em;"></span>
                                <span class="mop op-limits">
                                  <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                      <span class="vlist" style="height:1.05em;">
                                        <span style="top:-1.809em;margin-left:0em;">
                                          <span class="pstrut" style="height:3.05em;"></span>
                                          <span class="sizing reset-size6 size3 mtight">
                                            <span class="mord mtight">
                                              <span class="mord mathnormal mtight">
                                                e
                                              </span>
                                              <span class="mrel mtight">
                                                ∈
                                              </span>
                                              <span class="mord text mtight">
                                                <span class="mord mtight">
                                                  edges
                                                </span>
                                              </span>
                                              <span class="mopen mtight">
                                                (
                                              </span>
                                              <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                T
                                              </span>
                                              <span class="mclose mtight">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span style="top:-3.05em;">
                                          <span class="pstrut" style="height:3.05em;"></span>
                                          <span>
                                            <span class="mop op-symbol large-op">
                                              ∑
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="vlist-s">
                                        ​
                                      </span>
                                    </span>
                                    <span class="vlist-r">
                                      <span class="vlist" style="height:1.516em;">
                                        <span></span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ∣
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ∣
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <p dir="auto">
                          Consider we visit radix tree
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      T
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    T
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  T
                                </span>
                              </span>
                            </span>
                          </span>
                          in DFS order. For each edge
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      e
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    e
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                              </span>
                            </span>
                          </span>
                          of
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      T
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    T
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  T
                                </span>
                              </span>
                            </span>
                          </span>
                          , the first time we compute KV cache associated with
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      e
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    e
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                              </span>
                            </span>
                          </span>
                          , then we will compute the whole subtree of
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      e
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    e
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                              </span>
                            </span>
                          </span>
                          .
                        </p>
                        <p dir="auto">
                          During computation of
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      e
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    e
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                              </span>
                            </span>
                          </span>
                          subtree, then edge
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      e
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    e
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  e
                                </span>
                              </span>
                            </span>
                          </span>
                          will be continuously hit, thus no additional computation will happen.
                        </p>
                        <blockquote class="callout tip" data-callout="tip">
                          <div class="callout-title" dir="auto">
                            <div class="callout-icon" dir="auto"></div>
                            <div class="callout-title-inner" dir="auto">
                              <p dir="auto">
                                cache hit
                              </p>
                            </div>
                          </div>
                          <div class="callout-content" dir="auto">
                            <p dir="auto">
                              with cache size
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mo>
                                          ≥
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \ge
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span>
                                    <span class="mrel">
                                      ≥
                                    </span>
                                  </span>
                                </span>
                              </span>
                              maximum request length (which will equals to longest path in radix tree), edge
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          e
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        e
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal">
                                      e
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <strong>
                                WILL NOT
                              </strong>
                              be evicted during computation of its subtree
                              since the common prefix including
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          e
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        e
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal">
                                      e
                                    </span>
                                  </span>
                                </span>
                              </span>
                              of the subtree will be continuously hit.
                            </p>
                          </div>
                        </blockquote>
                        <p dir="auto">
                          We can show that longest-shared-prefix-first order is equivalent to DFS order by induction
                          <sup>
                            <a href="#user-content-fn-proof" id="user-content-fnref-proof" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                              <span class="indicator-hook"></span>
                              1
                            </a>
                          </sup>
                        </p>
                        <p dir="auto"></p>
                        <blockquote class="transclude" data-url="thoughts/constrained-decoding" data-block="#compressed-fsm-for-jump-ahead-tokens" data-embed-alias="compressed FSM for jump-ahead tokens.">
                          <h3 id="compressed-fsm-for-jump-ahead-tokens" dir="auto">
                            compressed FSM for jump-ahead tokens.
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#compressed-fsm-for-jump-ahead-tokens" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h3>
                          <p dir="auto">
                            Implemented in
                            <cite class id="citation--zheng2024sglangefficientexecutionstructured--1">
                              (
                              <a href="#bib-zheng2024sglangefficientexecutionstructured" data-no-popover data-bib class="internal alias">
                                <span class="indicator-hook"></span>
                                Zheng et al., 2024
                              </a>
                              )
                            </cite>
                          </p>
                          <h4 id="method-1-fsm-based-decoding" dir="auto">
                            Method 1:
                            <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#guided-generations-with-fsm" class="internal alias" data-slug="thoughts/constrained-decoding">
                              <span class="indicator-hook"></span>
                              FSM
                            </a>
                            -based decoding
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-1-fsm-based-decoding" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              <p dir="auto">
                                intuition: Using FSM
                                <cite class id="citation--willard2023efficientguidedgenerationlarge--2">
                                  (
                                  <a href="#bib-willard2023efficientguidedgenerationlarge" data-no-popover data-bib class="internal alias">
                                    <span class="indicator-hook"></span>
                                    Willard &amp; Louf, 2023
                                  </a>
                                  )
                                </cite>
                                to guide generations by increasing logit bias for tokens that conform to given JSON schema. This allows us to track the current state during decoding and filter out invalid tokens by applying logit bias to the output.
                                <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/constrained-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                              </p>
                            </li>
                            <li>
                              <p dir="auto">
                                limitation: we can see that given construction of FSM requires token-level access, it can only transition the state by only
                                <em>
                                  one
                                </em>
                                token at a time, resulting in slow decoding.
                              </p>
                            </li>
                          </ul>
                          <h4 id="method-2-interleaved-based" dir="auto">
                            Method 2: Interleaved-based
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-2-interleaved-based" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              <p dir="auto">
                                intuition: breaks down JSON schemas, each containing either a chunk prefill part or constrained decoding part. They are then executed interleaved by inference system.
                                Faster than per-token decoding given that chunked prefill components can process multiple tokens per forward pass
                              </p>
                              <p dir="auto">
                                See also
                                <a href="https://github.com/guidance-ai/guidance#guidance-acceleration" class="external">
                                  <span class="indicator-hook"></span>
                                  https://github.com/guidance-ai/guidance#guidance-acceleration
                                </a>
                                using llama.cpp as backend.
                              </p>
                            </li>
                            <li>
                              <p dir="auto">
                                limitation:
                              </p>
                              <ul dir="auto">
                                <li>
                                  interleaved-based require custom syntax, making it less expressive compared to regex.
                                </li>
                                <li>
                                  struggles to deal with tokenization boundaries due to conflicts between decode and chunked prefill segments.
                                </li>
                                <li>
                                  frequent communications between interpreter and back-end adds additional overhead.
                                </li>
                              </ul>
                            </li>
                          </ul>
                          <h4 id="method-3-jump-forward-decoding-with-compressed-fsm" dir="auto">
                            <strong>
                              <mark>
                                Method 3: Jump-Forward Decoding with compressed FSM
                              </mark>
                            </strong>
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-3-jump-forward-decoding-with-compressed-fsm" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <p dir="auto">
                            <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/jump-forward-decoding-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                          </p>
                          <blockquote class="callout tip" data-callout="tip">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  tokenization boundary handling
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                During decoding, it is preferred to combine multiple characters into a single tokens.
                              </p>
                              <p dir="auto">
                                For example, when decoding
                                <code>
                                  &quot;Hello&quot;
                                </code>
                                in context of JSON decoding, LLM might output the following token
                                <code>
                                  &quot;
                                </code>
                                ,
                                <code>
                                  He
                                </code>
                                ,
                                <code>
                                  llo
                                </code>
                                ,
                                <code>
                                  &quot;,
                                </code>
                              </p>
                              <p dir="auto">
                                This may cause some strange behaviour if we combine the last
                                <code>
                                  &quot;
                                </code>
                                with
                                <code>
                                  ,
                                </code>
                                (this regex
                                <code>
                                  &quot;[\w\d\s]*&quot;
                                </code>
                                with the last
                                <code>
                                  ,
                                </code>
                                will lead to endless decoding because this token
                                <code>
                                  &quot;,
                                </code>
                                is not valid even if the LM wants to stop.)
                              </p>
                            </div>
                          </blockquote>
                          <p dir="auto">
                            Fix:
                          </p>
                          <ul dir="auto">
                            <li>
                              implement
                              <mark>
                                re-tokenization
                              </mark>
                              mechanism during jump-forward phase (append string instead of the tokens, followed with re-tokenization of the entire text)
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mo>
                                          →
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \to
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.3669em;"></span>
                                    <span class="mrel">
                                      →
                                    </span>
                                  </span>
                                </span>
                              </span>
                              add approximately 4% of overhead
                            </li>
                            <li>
                              use a comprehensive regex to guide the decoding phase, instead of employing multiple concatenated regex
                              <sup>
                                <a href="#user-content-fn-coalescence" id="user-content-fnref-coalescence" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                  <span class="indicator-hook"></span>
                                  2
                                </a>
                              </sup>
                            </li>
                          </ul>
                          <a href="../thoughts/constrained-decoding#compressed-fsm-for-jump-ahead-tokens" class="internal transclude-src">
                            Lien vers l'original
                          </a>
                        </blockquote>
                        <p dir="auto"></p>
                      </div>
                    </div>
                  </section>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="ringattention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-ringattention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="ringattention" dir="auto">
                  RingAttention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#ringattention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-ringattention-toggle" data-level="2" data-heading-id="ringattention">
                  <p dir="auto">
                    <cite class id="citation--liu2023ringattentionblockwisetransformers--4">
                      (
                      <a href="#bib-liu2023ringattentionblockwisetransformers" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Liu et al., 2023
                      </a>
                      )
                    </cite>
                  </p>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="razorattention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-razorattention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="razorattention" dir="auto">
                  RazorAttention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#razorattention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-razorattention-toggle" data-level="2" data-heading-id="razorattention">
                  <p dir="auto">
                    <cite class id="citation--tang2024razorattentionefficientkvcache--5">
                      (
                      <a href="#bib-tang2024razorattentionefficientkvcache" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Tang et al., 2024
                      </a>
                      )
                    </cite>
                  </p>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="paged-attention" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-paged-attention-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="paged-attention" dir="auto">
                  Paged Attention
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#paged-attention" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-paged-attention-toggle" data-level="2" data-heading-id="paged-attention">
                  <p dir="auto">
                    by
                    <cite class id="citation--kwon2023efficient--6">
                      (
                      <a href="#bib-kwon2023efficient" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Kwon et al., 2023
                      </a>
                      )
                    </cite>
                  </p>
                  <p dir="auto">
                    Used in conjunction with
                    <a href="../thoughts/Continuous-batching" class="internal alias" data-slug="thoughts/Continuous-batching">
                      <span class="indicator-hook"></span>
                      continuous batching
                    </a>
                    , implemented through
                    <a href="../thoughts/vllm" class="internal alias" data-slug="thoughts/vllm">
                      <span class="indicator-hook"></span>
                      vLLM
                    </a>
                  </p>
                  <p dir="auto">
                    Reduce memory usage of attention mechanism by swapping kv-cache in and out of memory. A block manager is similar to those of
                    <em>
                      virtual memory
                    </em>
                    in OS.
                  </p>
                  <p dir="auto">
                    Essentially, it’s a form of
                    <strong>
                      paging
                    </strong>
                    , such that attention can be stored in contiguous memory.
                    Partitions the KV cache of each sequence into KV blocks.
                  </p>
                  <p dir="auto">
                    Another optimization is to use
                    <a href="../thoughts/KV-compression" class="internal alias" data-slug="thoughts/KV-compression">
                      <span class="indicator-hook"></span>
                      KV compression
                    </a>
                    to reduce the size of the KV cache for longer context.
                  </p>
                  <p dir="auto">
                    Given:
                  </p>
                  <ul dir="auto">
                    <li>
                      each block contains KV vectors for fixed number of tokens, denoted as block size
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  B
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                B
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.05017em;">
                              B
                            </span>
                          </span>
                        </span>
                      </span>
                      .
                    </li>
                    <li>
                      Key block
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <msub>
                                  <mi>
                                    K
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </msub>
                                <mo>
                                  =
                                </mo>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <msub>
                                  <mi>
                                    k
                                  </mi>
                                  <mrow>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mi>
                                      j
                                    </mi>
                                    <mo>
                                      −
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                    <mi>
                                      B
                                    </mi>
                                    <mo>
                                      +
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                  </mrow>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mo>
                                  …
                                </mo>
                                <mo separator="true">
                                  ,
                                </mo>
                                <msub>
                                  <mi>
                                    k
                                  </mi>
                                  <mrow>
                                    <mi>
                                      j
                                    </mi>
                                    <mi>
                                      B
                                    </mi>
                                  </mrow>
                                </msub>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                K_j= (k_{(j-1)B+1}, \ldots, k_{jB})
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.07153em;">
                                K
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3117em;">
                                      <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.2861em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              =
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                            <span class="mopen">
                              (
                            </span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03148em;">
                                k
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3448em;">
                                      <span style="top:-2.5198em;margin-left:-0.0315em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mopen mtight">
                                              (
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                              j
                                            </span>
                                            <span class="mbin mtight">
                                              −
                                            </span>
                                            <span class="mord mtight">
                                              1
                                            </span>
                                            <span class="mclose mtight">
                                              )
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                              B
                                            </span>
                                            <span class="mbin mtight">
                                              +
                                            </span>
                                            <span class="mord mtight">
                                              1
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3552em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="minner">
                              …
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03148em;">
                                k
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3283em;">
                                      <span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                              j
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                              B
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.2861em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mclose">
                              )
                            </span>
                          </span>
                        </span>
                      </span>
                    </li>
                    <li>
                      Value block
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <msub>
                                  <mi>
                                    V
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </msub>
                                <mo>
                                  =
                                </mo>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mrow>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mi>
                                      j
                                    </mi>
                                    <mo>
                                      −
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                    <mi>
                                      B
                                    </mi>
                                    <mo>
                                      +
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                  </mrow>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mo>
                                  …
                                </mo>
                                <mo separator="true">
                                  ,
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mrow>
                                    <mi>
                                      j
                                    </mi>
                                    <mi>
                                      B
                                    </mi>
                                  </mrow>
                                </msub>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                V_j= (v_{(j-1)B+1}, \ldots, v_{jB})
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.22222em;">
                                V
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3117em;">
                                      <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.2861em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              =
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                            <span class="mopen">
                              (
                            </span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3448em;">
                                      <span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mopen mtight">
                                              (
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                              j
                                            </span>
                                            <span class="mbin mtight">
                                              −
                                            </span>
                                            <span class="mord mtight">
                                              1
                                            </span>
                                            <span class="mclose mtight">
                                              )
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                              B
                                            </span>
                                            <span class="mbin mtight">
                                              +
                                            </span>
                                            <span class="mord mtight">
                                              1
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3552em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="minner">
                              …
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3283em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                              j
                                            </span>
                                            <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                              B
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.2861em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mclose">
                              )
                            </span>
                          </span>
                        </span>
                      </span>
                    </li>
                  </ul>
                  <span class="katex-display">
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  A
                                </mi>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </mrow>
                              </msub>
                              <mo>
                                =
                              </mo>
                              <mfrac>
                                <mrow>
                                  <mi>
                                    exp
                                  </mi>
                                  <mo>
                                    ⁡
                                  </mo>
                                  <mo stretchy="false">
                                    (
                                  </mo>
                                  <msubsup>
                                    <mi>
                                      q
                                    </mi>
                                    <mi>
                                      i
                                    </mi>
                                    <mi>
                                      T
                                    </mi>
                                  </msubsup>
                                  <msub>
                                    <mi>
                                      K
                                    </mi>
                                    <mi>
                                      j
                                    </mi>
                                  </msub>
                                  <mi mathvariant="normal">
                                    /
                                  </mi>
                                  <msqrt>
                                    <mi>
                                      d
                                    </mi>
                                  </msqrt>
                                  <mo stretchy="false">
                                    )
                                  </mo>
                                </mrow>
                                <mrow>
                                  <munderover>
                                    <mo>
                                      ∑
                                    </mo>
                                    <mrow>
                                      <mi>
                                        t
                                      </mi>
                                      <mo>
                                        =
                                      </mo>
                                      <mn>
                                        1
                                      </mn>
                                    </mrow>
                                    <mrow>
                                      <mi>
                                        i
                                      </mi>
                                      <mi mathvariant="normal">
                                        /
                                      </mi>
                                      <mi mathvariant="normal">
                                        /
                                      </mi>
                                      <mi>
                                        B
                                      </mi>
                                    </mrow>
                                  </munderover>
                                  <mi>
                                    exp
                                  </mi>
                                  <mo>
                                    ⁡
                                  </mo>
                                  <mo stretchy="false">
                                    (
                                  </mo>
                                  <msubsup>
                                    <mi>
                                      q
                                    </mi>
                                    <mi>
                                      i
                                    </mi>
                                    <mi>
                                      T
                                    </mi>
                                  </msubsup>
                                  <msub>
                                    <mi>
                                      K
                                    </mi>
                                    <mi>
                                      t
                                    </mi>
                                  </msub>
                                  <mi mathvariant="normal">
                                    /
                                  </mi>
                                  <msqrt>
                                    <mi>
                                      d
                                    </mi>
                                  </msqrt>
                                  <mo stretchy="false">
                                    )
                                  </mo>
                                </mrow>
                              </mfrac>
                              <mo separator="true">
                                ,
                              </mo>
                              <mspace width="1em"></mspace>
                              <msub>
                                <mi>
                                  o
                                </mi>
                                <mi>
                                  i
                                </mi>
                              </msub>
                              <mo>
                                =
                              </mo>
                              <munderover>
                                <mo>
                                  ∑
                                </mo>
                                <mrow>
                                  <mi>
                                    j
                                  </mi>
                                  <mo>
                                    =
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                </mrow>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mi mathvariant="normal">
                                    /
                                  </mi>
                                  <mi mathvariant="normal">
                                    /
                                  </mi>
                                  <mi>
                                    B
                                  </mi>
                                </mrow>
                              </munderover>
                              <msub>
                                <mi>
                                  V
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </msub>
                              <msubsup>
                                <mi>
                                  A
                                </mi>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </mrow>
                                <mi>
                                  T
                                </mi>
                              </msubsup>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              A_{ij} = \frac{\exp(q_i^T K_j / \sqrt{d})}{\sum_{t=1}^{i//B} \exp(q_i^T K_t / \sqrt{d})}, \quad o_i = \sum_{j=1}^{i//B} V_j A_{ij}^T
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              A
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            ij
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:2.8268em;vertical-align:-1.2176em;"></span>
                          <span class="mord">
                            <span class="mopen nulldelimiter"></span>
                            <span class="mfrac">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:1.6092em;">
                                    <span style="top:-2.11em;">
                                      <span class="pstrut" style="height:3.0279em;"></span>
                                      <span class="mord">
                                        <span class="mop">
                                          <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                            ∑
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:1.0279em;">
                                                  <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mtight">
                                                        <span class="mord mathnormal mtight">
                                                          t
                                                        </span>
                                                        <span class="mrel mtight">
                                                          =
                                                        </span>
                                                        <span class="mord mtight">
                                                          1
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.2029em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mtight">
                                                        <span class="mord mathnormal mtight">
                                                          i
                                                        </span>
                                                        <span class="mord mtight">
                                                          //
                                                        </span>
                                                        <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                                          B
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2997em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mop">
                                          exp
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                                            q
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8231em;">
                                                  <span style="top:-2.4231em;margin-left:-0.0359em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.0448em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                        T
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2769em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.07153em;">
                                            K
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2806em;">
                                                  <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        t
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.15em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mord">
                                          /
                                        </span>
                                        <span class="mord sqrt">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.9322em;">
                                                <span class="svg-align" style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord" style="padding-left:0.833em;">
                                                    <span class="mord mathnormal">
                                                      d
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-2.8922em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                      <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                    </svg>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.1078em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.2579em;">
                                      <span class="pstrut" style="height:3.0279em;"></span>
                                      <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                    </span>
                                    <span style="top:-3.7049em;">
                                      <span class="pstrut" style="height:3.0279em;"></span>
                                      <span class="mord">
                                        <span class="mop">
                                          exp
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                                            q
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8413em;">
                                                  <span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.063em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                        T
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2587em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.07153em;">
                                            K
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.3117em;">
                                                  <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                                        j
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2861em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mord">
                                          /
                                        </span>
                                        <span class="mord sqrt">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.9322em;">
                                                <span class="svg-align" style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord" style="padding-left:0.833em;">
                                                    <span class="mord mathnormal">
                                                      d
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-2.8922em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                      <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                    </svg>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.1078em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:1.2176em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mclose nulldelimiter"></span>
                          </span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:1em;"></span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              o
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight">
                                          i
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.15em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:3.3748em;vertical-align:-1.4138em;"></span>
                          <span class="mop op-limits">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:1.961em;">
                                  <span style="top:-1.8723em;margin-left:0em;">
                                    <span class="pstrut" style="height:3.05em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                        <span class="mrel mtight">
                                          =
                                        </span>
                                        <span class="mord mtight">
                                          1
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.05em;">
                                    <span class="pstrut" style="height:3.05em;"></span>
                                    <span>
                                      <span class="mop op-symbol large-op">
                                        ∑
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-4.386em;margin-left:0em;">
                                    <span class="pstrut" style="height:3.05em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          i
                                        </span>
                                        <span class="mord mtight">
                                          //
                                        </span>
                                        <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                          B
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:1.4138em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.22222em;">
                              V
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              A
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.8913em;">
                                    <span style="top:-2.453em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            ij
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.113em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                          T
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3831em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                  <p dir="auto">
                    where
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  A
                                </mi>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </mrow>
                              </msub>
                              <mo>
                                =
                              </mo>
                              <mo stretchy="false">
                                (
                              </mo>
                              <msub>
                                <mi>
                                  a
                                </mi>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mo separator="true">
                                    ,
                                  </mo>
                                  <mo stretchy="false">
                                    (
                                  </mo>
                                  <mi>
                                    j
                                  </mi>
                                  <mo>
                                    −
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                  <mo stretchy="false">
                                    )
                                  </mo>
                                  <mi>
                                    B
                                  </mi>
                                  <mo>
                                    +
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                </mrow>
                              </msub>
                              <mo separator="true">
                                ,
                              </mo>
                              <mo>
                                …
                              </mo>
                              <msub>
                                <mi>
                                  a
                                </mi>
                                <mrow>
                                  <mi>
                                    i
                                  </mi>
                                  <mo separator="true">
                                    ,
                                  </mo>
                                  <mi>
                                    j
                                  </mi>
                                  <mi>
                                    B
                                  </mi>
                                </mrow>
                              </msub>
                              <mo stretchy="false">
                                )
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              A_{ij}=(a_{i,(j-1)B+1}, \ldots a_{i,jB})
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              A
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            ij
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                          <span class="mopen">
                            (
                          </span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              a
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3448em;">
                                    <span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                            i
                                          </span>
                                          <span class="mpunct mtight">
                                            ,
                                          </span>
                                          <span class="mopen mtight">
                                            (
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mbin mtight">
                                            −
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                          <span class="mclose mtight">
                                            )
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                          <span class="mbin mtight">
                                            +
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3552em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="minner">
                            …
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal">
                              a
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3283em;">
                                    <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                            i
                                          </span>
                                          <span class="mpunct mtight">
                                            ,
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose">
                            )
                          </span>
                        </span>
                      </span>
                    </span>
                    is row vector of attention score on j-th KV block.
                  </p>
                </div>
              </div>
            </section>
            <section data-references class="bibliography">
              <h2 id="reference-label" dir="auto">
                References
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#reference-label" class="internal">
                  <span class="indicator-hook"></span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <ul dir="auto">
                <li class="csl-entry" id="bib-ainslie2023gqatraininggeneralizedmultiquery">
                  Ainslie, J., Lee-Thorp, J., de Jong, M., Zemlyanskiy, Y., Lebrón, F., &amp; Sanghai, S. (2023).
                  <i>
                    GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints
                  </i>
                  . arXiv preprint arXiv:2305.13245
                  <a href="https://arxiv.org/abs/2305.13245" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2305.13245">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-kwon2023efficient">
                  Kwon, W., Li, Z., Zhuang, S., Sheng, Y., Zheng, L., Yu, C. H., Gonzalez, J. E., Zhang, H., &amp; Stoica, I. (2023). Efficient Memory Management for Large Language Model Serving with PagedAttention.
                  <i>
                    Proceedings of the ACM SIGOPS 29th Symposium on Operating Systems Principles
                  </i>
                  .
                </li>
                <li class="csl-entry" id="bib-liu2023ringattentionblockwisetransformers">
                  Liu, H., Zaharia, M., &amp; Abbeel, P. (2023).
                  <i>
                    Ring Attention with Blockwise Transformers for Near-Infinite Context
                  </i>
                  . arXiv preprint arXiv:2310.01889
                  <a href="https://arxiv.org/abs/2310.01889" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2310.01889">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-tang2024razorattentionefficientkvcache">
                  Tang, H., Lin, Y., Lin, J., Han, Q., Hong, S., Yao, Y., &amp; Wang, G. (2024).
                  <i>
                    RazorAttention: Efficient KV Cache Compression Through Retrieval Heads
                  </i>
                  . arXiv preprint arXiv:2407.15891
                  <a href="https://arxiv.org/abs/2407.15891" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2407.15891">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-vaswani2023attentionneed">
                  Vaswani, A., Shazeer, N., Parmar, N., Uszkoreit, J., Jones, L., Gomez, A. N., Kaiser, L., &amp; Polosukhin, I. (2023).
                  <i>
                    Attention Is All You Need
                  </i>
                  . arXiv preprint arXiv:1706.03762
                  <a href="https://arxiv.org/abs/1706.03762" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="1706.03762">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-zheng2024sglangefficientexecutionstructured">
                  Zheng, L., Yin, L., Xie, Z., Sun, C., Huang, J., Yu, C. H., Cao, S., Kozyrakis, C., Stoica, I., Gonzalez, J. E., Barrett, C., &amp; Sheng, Y. (2024).
                  <i>
                    SGLang: Efficient Execution of Structured Language Model Programs
                  </i>
                  . arXiv preprint arXiv:2312.07104
                  <a href="https://arxiv.org/abs/2312.07104" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2312.07104">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
              </ul>
            </section>
            <section data-footnotes class="footnotes">
              <h2 class="sr-only" id="footnote-label" dir="auto">
                Footnotes
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#footnote-label" class="internal">
                  <span class="indicator-hook"></span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <ol dir="auto">
                <li id="user-content-fn-proof">
                  <p dir="auto">
                    <em>
                      base
                    </em>
                    : a random request correspond to node
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                x
                              </mi>
                              <mo>
                                ∈
                              </mo>
                              <mi>
                                T
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              x \in T
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                          <span class="mord mathnormal">
                            x
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            ∈
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                            T
                          </span>
                        </span>
                      </span>
                    </span>
                    will be processed.
                  </p>
                  <ul dir="auto">
                    <li>
                      All requests correspond to nodes
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mo stretchy="false">
                                  {
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mn>
                                    1
                                  </mn>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mo>
                                  …
                                </mo>
                                <mo separator="true">
                                  ,
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mi>
                                    n
                                  </mi>
                                </msub>
                                <mo stretchy="false">
                                  }
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \{v_{1}, \ldots, v_{n}\}
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                            <span class="mopen">
                              {
                            </span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3011em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mtight">
                                              1
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="minner">
                              …
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.1514em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mathnormal mtight">
                                              n
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mclose">
                              }
                            </span>
                          </span>
                        </span>
                      </span>
                      on path
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  x
                                </mi>
                                <mo>
                                  ←
                                </mo>
                                <mtext>
                                  root
                                </mtext>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                x \gets \text{root}
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal">
                              x
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              ←
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.6151em;"></span>
                            <span class="mord text">
                              <span class="mord">
                                root
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                      doesn’t need recomputation.
                    </li>
                    <li>
                      Thus, computation complexity for requests of nodes
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mo stretchy="false">
                                  {
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mn>
                                    1
                                  </mn>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mo>
                                  …
                                </mo>
                                <mo separator="true">
                                  ,
                                </mo>
                                <msub>
                                  <mi>
                                    v
                                  </mi>
                                  <mi>
                                    n
                                  </mi>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mi>
                                  x
                                </mi>
                                <mo stretchy="false">
                                  }
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \{v_{1}, \ldots, v_{n}, x\}
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                            <span class="mopen">
                              {
                            </span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3011em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mtight">
                                              1
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="minner">
                              …
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                v
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.1514em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            <span class="mord mathnormal mtight">
                                              n
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord mathnormal">
                              x
                            </span>
                            <span class="mclose">
                              }
                            </span>
                          </span>
                        </span>
                      </span>
                      is aligned with DFS
                    </li>
                  </ul>
                  <p dir="auto">
                    <em>
                      induction
                    </em>
                    : assume we visit node
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                y
                              </mi>
                              <mo>
                                ∈
                              </mo>
                              <mi>
                                T
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              y \in T
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                            y
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            ∈
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                            T
                          </span>
                        </span>
                      </span>
                    </span>
                    , and the visited node align with DFS order. Let
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                P
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              P
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                            P
                          </span>
                        </span>
                      </span>
                    </span>
                    denote
                    <em>
                      path of
                    </em>
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                y
                              </mi>
                              <mo>
                                ←
                              </mo>
                              <mtext>
                                root
                              </mtext>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              y \gets \text{root}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                            y
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            ←
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:0.6151em;"></span>
                          <span class="mord text">
                            <span class="mord">
                              root
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                    .
                  </p>
                  <ul dir="auto">
                    <li>
                      Each node that has not been visited has the lowest common ancestor with visited nodes on
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  P
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                P
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                              P
                            </span>
                          </span>
                        </span>
                      </span>
                      .
                    </li>
                    <li>
                      Since nodes on
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  P
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                P
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                              P
                            </span>
                          </span>
                        </span>
                      </span>
                      are cached, a node
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  z
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                z
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.04398em;">
                              z
                            </span>
                          </span>
                        </span>
                      </span>
                      that has yet to be visited with lowest common accestor on
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  P
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                P
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                              P
                            </span>
                          </span>
                        </span>
                      </span>
                      will have the
                      <em>
                        longest shared prefix
                      </em>
                    </li>
                    <li>
                      longest-shared-prefix-first order will select
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  z
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                z
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.04398em;">
                              z
                            </span>
                          </span>
                        </span>
                      </span>
                      , which is a valid DFS
                      q.e.d
                    </li>
                  </ul>
                  <a href="#user-content-fnref-proof" data-footnote-backref aria-label="Back to reference 1" class="data-footnote-backref internal alias">
                    <span class="indicator-hook"></span>
                    ↩
                  </a>
                </li>
              </ol>
            </section>
          </article>
          <div class="page-footer">
            <section data-backlinks="true" class="backlinks">
              <h2 id="backlinks-label">
                Liens retour
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#backlinks-label" class="internal">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <div class="overflow">
                <a href="../thoughts/LLMs" data-backlink="thoughts/LLMs">
                  <div class="small">
                    LLMs
                  </div>
                  <div class="description">
                    large language models, often implemented as autoregressive transformers models. GPTs and friends Most variants of LLMs are decoder-only Have “capabilities” to understand natural language.
                  </div>
                </a>
                <a href="../thoughts/Transformers" data-backlink="thoughts/Transformers">
                  <div class="small">
                    Transformers
                  </div>
                  <div class="description">
                    See also: LLMs, embedding, visualisation from Brendan Bycroft A multi-layer perceptron (MLP) architecture built on top of a multi-head attention mechanism (Vaswani et al., 2023) ...
                  </div>
                </a>
                <a href="../thoughts/large-models" data-backlink="thoughts/large-models">
                  <div class="small">
                    Foundational large models
                  </div>
                  <div class="description">
                    Popularized through LLMs, GPT-3 paper, See also: 7.1 of The Little Book of Deep Learning Though, it should be thought as Intelligence amplification rather than “artificial intelligence” ...
                  </div>
                </a>
                <a href="../thoughts/mechanistic-interpretability" data-backlink="thoughts/mechanistic-interpretability">
                  <div class="small">
                    mechanistic interpretability
                  </div>
                  <div class="description">
                    and reverse engineering neural networks.
                  </div>
                </a>
                <a href="../thoughts/state-space-models" data-backlink="thoughts/state-space-models">
                  <div class="small">
                    state-space models
                  </div>
                  <div class="description">
                    See state-space/mamba and paper Mama uses a selective SSM scan. State-space duality (SSD): SSM + attentions layers (SMA, or structured masked attention).
                  </div>
                </a>
                <a href="../thoughts/vllm" data-backlink="thoughts/vllm">
                  <div class="small">
                    vLLM
                  </div>
                  <div class="description">
                    See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ...
                  </div>
                </a>
              </div>
            </section>
            <footer class="minimal-footer">
              <ul class="icons">
                <li>
                  <a href="/" target="_self" aria-label="home">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="home" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                      <path d="M946.5 505L560.1 118.8l-25.9-25.9a31.5 31.5 0 00-44.4 0L77.5 505a63.9 63.9 0 00-18.8 46c.4 35.2 29.7 63.3 64.9 63.3h42.5V940h691.8V614.3h43.4c17.1 0 33.2-6.7 45.3-18.8a63.6 63.6 0 0018.7-45.3c0-17-6.7-33.1-18.8-45.2zM568 868H456V664h112v204zm217.9-325.7V868H632V640c0-22.1-17.9-40-40-40H432c-22.1 0-40 17.9-40 40v228H238.1V542.3h-96l370-369.7 23.1 23.1L882 542.3h-96.1z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://github.com/aarnphm" target="_blank" aria-label="github">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="var(--gray)" aria-label="true">
                      <path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0138.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/aarnphm_" target="_blank" aria-label="twitter">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="twitter" width="1em" height="1em" fill="var(--gray)" aria-hidden="true">
                      <path d="M928 254.3c-30.6 13.2-63.9 22.7-98.2 26.4a170.1 170.1 0 0075-94 336.64 336.64 0 01-108.2 41.2A170.1 170.1 0 00672 174c-94.5 0-170.5 76.6-170.5 170.6 0 13.2 1.6 26.4 4.2 39.1-141.5-7.4-267.7-75-351.6-178.5a169.32 169.32 0 00-23.2 86.1c0 59.2 30.1 111.4 76 142.1a172 172 0 01-77.1-21.7v2.1c0 82.9 58.6 151.6 136.7 167.4a180.6 180.6 0 01-44.9 5.8c-11.1 0-21.6-1.1-32.2-2.6C211 652 273.9 701.1 348.8 702.7c-58.6 45.9-132 72.9-211.7 72.9-14.3 0-27.5-.5-41.2-2.1C171.5 822 261.2 850 357.8 850 671.4 850 843 590.2 843 364.7c0-7.4 0-14.8-.5-22.2 33.2-24.3 62.3-54.4 85.5-88.2z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://bsky.app/profile/aarnphm.xyz" target="_blank" aria-label="bsky">
                    <svg viewBox="0 0 512 512" focusable="false" data-icon="bsky" width="1em" height="1em" aria-hidden="true">
                      <path d="M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2c42.1-31.6 110.3-56 110.3 21.8c0 15.5-8.9 130.5-14.1 149.2C478.2 298 412 314.6 353.1 304.5c102.9 17.5 129.1 75.5 72.5 133.5c-107.4 110.2-154.3-27.6-166.3-62.9l0 0c-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8l0 0c-12 35.3-59 173.1-166.3 62.9c-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1C10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z" fill="#1185fe"></path>
                    </svg>
                  </a>
                </li>
              </ul>
              <p class="info">
                Créé avec
                <a href="https://quartz.jzhao.xyz/" target="_blank" rel="noopener noreferrer" aria-label="Quartz links">
                  Quartz v4.4.0
                </a>
                © 2024
              </p>
            </footer>
          </div>
        </section>
        <section class="right sidebar">
          <div class="graph">
            <div id="global-graph-outer">
              <div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div>
            </div>
          </div>
          <div class="reader" id="reader-view">
            <div class="reader-backdrop"></div>
            <div class="reader-container">
              <div class="reader-header">
                <button class="reader-close" aria-label="Close reader">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="reader-content">
                <h1 class="reader-title">
                  Attention
                </h1>
                <p dir="auto">
                  <cite class id="citation--vaswani2023attentionneed--1">
                    (
                    <a href="#bib-vaswani2023attentionneed-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Vaswani et al., 2023
                    </a>
                    )
                  </cite>
                </p>
                <p dir="auto">
                  Attention operates on a sequence of query
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              Q
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            Q
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                        <span class="mord mathnormal">
                          Q
                        </span>
                      </span>
                    </span>
                  </span>
                  , key
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              K
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            K
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.6833em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                          K
                        </span>
                      </span>
                    </span>
                  </span>
                  and value
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              V
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            V
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.6833em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.22222em;">
                          V
                        </span>
                      </span>
                    </span>
                  </span>
                  vector. Attention matrix of a sequence then computed as:
                </p>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mrow>
                            <mi>
                              A
                            </mi>
                            <mo stretchy="false">
                              (
                            </mo>
                            <mi>
                              Q
                            </mi>
                            <mo separator="true">
                              ,
                            </mo>
                            <mi>
                              K
                            </mi>
                            <mo separator="true">
                              ,
                            </mo>
                            <mi>
                              V
                            </mi>
                            <mo stretchy="false">
                              )
                            </mo>
                            <mo>
                              =
                            </mo>
                            <mtext>
                              softmax
                            </mtext>
                            <mo stretchy="false">
                              (
                            </mo>
                            <mfrac>
                              <mrow>
                                <mi>
                                  Q
                                </mi>
                                <mo>
                                  ⋅
                                </mo>
                                <msup>
                                  <mi>
                                    K
                                  </mi>
                                  <mi>
                                    T
                                  </mi>
                                </msup>
                              </mrow>
                              <msqrt>
                                <mi>
                                  d
                                </mi>
                              </msqrt>
                            </mfrac>
                            <mo stretchy="false">
                              )
                            </mo>
                            <mi>
                              V
                            </mi>
                            <mtext>
                                 for
                            </mtext>
                            <msub>
                              <mi>
                                Q
                              </mi>
                              <mrow>
                                <mi>
                                  L
                                </mi>
                                <mo>
                                  ×
                                </mo>
                                <mi>
                                  d
                                </mi>
                              </mrow>
                            </msub>
                            <mo separator="true">
                              ,
                            </mo>
                            <msub>
                              <mi>
                                K
                              </mi>
                              <mrow>
                                <mi>
                                  L
                                </mi>
                                <mo>
                                  ×
                                </mo>
                                <mi>
                                  d
                                </mi>
                              </mrow>
                            </msub>
                            <mo separator="true">
                              ,
                            </mo>
                            <msub>
                              <mi>
                                V
                              </mi>
                              <mrow>
                                <mi>
                                  L
                                </mi>
                                <mo>
                                  ×
                                </mo>
                                <mi>
                                  d
                                </mi>
                              </mrow>
                            </msub>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d}
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                        <span class="mord mathnormal">
                          A
                        </span>
                        <span class="mopen">
                          (
                        </span>
                        <span class="mord mathnormal">
                          Q
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                          K
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.22222em;">
                          V
                        </span>
                        <span class="mclose">
                          )
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          =
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:2.4483em;vertical-align:-0.93em;"></span>
                        <span class="mord text">
                          <span class="mord">
                            softmax
                          </span>
                        </span>
                        <span class="mopen">
                          (
                        </span>
                        <span class="mord">
                          <span class="mopen nulldelimiter"></span>
                          <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:1.5183em;">
                                  <span style="top:-2.1778em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="mord">
                                      <span class="mord sqrt">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.9322em;">
                                              <span class="svg-align" style="top:-3em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord" style="padding-left:0.833em;">
                                                  <span class="mord mathnormal">
                                                    d
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-2.8922em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                  </svg>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.1078em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.23em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                  </span>
                                  <span style="top:-3.677em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="mord">
                                      <span class="mord mathnormal">
                                        Q
                                      </span>
                                      <span class="mspace" style="margin-right:0.2222em;"></span>
                                      <span class="mbin">
                                        ⋅
                                      </span>
                                      <span class="mspace" style="margin-right:0.2222em;"></span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                                          K
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.8413em;">
                                                <span style="top:-3.063em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                        T
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.93em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose nulldelimiter"></span>
                        </span>
                        <span class="mclose">
                          )
                        </span>
                        <span class="mord mathnormal" style="margin-right:0.22222em;">
                          V
                        </span>
                        <span class="mspace"></span>
                        <span class="mspace"></span>
                        <span class="mord text">
                          <span class="mord">
                             for
                          </span>
                        </span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            Q
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3361em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          L
                                        </span>
                                        <span class="mbin mtight">
                                          ×
                                        </span>
                                        <span class="mord mathnormal mtight">
                                          d
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2083em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal" style="margin-right:0.07153em;">
                            K
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3361em;">
                                  <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          L
                                        </span>
                                        <span class="mbin mtight">
                                          ×
                                        </span>
                                        <span class="mord mathnormal mtight">
                                          d
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2083em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal" style="margin-right:0.22222em;">
                            V
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3361em;">
                                  <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          L
                                        </span>
                                        <span class="mbin mtight">
                                          ×
                                        </span>
                                        <span class="mord mathnormal mtight">
                                          d
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2083em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <h2 id="muti-head-attention-reader" dir="auto">
                  Muti-head Attention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#muti-head-attention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  Allows the model to jointly attend to information from different representation subspaces at different positions:
                </p>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mtext>
                                      MHA
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      K
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      V
                                    </mi>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                  </mrow>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      =
                                    </mo>
                                    <mtext>
                                      concat
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <msub>
                                      <mtext>
                                        head
                                      </mtext>
                                      <mn>
                                        1
                                      </mn>
                                    </msub>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mo>
                                      ⋯
                                    </mo>
                                    <mtext></mtext>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <msub>
                                      <mtext>
                                        head
                                      </mtext>
                                      <mi>
                                        n
                                      </mi>
                                    </msub>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                    <msup>
                                      <mi>
                                        W
                                      </mi>
                                      <mi>
                                        O
                                      </mi>
                                    </msup>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow></mrow>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mtext>
                                      where
                                    </mtext>
                                    <msub>
                                      <mtext>
                                        head
                                      </mtext>
                                      <mi>
                                        i
                                      </mi>
                                    </msub>
                                    <mo>
                                      =
                                    </mo>
                                    <mtext>
                                      A
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                    <msubsup>
                                      <mi>
                                        W
                                      </mi>
                                      <mi>
                                        i
                                      </mi>
                                      <mi>
                                        O
                                      </mi>
                                    </msubsup>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      K
                                    </mi>
                                    <msubsup>
                                      <mi>
                                        W
                                      </mi>
                                      <mi>
                                        i
                                      </mi>
                                      <mi>
                                        O
                                      </mi>
                                    </msubsup>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      V
                                    </mi>
                                    <msubsup>
                                      <mi>
                                        W
                                      </mi>
                                      <mi>
                                        i
                                      </mi>
                                      <mi>
                                        O
                                      </mi>
                                    </msubsup>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <msup>
                                    <mi>
                                      W
                                    </mi>
                                    <mi>
                                      O
                                    </mi>
                                  </msup>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      ∈
                                    </mo>
                                    <msup>
                                      <mi mathvariant="double-struck">
                                        R
                                      </mi>
                                      <mrow>
                                        <mi>
                                          h
                                        </mi>
                                        <msub>
                                          <mi>
                                            d
                                          </mi>
                                          <mi>
                                            v
                                          </mi>
                                        </msub>
                                        <mo>
                                          ×
                                        </mo>
                                        <msub>
                                          <mi>
                                            d
                                          </mi>
                                          <mtext>
                                            model
                                          </mtext>
                                        </msub>
                                      </mrow>
                                    </msup>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                          </mtable>
                          <annotation encoding="application/x-tex">
                            \begin{aligned}
                            \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\
                            &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\
                            W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}}
                            \end{aligned}
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:4.6618em;vertical-align:-2.0809em;"></span>
                        <span class="mord">
                          <span class="mtable">
                            <span class="col-align-r">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5809em;">
                                    <span style="top:-4.6896em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord text">
                                          <span class="mord">
                                            MHA
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord mathnormal">
                                          Q
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                                          K
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.22222em;">
                                          V
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.1382em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord"></span>
                                    </span>
                                    <span style="top:-1.5791em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                                            W
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8913em;">
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                        O
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.0809em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="col-align-l">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5809em;">
                                    <span style="top:-4.6896em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            concat
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord">
                                          <span class="mord text">
                                            <span class="mord">
                                              head
                                            </span>
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.3011em;">
                                                  <span style="top:-2.55em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mtight">
                                                        1
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.15em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="minner">
                                          ⋯
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord">
                                          <span class="mord text">
                                            <span class="mord">
                                              head
                                            </span>
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.1514em;">
                                                  <span style="top:-2.55em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        n
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.15em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                                            W
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8913em;">
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                        O
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.1382em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            where
                                          </span>
                                        </span>
                                        <span class="mspace"></span>
                                        <span class="mord">
                                          <span class="mord text">
                                            <span class="mord">
                                              head
                                            </span>
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.3117em;">
                                                  <span style="top:-2.55em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.15em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            A
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord mathnormal">
                                          Q
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                                            W
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8913em;">
                                                  <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                        O
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.247em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                                          K
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                                            W
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8913em;">
                                                  <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                        O
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.247em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.22222em;">
                                          V
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.13889em;">
                                            W
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8913em;">
                                                  <span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                        O
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.247em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-1.5791em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ∈
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord">
                                          <span class="mord mathbb">
                                            R
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8991em;">
                                                  <span style="top:-3.113em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mtight">
                                                        <span class="mord mathnormal mtight">
                                                          h
                                                        </span>
                                                        <span class="mord mtight">
                                                          <span class="mord mathnormal mtight">
                                                            d
                                                          </span>
                                                          <span class="msupsub">
                                                            <span class="vlist-t vlist-t2">
                                                              <span class="vlist-r">
                                                                <span class="vlist" style="height:0.1645em;">
                                                                  <span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;">
                                                                    <span class="pstrut" style="height:2.5em;"></span>
                                                                    <span class="sizing reset-size3 size1 mtight">
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                                                        v
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                                <span class="vlist-s">
                                                                  ​
                                                                </span>
                                                              </span>
                                                              <span class="vlist-r">
                                                                <span class="vlist" style="height:0.143em;">
                                                                  <span></span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="mbin mtight">
                                                          ×
                                                        </span>
                                                        <span class="mord mtight">
                                                          <span class="mord mathnormal mtight">
                                                            d
                                                          </span>
                                                          <span class="msupsub">
                                                            <span class="vlist-t vlist-t2">
                                                              <span class="vlist-r">
                                                                <span class="vlist" style="height:0.3448em;">
                                                                  <span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;">
                                                                    <span class="pstrut" style="height:2.5em;"></span>
                                                                    <span class="sizing reset-size3 size1 mtight">
                                                                      <span class="mord mtight">
                                                                        <span class="mord text mtight">
                                                                          <span class="mord mtight">
                                                                            model
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                                <span class="vlist-s">
                                                                  ​
                                                                </span>
                                                              </span>
                                                              <span class="vlist-r">
                                                                <span class="vlist" style="height:0.1512em;">
                                                                  <span></span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.0809em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <h2 id="group-query-attention-reader" dir="auto">
                  Group-Query Attention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#group-query-attention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  by
                  <cite class id="citation--ainslie2023gqatraininggeneralizedmultiquery--2">
                    (
                    <a href="#bib-ainslie2023gqatraininggeneralizedmultiquery-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Ainslie et al., 2023
                    </a>
                    )
                  </cite>
                </p>
                <p dir="auto">
                  idea: reduce number of KV heads
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <msub>
                              <mi>
                                n
                              </mi>
                              <mi>
                                k
                              </mi>
                            </msub>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            n_k
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            n
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3361em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                        k
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.15em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                  to a fraction
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <msubsup>
                              <mi>
                                n
                              </mi>
                              <mi>
                                k
                              </mi>
                              <msup>
                                <mrow></mrow>
                                <mo mathvariant="normal" lspace="0em" rspace="0em">
                                  ′
                                </mo>
                              </msup>
                            </msubsup>
                            <mo>
                              =
                            </mo>
                            <mfrac>
                              <msub>
                                <mi>
                                  n
                                </mi>
                                <mi>
                                  q
                                </mi>
                              </msub>
                              <mi>
                                k
                              </mi>
                            </mfrac>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            n_k^{'} = \frac{n_q}{k}
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:1.2256em;vertical-align:-0.2831em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            n
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.9425em;">
                                  <span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                        k
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.063em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mtight">
                                          <span></span>
                                          <span class="msupsub">
                                            <span class="vlist-t">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.8278em;">
                                                  <span style="top:-2.931em;margin-right:0.0714em;">
                                                    <span class="pstrut" style="height:2.5em;"></span>
                                                    <span class="sizing reset-size3 size1 mtight">
                                                      <span class="mord mtight">
                                                        <span class="mord mtight">
                                                          ′
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2831em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          =
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:1.1537em;vertical-align:-0.345em;"></span>
                        <span class="mord">
                          <span class="mopen nulldelimiter"></span>
                          <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.8087em;">
                                  <span style="top:-2.655em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                          k
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.23em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                  </span>
                                  <span style="top:-3.5073em;">
                                    <span class="pstrut" style="height:3em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                            n
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.1645em;">
                                                  <span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;">
                                                    <span class="pstrut" style="height:2.5em;"></span>
                                                    <span class="sizing reset-size3 size1 mtight">
                                                      <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                                        q
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.2819em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.345em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose nulldelimiter"></span>
                        </span>
                      </span>
                    </span>
                  </span>
                  of number of query heads
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <msub>
                              <mi>
                                n
                              </mi>
                              <mi>
                                q
                              </mi>
                            </msub>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            n_q
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            n
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.1514em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.03588em;">
                                        q
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2861em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                  (evenly dividing the query heads into
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <msub>
                              <mi>
                                n
                              </mi>
                              <mi>
                                k
                              </mi>
                            </msub>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            n_k
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            n
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3361em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.03148em;">
                                        k
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.15em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                  groups with
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              r
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            r
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.02778em;">
                          r
                        </span>
                      </span>
                    </span>
                  </span>
                  heads)
                </p>
                <h2 id="radixattention-reader" dir="auto">
                  RadixAttention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#radixattention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  Implemented in
                  <cite class id="citation--zheng2024sglangefficientexecutionstructured--3">
                    (
                    <a href="#bib-zheng2024sglangefficientexecutionstructured-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Zheng et al., 2024
                    </a>
                    )
                  </cite>
                  where they maintain a LRU eviction policy to maintain relevant
                  <a href="../thoughts/KV-compression" class="internal" data-slug="thoughts/KV-compression" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    KV cache
                  </a>
                  for all requests within a
                  <a href="../thoughts/Radix-tree" class="internal" data-slug="thoughts/Radix-tree" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    radix tree
                  </a>
                </p>
                <p dir="auto">
                  radix tree setup:
                </p>
                <ul dir="auto">
                  <li>
                    key: sequence of tokens
                  </li>
                  <li>
                    value: KV cache tensor (stored in GPU in a paged layout)
                  </li>
                </ul>
                <p dir="auto">
                  <img src="../thoughts/images/vllm/radix-attention.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <p dir="auto">
                  <em>
                    dynamic evolution of the radix tree in response to various requests.
                  </em>
                </p>
                <blockquote class="callout" data-callout="abstract" data-callout-fold>
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        explanation of RadixAttention with LRU eviction policy
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      These requests include two chat sessions, a batch of few-shot learning inquiries, and a self-consistency sampling. Each tree edge carries a label denoting a substring or a sequence of tokens. The nodes are color-coded to reflect different states: green for newly added nodes, blue for cached nodes accessed during the time point, and red for nodes that have been evicted.
                    </p>
                    <p dir="auto">
                      <a href="https://lmsys.org/blog/2024-01-17-sglang/#backend-automatic-kv-cache-reuse-with-radixattention" class="external alias">
                        <span class="indicator-hook"></span>
                        full explanation
                      </a>
                    </p>
                  </div>
                </blockquote>
                <h3 id="cache-aware-scheduling-reader" dir="auto">
                  cache-aware scheduling
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#cache-aware-scheduling-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  We define the hit rate as
                </p>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mtext>
                                    hit rate
                                  </mtext>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      =
                                    </mo>
                                    <mfrac>
                                      <mrow>
                                        <munder>
                                          <mo>
                                            ∑
                                          </mo>
                                          <mrow>
                                            <mi>
                                              r
                                            </mi>
                                            <mo>
                                              ∈
                                            </mo>
                                            <mi>
                                              R
                                            </mi>
                                          </mrow>
                                        </munder>
                                        <mtext>
                                          number of cached prefill tokens in
                                        </mtext>
                                        <mi>
                                          r
                                        </mi>
                                      </mrow>
                                      <mrow>
                                        <munder>
                                          <mo>
                                            ∑
                                          </mo>
                                          <mrow>
                                            <mi>
                                              r
                                            </mi>
                                            <mo>
                                              ∈
                                            </mo>
                                            <mi>
                                              R
                                            </mi>
                                          </mrow>
                                        </munder>
                                        <mtext>
                                          number of prefill tokens in
                                        </mtext>
                                        <mi>
                                          r
                                        </mi>
                                      </mrow>
                                    </mfrac>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow></mrow>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      =
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                    <mo>
                                      −
                                    </mo>
                                    <mfrac>
                                      <mi>
                                        C
                                      </mi>
                                      <mrow>
                                        <munder>
                                          <mo>
                                            ∑
                                          </mo>
                                          <mrow>
                                            <mi>
                                              r
                                            </mi>
                                            <mo>
                                              ∈
                                            </mo>
                                            <mi>
                                              R
                                            </mi>
                                          </mrow>
                                        </munder>
                                        <mtext>
                                          number of prefill tokens
                                        </mtext>
                                      </mrow>
                                    </mfrac>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                          </mtable>
                          <annotation encoding="application/x-tex">
                            \begin{aligned}
                            \text{hit rate} &amp;= \frac{\sum_{r \in R} \text{number of cached prefill tokens in } r}{\sum_{r \in R} \text{number of prefill tokens in } r} \\[8pt]
                            &amp;=1 - \frac{C}{\sum_{r \in R} \text{number of prefill tokens}}
                            \end{aligned}
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:5.6005em;vertical-align:-2.5502em;"></span>
                        <span class="mord">
                          <span class="mtable">
                            <span class="col-align-r">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:3.0502em;">
                                    <span style="top:-5.0502em;">
                                      <span class="pstrut" style="height:3.4671em;"></span>
                                      <span class="mord">
                                        <span class="mord text">
                                          <span class="mord">
                                            hit rate
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-2.2299em;">
                                      <span class="pstrut" style="height:3.4671em;"></span>
                                      <span class="mord"></span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5502em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="col-align-l">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:3.0502em;">
                                    <span style="top:-5.0502em;">
                                      <span class="pstrut" style="height:3.4671em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord">
                                          <span class="mopen nulldelimiter"></span>
                                          <span class="mfrac">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:1.4671em;">
                                                  <span style="top:-2.314em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="mord">
                                                      <span class="mop">
                                                        <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                          ∑
                                                        </span>
                                                        <span class="msupsub">
                                                          <span class="vlist-t vlist-t2">
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.1786em;">
                                                                <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                                  <span class="sizing reset-size6 size3 mtight">
                                                                    <span class="mord mtight">
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                        r
                                                                      </span>
                                                                      <span class="mrel mtight">
                                                                        ∈
                                                                      </span>
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                        R
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="vlist-s">
                                                                ​
                                                              </span>
                                                            </span>
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.3271em;">
                                                                <span></span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                                      <span class="mord text">
                                                        <span class="mord">
                                                          number of prefill tokens in
                                                        </span>
                                                      </span>
                                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                        r
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.23em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                                  </span>
                                                  <span style="top:-3.7171em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="mord">
                                                      <span class="mop">
                                                        <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                          ∑
                                                        </span>
                                                        <span class="msupsub">
                                                          <span class="vlist-t vlist-t2">
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.1786em;">
                                                                <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                                  <span class="sizing reset-size6 size3 mtight">
                                                                    <span class="mord mtight">
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                        r
                                                                      </span>
                                                                      <span class="mrel mtight">
                                                                        ∈
                                                                      </span>
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                        R
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="vlist-s">
                                                                ​
                                                              </span>
                                                            </span>
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.3271em;">
                                                                <span></span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                                      <span class="mord text">
                                                        <span class="mord">
                                                          number of cached prefill tokens in
                                                        </span>
                                                      </span>
                                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                        r
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:1.0131em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mclose nulldelimiter"></span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-2.2299em;">
                                      <span class="pstrut" style="height:3.4671em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord">
                                          1
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                        <span class="mbin">
                                          −
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                        <span class="mord">
                                          <span class="mopen nulldelimiter"></span>
                                          <span class="mfrac">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:1.3603em;">
                                                  <span style="top:-2.314em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="mord">
                                                      <span class="mop">
                                                        <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                                          ∑
                                                        </span>
                                                        <span class="msupsub">
                                                          <span class="vlist-t vlist-t2">
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.1786em;">
                                                                <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                                  <span class="sizing reset-size6 size3 mtight">
                                                                    <span class="mord mtight">
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.02778em;">
                                                                        r
                                                                      </span>
                                                                      <span class="mrel mtight">
                                                                        ∈
                                                                      </span>
                                                                      <span class="mord mathnormal mtight" style="margin-right:0.00773em;">
                                                                        R
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                              <span class="vlist-s">
                                                                ​
                                                              </span>
                                                            </span>
                                                            <span class="vlist-r">
                                                              <span class="vlist" style="height:0.3271em;">
                                                                <span></span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                                      <span class="mord text">
                                                        <span class="mord">
                                                          number of prefill tokens
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span style="top:-3.23em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                                  </span>
                                                  <span style="top:-3.677em;">
                                                    <span class="pstrut" style="height:3em;"></span>
                                                    <span class="mord">
                                                      <span class="mord mathnormal" style="margin-right:0.07153em;">
                                                        C
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:1.0131em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="mclose nulldelimiter"></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5502em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <p dir="auto">
                  <em>
                    in batch settings: sort requests by matching prefix length and prioritise one with longer matched prefixes instead of FIFO schedule.
                  </em>
                </p>
                <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                  <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                    <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                      <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                    </svg>
                    <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                    </svg>
                  </button>
                  <span class="ps-mathml">
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                      <semantics>
                        <annotation encoding="application/x-tex">
                          &quot;\\begin{algorithm}\n\\caption{Cache-Aware Scheduling for RadixAttention with Continuous Batching}\n\\begin{algorithmic}\n\\State \\textbf{Input:} The radix tree $T$, the memory pool $P$, the current running batch $B$, the waiting queue $Q$.\n\\State \\textbf{Output:} Finished requests and updated system state.\n\\State // Get all requests from the waiting queue\n\\State requests $\\gets Q.\\text{get\\_all\\_requests}()$\n\\State // Search for prefix matching for all waiting request\n\\For{req $\\in$ requests}\n    \\State req.prefix\\_node, req.prefix\\_len $\\gets$ T.match\\_prefix(req.input\\_tokens)\n\\EndFor\n\\State // Sort the request according to matched prefix lengths\n\\State requests.sort()\n\\State // Select requests for the next batch\n\\State available\\_size $\\gets$ T.evictable\\_size() + P.available\\_size()\n\\State current\\_size $\\gets$ 0\n\\State new\\_batch $\\gets$ []\n\\For{req $\\in$ requests}\n    \\If{req.size() + current\\_size $\\le$ available\\_size}\n        \\State new\\_batch.append(req)\n        \\State $\\delta \\gets T.\\text{increase\\_ref\\_counter}(req.\\text{prefix\\_node})$\n        \\State available\\_size $\\gets$ available\\_size + $\\delta$\n    \\EndIf\n\\EndFor\n\\State Q.remove\\_requests(new\\_batch)\n\\State // Insert requests into the current running batch\n\\State B.merge(new\\_batch)\n\\State // Allocate new memory and do eviction if necessary\n\\State needed\\_size $\\gets$ B.needed\\_size()\n\\State success, buffer $\\gets$ P.alloc(needed\\_size)\n\\If{$\\neg \\text{success}$}\n    \\State T.evict(needed\\_size)\n    \\State success, buffer $\\gets$ P.alloc(needed\\_size)\n\\EndIf\n\\State B.run(buffer)\n\\State // Process finished requests\n\\State finished\\_requests $\\gets$ B.drop\\_finished\\_requests()\n\\For{req $\\in$ finished\\_requests}\n    \\State T.decrease\\_ref\\_counter(req.prefix\\_node)\n    \\State T.insert(req)\n\\EndFor\n\\State \\Return finished\\_requests\n\\end{algorithmic}\n\\end{algorithm}&quot;
                        </annotation>
                      </semantics>
                    </math>
                  </span>
                  <div class="ps-algorithm with-caption" dir="auto">
                    <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                      <span class="ps-keyword">
                        Algorithm 1
                      </span>
                      Cache-Aware Scheduling for RadixAttention with Continuous Batching
                    </p>
                    <div class="ps-algorithmic" dir="auto">
                      <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                        <p class="ps-line ps-code" dir="auto">
                          <span style="font-weight:bold;">
                            Input:
                          </span>
                          The radix tree
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      T
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    T
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  T
                                </span>
                              </span>
                            </span>
                          </span>
                          , the memory pool
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      P
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    P
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  P
                                </span>
                              </span>
                            </span>
                          </span>
                          , the current running batch
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      B
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    B
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.05017em;">
                                  B
                                </span>
                              </span>
                            </span>
                          </span>
                          , the waiting queue
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      Q
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    Q
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                              </span>
                            </span>
                          </span>
                          .
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          <span style="font-weight:bold;">
                            Output:
                          </span>
                          Finished requests and updated system state.
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Get all requests from the waiting queue
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          requests
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                    <mi mathvariant="normal">
                                      .
                                    </mi>
                                    <mtext>
                                      get_all_requests
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets Q.\text{get\_all\_requests}()
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                                <span class="mord">
                                  .
                                </span>
                                <span class="mord text">
                                  <span class="mord">
                                    get_all_requests
                                  </span>
                                </span>
                                <span class="mopen">
                                  (
                                </span>
                                <span class="mclose">
                                  )
                                </span>
                              </span>
                            </span>
                          </span>
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Search for prefix matching for all waiting request
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            for
                          </span>
                          req
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ∈
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \in
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                <span class="mrel">
                                  ∈
                                </span>
                              </span>
                            </span>
                          </span>
                          requests
                          <span class="ps-keyword">
                            do
                          </span>
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            req.prefix_node, req.prefix_len
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mo>
                                        ←
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \gets
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.3669em;"></span>
                                  <span class="mrel">
                                    ←
                                  </span>
                                </span>
                              </span>
                            </span>
                            T.match_prefix(req.input_tokens)
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            end for
                          </span>
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Sort the request according to matched prefix lengths
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          requests.sort()
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Select requests for the next batch
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          available_size
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          T.evictable_size() + P.available_size()
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          current_size
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          0
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          new_batch
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          []
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            for
                          </span>
                          req
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ∈
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \in
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                <span class="mrel">
                                  ∈
                                </span>
                              </span>
                            </span>
                          </span>
                          requests
                          <span class="ps-keyword">
                            do
                          </span>
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-keyword">
                              if
                            </span>
                            req.size() + current_size
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mo>
                                        ≤
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \le
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span>
                                  <span class="mrel">
                                    ≤
                                  </span>
                                </span>
                              </span>
                            </span>
                            available_size
                            <span class="ps-keyword">
                              then
                            </span>
                          </p>
                          <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                            <p class="ps-line ps-code" dir="auto">
                              new_batch.append(req)
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          δ
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mi>
                                          T
                                        </mi>
                                        <mi mathvariant="normal">
                                          .
                                        </mi>
                                        <mtext>
                                          increase_ref_counter
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          r
                                        </mi>
                                        <mi>
                                          e
                                        </mi>
                                        <mi>
                                          q
                                        </mi>
                                        <mi mathvariant="normal">
                                          .
                                        </mi>
                                        <mtext>
                                          prefix_node
                                        </mtext>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \delta \gets T.\text{increase\_ref\_counter}(req.\text{prefix\_node})
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6944em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.03785em;">
                                      δ
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.13889em;">
                                      T
                                    </span>
                                    <span class="mord">
                                      .
                                    </span>
                                    <span class="mord text">
                                      <span class="mord">
                                        increase_ref_counter
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal">
                                      re
                                    </span>
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      q
                                    </span>
                                    <span class="mord">
                                      .
                                    </span>
                                    <span class="mord text">
                                      <span class="mord">
                                        prefix_node
                                      </span>
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              available_size
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mo>
                                          ←
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \gets
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.3669em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                  </span>
                                </span>
                              </span>
                              available_size +
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          δ
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \delta
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6944em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.03785em;">
                                      δ
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                          </div>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-keyword">
                              end if
                            </span>
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            end for
                          </span>
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          Q.remove_requests(new_batch)
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Insert requests into the current running batch
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          B.merge(new_batch)
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Allocate new memory and do eviction if necessary
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          needed_size
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          B.needed_size()
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          success, buffer
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          P.alloc(needed_size)
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            if
                          </span>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi mathvariant="normal">
                                      ¬
                                    </mi>
                                    <mtext>
                                      success
                                    </mtext>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \neg \text{success}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord">
                                  ¬
                                </span>
                                <span class="mord text">
                                  <span class="mord">
                                    success
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="ps-keyword">
                            then
                          </span>
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            T.evict(needed_size)
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            success, buffer
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mo>
                                        ←
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \gets
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.3669em;"></span>
                                  <span class="mrel">
                                    ←
                                  </span>
                                </span>
                              </span>
                            </span>
                            P.alloc(needed_size)
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            end if
                          </span>
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          B.run(buffer)
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          // Process finished requests
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          finished_requests
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ←
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \gets
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.3669em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                              </span>
                            </span>
                          </span>
                          B.drop_finished_requests()
                        </p>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            for
                          </span>
                          req
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo>
                                      ∈
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \in
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                <span class="mrel">
                                  ∈
                                </span>
                              </span>
                            </span>
                          </span>
                          finished_requests
                          <span class="ps-keyword">
                            do
                          </span>
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            T.decrease_ref_counter(req.prefix_node)
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            T.insert(req)
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            end for
                          </span>
                        </p>
                        <p class="ps-line ps-code" dir="auto"></p>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-keyword">
                            return
                          </span>
                          finished_requests
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <p dir="auto">
                  We got lower bound:
                </p>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mrow>
                            <mi>
                              C
                            </mi>
                            <mo>
                              ≥
                            </mo>
                            <munder>
                              <mo>
                                ∑
                              </mo>
                              <mrow>
                                <mi>
                                  e
                                </mi>
                                <mo>
                                  ∈
                                </mo>
                                <mtext>
                                  edges
                                </mtext>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <mi>
                                  T
                                </mi>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                            </munder>
                            <mo>
                              ∣
                            </mo>
                            <mi>
                              e
                            </mi>
                            <mo>
                              ∣
                            </mo>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            C \ge \sum_{e \in \text{edges}(T)} \mid e \mid
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                          C
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          ≥
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:2.566em;vertical-align:-1.516em;"></span>
                        <span class="mop op-limits">
                          <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                              <span class="vlist" style="height:1.05em;">
                                <span style="top:-1.809em;margin-left:0em;">
                                  <span class="pstrut" style="height:3.05em;"></span>
                                  <span class="sizing reset-size6 size3 mtight">
                                    <span class="mord mtight">
                                      <span class="mord mathnormal mtight">
                                        e
                                      </span>
                                      <span class="mrel mtight">
                                        ∈
                                      </span>
                                      <span class="mord text mtight">
                                        <span class="mord mtight">
                                          edges
                                        </span>
                                      </span>
                                      <span class="mopen mtight">
                                        (
                                      </span>
                                      <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                        T
                                      </span>
                                      <span class="mclose mtight">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span style="top:-3.05em;">
                                  <span class="pstrut" style="height:3.05em;"></span>
                                  <span>
                                    <span class="mop op-symbol large-op">
                                      ∑
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="vlist-s">
                                ​
                              </span>
                            </span>
                            <span class="vlist-r">
                              <span class="vlist" style="height:1.516em;">
                                <span></span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          ∣
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          ∣
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <p dir="auto">
                  Consider we visit radix tree
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              T
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            T
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.6833em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.13889em;">
                          T
                        </span>
                      </span>
                    </span>
                  </span>
                  in DFS order. For each edge
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              e
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            e
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                      </span>
                    </span>
                  </span>
                  of
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              T
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            T
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.6833em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.13889em;">
                          T
                        </span>
                      </span>
                    </span>
                  </span>
                  , the first time we compute KV cache associated with
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              e
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            e
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                      </span>
                    </span>
                  </span>
                  , then we will compute the whole subtree of
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              e
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            e
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                      </span>
                    </span>
                  </span>
                  .
                </p>
                <p dir="auto">
                  During computation of
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              e
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            e
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                      </span>
                    </span>
                  </span>
                  subtree, then edge
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              e
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            e
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          e
                        </span>
                      </span>
                    </span>
                  </span>
                  will be continuously hit, thus no additional computation will happen.
                </p>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        cache hit
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      with cache size
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mo>
                                  ≥
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \ge
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span>
                            <span class="mrel">
                              ≥
                            </span>
                          </span>
                        </span>
                      </span>
                      maximum request length (which will equals to longest path in radix tree), edge
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  e
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                e
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal">
                              e
                            </span>
                          </span>
                        </span>
                      </span>
                      <strong>
                        WILL NOT
                      </strong>
                      be evicted during computation of its subtree
                      since the common prefix including
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  e
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                e
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal">
                              e
                            </span>
                          </span>
                        </span>
                      </span>
                      of the subtree will be continuously hit.
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  We can show that longest-shared-prefix-first order is equivalent to DFS order by induction
                  <sup>
                    <a href="#user-content-fn-proof-reader" id="user-content-fnref-proof-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      1
                    </a>
                  </sup>
                </p>
                <p dir="auto"></p>
                <h3 id="compressed-fsm-for-jump-ahead-tokens-reader" dir="auto">
                  compressed FSM for jump-ahead tokens.
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#compressed-fsm-for-jump-ahead-tokens-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  Implemented in
                  <cite class id="citation--zheng2024sglangefficientexecutionstructured--1">
                    (
                    <a href="#bib-zheng2024sglangefficientexecutionstructured-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Zheng et al., 2024
                    </a>
                    )
                  </cite>
                </p>
                <h4 id="method-1-fsm-based-decoding-reader" dir="auto">
                  Method 1:
                  <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#guided-generations-with-fsm" class="internal" data-slug="thoughts/constrained-decoding" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    FSM
                  </a>
                  -based decoding
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-1-fsm-based-decoding-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    <p dir="auto">
                      intuition: Using FSM
                      <cite class id="citation--willard2023efficientguidedgenerationlarge--2">
                        (
                        <a href="#bib-willard2023efficientguidedgenerationlarge-reader" data-no-popover="true" data-bib class="internal">
                          <span class="indicator-hook"></span>
                          Willard &amp; Louf, 2023
                        </a>
                        )
                      </cite>
                      to guide generations by increasing logit bias for tokens that conform to given JSON schema. This allows us to track the current state during decoding and filter out invalid tokens by applying logit bias to the output.
                      <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/constrained-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                    </p>
                  </li>
                  <li>
                    <p dir="auto">
                      limitation: we can see that given construction of FSM requires token-level access, it can only transition the state by only
                      <em>
                        one
                      </em>
                      token at a time, resulting in slow decoding.
                    </p>
                  </li>
                </ul>
                <h4 id="method-2-interleaved-based-reader" dir="auto">
                  Method 2: Interleaved-based
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-2-interleaved-based-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    <p dir="auto">
                      intuition: breaks down JSON schemas, each containing either a chunk prefill part or constrained decoding part. They are then executed interleaved by inference system.
                      Faster than per-token decoding given that chunked prefill components can process multiple tokens per forward pass
                    </p>
                    <p dir="auto">
                      See also
                      <a href="https://github.com/guidance-ai/guidance#guidance-acceleration" class="external">
                        <span class="indicator-hook"></span>
                        https://github.com/guidance-ai/guidance#guidance-acceleration
                      </a>
                      using llama.cpp as backend.
                    </p>
                  </li>
                  <li>
                    <p dir="auto">
                      limitation:
                    </p>
                    <ul dir="auto">
                      <li>
                        interleaved-based require custom syntax, making it less expressive compared to regex.
                      </li>
                      <li>
                        struggles to deal with tokenization boundaries due to conflicts between decode and chunked prefill segments.
                      </li>
                      <li>
                        frequent communications between interpreter and back-end adds additional overhead.
                      </li>
                    </ul>
                  </li>
                </ul>
                <h4 id="method-3-jump-forward-decoding-with-compressed-fsm-reader" dir="auto">
                  <strong>
                    <mark>
                      Method 3: Jump-Forward Decoding with compressed FSM
                    </mark>
                  </strong>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-3-jump-forward-decoding-with-compressed-fsm-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <p dir="auto">
                  <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/jump-forward-decoding-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        tokenization boundary handling
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      During decoding, it is preferred to combine multiple characters into a single tokens.
                    </p>
                    <p dir="auto">
                      For example, when decoding
                      <code>
                        &quot;Hello&quot;
                      </code>
                      in context of JSON decoding, LLM might output the following token
                      <code>
                        &quot;
                      </code>
                      ,
                      <code>
                        He
                      </code>
                      ,
                      <code>
                        llo
                      </code>
                      ,
                      <code>
                        &quot;,
                      </code>
                    </p>
                    <p dir="auto">
                      This may cause some strange behaviour if we combine the last
                      <code>
                        &quot;
                      </code>
                      with
                      <code>
                        ,
                      </code>
                      (this regex
                      <code>
                        &quot;[\w\d\s]*&quot;
                      </code>
                      with the last
                      <code>
                        ,
                      </code>
                      will lead to endless decoding because this token
                      <code>
                        &quot;,
                      </code>
                      is not valid even if the LM wants to stop.)
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  Fix:
                </p>
                <ul dir="auto">
                  <li>
                    implement
                    <mark>
                      re-tokenization
                    </mark>
                    mechanism during jump-forward phase (append string instead of the tokens, followed with re-tokenization of the entire text)
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mo>
                                →
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \to
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.3669em;"></span>
                          <span class="mrel">
                            →
                          </span>
                        </span>
                      </span>
                    </span>
                    add approximately 4% of overhead
                  </li>
                  <li>
                    use a comprehensive regex to guide the decoding phase, instead of employing multiple concatenated regex
                    <sup>
                      <a href="#user-content-fn-coalescence-reader" id="user-content-fnref-coalescence-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        2
                      </a>
                    </sup>
                  </li>
                </ul>
                <p dir="auto"></p>
                <h2 id="ringattention-reader" dir="auto">
                  RingAttention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#ringattention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  <cite class id="citation--liu2023ringattentionblockwisetransformers--4">
                    (
                    <a href="#bib-liu2023ringattentionblockwisetransformers-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Liu et al., 2023
                    </a>
                    )
                  </cite>
                </p>
                <h2 id="razorattention-reader" dir="auto">
                  RazorAttention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#razorattention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  <cite class id="citation--tang2024razorattentionefficientkvcache--5">
                    (
                    <a href="#bib-tang2024razorattentionefficientkvcache-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Tang et al., 2024
                    </a>
                    )
                  </cite>
                </p>
                <h2 id="paged-attention-reader" dir="auto">
                  Paged Attention
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#paged-attention-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  by
                  <cite class id="citation--kwon2023efficient--6">
                    (
                    <a href="#bib-kwon2023efficient-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Kwon et al., 2023
                    </a>
                    )
                  </cite>
                </p>
                <p dir="auto">
                  Used in conjunction with
                  <a href="../thoughts/Continuous-batching" class="internal" data-slug="thoughts/Continuous-batching" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    continuous batching
                  </a>
                  , implemented through
                  <a href="../thoughts/vllm" class="internal" data-slug="thoughts/vllm" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    vLLM
                  </a>
                </p>
                <p dir="auto">
                  Reduce memory usage of attention mechanism by swapping kv-cache in and out of memory. A block manager is similar to those of
                  <em>
                    virtual memory
                  </em>
                  in OS.
                </p>
                <p dir="auto">
                  Essentially, it’s a form of
                  <strong>
                    paging
                  </strong>
                  , such that attention can be stored in contiguous memory.
                  Partitions the KV cache of each sequence into KV blocks.
                </p>
                <p dir="auto">
                  Another optimization is to use
                  <a href="../thoughts/KV-compression" class="internal" data-slug="thoughts/KV-compression" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    KV compression
                  </a>
                  to reduce the size of the KV cache for longer context.
                </p>
                <p dir="auto">
                  Given:
                </p>
                <ul dir="auto">
                  <li>
                    each block contains KV vectors for fixed number of tokens, denoted as block size
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                B
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              B
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.05017em;">
                            B
                          </span>
                        </span>
                      </span>
                    </span>
                    .
                  </li>
                  <li>
                    Key block
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  K
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </msub>
                              <mo>
                                =
                              </mo>
                              <mo stretchy="false">
                                (
                              </mo>
                              <msub>
                                <mi>
                                  k
                                </mi>
                                <mrow>
                                  <mo stretchy="false">
                                    (
                                  </mo>
                                  <mi>
                                    j
                                  </mi>
                                  <mo>
                                    −
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                  <mo stretchy="false">
                                    )
                                  </mo>
                                  <mi>
                                    B
                                  </mi>
                                  <mo>
                                    +
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                </mrow>
                              </msub>
                              <mo separator="true">
                                ,
                              </mo>
                              <mo>
                                …
                              </mo>
                              <mo separator="true">
                                ,
                              </mo>
                              <msub>
                                <mi>
                                  k
                                </mi>
                                <mrow>
                                  <mi>
                                    j
                                  </mi>
                                  <mi>
                                    B
                                  </mi>
                                </mrow>
                              </msub>
                              <mo stretchy="false">
                                )
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              K_j= (k_{(j-1)B+1}, \ldots, k_{jB})
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.07153em;">
                              K
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                          <span class="mopen">
                            (
                          </span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.03148em;">
                              k
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3448em;">
                                    <span style="top:-2.5198em;margin-left:-0.0315em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mopen mtight">
                                            (
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mbin mtight">
                                            −
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                          <span class="mclose mtight">
                                            )
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                          <span class="mbin mtight">
                                            +
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3552em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="minner">
                            …
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.03148em;">
                              k
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3283em;">
                                    <span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose">
                            )
                          </span>
                        </span>
                      </span>
                    </span>
                  </li>
                  <li>
                    Value block
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <msub>
                                <mi>
                                  V
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </msub>
                              <mo>
                                =
                              </mo>
                              <mo stretchy="false">
                                (
                              </mo>
                              <msub>
                                <mi>
                                  v
                                </mi>
                                <mrow>
                                  <mo stretchy="false">
                                    (
                                  </mo>
                                  <mi>
                                    j
                                  </mi>
                                  <mo>
                                    −
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                  <mo stretchy="false">
                                    )
                                  </mo>
                                  <mi>
                                    B
                                  </mi>
                                  <mo>
                                    +
                                  </mo>
                                  <mn>
                                    1
                                  </mn>
                                </mrow>
                              </msub>
                              <mo separator="true">
                                ,
                              </mo>
                              <mo>
                                …
                              </mo>
                              <mo separator="true">
                                ,
                              </mo>
                              <msub>
                                <mi>
                                  v
                                </mi>
                                <mrow>
                                  <mi>
                                    j
                                  </mi>
                                  <mi>
                                    B
                                  </mi>
                                </mrow>
                              </msub>
                              <mo stretchy="false">
                                )
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              V_j= (v_{(j-1)B+1}, \ldots, v_{jB})
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.22222em;">
                              V
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3117em;">
                                    <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            =
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                          <span class="mopen">
                            (
                          </span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                              v
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3448em;">
                                    <span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mopen mtight">
                                            (
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mbin mtight">
                                            −
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                          <span class="mclose mtight">
                                            )
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                          <span class="mbin mtight">
                                            +
                                          </span>
                                          <span class="mord mtight">
                                            1
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3552em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="minner">
                            …
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mpunct">
                            ,
                          </span>
                          <span class="mspace" style="margin-right:0.1667em;"></span>
                          <span class="mord">
                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                              v
                            </span>
                            <span class="msupsub">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.3283em;">
                                    <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                      <span class="pstrut" style="height:2.7em;"></span>
                                      <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                          <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                            j
                                          </span>
                                          <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                            B
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:0.2861em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose">
                            )
                          </span>
                        </span>
                      </span>
                    </span>
                  </li>
                </ul>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mrow>
                            <msub>
                              <mi>
                                A
                              </mi>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </mrow>
                            </msub>
                            <mo>
                              =
                            </mo>
                            <mfrac>
                              <mrow>
                                <mi>
                                  exp
                                </mi>
                                <mo>
                                  ⁡
                                </mo>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <msubsup>
                                  <mi>
                                    q
                                  </mi>
                                  <mi>
                                    i
                                  </mi>
                                  <mi>
                                    T
                                  </mi>
                                </msubsup>
                                <msub>
                                  <mi>
                                    K
                                  </mi>
                                  <mi>
                                    j
                                  </mi>
                                </msub>
                                <mi mathvariant="normal">
                                  /
                                </mi>
                                <msqrt>
                                  <mi>
                                    d
                                  </mi>
                                </msqrt>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                              <mrow>
                                <munderover>
                                  <mo>
                                    ∑
                                  </mo>
                                  <mrow>
                                    <mi>
                                      t
                                    </mi>
                                    <mo>
                                      =
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                  </mrow>
                                  <mrow>
                                    <mi>
                                      i
                                    </mi>
                                    <mi mathvariant="normal">
                                      /
                                    </mi>
                                    <mi mathvariant="normal">
                                      /
                                    </mi>
                                    <mi>
                                      B
                                    </mi>
                                  </mrow>
                                </munderover>
                                <mi>
                                  exp
                                </mi>
                                <mo>
                                  ⁡
                                </mo>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <msubsup>
                                  <mi>
                                    q
                                  </mi>
                                  <mi>
                                    i
                                  </mi>
                                  <mi>
                                    T
                                  </mi>
                                </msubsup>
                                <msub>
                                  <mi>
                                    K
                                  </mi>
                                  <mi>
                                    t
                                  </mi>
                                </msub>
                                <mi mathvariant="normal">
                                  /
                                </mi>
                                <msqrt>
                                  <mi>
                                    d
                                  </mi>
                                </msqrt>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                            </mfrac>
                            <mo separator="true">
                              ,
                            </mo>
                            <mspace width="1em"></mspace>
                            <msub>
                              <mi>
                                o
                              </mi>
                              <mi>
                                i
                              </mi>
                            </msub>
                            <mo>
                              =
                            </mo>
                            <munderover>
                              <mo>
                                ∑
                              </mo>
                              <mrow>
                                <mi>
                                  j
                                </mi>
                                <mo>
                                  =
                                </mo>
                                <mn>
                                  1
                                </mn>
                              </mrow>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mi mathvariant="normal">
                                  /
                                </mi>
                                <mi mathvariant="normal">
                                  /
                                </mi>
                                <mi>
                                  B
                                </mi>
                              </mrow>
                            </munderover>
                            <msub>
                              <mi>
                                V
                              </mi>
                              <mi>
                                j
                              </mi>
                            </msub>
                            <msubsup>
                              <mi>
                                A
                              </mi>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </mrow>
                              <mi>
                                T
                              </mi>
                            </msubsup>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            A_{ij} = \frac{\exp(q_i^T K_j / \sqrt{d})}{\sum_{t=1}^{i//B} \exp(q_i^T K_t / \sqrt{d})}, \quad o_i = \sum_{j=1}^{i//B} V_j A_{ij}^T
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            A
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3117em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          ij
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2861em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          =
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:2.8268em;vertical-align:-1.2176em;"></span>
                        <span class="mord">
                          <span class="mopen nulldelimiter"></span>
                          <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:1.6092em;">
                                  <span style="top:-2.11em;">
                                    <span class="pstrut" style="height:3.0279em;"></span>
                                    <span class="mord">
                                      <span class="mop">
                                        <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                                          ∑
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:1.0279em;">
                                                <span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      <span class="mord mathnormal mtight">
                                                        t
                                                      </span>
                                                      <span class="mrel mtight">
                                                        =
                                                      </span>
                                                      <span class="mord mtight">
                                                        1
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.2029em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                      <span class="mord mtight">
                                                        //
                                                      </span>
                                                      <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                                        B
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2997em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mop">
                                        exp
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                                          q
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.8231em;">
                                                <span style="top:-2.4231em;margin-left:-0.0359em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight">
                                                      i
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.0448em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                      T
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2769em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                                          K
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2806em;">
                                                <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight">
                                                      t
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mord">
                                        /
                                      </span>
                                      <span class="mord sqrt">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.9322em;">
                                              <span class="svg-align" style="top:-3em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord" style="padding-left:0.833em;">
                                                  <span class="mord mathnormal">
                                                    d
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-2.8922em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                  </svg>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.1078em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.2579em;">
                                    <span class="pstrut" style="height:3.0279em;"></span>
                                    <span class="frac-line" style="border-bottom-width:0.04em;"></span>
                                  </span>
                                  <span style="top:-3.7049em;">
                                    <span class="pstrut" style="height:3.0279em;"></span>
                                    <span class="mord">
                                      <span class="mop">
                                        exp
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                                          q
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.8413em;">
                                                <span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight">
                                                      i
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.063em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                                      T
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2587em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.07153em;">
                                          K
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3117em;">
                                                <span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                                      j
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2861em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mord">
                                        /
                                      </span>
                                      <span class="mord sqrt">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.9322em;">
                                              <span class="svg-align" style="top:-3em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord" style="padding-left:0.833em;">
                                                  <span class="mord mathnormal">
                                                    d
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-2.8922em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="hide-tail" style="min-width:0.853em;height:1.08em;">
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">
                                                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                  </svg>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.1078em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:1.2176em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <span class="mclose nulldelimiter"></span>
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:1em;"></span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            o
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3117em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight">
                                        i
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.15em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          =
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:3.3748em;vertical-align:-1.4138em;"></span>
                        <span class="mop op-limits">
                          <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                              <span class="vlist" style="height:1.961em;">
                                <span style="top:-1.8723em;margin-left:0em;">
                                  <span class="pstrut" style="height:3.05em;"></span>
                                  <span class="sizing reset-size6 size3 mtight">
                                    <span class="mord mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                        j
                                      </span>
                                      <span class="mrel mtight">
                                        =
                                      </span>
                                      <span class="mord mtight">
                                        1
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span style="top:-3.05em;">
                                  <span class="pstrut" style="height:3.05em;"></span>
                                  <span>
                                    <span class="mop op-symbol large-op">
                                      ∑
                                    </span>
                                  </span>
                                </span>
                                <span style="top:-4.386em;margin-left:0em;">
                                  <span class="pstrut" style="height:3.05em;"></span>
                                  <span class="sizing reset-size6 size3 mtight">
                                    <span class="mord mtight">
                                      <span class="mord mathnormal mtight">
                                        i
                                      </span>
                                      <span class="mord mtight">
                                        //
                                      </span>
                                      <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                        B
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="vlist-s">
                                ​
                              </span>
                            </span>
                            <span class="vlist-r">
                              <span class="vlist" style="height:1.4138em;">
                                <span></span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal" style="margin-right:0.22222em;">
                            V
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3117em;">
                                  <span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                        j
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2861em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            A
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.8913em;">
                                  <span style="top:-2.453em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          ij
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span style="top:-3.113em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.13889em;">
                                        T
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3831em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <p dir="auto">
                  where
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <msub>
                              <mi>
                                A
                              </mi>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mi>
                                  j
                                </mi>
                              </mrow>
                            </msub>
                            <mo>
                              =
                            </mo>
                            <mo stretchy="false">
                              (
                            </mo>
                            <msub>
                              <mi>
                                a
                              </mi>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <mi>
                                  j
                                </mi>
                                <mo>
                                  −
                                </mo>
                                <mn>
                                  1
                                </mn>
                                <mo stretchy="false">
                                  )
                                </mo>
                                <mi>
                                  B
                                </mi>
                                <mo>
                                  +
                                </mo>
                                <mn>
                                  1
                                </mn>
                              </mrow>
                            </msub>
                            <mo separator="true">
                              ,
                            </mo>
                            <mo>
                              …
                            </mo>
                            <msub>
                              <mi>
                                a
                              </mi>
                              <mrow>
                                <mi>
                                  i
                                </mi>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mi>
                                  j
                                </mi>
                                <mi>
                                  B
                                </mi>
                              </mrow>
                            </msub>
                            <mo stretchy="false">
                              )
                            </mo>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            A_{ij}=(a_{i,(j-1)B+1}, \ldots a_{i,jB})
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            A
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3117em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          ij
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2861em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          =
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span>
                        <span class="mopen">
                          (
                        </span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            a
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3448em;">
                                  <span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          i
                                        </span>
                                        <span class="mpunct mtight">
                                          ,
                                        </span>
                                        <span class="mopen mtight">
                                          (
                                        </span>
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                        <span class="mbin mtight">
                                          −
                                        </span>
                                        <span class="mord mtight">
                                          1
                                        </span>
                                        <span class="mclose mtight">
                                          )
                                        </span>
                                        <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                          B
                                        </span>
                                        <span class="mbin mtight">
                                          +
                                        </span>
                                        <span class="mord mtight">
                                          1
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3552em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="minner">
                          …
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          <span class="mord mathnormal">
                            a
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.3283em;">
                                  <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                          i
                                        </span>
                                        <span class="mpunct mtight">
                                          ,
                                        </span>
                                        <span class="mord mathnormal mtight" style="margin-right:0.05724em;">
                                          j
                                        </span>
                                        <span class="mord mathnormal mtight" style="margin-right:0.05017em;">
                                          B
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="vlist-s">
                                  ​
                                </span>
                              </span>
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.2861em;">
                                  <span></span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        <span class="mclose">
                          )
                        </span>
                      </span>
                    </span>
                  </span>
                  is row vector of attention score on j-th KV block.
                </p>
                <section data-references class="bibliography">
                  <h2 id="reference-label-reader" dir="auto">
                    References
                    <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#reference-label-reader" class="internal">
                      <span class="indicator-hook"></span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </a>
                  </h2>
                  <ul dir="auto">
                    <li class="csl-entry" id="bib-ainslie2023gqatraininggeneralizedmultiquery-reader">
                      Ainslie, J., Lee-Thorp, J., de Jong, M., Zemlyanskiy, Y., Lebrón, F., &amp; Sanghai, S. (2023).
                      <i>
                        GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints
                      </i>
                      . arXiv preprint arXiv:2305.13245
                      <a href="https://arxiv.org/abs/2305.13245" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2305.13245" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-kwon2023efficient-reader">
                      Kwon, W., Li, Z., Zhuang, S., Sheng, Y., Zheng, L., Yu, C. H., Gonzalez, J. E., Zhang, H., &amp; Stoica, I. (2023). Efficient Memory Management for Large Language Model Serving with PagedAttention.
                      <i>
                        Proceedings of the ACM SIGOPS 29th Symposium on Operating Systems Principles
                      </i>
                      .
                    </li>
                    <li class="csl-entry" id="bib-liu2023ringattentionblockwisetransformers-reader">
                      Liu, H., Zaharia, M., &amp; Abbeel, P. (2023).
                      <i>
                        Ring Attention with Blockwise Transformers for Near-Infinite Context
                      </i>
                      . arXiv preprint arXiv:2310.01889
                      <a href="https://arxiv.org/abs/2310.01889" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2310.01889" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-tang2024razorattentionefficientkvcache-reader">
                      Tang, H., Lin, Y., Lin, J., Han, Q., Hong, S., Yao, Y., &amp; Wang, G. (2024).
                      <i>
                        RazorAttention: Efficient KV Cache Compression Through Retrieval Heads
                      </i>
                      . arXiv preprint arXiv:2407.15891
                      <a href="https://arxiv.org/abs/2407.15891" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2407.15891" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-vaswani2023attentionneed-reader">
                      Vaswani, A., Shazeer, N., Parmar, N., Uszkoreit, J., Jones, L., Gomez, A. N., Kaiser, L., &amp; Polosukhin, I. (2023).
                      <i>
                        Attention Is All You Need
                      </i>
                      . arXiv preprint arXiv:1706.03762
                      <a href="https://arxiv.org/abs/1706.03762" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="1706.03762" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-zheng2024sglangefficientexecutionstructured-reader">
                      Zheng, L., Yin, L., Xie, Z., Sun, C., Huang, J., Yu, C. H., Cao, S., Kozyrakis, C., Stoica, I., Gonzalez, J. E., Barrett, C., &amp; Sheng, Y. (2024).
                      <i>
                        SGLang: Efficient Execution of Structured Language Model Programs
                      </i>
                      . arXiv preprint arXiv:2312.07104
                      <a href="https://arxiv.org/abs/2312.07104" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2312.07104" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                  </ul>
                </section>
                <section data-footnotes class="footnotes">
                  <h2 class="sr-only" id="footnote-label-reader" dir="auto">
                    Footnotes
                    <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#footnote-label-reader" class="internal">
                      <span class="indicator-hook"></span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </a>
                  </h2>
                  <ol dir="auto">
                    <li id="user-content-fn-proof-reader">
                      <p dir="auto">
                        <em>
                          base
                        </em>
                        : a random request correspond to node
                        <span class="katex">
                          <span class="katex-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <mrow>
                                  <mi>
                                    x
                                  </mi>
                                  <mo>
                                    ∈
                                  </mo>
                                  <mi>
                                    T
                                  </mi>
                                </mrow>
                                <annotation encoding="application/x-tex">
                                  x \in T
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <span class="katex-html" aria-hidden="true">
                            <span class="base">
                              <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                              <span class="mord mathnormal">
                                x
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                              <span class="mrel">
                                ∈
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                            </span>
                            <span class="base">
                              <span class="strut" style="height:0.6833em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.13889em;">
                                T
                              </span>
                            </span>
                          </span>
                        </span>
                        will be processed.
                      </p>
                      <ul dir="auto">
                        <li>
                          All requests correspond to nodes
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo stretchy="false">
                                      {
                                    </mo>
                                    <msub>
                                      <mi>
                                        v
                                      </mi>
                                      <mn>
                                        1
                                      </mn>
                                    </msub>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mo>
                                      …
                                    </mo>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <msub>
                                      <mi>
                                        v
                                      </mi>
                                      <mi>
                                        n
                                      </mi>
                                    </msub>
                                    <mo stretchy="false">
                                      }
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \{v_{1}, \ldots, v_{n}\}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                <span class="mopen">
                                  {
                                </span>
                                <span class="mord">
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                  <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.3011em;">
                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                            <span class="pstrut" style="height:2.7em;"></span>
                                            <span class="sizing reset-size6 size3 mtight">
                                              <span class="mord mtight">
                                                <span class="mord mtight">
                                                  1
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.15em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="minner">
                                  …
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                  <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.1514em;">
                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                            <span class="pstrut" style="height:2.7em;"></span>
                                            <span class="sizing reset-size6 size3 mtight">
                                              <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                  n
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.15em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mclose">
                                  }
                                </span>
                              </span>
                            </span>
                          </span>
                          on path
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      x
                                    </mi>
                                    <mo>
                                      ←
                                    </mo>
                                    <mtext>
                                      root
                                    </mtext>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    x \gets \text{root}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal">
                                  x
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ←
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.6151em;"></span>
                                <span class="mord text">
                                  <span class="mord">
                                    root
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          doesn’t need recomputation.
                        </li>
                        <li>
                          Thus, computation complexity for requests of nodes
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo stretchy="false">
                                      {
                                    </mo>
                                    <msub>
                                      <mi>
                                        v
                                      </mi>
                                      <mn>
                                        1
                                      </mn>
                                    </msub>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mo>
                                      …
                                    </mo>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <msub>
                                      <mi>
                                        v
                                      </mi>
                                      <mi>
                                        n
                                      </mi>
                                    </msub>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      x
                                    </mi>
                                    <mo stretchy="false">
                                      }
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \{v_{1}, \ldots, v_{n}, x\}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                <span class="mopen">
                                  {
                                </span>
                                <span class="mord">
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                  <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.3011em;">
                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                            <span class="pstrut" style="height:2.7em;"></span>
                                            <span class="sizing reset-size6 size3 mtight">
                                              <span class="mord mtight">
                                                <span class="mord mtight">
                                                  1
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.15em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="minner">
                                  …
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                  <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.1514em;">
                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                            <span class="pstrut" style="height:2.7em;"></span>
                                            <span class="sizing reset-size6 size3 mtight">
                                              <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                  n
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.15em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord mathnormal">
                                  x
                                </span>
                                <span class="mclose">
                                  }
                                </span>
                              </span>
                            </span>
                          </span>
                          is aligned with DFS
                        </li>
                      </ul>
                      <p dir="auto">
                        <em>
                          induction
                        </em>
                        : assume we visit node
                        <span class="katex">
                          <span class="katex-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <mrow>
                                  <mi>
                                    y
                                  </mi>
                                  <mo>
                                    ∈
                                  </mo>
                                  <mi>
                                    T
                                  </mi>
                                </mrow>
                                <annotation encoding="application/x-tex">
                                  y \in T
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <span class="katex-html" aria-hidden="true">
                            <span class="base">
                              <span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                y
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                              <span class="mrel">
                                ∈
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                            </span>
                            <span class="base">
                              <span class="strut" style="height:0.6833em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.13889em;">
                                T
                              </span>
                            </span>
                          </span>
                        </span>
                        , and the visited node align with DFS order. Let
                        <span class="katex">
                          <span class="katex-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <mrow>
                                  <mi>
                                    P
                                  </mi>
                                </mrow>
                                <annotation encoding="application/x-tex">
                                  P
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <span class="katex-html" aria-hidden="true">
                            <span class="base">
                              <span class="strut" style="height:0.6833em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.13889em;">
                                P
                              </span>
                            </span>
                          </span>
                        </span>
                        denote
                        <em>
                          path of
                        </em>
                        <span class="katex">
                          <span class="katex-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <mrow>
                                  <mi>
                                    y
                                  </mi>
                                  <mo>
                                    ←
                                  </mo>
                                  <mtext>
                                    root
                                  </mtext>
                                </mrow>
                                <annotation encoding="application/x-tex">
                                  y \gets \text{root}
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <span class="katex-html" aria-hidden="true">
                            <span class="base">
                              <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                y
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                              <span class="mrel">
                                ←
                              </span>
                              <span class="mspace" style="margin-right:0.2778em;"></span>
                            </span>
                            <span class="base">
                              <span class="strut" style="height:0.6151em;"></span>
                              <span class="mord text">
                                <span class="mord">
                                  root
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                        .
                      </p>
                      <ul dir="auto">
                        <li>
                          Each node that has not been visited has the lowest common ancestor with visited nodes on
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      P
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    P
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  P
                                </span>
                              </span>
                            </span>
                          </span>
                          .
                        </li>
                        <li>
                          Since nodes on
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      P
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    P
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  P
                                </span>
                              </span>
                            </span>
                          </span>
                          are cached, a node
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      z
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    z
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.04398em;">
                                  z
                                </span>
                              </span>
                            </span>
                          </span>
                          that has yet to be visited with lowest common accestor on
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      P
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    P
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  P
                                </span>
                              </span>
                            </span>
                          </span>
                          will have the
                          <em>
                            longest shared prefix
                          </em>
                        </li>
                        <li>
                          longest-shared-prefix-first order will select
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      z
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    z
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.4306em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.04398em;">
                                  z
                                </span>
                              </span>
                            </span>
                          </span>
                          , which is a valid DFS
                          q.e.d
                        </li>
                      </ul>
                      <a href="#user-content-fnref-proof-reader" data-footnote-backref aria-label="Back to reference 1" class="internal" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        ↩
                      </a>
                    </li>
                  </ol>
                </section>
              </div>
            </div>
          </div>
          <div class="image-popup-modal" id="image-popup-modal">
            <div class="image-popup-backdrop"></div>
            <div class="image-popup-content">
              <button class="image-popup-close" aria-label="Close popup">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
              <img class="image-popup-img" src alt/>
            </div>
          </div>
          <div id="mermaid-container">
            <div class="mermaid-backdrop"></div>
            <div id="mermaid-space">
              <div class="mermaid-header">
                <button class="close-button" aria-label="close button">
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="mermaid-content"></div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </body>
  <script type="application/javascript">
    function i(){let l=this.parentElement;l.classList.toggle("is-collapsed");let e=l.classList.contains("is-collapsed")?this.scrollHeight:l.scrollHeight;l.style.maxHeight=e+"px";let s=l,t=l.parentElement;for(;t;){if(!t.classList.contains("callout"))return;let a=t.classList.contains("is-collapsed")?t.scrollHeight:t.scrollHeight+s.scrollHeight;t.style.maxHeight=a+"px",s=t,t=t.parentElement}}function r(l){let o=l.getBoundingClientRect(),e=1056,s=o.height;return o.top%e+s>e}function c(){let l=document.getElementsByClassName("callout is-collapsible");for(let e of l){let s=e.firstElementChild;if(s){s.addEventListener("click",i),window.addCleanup(()=>s.removeEventListener("click",i));let n=e.classList.contains("is-collapsed")?s.scrollHeight:e.scrollHeight;e.style.maxHeight=n+"px"}}let o=document.getElementsByClassName("callout");for(let e of o)r(e)&&(e.style.pageBreakBefore="always",e.classList.add("force-page-break"))}document.addEventListener("nav",c);window.addEventListener("resize",c);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script>
  <script src="../postscript.js" type="module"></script>
</html>