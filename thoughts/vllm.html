<!DOCTYPE html>
<!--
/*************************************************************************
* Bop got your nose !!!
*
* Hehe
*
* Anw if you see a component you like ping @aarnphm on Discord I can try
* to send it your way. Have a wonderful day!
**************************************************************************/
-->
<html lang="fr">
  <head>
    <title>
      vLLM - Aaron's notes
    </title>
    <meta charset="utf-8"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains Mono&amp;family=Newsreader:wght@400;700&amp;family=Newsreader:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="true"/>
    <link rel="preconnect" href="https://plausible.io" crossorigin="true"/>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="og:site_name" content="Aaron's notes"/>
    <meta property="og:locale" content="fr-FR"/>
    <meta property="og:title" content="vLLM - Aaron's notes"/>
    <meta property="og:type" content="website"/>
    <meta name="twitter:site" content="@aarnphm_"/>
    <meta name="twitter:creator" content="@aarnphm_"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="vLLM - Aaron's notes"/>
    <meta name="twitter:description" content="See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ..."/>
    <meta property="og:description" content="See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ..."/>
    <meta property="og:image:type" content="image/webp"/>
    <meta property="og:image:alt" content="See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ..."/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <meta property="og:width" content="1200"/>
    <meta property="og:height" content="630"/>
    <meta property="og:image" content="https://aarnphm.xyz/static/social-images/thoughts-vllm.webp"/>
    <meta property="og:url" content="https:/aarnphm.xyz/thoughts/vllm"/>
    <meta property="og:image" content="https://aarnphm.xyz/static/social-images/thoughts-vllm.webp"/>
    <meta name="twitter:image" content="https://aarnphm.xyz/static/social-images/thoughts-vllm.webp"/>
    <meta property="twitter:domain" content="https://aarnphm.xyz/"/>
    <meta property="twitter:url" content="https:/aarnphm.xyz/thoughts/vllm"/>
    <link rel="icon" href="../static/icon.webp"/>
    <link rel="canonical" href="https:/aarnphm.xyz/thoughts/vllm"/>
    <meta name="description" content="See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ..."/>
    <meta name="generator" content="Quartz"/>
    <link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/>
    <style>
      .collapsible-header {
      position: relative;
      margin-left: -9px;
      }
      .collapsible-header:first-child {
      margin-top: 1rem;
      }
      .collapsible-header:last-child {
      margin-bottom: 1rem;
      }
      .collapsible-header[data-level=&quot;2&quot;] {
      margin-left: 1rem;
      }
      .collapsible-header[data-level=&quot;3&quot;] {
      margin-left: 1.5rem;
      }
      .collapsible-header[data-level=&quot;4&quot;] {
      margin-left: 1.9rem;
      }
      .collapsible-header[data-level=&quot;5&quot;] {
      margin-left: 2.2rem;
      }
      .collapsible-header[data-level=&quot;6&quot;] {
      margin-left: 2.4rem;
      }
      .collapsible-header .collapsed-dots {
      display: none;
      }
      .collapsible-header.collapsed {
      margin-bottom: 1rem;
      }
      .collapsible-header.collapsed .collapsed-dots {
      display: block;
      }
      .collapsible-header .header-controls {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      }
      .collapsible-header .header-controls .toggle-button {
      grid-column: 1;
      }
      .collapsible-header .toggle-button {
      background-color: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      padding: 0;
      color: var(--dark);
      display: inline-flex;
      align-items: center;
      }
      .collapsible-header .toggle-button:hover .circle-icon {
      display: none;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=true] .collapse-icon {
      display: block;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=true] .expand-icon {
      display: none;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=false] .expand-icon {
      display: block;
      }
      .collapsible-header .toggle-button:hover[aria-expanded=false] .collapse-icon {
      display: none;
      }
      .collapsible-header .toggle-icons {
      display: grid;
      grid-template-columns: 1fr;
      }
      .collapsible-header .toggle-icons .circle-icon,
      .collapsible-header .toggle-icons .expand-icon,
      .collapsible-header .toggle-icons .collapse-icon {
      opacity: 0.85;
      grid-column: 1;
      grid-row: 1;
      }
      .collapsible-header .toggle-icons .circle-icon {
      display: block;
      }
      .collapsible-header .toggle-icons .expand-icon,
      .collapsible-header .toggle-icons .collapse-icon {
      display: none;
      }
      .collapsible-header.collapsed :where(h1, h2, h3, h4, h5, h6):not(.popover *) {
      display: inline-flex;
      align-items: center;
      }
      .collapsible-header :where(h1, h2, h3, h4, h5, h6):not(.popover *) {
      margin: 0;
      }
      .collapsible-header .collapsible-header-content-outer {
      padding-left: 9px;
      padding-bottom: 9px;
      }
      .collapsible-header .collapsible-header-content-outer .collapsible-header-content {
      border-left: 1px solid var(--lightgray);
      overflow: hidden;
      padding-left: 9px;
      max-height: none;
      }
      .collapsible-header .collapsible-header-content-outer .collapsible-header-content.collapsed {
      max-height: 0 !important;
      padding-top: 0;
      padding-bottom: 0;
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/node-tikzjax@latest/css/fonts.css" rel="stylesheet" type="text/css" spa-preserve/>
    <link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/>
    <script src="../prescript.js" type="application/javascript" spa-preserve></script>
    <script type="application/javascript" spa-preserve>
      const fetchData = fetch("../static/contentIndex.json").then(data => data.json())
    </script>
    <script type="application/javascript" spa-preserve>
      var T=Object.create;var g=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var q=(e,u)=>()=>(u||e((u={exports:{}}).exports,u),u.exports);var P=(e,u,t,F)=>{if(u&&typeof u=="object"||typeof u=="function")for(let o of j(u))!O.call(e,o)&&o!==t&&g(e,o,{get:()=>u[o],enumerable:!(F=R(u,o))||F.enumerable});return e};var U=(e,u,t)=>(t=e!=null?T(k(e)):{},P(u||!e||!e.__esModule?g(t,"default",{value:e,enumerable:!0}):t,e));var m=q((X,p)=>{"use strict";p.exports=W;function A(e){return e instanceof Buffer?Buffer.from(e):new e.constructor(e.buffer.slice(),e.byteOffset,e.length)}function W(e){if(e=e||{},e.circles)return $(e);let u=new Map;if(u.set(Date,D=>new Date(D)),u.set(Map,(D,i)=>new Map(F(Array.from(D),i))),u.set(Set,(D,i)=>new Set(F(Array.from(D),i))),e.constructorHandlers)for(let D of e.constructorHandlers)u.set(D[0],D[1]);let t=null;return e.proto?l:o;function F(D,i){let n=Object.keys(D),r=new Array(n.length);for(let c=0;c<n.length;c++){let s=n[c],a=D[s];typeof a!="object"||a===null?r[s]=a:a.constructor!==Object&&(t=u.get(a.constructor))?r[s]=t(a,i):ArrayBuffer.isView(a)?r[s]=A(a):r[s]=i(a)}return r}function o(D){if(typeof D!="object"||D===null)return D;if(Array.isArray(D))return F(D,o);if(D.constructor!==Object&&(t=u.get(D.constructor)))return t(D,o);let i={};for(let n in D){if(Object.hasOwnProperty.call(D,n)===!1)continue;let r=D[n];typeof r!="object"||r===null?i[n]=r:r.constructor!==Object&&(t=u.get(r.constructor))?i[n]=t(r,o):ArrayBuffer.isView(r)?i[n]=A(r):i[n]=o(r)}return i}function l(D){if(typeof D!="object"||D===null)return D;if(Array.isArray(D))return F(D,l);if(D.constructor!==Object&&(t=u.get(D.constructor)))return t(D,l);let i={};for(let n in D){let r=D[n];typeof r!="object"||r===null?i[n]=r:r.constructor!==Object&&(t=u.get(r.constructor))?i[n]=t(r,l):ArrayBuffer.isView(r)?i[n]=A(r):i[n]=l(r)}return i}}function $(e){let u=[],t=[],F=new Map;if(F.set(Date,n=>new Date(n)),F.set(Map,(n,r)=>new Map(l(Array.from(n),r))),F.set(Set,(n,r)=>new Set(l(Array.from(n),r))),e.constructorHandlers)for(let n of e.constructorHandlers)F.set(n[0],n[1]);let o=null;return e.proto?i:D;function l(n,r){let c=Object.keys(n),s=new Array(c.length);for(let a=0;a<c.length;a++){let C=c[a],E=n[C];if(typeof E!="object"||E===null)s[C]=E;else if(E.constructor!==Object&&(o=F.get(E.constructor)))s[C]=o(E,r);else if(ArrayBuffer.isView(E))s[C]=A(E);else{let B=u.indexOf(E);B!==-1?s[C]=t[B]:s[C]=r(E)}}return s}function D(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return l(n,D);if(n.constructor!==Object&&(o=F.get(n.constructor)))return o(n,D);let r={};u.push(n),t.push(r);for(let c in n){if(Object.hasOwnProperty.call(n,c)===!1)continue;let s=n[c];if(typeof s!="object"||s===null)r[c]=s;else if(s.constructor!==Object&&(o=F.get(s.constructor)))r[c]=o(s,D);else if(ArrayBuffer.isView(s))r[c]=A(s);else{let a=u.indexOf(s);a!==-1?r[c]=t[a]:r[c]=D(s)}}return u.pop(),t.pop(),r}function i(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return l(n,i);if(n.constructor!==Object&&(o=F.get(n.constructor)))return o(n,i);let r={};u.push(n),t.push(r);for(let c in n){let s=n[c];if(typeof s!="object"||s===null)r[c]=s;else if(s.constructor!==Object&&(o=F.get(s.constructor)))r[c]=o(s,i);else if(ArrayBuffer.isView(s))r[c]=A(s);else{let a=u.indexOf(s);a!==-1?r[c]=t[a]:r[c]=i(s)}}return u.pop(),t.pop(),r}}});var J=Object.hasOwnProperty;var h=U(m(),1),eu=(0,h.default)();function y(e){return e.document.body.dataset.slug}function I(e,u=100){let t=e.getBoundingClientRect();return t.top>=-u&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)+u}function _(e,u){let t=e.getBoundingClientRect(),F=u.getBoundingClientRect(),o=e.parentElement?.getBoundingClientRect()||t;return F.top-o.top}function V(e,u){let t=e.getBoundingClientRect(),F=u.getBoundingClientRect();return{min:0,max:t.height-F.height}}function L(e,u,t){let F=_(u,e),o=V(t,u);F=Math.max(F,Math.min(o.min,o.max)),u.style.top=`${F}px`}function f(e,u){let t=e.querySelectorAll("a[data-footnote-ref]"),F=document.querySelector(".sidenotes");if(F)for(let o of t){let l=o.getAttribute("href")?.replace("#","sidebar-"),D=F.querySelector(`.sidenote-element[id="${l}"]`);D&&(u?(D.classList.remove("in-view"),o.classList.remove("active"),D.classList.add("collapsed")):I(o)?(D.classList.add("in-view"),o.classList.add("active"),D.classList.remove("collapsed"),L(o,D,F)):D.classList.remove("collapsed"))}}var S=(e,u)=>`${y(e)}-${u}`;function x(e,u){return localStorage.getItem(S(e,u))}function v(e,u,t){localStorage.setItem(S(e,u),t)}function b(e,u,t,F){e.setAttribute("aria-expanded",F?"false":"true"),u.style.maxHeight=F?"0px":"inherit",e.classList.toggle("collapsed",F),u.classList.toggle("collapsed",F),t.classList.toggle("collapsed",F),f(u,F)}function d(){let e=document.querySelector(".center"),u=document.querySelector(".sidenotes");if(!e||!u)return;let t=0,F=e.children;Array.from(F).forEach(l=>{let D=l.getBoundingClientRect();t+=D.height});let o=window.getComputedStyle(e);t+=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom)+parseFloat(o.marginTop)+parseFloat(o.marginBottom),e.style.minHeight=`${t}px`,u.style.height=`${t}px`,u.offsetHeight,requestAnimationFrame(()=>{let l=u.querySelectorAll(".sidenote-element"),D=Array.from(l).filter(i=>i.classList.contains("in-view"));for(let i of D){let n=i.id.replace("sidebar-",""),r=e.querySelector(`a[href="#${n}"]`);r&&L(r,i,u)}})}function H(e,u){let t;return(...F)=>{clearTimeout(t),t=setTimeout(()=>e(...F),u)}}var z=H(d,150);function M(e){let u=e.target;if(!u)return;let t=u.closest(".toggle-button");if(!t||u.parentElement.classList.contains("callout"))return;let F=t.id.replace("collapsible-header-","").replace("-toggle",""),o=document.querySelector(`section.collapsible-header[id="${F}"]`);if(!o)return;e.stopPropagation();let l=document.querySelector(`.collapsible-header-content[data-references="${t.id}"]`);if(!l)return;let D=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",D?"false":"true"),l.style.maxHeight=D?"0px":"inherit",l.classList.toggle("collapsed",D),o.classList.toggle("collapsed",D),t.classList.toggle("collapsed",D),f(l,D),v(window,t.id,D?"false":"true"),requestAnimationFrame(()=>{d(),z()})}function w(){let e=document.querySelectorAll(".collapsible-header");for(let t of e){let F=t.querySelector("button.toggle-button");if(F){F.addEventListener("click",M),window.addCleanup(()=>F.removeEventListener("click",M));let o=document.querySelector(`.collapsible-header-content[data-references="${F.id}"]`);if(o){let l=x(window,F.id);l&&b(F,o,t,l==="false")}}}let u=document.querySelectorAll("svg.blockquote-link");for(let t of u){let l=function(){window.spaNavigate(new URL(o,window.location.toString()))},o=t.parentElement.dataset.href;t.addEventListener("click",l),window.addCleanup(()=>t.removeEventListener("click",l))}}document.addEventListener("nav",w);window.addEventListener("resize",w);
    </script>
  </head>
  <body data-slug="thoughts/vllm" data-language="fr" data-menu="false" data-poem="false">
    <main id="quartz-root" class="page">
      <section id="quartz-body">
        <aside class="left sidebar">
          <div class="toc desktop-only" id="toc" data-layout="minimal">
            <nav id="toc-vertical">
              <button class="depth-0 toc-item" data-depth="0" data-href="#kv-compress" data-for="kv-compress" style="--animation-order:1;" aria-label="KV-Compress">
                <div class="fill"></div>
                <div class="indicator">
                  KV-Compress
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#idea" data-for="idea" style="--animation-order:2;" aria-label="idea.">
                <div class="fill"></div>
                <div class="indicator">
                  idea.
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#query-group-compression-qgc" data-for="query-group-compression-qgc" style="--animation-order:3;" aria-label="Query-Group Compression (QGC)">
                <div class="fill"></div>
                <div class="indicator">
                  Query-Group Compression (QGC)
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#block-layout-and-allocation" data-for="block-layout-and-allocation" style="--animation-order:4;" aria-label="Block layout and allocation">
                <div class="fill"></div>
                <div class="indicator">
                  Block layout and allocation
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#evict-from-paged-kv-cache" data-for="evict-from-paged-kv-cache" style="--animation-order:5;" aria-label="Evict from Paged KV cache">
                <div class="fill"></div>
                <div class="indicator">
                  Evict from Paged KV cache
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#automatic-prefix-caching" data-for="automatic-prefix-caching" style="--animation-order:6;" aria-label="automatic prefix caching">
                <div class="fill"></div>
                <div class="indicator">
                  automatic prefix caching
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#block-manager-and-evictor" data-for="block-manager-and-evictor" style="--animation-order:7;" aria-label="block manager and evictor">
                <div class="fill"></div>
                <div class="indicator">
                  block manager and evictor
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#speculative-decoding" data-for="speculative-decoding" style="--animation-order:8;" aria-label="speculative decoding">
                <div class="fill"></div>
                <div class="indicator">
                  speculative decoding
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#continuous-batching" data-for="continuous-batching" style="--animation-order:9;" aria-label="continuous batching">
                <div class="fill"></div>
                <div class="indicator">
                  continuous batching
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#guided-decoding" data-for="guided-decoding" style="--animation-order:10;" aria-label="guided decoding">
                <div class="fill"></div>
                <div class="indicator">
                  guided decoding
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#waterfall" data-for="waterfall" style="--animation-order:11;" aria-label="waterfall">
                <div class="fill"></div>
                <div class="indicator">
                  waterfall
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#proposal" data-for="proposal" style="--animation-order:12;" aria-label="proposal">
                <div class="fill"></div>
                <div class="indicator">
                  proposal
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#background" data-for="background" style="--animation-order:13;" aria-label="background">
                <div class="fill"></div>
                <div class="indicator">
                  background
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#plan" data-for="plan" style="--animation-order:14;" aria-label="plan">
                <div class="fill"></div>
                <div class="indicator">
                  plan
                </div>
              </button>
              <button class="depth-0 toc-item" data-depth="0" data-href="#appendix" data-for="appendix" style="--animation-order:15;" aria-label="appendix.">
                <div class="fill"></div>
                <div class="indicator">
                  appendix.
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#batched-constrained-decoding-for-cfg-and-pda" data-for="batched-constrained-decoding-for-cfg-and-pda" style="--animation-order:16;" aria-label="batched constrained decoding for CFG and PDA">
                <div class="fill"></div>
                <div class="indicator">
                  batched constrained decoding for CFG and PDA
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#questions" data-for="questions" style="--animation-order:17;" aria-label="questions">
                <div class="fill"></div>
                <div class="indicator">
                  questions
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#future-plans" data-for="future-plans" style="--animation-order:18;" aria-label="future plans">
                <div class="fill"></div>
                <div class="indicator">
                  future plans
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#compressed-fsm-for-jump-ahead-tokens" data-for="compressed-fsm-for-jump-ahead-tokens" style="--animation-order:19;" aria-label="compressed FSM for jump-ahead tokens.">
                <div class="fill"></div>
                <div class="indicator">
                  compressed FSM for jump-ahead tokens.
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-1-fsm-based-decoding" data-for="method-1-fsm-based-decoding" style="--animation-order:20;" aria-label="Method 1: FSM-based decoding">
                <div class="fill"></div>
                <div class="indicator">
                  Method 1: FSM-based decoding
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-2-interleaved-based" data-for="method-2-interleaved-based" style="--animation-order:21;" aria-label="Method 2: Interleaved-based">
                <div class="fill"></div>
                <div class="indicator">
                  Method 2: Interleaved-based
                </div>
              </button>
              <button class="depth-2 toc-item" data-depth="2" data-href="#method-3-jump-forward-decoding-with-compressed-fsm" data-for="method-3-jump-forward-decoding-with-compressed-fsm" style="--animation-order:22;" aria-label="&lt;mark>Method 3: Jump-Forward Decoding with compressed FSM&lt;/mark>">
                <div class="fill"></div>
                <div class="indicator">
                  <mark>
                    Method 3: Jump-Forward Decoding with compressed FSM
                  </mark>
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#coalescence" data-for="coalescence" style="--animation-order:23;" aria-label="Coalescence">
                <div class="fill"></div>
                <div class="indicator">
                  Coalescence
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#guided-generations-with-fsm" data-for="guided-generations-with-fsm" style="--animation-order:24;" aria-label="Guided generations with FSM.">
                <div class="fill"></div>
                <div class="indicator">
                  Guided generations with FSM.
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#reference-label" data-for="reference-label" style="--animation-order:25;" aria-label="References">
                <div class="fill"></div>
                <div class="indicator">
                  References
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#footnote-label" data-for="footnote-label" style="--animation-order:26;" aria-label="Footnotes">
                <div class="fill"></div>
                <div class="indicator">
                  Footnotes
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#backlinks-label" data-for="backlinks-label" style="--animation-order:27;" aria-label="Liens retour">
                <div class="fill"></div>
                <div class="indicator">
                  Liens retour
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#reference-label" data-for="reference-label" style="--animation-order:28;" aria-label="References">
                <div class="fill"></div>
                <div class="indicator">
                  References
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#footnote-label" data-for="footnote-label" style="--animation-order:29;" aria-label="Footnotes">
                <div class="fill"></div>
                <div class="indicator">
                  Footnotes
                </div>
              </button>
              <button class="depth-1 toc-item" data-depth="1" data-href="#backlinks-label" data-for="backlinks-label" style="--animation-order:30;" aria-label="Liens retour">
                <div class="fill"></div>
                <div class="indicator">
                  Liens retour
                </div>
              </button>
            </nav>
          </div>
          <div class="toolbar">
            <div class="toolbar-content">
              <button class="toolbar-item pen-button" aria-label="Toggle toolbar" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="var(--darkgray)" viewBox="0 0 256 256" class="pen-icon">
                  <path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="reader-button" aria-label="Toggle reader mode" data-active="false">
                <span class="tooltip">
                  Reader mode
                </span>
                <svg class="reader-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="pdf-button" aria-label="Export to PDF">
                <span class="tooltip">
                  Export PDF
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
              </button>
              <button class="toolbar-item " id="graph-button" aria-label="Toggle global graph">
                <span class="tooltip">
                  Global graph
                </span>
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve">
                  <path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path>
                </svg>
              </button>
              <button class="toolbar-item " id="skew-button" aria-label="add a tiny bit of skew, cuz why not">
                <span class="tooltip">
                  Skew page
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 4l18 16"></path>
                  <path d="M21 4H3"></path>
                  <path d="M21 20H3"></path>
                </svg>
              </button>
            </div>
          </div>
        </aside>
        <section class="center">
          <div class="page-header">
            <header>
              <nav class="breadcrumb-container" aria-label="breadcrumbs">
                <div class="breadcrumb-element">
                  <a href="../">
                    ~
                  </a>
                  <p>
                    /
                  </p>
                </div>
                <div class="breadcrumb-element">
                  <a href="../thoughts/">
                    t
                  </a>
                  <p>
                    /
                  </p>
                </div>
                <div class="breadcrumb-element">
                  <a href>
                    vLLM
                  </a>
                </div>
              </nav>
              <div class="keybind" lang="fr">
                <kbd id="shortcut-key" data-mapping="[&quot;cmd--'&quot;,&quot;ctrl--'&quot;]">
                  ⌘ '
                </kbd>
                <div id="shortcut-container">
                  <div id="shortcut-space">
                    <div id="title">
                      raccourcis clavier
                    </div>
                    <ul id="shortcut-list">
                      <li>
                        <div id="shortcuts" data-key="⌘--/" data-value="recherche"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--\" data-value="page d'accueil"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--j" data-value="curius"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--b" data-value="lecteur"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--g" data-value="graphique"></div>
                      </li>
                      <li>
                        <div id="shortcuts" data-key="⌘--u" data-value="fausser"></div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="search">
                <button class="search-button" id="search-button">
                  <svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7">
                    <title>
                      Search
                    </title>
                    <g class="search-path" fill="none">
                      <path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path>
                      <circle cx="8" cy="8" r="7"></circle>
                    </g>
                  </svg>
                </button>
                <div id="search-container">
                  <div id="search-space">
                    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Rechercher quelque chose" placeholder="Rechercher quelque chose"/>
                    <div id="search-layout" data-preview="true"></div>
                  </div>
                </div>
              </div>
            </header>
            <div class="popover-hint">
              <hgroup>
                <h1 class="article-title">
                  vLLM
                </h1>
                <p class="description">
                  See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ...
                </p>
              </hgroup>
              <ul class="content-meta">
                <li>
                  <span class="page-creation" title="Date de création du contenu de la page">
                    <em>
                      08 sept. 2024
                    </em>
                  </span>
                </li>
                <li>
                  <a href="../thoughts/vllm.html.md" target="_blank" rel="noopener noreferrer" class="llm-source" style="color: inherit;font-weight: inherit;text-decoration: underline">
                    <span title="voir https://github.com/AnswerDotAI/llms-txt">
                      llms.txt
                    </span>
                  </a>
                </li>
              </ul>
              <ul class="tags">
                <li>
                  <a href="../tags/ml" class="internal tag-link">
                    ml
                  </a>
                </li>
                <li>
                  <a href="../tags/serving" class="internal tag-link">
                    serving
                  </a>
                </li>
              </ul>
              <div class="spacer"></div>
            </div>
          </div>
          <article class="popover-hint">
            <p dir="auto">
              See also
              <a href="../thoughts/Attention#paged-attention" class="internal alias" data-slug="thoughts/Attention">
                <span class="indicator-hook"></span>
                Paged Attention
              </a>
              <cite class id="citation--kwon2023efficient--1">
                (
                <a href="#bib-kwon2023efficient" data-no-popover data-bib class="internal alias">
                  <span class="indicator-hook"></span>
                  Kwon et al., 2023
                </a>
                )
              </cite>
            </p>
            <section class="collapsible-header" id="kv-compress" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-kv-compress-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="kv-compress" dir="auto">
                  KV-Compress
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#kv-compress" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-kv-compress-toggle" data-level="2" data-heading-id="kv-compress">
                  <p dir="auto">
                    <em>
                      variable compression rates per attention head
                    </em>
                  </p>
                  <p dir="auto">
                    source:
                    <a href="https://github.com/IsaacRe/vllm-kvcompress" class="external alias">
                      <span class="indicator-hook"></span>
                      github
                    </a>
                  </p>
                  <p dir="auto"></p>
                  <blockquote class="transclude" data-url="thoughts/KV-compression" data-block="#idea" data-embed-alias="idea for kv cache">
                    <div class="transclude-ref" data-href="../thoughts/KV-compression#idea">
                      <ul class="metadata">
                        <li style="font-style:italic;color:var(--gray);">
                          url: thoughts/KV-compression
                        </li>
                        <li>
                          <span style="text-decoration:underline;">
                            description
                          </span>
                          : idea for kv cache
                        </li>
                      </ul>
                      <svg class="blockquote-link" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </div>
                    <h2 id="idea" dir="auto">
                      idea.
                      <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#idea" class="internal">
                        <span class="indicator-hook"></span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                      </a>
                    </h2>
                    <p dir="auto">
                      Look at past attention weights for each pair of key and value vectors
                      (a measure of the degree with which that KV’s representation has been queried during past attention operations)
                    </p>
                    <p dir="auto">
                      Then select the KV with the least attention to evict
                    </p>
                    <p dir="auto">
                      Think of LFU (least frequency used) cache management policy
                    </p>
                    <p dir="auto">
                      the KV cache for each sequence in a particular layer is allocated on the GPU as a
                      <em>
                        # attention heads
                        <span class="katex">
                          <span class="katex-mathml">
                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                              <semantics>
                                <mrow>
                                  <mi>
                                    X
                                  </mi>
                                </mrow>
                                <annotation encoding="application/x-tex">
                                  X
                                </annotation>
                              </semantics>
                            </math>
                          </span>
                          <span class="katex-html" aria-hidden="true">
                            <span class="base">
                              <span class="strut" style="height:0.6833em;"></span>
                              <span class="mord mathnormal" style="margin-right:0.07847em;">
                                X
                              </span>
                            </span>
                          </span>
                        </span>
                        sequence length
                      </em>
                      tensor.
                    </p>
                    <blockquote class="callout tip" data-callout="tip">
                      <div class="callout-title" dir="auto">
                        <div class="callout-icon" dir="auto"></div>
                        <div class="callout-title-inner" dir="auto">
                          <p dir="auto">
                            Important
                          </p>
                        </div>
                      </div>
                      <div class="callout-content" dir="auto">
                        <p dir="auto">
                          total memory allocation scales with the
                          <em>
                            maximum
                          </em>
                          sequence length for all attention heads of the KV cache
                        </p>
                      </div>
                    </blockquote>
                    <a href="../thoughts/KV-compression#idea" class="internal transclude-src">
                      Lien vers l'original
                    </a>
                  </blockquote>
                  <p dir="auto"></p>
                  <blockquote class="callout notes" data-callout="notes">
                    <div class="callout-title" dir="auto">
                      <div class="callout-icon" dir="auto"></div>
                      <div class="callout-title-inner" dir="auto">
                        <p dir="auto">
                          Notes
                        </p>
                      </div>
                    </div>
                    <div class="callout-content" dir="auto">
                      <p dir="auto">
                        A variation of
                        <a href="../thoughts/KV-compression#ada-kv" class="internal alias" data-slug="thoughts/KV-compression">
                          <span class="indicator-hook"></span>
                          Ada-SnapKV
                        </a>
                      </p>
                    </div>
                  </blockquote>
                  <p dir="auto">
                    Motivation:
                  </p>
                  <ul dir="auto">
                    <li>
                      <em>
                        group-query-compression
                      </em>
                      : compress KV-cache of
                      <a href="../thoughts/Attention#group-query-attention" class="internal alias" data-slug="thoughts/Attention">
                        <span class="indicator-hook"></span>
                        GQA
                      </a>
                      without repeating it into the dimension of
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mo>
                                  ∑
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \sum
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                            <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                              ∑
                            </span>
                          </span>
                        </span>
                      </span>
                      query heads.
                    </li>
                    <li>
                      Modified
                      <code>
                        PagedAttention
                      </code>
                      that compute
                      <em>
                        against
                      </em>
                      KV-cache (contains variable numbers of KVs per head)
                    </li>
                  </ul>
                  <p dir="auto">
                    <img src="../thoughts/images/vllm/kv-compress-vllm.webp" width="auto" height="auto" alt loading="lazy"/>
                  </p>
                  <blockquote>
                    <p dir="auto">
                      For vLLM, each cache block stores KV for every attention head of every layer
                    </p>
                    <p dir="auto">
                      For KV-Compress, each block only holds KVs for a single head.
                      Block tables are expanded
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  l
                                </mi>
                                <mo>
                                  ×
                                </mo>
                                <mi>
                                  H
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                l \times H
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.01968em;">
                              l
                            </span>
                            <span class="mspace" style="margin-right:0.2222em;"></span>
                            <span class="mbin">
                              ×
                            </span>
                            <span class="mspace" style="margin-right:0.2222em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.08125em;">
                              H
                            </span>
                          </span>
                        </span>
                      </span>
                      so that unique block for each specific KV head and layer can be retrieved
                    </p>
                  </blockquote>
                  <section class="collapsible-header" id="query-group-compression-qgc" data-level="3">
                    <div class="header-controls">
                      <button id="collapsible-header-query-group-compression-qgc-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                        <div class="toggle-icons">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </div>
                      </button>
                      <h3 id="query-group-compression-qgc" dir="auto">
                        Query-Group Compression (QGC)
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                          <circle cx="6" cy="12" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="18" cy="12" r="2"></circle>
                        </svg>
                        <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#query-group-compression-qgc" class="internal">
                          <span class="indicator-hook"></span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                        </a>
                      </h3>
                    </div>
                    <div class="collapsible-header-content-outer">
                      <div class="collapsible-header-content" data-references="collapsible-header-query-group-compression-qgc-toggle" data-level="3" data-heading-id="query-group-compression-qgc">
                        <p dir="auto">
                          KV compression algorithm doesn’t have GQA design in mind.
                        </p>
                        <ul dir="auto">
                          <li>
                            <a href="../thoughts/KV-compression#pyramid-kv" class="internal alias" data-slug="thoughts/KV-compression">
                              <span class="indicator-hook"></span>
                              Pyramid-KV
                            </a>
                            cache and compress KV
                            <em>
                              after
                            </em>
                            repetition for alignment with query tensors
                          </li>
                          <li>
                            Redundancy in cache before compression
                          </li>
                        </ul>
                        <blockquote>
                          <p dir="auto">
                            modification of eviction-based methods per groups
                          </p>
                        </blockquote>
                      </div>
                    </div>
                  </section>
                  <section class="collapsible-header" id="block-layout-and-allocation" data-level="3">
                    <div class="header-controls">
                      <button id="collapsible-header-block-layout-and-allocation-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                        <div class="toggle-icons">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </div>
                      </button>
                      <h3 id="block-layout-and-allocation" dir="auto">
                        Block layout and allocation
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                          <circle cx="6" cy="12" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="18" cy="12" r="2"></circle>
                        </svg>
                        <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#block-layout-and-allocation" class="internal">
                          <span class="indicator-hook"></span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                        </a>
                      </h3>
                    </div>
                    <div class="collapsible-header-content-outer">
                      <div class="collapsible-header-content" data-references="collapsible-header-block-layout-and-allocation-toggle" data-level="3" data-heading-id="block-layout-and-allocation">
                        <p dir="auto">
                          idea: adapt PagedAttention to page out cache on a
                          <em>
                            per-head, per-layer–as well as per sequence–basis
                          </em>
                        </p>
                        <p dir="auto">
                          <img src="../thoughts/images/vllm/paged-attention-block-kv-compress.webp" width="auto" height="auto" alt loading="lazy"/>
                        </p>
                        <blockquote class="callout note is-collapsible is-collapsed" data-callout="note" data-callout-fold>
                          <div class="callout-title" dir="auto">
                            <div class="callout-icon" dir="auto"></div>
                            <div class="callout-title-inner" dir="auto">
                              <p dir="auto">
                                explanation
                              </p>
                            </div>
                            <div class="fold-callout-icon" dir="auto"></div>
                          </div>
                          <div class="callout-content" dir="auto">
                            <p dir="auto">
                              A simplified example with two KV heads and a block size of two:
                            </p>
                            <ul dir="auto">
                              <li>
                                KV metrics are visualized for a given cache state, highlighting blocks of a particular sequence in the decoding batch that is scheduled to evict two blocks.
                              </li>
                              <li>
                                Logical indices are displayed under the corresponding metrics slot.
                              </li>
                            </ul>
                          </div>
                        </blockquote>
                        <section class="collapsible-header" id="evict-from-paged-kv-cache" data-level="4">
                          <div class="header-controls">
                            <button id="collapsible-header-evict-from-paged-kv-cache-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                              <div class="toggle-icons">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                                  <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                                  <line x1="12" y1="5" x2="12" y2="19"></line>
                                  <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                  <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                              </div>
                            </button>
                            <h4 id="evict-from-paged-kv-cache" dir="auto">
                              Evict from Paged KV cache
                              <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                                <circle cx="6" cy="12" r="2"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                                <circle cx="18" cy="12" r="2"></circle>
                              </svg>
                              <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#evict-from-paged-kv-cache" class="internal">
                                <span class="indicator-hook"></span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                              </a>
                            </h4>
                          </div>
                          <div class="collapsible-header-content-outer">
                            <div class="collapsible-header-content" data-references="collapsible-header-evict-from-paged-kv-cache-toggle" data-level="4" data-heading-id="evict-from-paged-kv-cache">
                              <blockquote>
                                <p dir="auto">
                                  need to evict KV blocks instead of evict single KV attention
                                </p>
                              </blockquote>
                            </div>
                          </div>
                        </section>
                      </div>
                    </div>
                  </section>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="automatic-prefix-caching" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-automatic-prefix-caching-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="automatic-prefix-caching" dir="auto">
                  automatic prefix caching
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#automatic-prefix-caching" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-automatic-prefix-caching-toggle" data-level="2" data-heading-id="automatic-prefix-caching">
                  <p dir="auto">
                    <em>
                      excerpt from
                      <a href="https://github.com/vllm-project/vllm/blob/main/docs/source/automatic_prefix_caching/details.md" class="external alias">
                        <span class="indicator-hook"></span>
                        github
                      </a>
                    </em>
                  </p>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="block-manager-and-evictor" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-block-manager-and-evictor-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="block-manager-and-evictor" dir="auto">
                  block manager and evictor
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#block-manager-and-evictor" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-block-manager-and-evictor-toggle" data-level="2" data-heading-id="block-manager-and-evictor">
                  <p dir="auto">
                    see also:
                    <a href="https://github.com/vllm-project/vllm/blob/main/vllm/core/block_manager.py" class="external alias">
                      <span class="indicator-hook"></span>
                      v2
                    </a>
                    and
                    <a href="https://github.com/vllm-project/vllm/blob/5eda21e773447d81ffc661ac094716420dc7b7cb/vllm/core/block_manager_v1.py" class="external alias">
                      <span class="indicator-hook"></span>
                      v1
                    </a>
                    ,
                    <a href="https://docs.google.com/document/d/1XxYUFai07ta5rE7OdtCVhLJ5J0oAxEqrGgarFdjv0Zc/edit?tab=t.0" class="external alias">
                      <span class="indicator-hook"></span>
                      benchmark
                    </a>
                  </p>
                  <p dir="auto">
                    Reasoning for v2:
                  </p>
                  <ul dir="auto">
                    <li>
                      support sliding windows attention
                    </li>
                    <li>
                      lookahead slot for
                      <a href="../thoughts/vllm#speculative-decoding" class="internal alias" data-slug="thoughts/vllm">
                        <span class="indicator-hook"></span>
                        speculative decoding
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="speculative-decoding" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-speculative-decoding-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="speculative-decoding" dir="auto">
                  speculative decoding
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#speculative-decoding" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-speculative-decoding-toggle" data-level="2" data-heading-id="speculative-decoding">
                  <p dir="auto">
                    See
                    <a href="https://docs.google.com/presentation/d/1p1xE-EbSAnXpTSiSI0gmy_wdwxN5XaULO3AnCWWoRe4/edit#slide=id.p" class="external alias">
                      <span class="indicator-hook"></span>
                      slides
                    </a>
                  </p>
                  <blockquote class="twitter-tweet" data-lang="fr">
                    <p lang="en" dir="auto">
                      Speculative execution for LLMs is an excellent inference-time optimization.
                      <br/>
                      <br/>
                      It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on K input tokens in a batch (for larger K than you might…
                      <a href="https://t.co/FiwTwqsfho" class="external">
                        <span class="indicator-hook"></span>
                        https://t.co/FiwTwqsfho
                      </a>
                    </p>
                    — Andrej Karpathy (@karpathy)
                    <a href="https://twitter.com/karpathy/status/1697318534555336961?ref_src=twsrc%5Etfw" class="alias">
                      <span class="indicator-hook"></span>
                      31 août 2023
                    </a>
                  </blockquote>
                  <ul dir="auto">
                    <li>
                      not all parameters are required for generations tokens
                    </li>
                    <li>
                      constraints tokens with low information-density
                    </li>
                  </ul>
                  <blockquote class="callout note" data-callout="note">
                    <div class="callout-title" dir="auto">
                      <div class="callout-icon" dir="auto"></div>
                      <div class="callout-title-inner" dir="auto">
                        <p dir="auto">
                          Ideas
                        </p>
                      </div>
                    </div>
                    <div class="callout-content" dir="auto">
                      <p dir="auto">
                        Uses a small cheap “draft model” to generate candidate K tokens
                        <span>
                          ⇒
                        </span>
                        feed back to the large models in a batch
                      </p>
                      <ul dir="auto">
                        <li>
                          have a sort of sampling logics to get the probability of the next token, then forward passing for all later tokens.
                        </li>
                      </ul>
                    </div>
                  </blockquote>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="continuous-batching" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-continuous-batching-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="continuous-batching" dir="auto">
                  continuous batching
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#continuous-batching" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-continuous-batching-toggle" data-level="2" data-heading-id="continuous-batching">
                  <p dir="auto"></p>
                  <blockquote class="transclude" data-url="thoughts/Continuous-batching" data-block data-embed-alias="undefined">
                    <p dir="auto">
                      <cite class id="citation--280922--1">
                        (
                        <a href="#bib-280922" data-no-popover data-bib class="internal alias">
                          <span class="indicator-hook"></span>
                          Yu et al., 2022
                        </a>
                        )
                      </cite>
                      solves the static batching to reduce cost and improve throughput by appending requests continuously into existing KV cache
                      <sup>
                        <a href="#user-content-fn-paper" id="user-content-fnref-paper" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                          <span class="indicator-hook"></span>
                          1
                        </a>
                      </sup>
                    </p>
                    <p dir="auto">
                      <img src="../thoughts/Continuous-batching/../../thoughts/images/vllm/continuous-batching.webp" width="auto" height="auto" alt loading="lazy"/>
                    </p>
                    <a href="../thoughts/Continuous-batching" class="internal transclude-src">
                      Lien vers l'original
                    </a>
                  </blockquote>
                  <p dir="auto"></p>
                </div>
              </div>
            </section>
            <section class="collapsible-header" id="guided-decoding" data-level="2">
              <div class="header-controls">
                <button id="collapsible-header-guided-decoding-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                  <div class="toggle-icons">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                </button>
                <h2 id="guided-decoding" dir="auto">
                  guided decoding
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                    <circle cx="6" cy="12" r="2"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="18" cy="12" r="2"></circle>
                  </svg>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#guided-decoding" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
              </div>
              <div class="collapsible-header-content-outer">
                <div class="collapsible-header-content" data-references="collapsible-header-guided-decoding-toggle" data-level="2" data-heading-id="guided-decoding">
                  <p dir="auto">
                    See
                    <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#5423
                    </a>
                  </p>
                  <ul dir="auto">
                    <li>
                      not supported from
                      <code>
                        SamplingParams
                      </code>
                    </li>
                    <li>
                      requires support batch/async logits processing
                    </li>
                    <li>
                      engine will die if failed
                    </li>
                  </ul>
                  <p dir="auto">
                    Benchmark script:
                    <a href="https://github.com/vllm-project/vllm/pull/10046" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#10046
                    </a>
                  </p>
                  <p dir="auto">
                    <img src="../thoughts/images/vllm/benchmark-guided-before-optimization.webp" width="auto" height="auto" alt loading="lazy"/>
                  </p>
                  <blockquote class="callout quote" data-callout="quote">
                    <div class="callout-title" dir="auto">
                      <div class="callout-icon" dir="auto"></div>
                      <div class="callout-title-inner" dir="auto">
                        <p dir="auto">
                          overhead
                        </p>
                      </div>
                    </div>
                    <div class="callout-content" dir="auto">
                      <p dir="auto">
                        Currently logit_processor are happening in frontend, so we should move this to model_executor layers
                      </p>
                    </div>
                  </blockquote>
                  <section class="collapsible-header" id="waterfall" data-level="3">
                    <div class="header-controls">
                      <button id="collapsible-header-waterfall-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                        <div class="toggle-icons">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </div>
                      </button>
                      <h3 id="waterfall" dir="auto">
                        waterfall
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                          <circle cx="6" cy="12" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="18" cy="12" r="2"></circle>
                        </svg>
                        <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#waterfall" class="internal">
                          <span class="indicator-hook"></span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                        </a>
                      </h3>
                    </div>
                    <div class="collapsible-header-content-outer">
                      <div class="collapsible-header-content" data-references="collapsible-header-waterfall-toggle" data-level="3" data-heading-id="waterfall">
                        <p dir="auto">
                          see also
                          <a href="https://docs.google.com/presentation/d/1QL-XPFXiFpDBh86DbEegFXBXFXjix4v032GhShbKf3s/edit" class="external alias">
                            <span class="indicator-hook"></span>
                            introduction slides
                          </a>
                        </p>
                        <p dir="auto">
                          tldr: Bottleneck at
                          <code>
                            AsyncLogitProcessor
                          </code>
                          and
                          <code>
                            Scheduling
                          </code>
                          layer, given that this is row-wise operations
                          <sup>
                            <a href="#user-content-fn-row-wise" id="user-content-fnref-row-wise" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                              <span class="indicator-hook"></span>
                              2
                            </a>
                          </sup>
                        </p>
                        <pre><button class="expand-button" aria-label="Expand mermaid diagram" aria-hidden="true" data-view-component="true" tabindex="-1"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M3.72 3.72a.75.75 0 011.06 1.06L2.56 7h10.88l-2.22-2.22a.75.75 0 011.06-1.06l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 11-1.06-1.06l2.22-2.22H2.56l2.22 2.22a.75.75 0 11-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5z"></path></svg></button><code class="mermaid" data-clipboard="---
title: Initialization flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph Control Plane
    Scheduling[Scheduling]
    SequenceGroup[SequenceGroup]
    KVCache[KVCache]
    Executors
  end

  AsyncLLMEngine --> |init| C[init]
  C --> |device_type=gpu| GPU
  C --> |device_type=tpu| TPU
  C --> |device_type=xpu| XPU
  GPU --> Workers
  Workers --> |model_type=decoder| GPUModelRunner
  Workers --> |model_type=embeddings| EmbeddingModelRunner
  GPUModelRunner --> ModelClassImpl[LlamaModelForCausalLM]">---
title: Initialization flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph Control Plane
    Scheduling[Scheduling]
    SequenceGroup[SequenceGroup]
    KVCache[KVCache]
    Executors
  end

  AsyncLLMEngine --> |init| C[init]
  C --> |device_type=gpu| GPU
  C --> |device_type=tpu| TPU
  C --> |device_type=xpu| XPU
  GPU --> Workers
  Workers --> |model_type=decoder| GPUModelRunner
  Workers --> |model_type=embeddings| EmbeddingModelRunner
  GPUModelRunner --> ModelClassImpl[LlamaModelForCausalLM]
</code></pre>
                        <pre><button class="expand-button" aria-label="Expand mermaid diagram" aria-hidden="true" data-view-component="true" tabindex="-1"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M3.72 3.72a.75.75 0 011.06 1.06L2.56 7h10.88l-2.22-2.22a.75.75 0 011.06-1.06l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 11-1.06-1.06l2.22-2.22H2.56l2.22 2.22a.75.75 0 11-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5z"></path></svg></button><code class="mermaid" data-clipboard="---
title: Request flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph control plane
    Scheduling[Scheduling]
  end

  Request[prompt, sampling_params] --> AsyncLLMEngine
  AsyncLLMEngine --> |add_request_async| AsyncLogitProcessor[AsyncLogitProcessorList]
  AsyncLogitProcessor --> Scheduling --> Executors
  GPU --> GPUWorker --> GPUModelRunner --> |.execute_model| ModelClassImpl[LlamaModelForCausalLM]">---
title: Request flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph control plane
    Scheduling[Scheduling]
  end

  Request[prompt, sampling_params] --> AsyncLLMEngine
  AsyncLLMEngine --> |add_request_async| AsyncLogitProcessor[AsyncLogitProcessorList]
  AsyncLogitProcessor --> Scheduling --> Executors
  GPU --> GPUWorker --> GPUModelRunner --> |.execute_model| ModelClassImpl[LlamaModelForCausalLM]
</code></pre>
                        <blockquote class="callout note is-collapsible" data-callout="note" data-callout-fold>
                          <div class="callout-title" dir="auto">
                            <div class="callout-icon" dir="auto"></div>
                            <div class="callout-title-inner" dir="auto">
                              <p dir="auto">
                                some related items
                              </p>
                            </div>
                            <div class="fold-callout-icon" dir="auto"></div>
                          </div>
                          <div class="callout-content" dir="auto">
                            <p dir="auto">
                              Worker base:
                              <code>
                                vllm/worker/worker_base.py
                              </code>
                            </p>
                            <p dir="auto">
                              Initialize GPU cache and sequence group in ModelRunner step
                            </p>
                            <p dir="auto">
                              Executor will handle all KVCache, block manager, and evictor layer here during model execution
                            </p>
                            <p dir="auto">
                              broadcast SPMD with sequence groups
                            </p>
                          </div>
                        </blockquote>
                      </div>
                    </div>
                  </section>
                  <section class="collapsible-header" id="proposal" data-level="3">
                    <div class="header-controls">
                      <button id="collapsible-header-proposal-toggle" aria-label="Toggle content visibility" aria-expanded="true" class="toggle-button">
                        <div class="toggle-icons">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--dark)" stroke="var(--dark)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="circle-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="var(--tertiary)" stroke="var(--tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="expand-icon">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </div>
                      </button>
                      <h3 id="proposal" dir="auto">
                        proposal
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" style="padding-left:0.2rem;" class="collapsed-dots">
                          <circle cx="6" cy="12" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="18" cy="12" r="2"></circle>
                        </svg>
                        <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#proposal" class="internal">
                          <span class="indicator-hook"></span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                        </a>
                      </h3>
                    </div>
                    <div class="collapsible-header-content-outer">
                      <div class="collapsible-header-content" data-references="collapsible-header-proposal-toggle" data-level="3" data-heading-id="proposal">
                        <p dir="auto"></p>
                        <blockquote class="transclude" data-url="thoughts/constrained-decoding" data-block data-embed-alias="guided decoding">
                          <p dir="auto">
                            The following document describes and summarizes existing works in vLLM to improve general guided decoding performance.
                            <sup>
                              <a href="#user-content-fn-performance" id="user-content-fnref-performance" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                <span class="indicator-hook"></span>
                                3
                              </a>
                            </sup>
                          </p>
                          <p dir="auto">
                            This design will largely affect how
                            <code>
                              logit_processor
                            </code>
                            are currently being handle within the vLLM architecture.
                          </p>
                          <p dir="auto">
                            Main mega thread:
                            <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                              <span class="indicator-hook"></span>
                              vllm-project/vllm#5423
                            </a>
                          </p>
                          <p dir="auto">
                            Goal:
                          </p>
                          <ul dir="auto">
                            <li>
                              Improve general TPS when using guided decoding.
                            </li>
                            <li>
                              Standardize logit processor interface
                              <sup>
                                <a href="#user-content-fn-samplingpr" id="user-content-fnref-samplingpr" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                  <span class="indicator-hook"></span>
                                  4
                                </a>
                              </sup>
                            </li>
                            <li>
                              separate compute_logits and preparing logits into two separate steps
                            </li>
                          </ul>
                          <p dir="auto">
                            Orthogonal, but still goals:
                          </p>
                          <ul dir="auto">
                            <li>
                              <a href="https://github.com/vllm-project/vllm/pull/5006" class="external alias">
                                <span class="indicator-hook"></span>
                                vllm-project/vllm#5006
                              </a>
                            </li>
                            <li>
                              Logit processor plugins, similar to how vLLM plugins are handled.
                              <a href="https://github.com/vllm-project/vllm/pull/4769" class="external alias">
                                <span class="indicator-hook"></span>
                                vllm-project/vllm#4769
                              </a>
                            </li>
                            <li>
                              <a href="https://github.com/mlc-ai/xgrammar" class="external">
                                <span class="indicator-hook"></span>
                                https://github.com/mlc-ai/xgrammar
                              </a>
                            </li>
                          </ul>
                          <p dir="auto">
                            Scope:
                            <code>
                              logit_processor
                            </code>
                            ,
                            <code>
                              sampling controller interface
                            </code>
                          </p>
                          <h2 id="background" dir="auto">
                            background
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#background" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h2>
                          <p dir="auto">
                            <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/pre-optimized-logit-processor-handling.webp" width="auto" height="auto" alt="flow" loading="lazy"/>
                          </p>
                          <p dir="auto">
                            <em>
                              reference:
                              <a href="https://github.com/vllm-project/vllm/pull/5329" class="external alias">
                                <span class="indicator-hook"></span>
                                vllm-project/vllm#5329
                              </a>
                            </em>
                          </p>
                          <p dir="auto">
                            Currently, generations with FSM is super slow, even with warmup steps to initialize given FSM. This behaviour is further exemplified when running with context longer than 4096 tokens.
                          </p>
                          <p dir="auto">
                            Additionally, all outlines logit processors are considered stateful, which slows down the model executor, given in V0 logit processors are applied
                            <a href="https://github.com/vllm-project/vllm/blob/1ea291a4173a82c537ab42487e23375be4926d30/vllm/model_executor/layers/logits_processor.py#L143" class="external alias">
                              <span class="indicator-hook"></span>
                              row-by-row blocking
                            </a>
                          </p>
                          <p dir="auto">
                            Thus comparing to sglang, vLLM v0 is currently not up to par.
                          </p>
                          <h2 id="plan" dir="auto">
                            plan
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#plan" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h2>
                          <ul dir="auto">
                            <li>
                              Implement
                              <a href="https://lmsys.org/blog/2024-02-05-compressed-fsm/#method-1-finite-state-machine-based" class="external alias">
                                <span class="indicator-hook"></span>
                                jump-ahead decoding
                              </a>
                              through a JSONWorker, we can then extend this to CFGWorker
                            </li>
                            <li>
                              similar to how spec decode is currently implemented in V0
                            </li>
                          </ul>
                          <p dir="auto">
                            <a href="https://github.com/cadedaniel" class="external">
                              <span class="indicator-hook"></span>
                              <strong>
                                @cadedaniel
                              </strong>
                            </a>
                            : “tree scoring in [spec decode] could use the same API as multi-path jump decoding.”
                          </p>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  How should we handle FSM per requests?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <ul dir="auto">
                                <li>
                                  Currently, users can specify different schemas per request, which means the FSM will be compiled per request. This is suboptimal because it slows down general TTFT.
                                </li>
                                <li>
                                  For most use cases, we should assume JSON schema similar to how the system prompt is currently being handled (pass during server init)
                                </li>
                              </ul>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  Why should we follow the plugins system?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <ul dir="auto">
                                <li>
                                  If going with the best options, then what is the reasoning behind supporting different backends?
                                </li>
                                <li>
                                  Agree for extensibility, but seems to add additional overhead.
                                </li>
                              </ul>
                            </div>
                          </blockquote>
                          <hr/>
                          <h2 id="appendix" dir="auto">
                            appendix.
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#appendix" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h2>
                          <p dir="auto">
                            The following includes background information about guided generations.
                          </p>
                          <h3 id="batched-constrained-decoding-for-cfg-and-pda" dir="auto">
                            batched constrained decoding for CFG and PDA
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#batched-constrained-decoding-for-cfg-and-pda" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h3>
                          <p dir="auto">
                            Implemented in
                            <a href="https://github.com/mlc-ai/xgrammar" class="external alias">
                              <span class="indicator-hook"></span>
                              mlc-ai/xgrammar
                            </a>
                          </p>
                          <blockquote class="callout quote" data-callout="quote">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  Quote
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                Combine bitmask in CB to send to GPU
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout tip" data-callout="tip">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  IMPORTANT
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                operating on string level, not
                                <code>
                                  token_id
                                </code>
                              </p>
                            </div>
                          </blockquote>
                          <p dir="auto">
                            <code>
                              GrammarMatcher
                            </code>
                            <span>
                              ⇒
                            </span>
                            FSM in xgrammar
                          </p>
                          <h4 id="questions" dir="auto">
                            questions
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#questions" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              byte-level automaton
                            </li>
                          </ul>
                          <p dir="auto">
                            overhead of token_id
                            <span>
                              ⇒
                            </span>
                            string
                          </p>
                          <p dir="auto">
                            Token for context-independent tokens vs dependent tokens within the generation masks
                          </p>
                          <p dir="auto">
                            async pre-compile
                          </p>
                          <p dir="auto">
                            synchronize apply mask for CPU
                            <span>
                              →
                            </span>
                            GPU?
                          </p>
                          <p dir="auto">
                            How do we apply said masks to GPU block? Zero-overhead generations?
                          </p>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  worst-case scenario for grammar compilation?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                mask gen overhead: 36
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            μ
                                          </mi>
                                          <mi>
                                            s
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \mu s
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                      <span class="mord mathnormal">
                                        μ
                                      </span>
                                      <span class="mord mathnormal">
                                        s
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  time linearly increase for batch size?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                parallelize for compilation.
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  do we need to parallelize on vLLM?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                no, xgrammar parallelize it, with
                                <code>
                                  pthread
                                </code>
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  shape of masks?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                bitmask, tensors of vocab size
                                <span>
                                  ⇒
                                </span>
                                concat with recast
                                <span>
                                  ⇒
                                </span>
                                GPU
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  supported tokenizers?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                GLM yet to be supported (Nov 22nd)
                              </p>
                            </div>
                          </blockquote>
                          <blockquote class="callout question" data-callout="question">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  Given that detokenizer is in a separate process with vLLM, then can we stops duplicating this process?
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                Currently with
                                <code>
                                  xgrammar
                                </code>
                                : detokenizer included in mask generations.
                              </p>
                              <p dir="auto">
                                token_id
                                <span>
                                  ⇒
                                </span>
                                tokens
                              </p>
                            </div>
                          </blockquote>
                          <h4 id="future-plans" dir="auto">
                            future plans
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#future-plans" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              Function calling support
                            </li>
                            <li>
                              Support more grammar (CFG, Python grammar)
                            </li>
                          </ul>
                          <h3 id="compressed-fsm-for-jump-ahead-tokens" dir="auto">
                            compressed FSM for jump-ahead tokens.
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#compressed-fsm-for-jump-ahead-tokens" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h3>
                          <p dir="auto">
                            Implemented in
                            <cite class id="citation--zheng2024sglangefficientexecutionstructured--1">
                              (
                              <a href="#bib-zheng2024sglangefficientexecutionstructured" data-no-popover data-bib class="internal alias">
                                <span class="indicator-hook"></span>
                                Zheng et al., 2024
                              </a>
                              )
                            </cite>
                          </p>
                          <h4 id="method-1-fsm-based-decoding" dir="auto">
                            Method 1:
                            <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#guided-generations-with-fsm" class="internal alias" data-slug="thoughts/constrained-decoding">
                              <span class="indicator-hook"></span>
                              FSM
                            </a>
                            -based decoding
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-1-fsm-based-decoding" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              <p dir="auto">
                                intuition: Using FSM
                                <cite class id="citation--willard2023efficientguidedgenerationlarge--2">
                                  (
                                  <a href="#bib-willard2023efficientguidedgenerationlarge" data-no-popover data-bib class="internal alias">
                                    <span class="indicator-hook"></span>
                                    Willard &amp; Louf, 2023
                                  </a>
                                  )
                                </cite>
                                to guide generations by increasing logit bias for tokens that conform to given JSON schema. This allows us to track the current state during decoding and filter out invalid tokens by applying logit bias to the output.
                                <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/constrained-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                              </p>
                            </li>
                            <li>
                              <p dir="auto">
                                limitation: we can see that given construction of FSM requires token-level access, it can only transition the state by only
                                <em>
                                  one
                                </em>
                                token at a time, resulting in slow decoding.
                              </p>
                            </li>
                          </ul>
                          <h4 id="method-2-interleaved-based" dir="auto">
                            Method 2: Interleaved-based
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-2-interleaved-based" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <ul dir="auto">
                            <li>
                              <p dir="auto">
                                intuition: breaks down JSON schemas, each containing either a chunk prefill part or constrained decoding part. They are then executed interleaved by inference system.
                                Faster than per-token decoding given that chunked prefill components can process multiple tokens per forward pass
                              </p>
                              <p dir="auto">
                                See also
                                <a href="https://github.com/guidance-ai/guidance#guidance-acceleration" class="external">
                                  <span class="indicator-hook"></span>
                                  https://github.com/guidance-ai/guidance#guidance-acceleration
                                </a>
                                using llama.cpp as backend.
                              </p>
                            </li>
                            <li>
                              <p dir="auto">
                                limitation:
                              </p>
                              <ul dir="auto">
                                <li>
                                  interleaved-based require custom syntax, making it less expressive compared to regex.
                                </li>
                                <li>
                                  struggles to deal with tokenization boundaries due to conflicts between decode and chunked prefill segments.
                                </li>
                                <li>
                                  frequent communications between interpreter and back-end adds additional overhead.
                                </li>
                              </ul>
                            </li>
                          </ul>
                          <h4 id="method-3-jump-forward-decoding-with-compressed-fsm" dir="auto">
                            <strong>
                              <mark>
                                Method 3: Jump-Forward Decoding with compressed FSM
                              </mark>
                            </strong>
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-3-jump-forward-decoding-with-compressed-fsm" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h4>
                          <p dir="auto">
                            <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/jump-forward-decoding-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                          </p>
                          <blockquote class="callout tip" data-callout="tip">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  tokenization boundary handling
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                During decoding, it is preferred to combine multiple characters into a single tokens.
                              </p>
                              <p dir="auto">
                                For example, when decoding
                                <code>
                                  &quot;Hello&quot;
                                </code>
                                in context of JSON decoding, LLM might output the following token
                                <code>
                                  &quot;
                                </code>
                                ,
                                <code>
                                  He
                                </code>
                                ,
                                <code>
                                  llo
                                </code>
                                ,
                                <code>
                                  &quot;,
                                </code>
                              </p>
                              <p dir="auto">
                                This may cause some strange behaviour if we combine the last
                                <code>
                                  &quot;
                                </code>
                                with
                                <code>
                                  ,
                                </code>
                                (this regex
                                <code>
                                  &quot;[\w\d\s]*&quot;
                                </code>
                                with the last
                                <code>
                                  ,
                                </code>
                                will lead to endless decoding because this token
                                <code>
                                  &quot;,
                                </code>
                                is not valid even if the LM wants to stop.)
                              </p>
                            </div>
                          </blockquote>
                          <p dir="auto">
                            Fix:
                          </p>
                          <ul dir="auto">
                            <li>
                              implement
                              <mark>
                                re-tokenization
                              </mark>
                              mechanism during jump-forward phase (append string instead of the tokens, followed with re-tokenization of the entire text)
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mo>
                                          →
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \to
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.3669em;"></span>
                                    <span class="mrel">
                                      →
                                    </span>
                                  </span>
                                </span>
                              </span>
                              add approximately 4% of overhead
                            </li>
                            <li>
                              use a comprehensive regex to guide the decoding phase, instead of employing multiple concatenated regex
                              <sup>
                                <a href="#user-content-fn-coalescence" id="user-content-fnref-coalescence" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                  <span class="indicator-hook"></span>
                                  5
                                </a>
                              </sup>
                            </li>
                          </ul>
                          <h3 id="coalescence" dir="auto">
                            Coalescence
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#coalescence" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h3>
                          <p dir="auto">
                            intuition: Instead of expanding to
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        n
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      n
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal">
                                    n
                                  </span>
                                </span>
                              </span>
                            </span>
                            state, we can compress certain chunks into one state to reduce the size of said FSM.
                          </p>
                          <p dir="auto">
                            <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/part-of-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                            <em>
                              figure 1: initial FSM state
                            </em>
                          </p>
                          <p dir="auto">
                            <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/compressed-fsm-json.webp" width="auto" height="auto" alt loading="lazy"/>
                            <em>
                              figure 2: compressed FSM state
                            </em>
                          </p>
                          <p dir="auto">
                            A way to adapt character regex to work with tokens in
                            <code>
                              outlines
                            </code>
                            :
                          </p>
                          <figure data-rehype-pretty-code-figure>
                            <pre style="--shiki-light:#575279;--shiki-dark:#e0def4;--shiki-light-bg:#faf4ed;--shiki-dark-bg:#191724;" tabindex="0" data-language="python" data-theme="rose-pine-dawn rose-pine"><code data-language="python" data-theme="rose-pine-dawn rose-pine" style="display:grid;"><span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">import</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> outlines</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">as</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> fsm</span></span>
<span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">from</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> outlines</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">regex </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">import</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> make_deterministic_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> create_fsm_index_tokenizer</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">new_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> _ </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> make_deterministic_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">(</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">)</span></span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">idx</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> _ </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> create_fsm_index_tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">(</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">new_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">)</span></span></code></pre>
                          </figure>
                          <pre><button class="expand-button" aria-label="Expand mermaid diagram" aria-hidden="true" data-view-component="true" tabindex="-1"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M3.72 3.72a.75.75 0 011.06 1.06L2.56 7h10.88l-2.22-2.22a.75.75 0 011.06-1.06l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 11-1.06-1.06l2.22-2.22H2.56l2.22 2.22a.75.75 0 11-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5z"></path></svg></button><code class="mermaid" data-clipboard="stateDiagram-v2
    [*] --> InputPrompt: Start

    state &quot;input prompt&quot; as InputPrompt
    state &quot;next-token probability distribution&quot; as GetProb
    state &quot;valid tokens&quot; as ListTokens {
        [*] --> CheckTransitions
        CheckTransitions --> FilterTokens: Get index[0].keys()
        FilterTokens --> [*]
    }
    state &quot;Sample Token&quot; as SampleToken
    state &quot;Update FSM State&quot; as UpdateState

    InputPrompt --> GetProb: &quot;model.generate&quot;
    GetProb --> ListTokens: Get next-token distribution
    ListTokens --> SampleToken: Use filtered token list
    SampleToken --> UpdateState: Selected token X
    UpdateState --> [*]: new_state = index[0][&quot;X&quot;]">stateDiagram-v2
    [*] --> InputPrompt: Start

    state &quot;input prompt&quot; as InputPrompt
    state &quot;next-token probability distribution&quot; as GetProb
    state &quot;valid tokens&quot; as ListTokens {
        [*] --> CheckTransitions
        CheckTransitions --> FilterTokens: Get index[0].keys()
        FilterTokens --> [*]
    }
    state &quot;Sample Token&quot; as SampleToken
    state &quot;Update FSM State&quot; as UpdateState

    InputPrompt --> GetProb: &quot;model.generate&quot;
    GetProb --> ListTokens: Get next-token distribution
    ListTokens --> SampleToken: Use filtered token list
    SampleToken --> UpdateState: Selected token X
    UpdateState --> [*]: new_state = index[0][&quot;X&quot;]
</code></pre>
                          <figure data-rehype-pretty-code-figure>
                            <pre style="--shiki-light:#575279;--shiki-dark:#e0def4;--shiki-light-bg:#faf4ed;--shiki-dark-bg:#191724;" tabindex="0" data-language="python" data-theme="rose-pine-dawn rose-pine"><code data-language="python" data-theme="rose-pine-dawn rose-pine" style="display:grid;"><span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">idx_with_tokens </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span></span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  state</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">decode</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">([</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">key</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">]):</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> value </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">for</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> key</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> value </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">in</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> transitions</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">items</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">()}</span></span>
<span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">  for</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> state</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> transitions </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">in</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> idx</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">items</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">()</span></span>
<span data-line><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span></span></code></pre>
                          </figure>
                          <blockquote class="callout note is-collapsible is-collapsed" data-callout="note" data-callout-fold>
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  example
                                </p>
                              </div>
                              <div class="fold-callout-icon" dir="auto"></div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <pre><button class="expand-button" aria-label="Expand mermaid diagram" aria-hidden="true" data-view-component="true" tabindex="-1"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M3.72 3.72a.75.75 0 011.06 1.06L2.56 7h10.88l-2.22-2.22a.75.75 0 011.06-1.06l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 11-1.06-1.06l2.22-2.22H2.56l2.22 2.22a.75.75 0 11-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5z"></path></svg></button><code class="mermaid" data-clipboard="stateDiagram-v2
    direction LR
    0 --> 2: n
    0 --> 1: t
    1 --> 2: a
    2 --> 4: na
    2 --> 3: a
    3 --> 5: am
    4 --> 6: me
    5 --> 6: me
    2 --> 6: name
    6 --> 7: e
    6 --> 8: c
    7 --> 9: p
    8 --> 9: p
    9 --> 11: Paul
    9 --> 12: Pa
    9 --> 10: Jo
    11 --> 13: aul
    12 --> 14: ul
    10 --> 26: o
    26 --> 27: h
    27 --> 14: n
    13 --> 14: l
    14 --> 16: s
    14 --> 15: s
    15 --> 17: s
    16 --> 17: s
    17 --> 18: a
    17 --> 19: ag
    18 --> 20: ge
    19 --> 20: e
    20 --> 21: 30
    20 --> 22: 20
    21 --> 24: 2
    22 --> 24: 2
    22 --> 23: 3
    24 --> 25: 0
    25 --> [*]">stateDiagram-v2
    direction LR
    0 --> 2: n
    0 --> 1: t
    1 --> 2: a
    2 --> 4: na
    2 --> 3: a
    3 --> 5: am
    4 --> 6: me
    5 --> 6: me
    2 --> 6: name
    6 --> 7: e
    6 --> 8: c
    7 --> 9: p
    8 --> 9: p
    9 --> 11: Paul
    9 --> 12: Pa
    9 --> 10: Jo
    11 --> 13: aul
    12 --> 14: ul
    10 --> 26: o
    26 --> 27: h
    27 --> 14: n
    13 --> 14: l
    14 --> 16: s
    14 --> 15: s
    15 --> 17: s
    16 --> 17: s
    17 --> 18: a
    17 --> 19: ag
    18 --> 20: ge
    19 --> 20: e
    20 --> 21: 30
    20 --> 22: 20
    21 --> 24: 2
    22 --> 24: 2
    22 --> 23: 3
    24 --> 25: 0
    25 --> [*]
</code></pre>
                            </div>
                          </blockquote>
                          <p dir="auto">
                            <em>
                              note:
                            </em>
                            each state of FSM represents a forward pass to the LM. In vanilla generation, this is essentially necessary. Thus there is no added overhead of FSM for controlling the generated outputs.
                          </p>
                          <p dir="auto">
                            From state 2-6, we observer that there are eight different paths to get the same generations of
                            <code>
                              name
                            </code>
                            . We probably don’t need to do this, given that it will all give us result
                            <code>
                              name
                            </code>
                          </p>
                          <p dir="auto">
                            But suffice to say, we can hijack this behaviour to accelerate generations by append either of the following tokens
                            <strong>
                              word
                            </strong>
                            to currently generated sequence:
                          </p>
                          <ul dir="auto">
                            <li>
                              [”name”]
                            </li>
                            <li>
                              [”n”, “a”, “m”, “e”]
                            </li>
                            <li>
                              [”na”, “m”, “e”]
                            </li>
                            <li>
                              [”nam”, “e”]
                            </li>
                            <li>
                              [”n”, “am”, “e”]
                            </li>
                            <li>
                              [”n”, “ame”]
                            </li>
                            <li>
                              [”na”, “me”]
                            </li>
                            <li>
                              [”n”, “a”, “me”]
                            </li>
                          </ul>
                          <p dir="auto">
                            A simplified index can be shown as:
                          </p>
                          <figure data-rehype-pretty-code-figure>
                            <pre style="--shiki-light:#575279;--shiki-dark:#e0def4;--shiki-light-bg:#faf4ed;--shiki-dark-bg:#191724;" tabindex="0" data-language="python" data-theme="rose-pine-dawn rose-pine"><code data-language="python" data-theme="rose-pine-dawn rose-pine" style="display:grid;"><span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">simplified_index </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    0</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'{&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 2</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    2</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&quot;name&quot;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 6</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    6</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;:&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 9</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    9</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'Paul'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> 'John'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;,&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 17</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    17</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'age'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 20</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    20</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;:'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 22</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    22</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'20'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> '30'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'}'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 25</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span></span></code></pre>
                          </figure>
                          <p dir="auto">
                            That’s at least a 5x speedup over structured generations, given that out of the 9 tokens, two states are single-state transitions. Therefore we only need to call the model
                            <mark>
                              twice
                            </mark>
                            !!
                          </p>
                          <blockquote class="callout tip is-collapsible is-collapsed" data-callout="tip" data-callout-fold>
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  difference in sampling distribution
                                </p>
                              </div>
                              <div class="fold-callout-icon" dir="auto"></div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                All these paths lead to the same string and the same speedup, however they lead to potentially very different states for the LLM when it reaches state 6. That is, the strings are the same, but each path leads to a different conditional probability distribution in stage 6.
                              </p>
                              <p dir="auto">
                                <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/json-difference-in-sampling-distribution.webp" width="auto" height="auto" alt loading="lazy"/>
                              </p>
                            </div>
                          </blockquote>
                          <h3 id="guided-generations-with-fsm" dir="auto">
                            Guided generations with FSM.
                            <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#guided-generations-with-fsm" class="internal">
                              <span class="indicator-hook"></span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                              </svg>
                            </a>
                          </h3>
                          <p dir="auto">
                            <cite class id="citation--willard2023efficientguidedgenerationlarge--3">
                              (
                              <a href="#bib-willard2023efficientguidedgenerationlarge" data-no-popover data-bib class="internal alias">
                                <span class="indicator-hook"></span>
                                Willard &amp; Louf, 2023
                              </a>
                              )
                            </cite>
                            , implemented at
                            <a href="https://github.com/dottxt-ai/outlines" class="external">
                              <span class="indicator-hook"></span>
                              https://github.com/dottxt-ai/outlines
                            </a>
                          </p>
                          <p dir="auto">
                            <em>
                              assumption: we are building against
                              <a href="../thoughts/constrained-decoding/../../thoughts/Autoregressive-models" class="internal alias" data-slug="thoughts/Autoregressive-models">
                                <span class="indicator-hook"></span>
                                autoregressive transformers models
                              </a>
                            </em>
                          </p>
                          <ul dir="auto">
                            <li>
                              Let
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi mathvariant="script">
                                          F
                                        </mi>
                                        <mo>
                                          ⊂
                                        </mo>
                                        <mi mathvariant="script">
                                          P
                                        </mi>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi mathvariant="script">
                                          V
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \mathcal{F} \subset \mathcal{P}(\mathcal{V})
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                                    <span class="mord mathcal" style="margin-right:0.09931em;">
                                      F
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ⊂
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord mathcal" style="margin-right:0.08222em;">
                                      P
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathcal" style="margin-right:0.08222em;">
                                      V
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                              , where
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi mathvariant="script">
                                          P
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \mathcal{P}
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathcal" style="margin-right:0.08222em;">
                                      P
                                    </span>
                                  </span>
                                </span>
                              </span>
                              is the power set operator, be subset of multi-token string that ends with tokens
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mtext>
                                          EOS
                                        </mtext>
                                        <mo>
                                          ∈
                                        </mo>
                                        <mi mathvariant="script">
                                          V
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \text{EOS} \in \mathcal{V}
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        EOS
                                      </span>
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ∈
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathcal" style="margin-right:0.08222em;">
                                      V
                                    </span>
                                  </span>
                                </span>
                              </span>
                              .
                            </li>
                            <li>
                              Text generation tasks is to draw samples from
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi mathvariant="script">
                                          F
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \mathcal{F}
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathcal" style="margin-right:0.09931em;">
                                      F
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </li>
                          </ul>
                          <p dir="auto">
                            Notable
                            <mark>
                              sampling
                            </mark>
                            methods include greedy decoding (generate tokens recursively with highest probability tokens), beam search (but using heuristic to find the mode of distribution)
                            <sup>
                              <a href="#user-content-fn-smc" id="user-content-fnref-smc" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                <span class="indicator-hook"></span>
                                6
                              </a>
                            </sup>
                          </p>
                          <p dir="auto">
                            A pseudocode for sampling procedure is as follow:
                          </p>
                          <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                            <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                              <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                                <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                              </svg>
                              <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                              </svg>
                            </button>
                            <span class="ps-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <annotation encoding="application/x-tex">
                                    &quot;\\begin{algorithm}\n\\caption{LLM token sampling}\n\\begin{algorithmic}\n\\Function{sample}{$L$}\n    \\State $s \\gets ()$\n    \\For{$i \\gets 1, L$}\n        \\State $\\alpha \\gets \\text{LM}(s, \\theta)$\n        \\State Sample $s \\sim \\text{Categorical}(\\alpha)$\n        \\If{$s = \\text{EOS}$}\n            \\State \\textbf{break}\n        \\EndIf\n        \\State $s \\gets \\text{append}(s, s)$\n    \\EndFor\n    \\State \\Return $s$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <div class="ps-algorithm with-caption" dir="auto">
                              <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                                <span class="ps-keyword">
                                  Algorithm 1
                                </span>
                                LLM token sampling
                              </p>
                              <div class="ps-algorithmic with-linenum" dir="auto">
                                <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      1:
                                    </span>
                                    <span class="ps-keyword">
                                      function
                                    </span>
                                    <span class="ps-funcname">
                                      sample
                                    </span>
                                    (
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mi>
                                                L
                                              </mi>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              L
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.6833em;"></span>
                                          <span class="mord mathnormal">
                                            L
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    )
                                  </p>
                                  <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        2:
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  s
                                                </mi>
                                                <mo>
                                                  ←
                                                </mo>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                s \gets ()
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord mathnormal">
                                              s
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ←
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        3:
                                      </span>
                                      <span class="ps-keyword">
                                        for
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  i
                                                </mi>
                                                <mo>
                                                  ←
                                                </mo>
                                                <mn>
                                                  1
                                                </mn>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi>
                                                  L
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                i \gets 1, L
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.6595em;"></span>
                                            <span class="mord mathnormal">
                                              i
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ←
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                            <span class="mord">
                                              1
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord mathnormal">
                                              L
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="ps-keyword">
                                        do
                                      </span>
                                    </p>
                                    <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          4:
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    α
                                                  </mi>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mtext>
                                                    LM
                                                  </mtext>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo separator="true">
                                                    ,
                                                  </mo>
                                                  <mi>
                                                    θ
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  \alpha \gets \text{LM}(s, \theta)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.4306em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                α
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  LM
                                                </span>
                                              </span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mpunct">
                                                ,
                                              </span>
                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                θ
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          5:
                                        </span>
                                        Sample
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo>
                                                    ∼
                                                  </mo>
                                                  <mtext>
                                                    Categorical
                                                  </mtext>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mi>
                                                    α
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  s \sim \text{Categorical}(\alpha)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.4306em;"></span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ∼
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  Categorical
                                                </span>
                                              </span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                α
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          6:
                                        </span>
                                        <span class="ps-keyword">
                                          if
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo>
                                                    =
                                                  </mo>
                                                  <mtext>
                                                    EOS
                                                  </mtext>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  s = \text{EOS}
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.4306em;"></span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                =
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:0.6833em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  EOS
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="ps-keyword">
                                          then
                                        </span>
                                      </p>
                                      <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            7:
                                          </span>
                                          <span style="font-weight:bold;">
                                            break
                                          </span>
                                        </p>
                                      </div>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          8:
                                        </span>
                                        <span class="ps-keyword">
                                          end if
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          9:
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mtext>
                                                    append
                                                  </mtext>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo separator="true">
                                                    ,
                                                  </mo>
                                                  <mi>
                                                    s
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  s \gets \text{append}(s, s)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.4306em;"></span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  append
                                                </span>
                                              </span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mpunct">
                                                ,
                                              </span>
                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                              <span class="mord mathnormal">
                                                s
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                    </div>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        10:
                                      </span>
                                      <span class="ps-keyword">
                                        end for
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        11:
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        12:
                                      </span>
                                      <span class="ps-keyword">
                                        return
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  s
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                s
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord mathnormal">
                                              s
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                  </div>
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      13:
                                    </span>
                                    <span class="ps-keyword">
                                      end function
                                    </span>
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                          <p dir="auto">
                            Given that we are dealing with finite discrete distribution, we can then compute an un-normalized conditional distribution by applying a boolean mask
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        m
                                      </mi>
                                      <mo>
                                        :
                                      </mo>
                                      <mi mathvariant="script">
                                        P
                                      </mi>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mi mathvariant="script">
                                        V
                                      </mi>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                      <mo>
                                        →
                                      </mo>
                                      <mo stretchy="false">
                                        {
                                      </mo>
                                      <mn>
                                        0
                                      </mn>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mn>
                                        1
                                      </mn>
                                      <msup>
                                        <mo stretchy="false">
                                          }
                                        </mo>
                                        <mi>
                                          N
                                        </mi>
                                      </msup>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      m: \mathcal{P}(\mathcal{V}) \to \{0,1\}^N
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal">
                                    m
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    :
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                  <span class="mord mathcal" style="margin-right:0.08222em;">
                                    P
                                  </span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mord mathcal" style="margin-right:0.08222em;">
                                    V
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    →
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span>
                                  <span class="mopen">
                                    {
                                  </span>
                                  <span class="mord">
                                    0
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    1
                                  </span>
                                  <span class="mclose">
                                    <span class="mclose">
                                      }
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.8413em;">
                                            <span style="top:-3.063em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mathnormal mtight" style="margin-right:0.10903em;">
                                                  N
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            , which restricts the support of original distribution:
                          </p>
                          <span class="katex-display">
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                                  <semantics>
                                    <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                                      <mtr>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mi>
                                              α
                                            </mi>
                                          </mstyle>
                                        </mtd>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mrow>
                                              <mrow></mrow>
                                              <mo>
                                                =
                                              </mo>
                                              <mtext>
                                                LM
                                              </mtext>
                                              <mo stretchy="false">
                                                (
                                              </mo>
                                              <mover accent="true">
                                                <msub>
                                                  <mi>
                                                    S
                                                  </mi>
                                                  <mi>
                                                    t
                                                  </mi>
                                                </msub>
                                                <mo>
                                                  ~
                                                </mo>
                                              </mover>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mi>
                                                θ
                                              </mi>
                                              <mo stretchy="false">
                                                )
                                              </mo>
                                            </mrow>
                                          </mstyle>
                                        </mtd>
                                      </mtr>
                                      <mtr>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mover accent="true">
                                              <mi>
                                                α
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                          </mstyle>
                                        </mtd>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mrow>
                                              <mrow></mrow>
                                              <mo>
                                                =
                                              </mo>
                                              <mi>
                                                m
                                              </mi>
                                              <mo stretchy="false">
                                                (
                                              </mo>
                                              <mover accent="true">
                                                <msub>
                                                  <mi>
                                                    S
                                                  </mi>
                                                  <mi>
                                                    t
                                                  </mi>
                                                </msub>
                                                <mo>
                                                  ~
                                                </mo>
                                              </mover>
                                              <mo stretchy="false">
                                                )
                                              </mo>
                                              <mo>
                                                ⊙
                                              </mo>
                                              <mi>
                                                α
                                              </mi>
                                            </mrow>
                                          </mstyle>
                                        </mtd>
                                      </mtr>
                                      <mtr>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mover accent="true">
                                              <msub>
                                                <mi>
                                                  s
                                                </mi>
                                                <mrow>
                                                  <mi>
                                                    t
                                                  </mi>
                                                  <mo>
                                                    +
                                                  </mo>
                                                  <mn>
                                                    1
                                                  </mn>
                                                </mrow>
                                              </msub>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                          </mstyle>
                                        </mtd>
                                        <mtd>
                                          <mstyle scriptlevel="0" displaystyle="true">
                                            <mrow>
                                              <mrow></mrow>
                                              <mo>
                                                ≈
                                              </mo>
                                              <mtext>
                                                Categorial
                                              </mtext>
                                              <mo stretchy="false">
                                                (
                                              </mo>
                                              <mover accent="true">
                                                <mi>
                                                  α
                                                </mi>
                                                <mo>
                                                  ~
                                                </mo>
                                              </mover>
                                              <mo stretchy="false">
                                                )
                                              </mo>
                                            </mrow>
                                          </mstyle>
                                        </mtd>
                                      </mtr>
                                    </mtable>
                                    <annotation encoding="application/x-tex">
                                      \begin{aligned}
                                      \alpha &amp;= \text{LM}(\tilde{S_t}, \theta) \\
                                      \tilde{\alpha} &amp;= m(\tilde{S_t}) \odot \alpha \\
                                      \tilde{s_{t+1}} &amp;\approx \text{Categorial}(\tilde{\alpha})
                                      \end{aligned}
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:4.6604em;vertical-align:-2.0802em;"></span>
                                  <span class="mord">
                                    <span class="mtable">
                                      <span class="col-align-r">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:2.5802em;">
                                              <span style="top:-4.66em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-3.0798em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                              α
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.2222em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-1.5798em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord accent">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mord mathnormal">
                                                                s
                                                              </span>
                                                              <span class="msupsub">
                                                                <span class="vlist-t vlist-t2">
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.3011em;">
                                                                      <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                                        <span class="sizing reset-size6 size3 mtight">
                                                                          <span class="mord mtight">
                                                                            <span class="mord mathnormal mtight">
                                                                              t
                                                                            </span>
                                                                            <span class="mbin mtight">
                                                                              +
                                                                            </span>
                                                                            <span class="mord mtight">
                                                                              1
                                                                            </span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-s">
                                                                      ​
                                                                    </span>
                                                                  </span>
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.2083em;">
                                                                      <span></span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.25em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.2083em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:2.0802em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="col-align-l">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:2.5802em;">
                                              <span style="top:-4.66em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord"></span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    =
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      LM
                                                    </span>
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.9202em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mord mathnormal" style="margin-right:0.05764em;">
                                                                S
                                                              </span>
                                                              <span class="msupsub">
                                                                <span class="vlist-t vlist-t2">
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.2806em;">
                                                                      <span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;">
                                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                                        <span class="sizing reset-size6 size3 mtight">
                                                                          <span class="mord mathnormal mtight">
                                                                            t
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-s">
                                                                      ​
                                                                    </span>
                                                                  </span>
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.15em;">
                                                                      <span></span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.6023em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.25em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mpunct">
                                                    ,
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                    θ
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-3.0798em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord"></span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    =
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mord mathnormal">
                                                    m
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.9202em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord">
                                                              <span class="mord mathnormal" style="margin-right:0.05764em;">
                                                                S
                                                              </span>
                                                              <span class="msupsub">
                                                                <span class="vlist-t vlist-t2">
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.2806em;">
                                                                      <span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;">
                                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                                        <span class="sizing reset-size6 size3 mtight">
                                                                          <span class="mord mathnormal mtight">
                                                                            t
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                    <span class="vlist-s">
                                                                      ​
                                                                    </span>
                                                                  </span>
                                                                  <span class="vlist-r">
                                                                    <span class="vlist" style="height:0.15em;">
                                                                      <span></span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.6023em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.25em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                                  <span class="mbin">
                                                    ⊙
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                              </span>
                                              <span style="top:-1.5798em;">
                                                <span class="pstrut" style="height:3em;"></span>
                                                <span class="mord">
                                                  <span class="mord"></span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ≈
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      Categorial
                                                    </span>
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                              α
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.2222em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:2.0802em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                          <blockquote class="callout math" data-callout="math">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  augmentation upon sampling algorithm
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                                <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                                  <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                                    <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                                    <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                                  </svg>
                                  <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                                    <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                                  </svg>
                                </button>
                                <span class="ps-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <annotation encoding="application/x-tex">
                                        &quot;\\begin{algorithm}\n\\caption{token sampling with masking}\n\\begin{algorithmic}\n\\Function{sample}{$L$}\n    \\State $s \\gets ()$\n    \\For{$i \\gets 1, L$}\n        \\State $\\alpha \\gets \\text{LM}(s, \\theta)$\n        \\State Construct the mask m($s$)\n        \\State $\\tilde{\\alpha} \\gets m \\odot \\alpha$\n        \\State Sample $\\tilde{s} \\sim \\text{Categorical}(\\tilde{\\alpha})$\n        \\If{$\\tilde{s} = \\text{EOS}$}\n            \\State \\textbf{break}\n        \\EndIf\n        \\State $s \\gets \\text{append}(s, \\tilde{s})$\n    \\EndFor\n    \\State \\Return $s$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <div class="ps-algorithm with-caption" dir="auto">
                                  <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                                    <span class="ps-keyword">
                                      Algorithm 2
                                    </span>
                                    token sampling with masking
                                  </p>
                                  <div class="ps-algorithmic with-linenum" dir="auto">
                                    <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:0em;">
                                          1:
                                        </span>
                                        <span class="ps-keyword">
                                          function
                                        </span>
                                        <span class="ps-funcname">
                                          sample
                                        </span>
                                        (
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    L
                                                  </mi>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  L
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.6833em;"></span>
                                              <span class="mord mathnormal">
                                                L
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        )
                                      </p>
                                      <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-0.75em;">
                                            2:
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      s
                                                    </mi>
                                                    <mo>
                                                      ←
                                                    </mo>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    s \gets ()
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.4306em;"></span>
                                                <span class="mord mathnormal">
                                                  s
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  ←
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-0.75em;">
                                            3:
                                          </span>
                                          <span class="ps-keyword">
                                            for
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      i
                                                    </mi>
                                                    <mo>
                                                      ←
                                                    </mo>
                                                    <mn>
                                                      1
                                                    </mn>
                                                    <mo separator="true">
                                                      ,
                                                    </mo>
                                                    <mi>
                                                      L
                                                    </mi>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    i \gets 1, L
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.6595em;"></span>
                                                <span class="mord mathnormal">
                                                  i
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  ←
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                                <span class="mord">
                                                  1
                                                </span>
                                                <span class="mpunct">
                                                  ,
                                                </span>
                                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                                <span class="mord mathnormal">
                                                  L
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="ps-keyword">
                                            do
                                          </span>
                                        </p>
                                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              4:
                                            </span>
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mi>
                                                        α
                                                      </mi>
                                                      <mo>
                                                        ←
                                                      </mo>
                                                      <mtext>
                                                        LM
                                                      </mtext>
                                                      <mo stretchy="false">
                                                        (
                                                      </mo>
                                                      <mi>
                                                        s
                                                      </mi>
                                                      <mo separator="true">
                                                        ,
                                                      </mo>
                                                      <mi>
                                                        θ
                                                      </mi>
                                                      <mo stretchy="false">
                                                        )
                                                      </mo>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      \alpha \gets \text{LM}(s, \theta)
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.4306em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ←
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      LM
                                                    </span>
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                  <span class="mpunct">
                                                    ,
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                    θ
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              5:
                                            </span>
                                            Construct the mask m(
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mi>
                                                        s
                                                      </mi>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      s
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.4306em;"></span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            )
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              6:
                                            </span>
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mover accent="true">
                                                        <mi>
                                                          α
                                                        </mi>
                                                        <mo>
                                                          ~
                                                        </mo>
                                                      </mover>
                                                      <mo>
                                                        ←
                                                      </mo>
                                                      <mi>
                                                        m
                                                      </mi>
                                                      <mo>
                                                        ⊙
                                                      </mo>
                                                      <mi>
                                                        α
                                                      </mi>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      \tilde{\alpha} \gets m \odot \alpha
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.6679em;"></span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                              α
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.2222em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ←
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span>
                                                  <span class="mord mathnormal">
                                                    m
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                                  <span class="mbin">
                                                    ⊙
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2222em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:0.4306em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              7:
                                            </span>
                                            Sample
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mover accent="true">
                                                        <mi>
                                                          s
                                                        </mi>
                                                        <mo>
                                                          ~
                                                        </mo>
                                                      </mover>
                                                      <mo>
                                                        ∼
                                                      </mo>
                                                      <mtext>
                                                        Categorical
                                                      </mtext>
                                                      <mo stretchy="false">
                                                        (
                                                      </mo>
                                                      <mover accent="true">
                                                        <mi>
                                                          α
                                                        </mi>
                                                        <mo>
                                                          ~
                                                        </mo>
                                                      </mover>
                                                      <mo stretchy="false">
                                                        )
                                                      </mo>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      \tilde{s} \sim \text{Categorical}(\tilde{\alpha})
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.6679em;"></span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal">
                                                              s
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.1944em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ∼
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      Categorical
                                                    </span>
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                              α
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.2222em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              8:
                                            </span>
                                            <span class="ps-keyword">
                                              if
                                            </span>
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mover accent="true">
                                                        <mi>
                                                          s
                                                        </mi>
                                                        <mo>
                                                          ~
                                                        </mo>
                                                      </mover>
                                                      <mo>
                                                        =
                                                      </mo>
                                                      <mtext>
                                                        EOS
                                                      </mtext>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      \tilde{s} = \text{EOS}
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.6679em;"></span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal">
                                                              s
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.1944em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    =
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:0.6833em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      EOS
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="ps-keyword">
                                              then
                                            </span>
                                          </p>
                                          <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                            <p class="ps-line ps-code" dir="auto">
                                              <span class="ps-linenum" style="left:-2.25em;">
                                                9:
                                              </span>
                                              <span style="font-weight:bold;">
                                                break
                                              </span>
                                            </p>
                                          </div>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              10:
                                            </span>
                                            <span class="ps-keyword">
                                              end if
                                            </span>
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-1.5em;">
                                              11:
                                            </span>
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mi>
                                                        s
                                                      </mi>
                                                      <mo>
                                                        ←
                                                      </mo>
                                                      <mtext>
                                                        append
                                                      </mtext>
                                                      <mo stretchy="false">
                                                        (
                                                      </mo>
                                                      <mi>
                                                        s
                                                      </mi>
                                                      <mo separator="true">
                                                        ,
                                                      </mo>
                                                      <mover accent="true">
                                                        <mi>
                                                          s
                                                        </mi>
                                                        <mo>
                                                          ~
                                                        </mo>
                                                      </mover>
                                                      <mo stretchy="false">
                                                        )
                                                      </mo>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      s \gets \text{append}(s, \tilde{s})
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.4306em;"></span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ←
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                      append
                                                    </span>
                                                  </span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                  <span class="mpunct">
                                                    ,
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                                  <span class="mord accent">
                                                    <span class="vlist-t">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.6679em;">
                                                          <span style="top:-3em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="mord mathnormal">
                                                              s
                                                            </span>
                                                          </span>
                                                          <span style="top:-3.35em;">
                                                            <span class="pstrut" style="height:3em;"></span>
                                                            <span class="accent-body" style="left:-0.1944em;">
                                                              <span class="mord">
                                                                ~
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                        </div>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-0.75em;">
                                            12:
                                          </span>
                                          <span class="ps-keyword">
                                            end for
                                          </span>
                                        </p>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-0.75em;">
                                            13:
                                          </span>
                                        </p>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-0.75em;">
                                            14:
                                          </span>
                                          <span class="ps-keyword">
                                            return
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      s
                                                    </mi>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    s
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.4306em;"></span>
                                                <span class="mord mathnormal">
                                                  s
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                      </div>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:0em;">
                                          15:
                                        </span>
                                        <span class="ps-keyword">
                                          end function
                                        </span>
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </blockquote>
                          <blockquote class="callout tip" data-callout="tip">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  finite automaton
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                We define a
                                <em>
                                  finite-state machine
                                </em>
                                , given by
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mi>
                                            Q
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <mi mathvariant="normal">
                                            Σ
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <mi>
                                            δ
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <msub>
                                            <mi>
                                              q
                                            </mi>
                                            <mn>
                                              0
                                            </mn>
                                          </msub>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <mi>
                                            F
                                          </mi>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          (Q, \Sigma , \delta, q_0, F)
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord mathnormal">
                                        Q
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord">
                                        Σ
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03785em;">
                                        δ
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                                          q
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3011em;">
                                                <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      0
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.13889em;">
                                        F
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <sup>
                                  <a href="#user-content-fn-automaton-definition" id="user-content-fnref-automaton-definition" data-footnote-ref aria-describedby="footnote-label" class="internal alias">
                                    <span class="indicator-hook"></span>
                                    7
                                  </a>
                                </sup>
                                where character comprising the strings in
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi mathvariant="script">
                                            V
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \mathcal{V}
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6833em;"></span>
                                      <span class="mord mathcal" style="margin-right:0.08222em;">
                                        V
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                are drawn from
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi mathvariant="normal">
                                            Σ
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \Sigma
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6833em;"></span>
                                      <span class="mord">
                                        Σ
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                , i.e:
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi mathvariant="script">
                                            V
                                          </mi>
                                          <mo>
                                            ∈
                                          </mo>
                                          <mi mathvariant="script">
                                            P
                                          </mi>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mi mathvariant="normal">
                                            Σ
                                          </mi>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \mathcal{V} \in \mathcal{P}(\Sigma)
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                                      <span class="mord mathcal" style="margin-right:0.08222em;">
                                        V
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ∈
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord mathcal" style="margin-right:0.08222em;">
                                        P
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord">
                                        Σ
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <p dir="auto">
                                <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/fsm-iterative-generations.webp" width="auto" height="auto" alt loading="lazy"/>
                                >
                                <em>
                                  FSM making for regular expression
                                  <code>
                                    ([0-9]*)?\.?[0-9]*
                                  </code>
                                </em>
                              </p>
                              <blockquote class="callout note is-collapsible is-collapsed" data-callout="note" data-callout-fold>
                                <div class="callout-title" dir="auto">
                                  <div class="callout-icon" dir="auto"></div>
                                  <div class="callout-title-inner" dir="auto">
                                    <p dir="auto">
                                      example illustration
                                    </p>
                                  </div>
                                  <div class="fold-callout-icon" dir="auto"></div>
                                </div>
                                <div class="callout-content" dir="auto">
                                  <p dir="auto">
                                    For simplicity, let the vocabulary
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mi mathvariant="script">
                                                V
                                              </mi>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \mathcal{V}
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.6833em;"></span>
                                          <span class="mord mathcal" style="margin-right:0.08222em;">
                                            V
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    consists of strings
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mo stretchy="false">
                                                {
                                              </mo>
                                              <mi>
                                                A
                                              </mi>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mi mathvariant="normal">
                                                .
                                              </mi>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mn>
                                                42
                                              </mn>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mi mathvariant="normal">
                                                .
                                              </mi>
                                              <mn>
                                                2
                                              </mn>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mn>
                                                1
                                              </mn>
                                              <mo stretchy="false">
                                                }
                                              </mo>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \{A, ., 42, .2, 1\}
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                          <span class="mopen">
                                            {
                                          </span>
                                          <span class="mord mathnormal">
                                            A
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord">
                                            .
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord">
                                            42
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord">
                                            .2
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord">
                                            1
                                          </span>
                                          <span class="mclose">
                                            }
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </p>
                                  <ul dir="auto">
                                    <li>
                                      generations start: FSM in state 0, so it masks “A”, since it wouldn’t accepted by the FSM. Then we only sample ”.”, “42”, “.2”, “1” in this case
                                    </li>
                                    <li>
                                      if we sample “.2” then we advance the FSM to state 3. In this case. only “42” and “1” are valid completions, so we mask other values before sampling.
                                      If we sample “1” instead, then we advance FSM to state 1, in which case ”.”, “.42”, “.2”, and “1” are valid completions
                                    </li>
                                  </ul>
                                </div>
                              </blockquote>
                            </div>
                          </blockquote>
                          <blockquote class="callout tip" data-callout="tip">
                            <div class="callout-title" dir="auto">
                              <div class="callout-icon" dir="auto"></div>
                              <div class="callout-title-inner" dir="auto">
                                <p dir="auto">
                                  determinism
                                </p>
                              </div>
                            </div>
                            <div class="callout-content" dir="auto">
                              <p dir="auto">
                                Looping through the vocabulary is still the biggest issue. For that, we preprocess the vocabulary using Regex’s FSM and build a index.
                                Thus a proceeding for producing matches starting at any point in the FSM is required.
                              </p>
                            </div>
                          </blockquote>
                          <p dir="auto">
                            We define finding sub-sequences of FSM
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        M
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      M
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.6833em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.10903em;">
                                    M
                                  </span>
                                </span>
                              </span>
                            </span>
                            that accept string
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        v
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      v
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                </span>
                              </span>
                            </span>
                            as follow:
                          </p>
                          <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                            <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                              <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                                <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                              </svg>
                              <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                              </svg>
                            </button>
                            <span class="ps-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <annotation encoding="application/x-tex">
                                    &quot;\\begin{algorithm}\n\\caption{Find sub-sequences of the FSM $M$ that accept the string $v$}\n\\begin{algorithmic}\n\\Function{FindSubSequences}{$M, v$}\n    \\State $M = (Q, \\Sigma, \\delta, q_0, F)$\n    \\State $\\texttt{res} \\gets ()$\n    \\For{$r \\in \\delta^{-1}(\\cdot, v_0)$} \\Comment{$\\text{ Loop through states that read } v_0$}\n        \\State $p \\gets (r)$\n        \\For{$i \\gets 1, |v| - 1$} \\Comment{$\\text{ Walk the FSM}$}\n            \\If{$\\delta(r, v_i) = \\emptyset$} \\Comment{$\\text{ The FSM does not read } v_i$}\n                \\State $p \\gets ()$\n                \\State \\textbf{break} \\Comment{$\\text{ Stop walking and try the next start state}$}\n            \\EndIf\n            \\State $r \\gets \\delta(r, v_i)$\n            \\State $p \\gets \\text{append}(p, r)$\n        \\EndFor\n        \\State $\\texttt{res} \\gets \\text{append}(\\texttt{res}, p)$\n    \\EndFor\n    \\State \\Return $\\texttt{res}$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <div class="ps-algorithm with-caption" dir="auto">
                              <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                                <span class="ps-keyword">
                                  Algorithm 3
                                </span>
                                Find sub-sequences of the FSM
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            M
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          M
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6833em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.10903em;">
                                        M
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                that accept the string
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            v
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          v
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.4306em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        v
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <div class="ps-algorithmic with-linenum" dir="auto">
                                <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      1:
                                    </span>
                                    <span class="ps-keyword">
                                      function
                                    </span>
                                    <span class="ps-funcname">
                                      FindSubSequences
                                    </span>
                                    (
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mi>
                                                M
                                              </mi>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mi>
                                                v
                                              </mi>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              M, v
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.10903em;">
                                            M
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                                            v
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    )
                                  </p>
                                  <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        2:
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  M
                                                </mi>
                                                <mo>
                                                  =
                                                </mo>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mi>
                                                  Q
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi mathvariant="normal">
                                                  Σ
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi>
                                                  δ
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <msub>
                                                  <mi>
                                                    q
                                                  </mi>
                                                  <mn>
                                                    0
                                                  </mn>
                                                </msub>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi>
                                                  F
                                                </mi>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                M = (Q, \Sigma, \delta, q_0, F)
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.6833em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.10903em;">
                                              M
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              =
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mord mathnormal">
                                              Q
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord">
                                              Σ
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                                              δ
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord">
                                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                q
                                              </span>
                                              <span class="msupsub">
                                                <span class="vlist-t vlist-t2">
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.3011em;">
                                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                        <span class="sizing reset-size6 size3 mtight">
                                                          <span class="mord mtight">
                                                            0
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span class="vlist-s">
                                                      ​
                                                    </span>
                                                  </span>
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.15em;">
                                                      <span></span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              F
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        3:
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mtext mathvariant="monospace">
                                                  res
                                                </mtext>
                                                <mo>
                                                  ←
                                                </mo>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \texttt{res} \gets ()
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord text">
                                              <span class="mord texttt">
                                                res
                                              </span>
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ←
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        4:
                                      </span>
                                      <span class="ps-keyword">
                                        for
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  r
                                                </mi>
                                                <mo>
                                                  ∈
                                                </mo>
                                                <msup>
                                                  <mi>
                                                    δ
                                                  </mi>
                                                  <mrow>
                                                    <mo>
                                                      −
                                                    </mo>
                                                    <mn>
                                                      1
                                                    </mn>
                                                  </mrow>
                                                </msup>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mo>
                                                  ⋅
                                                </mo>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <msub>
                                                  <mi>
                                                    v
                                                  </mi>
                                                  <mn>
                                                    0
                                                  </mn>
                                                </msub>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                r \in \delta^{-1}(\cdot, v_0)
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.02778em;">
                                              r
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ∈
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span>
                                            <span class="mord">
                                              <span class="mord mathnormal" style="margin-right:0.03785em;">
                                                δ
                                              </span>
                                              <span class="msupsub">
                                                <span class="vlist-t">
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.8141em;">
                                                      <span style="top:-3.063em;margin-right:0.05em;">
                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                        <span class="sizing reset-size6 size3 mtight">
                                                          <span class="mord mtight">
                                                            <span class="mord mtight">
                                                              −
                                                            </span>
                                                            <span class="mord mtight">
                                                              1
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mord">
                                              ⋅
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord">
                                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                v
                                              </span>
                                              <span class="msupsub">
                                                <span class="vlist-t vlist-t2">
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.3011em;">
                                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                        <span class="sizing reset-size6 size3 mtight">
                                                          <span class="mord mtight">
                                                            0
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span class="vlist-s">
                                                      ​
                                                    </span>
                                                  </span>
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.15em;">
                                                      <span></span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="ps-keyword">
                                        do
                                      </span>
                                      <span class="ps-comment">
                                        ▷
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mtext>
                                                     Loop through states that read
                                                  </mtext>
                                                  <msub>
                                                    <mi>
                                                      v
                                                    </mi>
                                                    <mn>
                                                      0
                                                    </mn>
                                                  </msub>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  \text{ Loop through states that read } v_0
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                   Loop through states that read
                                                </span>
                                              </span>
                                              <span class="mord">
                                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                  v
                                                </span>
                                                <span class="msupsub">
                                                  <span class="vlist-t vlist-t2">
                                                    <span class="vlist-r">
                                                      <span class="vlist" style="height:0.3011em;">
                                                        <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                          <span class="pstrut" style="height:2.7em;"></span>
                                                          <span class="sizing reset-size6 size3 mtight">
                                                            <span class="mord mtight">
                                                              0
                                                            </span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                      <span class="vlist-s">
                                                        ​
                                                      </span>
                                                    </span>
                                                    <span class="vlist-r">
                                                      <span class="vlist" style="height:0.15em;">
                                                        <span></span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          5:
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    p
                                                  </mi>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mi>
                                                    r
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  p \gets (r)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                              <span class="mord mathnormal">
                                                p
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                r
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          6:
                                        </span>
                                        <span class="ps-keyword">
                                          for
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    i
                                                  </mi>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mn>
                                                    1
                                                  </mn>
                                                  <mo separator="true">
                                                    ,
                                                  </mo>
                                                  <mi mathvariant="normal">
                                                    ∣
                                                  </mi>
                                                  <mi>
                                                    v
                                                  </mi>
                                                  <mi mathvariant="normal">
                                                    ∣
                                                  </mi>
                                                  <mo>
                                                    −
                                                  </mo>
                                                  <mn>
                                                    1
                                                  </mn>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  i \gets 1, |v| - 1
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.6595em;"></span>
                                              <span class="mord mathnormal">
                                                i
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mord">
                                                1
                                              </span>
                                              <span class="mpunct">
                                                ,
                                              </span>
                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                              <span class="mord">
                                                ∣
                                              </span>
                                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                v
                                              </span>
                                              <span class="mord">
                                                ∣
                                              </span>
                                              <span class="mspace" style="margin-right:0.2222em;"></span>
                                              <span class="mbin">
                                                −
                                              </span>
                                              <span class="mspace" style="margin-right:0.2222em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:0.6444em;"></span>
                                              <span class="mord">
                                                1
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="ps-keyword">
                                          do
                                        </span>
                                        <span class="ps-comment">
                                          ▷
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mtext>
                                                       Walk the FSM
                                                    </mtext>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    \text{ Walk the FSM}
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.6944em;"></span>
                                                <span class="mord text">
                                                  <span class="mord">
                                                     Walk the FSM
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            7:
                                          </span>
                                          <span class="ps-keyword">
                                            if
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      δ
                                                    </mi>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo separator="true">
                                                      ,
                                                    </mo>
                                                    <msub>
                                                      <mi>
                                                        v
                                                      </mi>
                                                      <mi>
                                                        i
                                                      </mi>
                                                    </msub>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                    <mo>
                                                      =
                                                    </mo>
                                                    <mi mathvariant="normal">
                                                      ∅
                                                    </mi>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    \delta(r, v_i) = \emptyset
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.03785em;">
                                                  δ
                                                </span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                  r
                                                </span>
                                                <span class="mpunct">
                                                  ,
                                                </span>
                                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                                <span class="mord">
                                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                    v
                                                  </span>
                                                  <span class="msupsub">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.3117em;">
                                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                            <span class="pstrut" style="height:2.7em;"></span>
                                                            <span class="sizing reset-size6 size3 mtight">
                                                              <span class="mord mathnormal mtight">
                                                                i
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  =
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span>
                                                <span class="mord">
                                                  ∅
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="ps-keyword">
                                            then
                                          </span>
                                          <span class="ps-comment">
                                            ▷
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mtext>
                                                         The FSM does not read
                                                      </mtext>
                                                      <msub>
                                                        <mi>
                                                          v
                                                        </mi>
                                                        <mi>
                                                          i
                                                        </mi>
                                                      </msub>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      \text{ The FSM does not read } v_i
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span>
                                                  <span class="mord text">
                                                    <span class="mord">
                                                       The FSM does not read
                                                    </span>
                                                  </span>
                                                  <span class="mord">
                                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                      v
                                                    </span>
                                                    <span class="msupsub">
                                                      <span class="vlist-t vlist-t2">
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.3117em;">
                                                            <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                              <span class="pstrut" style="height:2.7em;"></span>
                                                              <span class="sizing reset-size6 size3 mtight">
                                                                <span class="mord mathnormal mtight">
                                                                  i
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span class="vlist-s">
                                                            ​
                                                          </span>
                                                        </span>
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.15em;">
                                                            <span></span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-3em;">
                                              8:
                                            </span>
                                            <span class="katex">
                                              <span class="katex-mathml">
                                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                  <semantics>
                                                    <mrow>
                                                      <mi>
                                                        p
                                                      </mi>
                                                      <mo>
                                                        ←
                                                      </mo>
                                                      <mo stretchy="false">
                                                        (
                                                      </mo>
                                                      <mo stretchy="false">
                                                        )
                                                      </mo>
                                                    </mrow>
                                                    <annotation encoding="application/x-tex">
                                                      p \gets ()
                                                    </annotation>
                                                  </semantics>
                                                </math>
                                              </span>
                                              <span class="katex-html" aria-hidden="true">
                                                <span class="base">
                                                  <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                                  <span class="mord mathnormal">
                                                    p
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                  <span class="mrel">
                                                    ←
                                                  </span>
                                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                                </span>
                                                <span class="base">
                                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                  <span class="mopen">
                                                    (
                                                  </span>
                                                  <span class="mclose">
                                                    )
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                          <p class="ps-line ps-code" dir="auto">
                                            <span class="ps-linenum" style="left:-3em;">
                                              9:
                                            </span>
                                            <span style="font-weight:bold;">
                                              break
                                            </span>
                                            <span class="ps-comment">
                                              ▷
                                              <span class="katex">
                                                <span class="katex-mathml">
                                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                    <semantics>
                                                      <mrow>
                                                        <mtext>
                                                           Stop walking and try the next start state
                                                        </mtext>
                                                      </mrow>
                                                      <annotation encoding="application/x-tex">
                                                        \text{ Stop walking and try the next start state}
                                                      </annotation>
                                                    </semantics>
                                                  </math>
                                                </span>
                                                <span class="katex-html" aria-hidden="true">
                                                  <span class="base">
                                                    <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                                    <span class="mord text">
                                                      <span class="mord">
                                                         Stop walking and try the next start state
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </p>
                                        </div>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            10:
                                          </span>
                                          <span class="ps-keyword">
                                            end if
                                          </span>
                                        </p>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            11:
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo>
                                                      ←
                                                    </mo>
                                                    <mi>
                                                      δ
                                                    </mi>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo separator="true">
                                                      ,
                                                    </mo>
                                                    <msub>
                                                      <mi>
                                                        v
                                                      </mi>
                                                      <mi>
                                                        i
                                                      </mi>
                                                    </msub>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    r \gets \delta(r, v_i)
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.4306em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                  r
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  ←
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.03785em;">
                                                  δ
                                                </span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                  r
                                                </span>
                                                <span class="mpunct">
                                                  ,
                                                </span>
                                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                                <span class="mord">
                                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                    v
                                                  </span>
                                                  <span class="msupsub">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.3117em;">
                                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                            <span class="pstrut" style="height:2.7em;"></span>
                                                            <span class="sizing reset-size6 size3 mtight">
                                                              <span class="mord mathnormal mtight">
                                                                i
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            12:
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      p
                                                    </mi>
                                                    <mo>
                                                      ←
                                                    </mo>
                                                    <mtext>
                                                      append
                                                    </mtext>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <mi>
                                                      p
                                                    </mi>
                                                    <mo separator="true">
                                                      ,
                                                    </mo>
                                                    <mi>
                                                      r
                                                    </mi>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    p \gets \text{append}(p, r)
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                                <span class="mord mathnormal">
                                                  p
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  ←
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mord text">
                                                  <span class="mord">
                                                    append
                                                  </span>
                                                </span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mord mathnormal">
                                                  p
                                                </span>
                                                <span class="mpunct">
                                                  ,
                                                </span>
                                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.02778em;">
                                                  r
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                      </div>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          13:
                                        </span>
                                        <span class="ps-keyword">
                                          end for
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          14:
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mtext mathvariant="monospace">
                                                    res
                                                  </mtext>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mtext>
                                                    append
                                                  </mtext>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mtext mathvariant="monospace">
                                                    res
                                                  </mtext>
                                                  <mo separator="true">
                                                    ,
                                                  </mo>
                                                  <mi>
                                                    p
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  \texttt{res} \gets \text{append}(\texttt{res}, p)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.4306em;"></span>
                                              <span class="mord text">
                                                <span class="mord texttt">
                                                  res
                                                </span>
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  append
                                                </span>
                                              </span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord text">
                                                <span class="mord texttt">
                                                  res
                                                </span>
                                              </span>
                                              <span class="mpunct">
                                                ,
                                              </span>
                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                              <span class="mord mathnormal">
                                                p
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                    </div>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        15:
                                      </span>
                                      <span class="ps-keyword">
                                        end for
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        16:
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        17:
                                      </span>
                                      <span class="ps-keyword">
                                        return
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mtext mathvariant="monospace">
                                                  res
                                                </mtext>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \texttt{res}
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord text">
                                              <span class="mord texttt">
                                                res
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                  </div>
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      18:
                                    </span>
                                    <span class="ps-keyword">
                                      end function
                                    </span>
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                          <p dir="auto">
                            We can then define construction of
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        σ
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \sigma
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    σ
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                            <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                              <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                                <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                              </svg>
                              <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                                <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                              </svg>
                            </button>
                            <span class="ps-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <annotation encoding="application/x-tex">
                                    &quot;\\begin{algorithm}\n\\caption{Construct a map from FSM states to subsets of $\\mathcal{V}$}\n\\begin{algorithmic}\n\\Function{MapStatesToVocab}{$M, \\mathcal{V}$}\n    \\State $M = (Q, \\Sigma, \\delta, q_0, F)$\n    \\State Initialize the map $\\sigma$ with empty sets for each element in $Q$\n    \\For{$v \\in \\mathcal{V}$} \\Comment{$\\text{Loop through the vocabulary}$}\n        \\State $Z \\gets \\text{find\\_sub\\_sequences}(M, v)$\n        \\For{$z \\in Z$} \\Comment{$\\text{Loop through state sequences accepting } v$}\n            \\State $\\sigma(z_0) \\gets \\sigma(z_0) \\cup v$\n        \\EndFor\n    \\EndFor\n    \\State \\Return $\\sigma$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <div class="ps-algorithm with-caption" dir="auto">
                              <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                                <span class="ps-keyword">
                                  Algorithm 4
                                </span>
                                Construct a map from FSM states to subsets of
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi mathvariant="script">
                                            V
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \mathcal{V}
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6833em;"></span>
                                      <span class="mord mathcal" style="margin-right:0.08222em;">
                                        V
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <div class="ps-algorithmic with-linenum" dir="auto">
                                <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      1:
                                    </span>
                                    <span class="ps-keyword">
                                      function
                                    </span>
                                    <span class="ps-funcname">
                                      MapStatesToVocab
                                    </span>
                                    (
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mi>
                                                M
                                              </mi>
                                              <mo separator="true">
                                                ,
                                              </mo>
                                              <mi mathvariant="script">
                                                V
                                              </mi>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              M, \mathcal{V}
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                          <span class="mord mathnormal" style="margin-right:0.10903em;">
                                            M
                                          </span>
                                          <span class="mpunct">
                                            ,
                                          </span>
                                          <span class="mspace" style="margin-right:0.1667em;"></span>
                                          <span class="mord mathcal" style="margin-right:0.08222em;">
                                            V
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    )
                                  </p>
                                  <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        2:
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  M
                                                </mi>
                                                <mo>
                                                  =
                                                </mo>
                                                <mo stretchy="false">
                                                  (
                                                </mo>
                                                <mi>
                                                  Q
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi mathvariant="normal">
                                                  Σ
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi>
                                                  δ
                                                </mi>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <msub>
                                                  <mi>
                                                    q
                                                  </mi>
                                                  <mn>
                                                    0
                                                  </mn>
                                                </msub>
                                                <mo separator="true">
                                                  ,
                                                </mo>
                                                <mi>
                                                  F
                                                </mi>
                                                <mo stretchy="false">
                                                  )
                                                </mo>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                M = (Q, \Sigma, \delta, q_0, F)
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.6833em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.10903em;">
                                              M
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              =
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                            <span class="mopen">
                                              (
                                            </span>
                                            <span class="mord mathnormal">
                                              Q
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord">
                                              Σ
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                                              δ
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord">
                                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                q
                                              </span>
                                              <span class="msupsub">
                                                <span class="vlist-t vlist-t2">
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.3011em;">
                                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                        <span class="pstrut" style="height:2.7em;"></span>
                                                        <span class="sizing reset-size6 size3 mtight">
                                                          <span class="mord mtight">
                                                            0
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                    <span class="vlist-s">
                                                      ​
                                                    </span>
                                                  </span>
                                                  <span class="vlist-r">
                                                    <span class="vlist" style="height:0.15em;">
                                                      <span></span>
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="mpunct">
                                              ,
                                            </span>
                                            <span class="mspace" style="margin-right:0.1667em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                                              F
                                            </span>
                                            <span class="mclose">
                                              )
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        3:
                                      </span>
                                      Initialize the map
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  σ
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \sigma
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                                              σ
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      with empty sets for each element in
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  Q
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                Q
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                            <span class="mord mathnormal">
                                              Q
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        4:
                                      </span>
                                      <span class="ps-keyword">
                                        for
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  v
                                                </mi>
                                                <mo>
                                                  ∈
                                                </mo>
                                                <mi mathvariant="script">
                                                  V
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                v \in \mathcal{V}
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                                              v
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                            <span class="mrel">
                                              ∈
                                            </span>
                                            <span class="mspace" style="margin-right:0.2778em;"></span>
                                          </span>
                                          <span class="base">
                                            <span class="strut" style="height:0.6833em;"></span>
                                            <span class="mord mathcal" style="margin-right:0.08222em;">
                                              V
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="ps-keyword">
                                        do
                                      </span>
                                      <span class="ps-comment">
                                        ▷
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mtext>
                                                    Loop through the vocabulary
                                                  </mtext>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  \text{Loop through the vocabulary}
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  Loop through the vocabulary
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                    <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          5:
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    Z
                                                  </mi>
                                                  <mo>
                                                    ←
                                                  </mo>
                                                  <mtext>
                                                    find_sub_sequences
                                                  </mtext>
                                                  <mo stretchy="false">
                                                    (
                                                  </mo>
                                                  <mi>
                                                    M
                                                  </mi>
                                                  <mo separator="true">
                                                    ,
                                                  </mo>
                                                  <mi>
                                                    v
                                                  </mi>
                                                  <mo stretchy="false">
                                                    )
                                                  </mo>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  Z \gets \text{find\_sub\_sequences}(M, v)
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.6833em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.07153em;">
                                                Z
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ←
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                              <span class="mord text">
                                                <span class="mord">
                                                  find_sub_sequences
                                                </span>
                                              </span>
                                              <span class="mopen">
                                                (
                                              </span>
                                              <span class="mord mathnormal" style="margin-right:0.10903em;">
                                                M
                                              </span>
                                              <span class="mpunct">
                                                ,
                                              </span>
                                              <span class="mspace" style="margin-right:0.1667em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                v
                                              </span>
                                              <span class="mclose">
                                                )
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          6:
                                        </span>
                                        <span class="ps-keyword">
                                          for
                                        </span>
                                        <span class="katex">
                                          <span class="katex-mathml">
                                            <math xmlns="http://www.w3.org/1998/Math/MathML">
                                              <semantics>
                                                <mrow>
                                                  <mi>
                                                    z
                                                  </mi>
                                                  <mo>
                                                    ∈
                                                  </mo>
                                                  <mi>
                                                    Z
                                                  </mi>
                                                </mrow>
                                                <annotation encoding="application/x-tex">
                                                  z \in Z
                                                </annotation>
                                              </semantics>
                                            </math>
                                          </span>
                                          <span class="katex-html" aria-hidden="true">
                                            <span class="base">
                                              <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.04398em;">
                                                z
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                              <span class="mrel">
                                                ∈
                                              </span>
                                              <span class="mspace" style="margin-right:0.2778em;"></span>
                                            </span>
                                            <span class="base">
                                              <span class="strut" style="height:0.6833em;"></span>
                                              <span class="mord mathnormal" style="margin-right:0.07153em;">
                                                Z
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="ps-keyword">
                                          do
                                        </span>
                                        <span class="ps-comment">
                                          ▷
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mtext>
                                                      Loop through state sequences accepting
                                                    </mtext>
                                                    <mi>
                                                      v
                                                    </mi>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    \text{Loop through state sequences accepting } v
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                                <span class="mord text">
                                                  <span class="mord">
                                                    Loop through state sequences accepting
                                                  </span>
                                                </span>
                                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                  v
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </p>
                                      <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                        <p class="ps-line ps-code" dir="auto">
                                          <span class="ps-linenum" style="left:-2.25em;">
                                            7:
                                          </span>
                                          <span class="katex">
                                            <span class="katex-mathml">
                                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                                <semantics>
                                                  <mrow>
                                                    <mi>
                                                      σ
                                                    </mi>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <msub>
                                                      <mi>
                                                        z
                                                      </mi>
                                                      <mn>
                                                        0
                                                      </mn>
                                                    </msub>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                    <mo>
                                                      ←
                                                    </mo>
                                                    <mi>
                                                      σ
                                                    </mi>
                                                    <mo stretchy="false">
                                                      (
                                                    </mo>
                                                    <msub>
                                                      <mi>
                                                        z
                                                      </mi>
                                                      <mn>
                                                        0
                                                      </mn>
                                                    </msub>
                                                    <mo stretchy="false">
                                                      )
                                                    </mo>
                                                    <mo>
                                                      ∪
                                                    </mo>
                                                    <mi>
                                                      v
                                                    </mi>
                                                  </mrow>
                                                  <annotation encoding="application/x-tex">
                                                    \sigma(z_0) \gets \sigma(z_0) \cup v
                                                  </annotation>
                                                </semantics>
                                              </math>
                                            </span>
                                            <span class="katex-html" aria-hidden="true">
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                  σ
                                                </span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mord">
                                                  <span class="mord mathnormal" style="margin-right:0.04398em;">
                                                    z
                                                  </span>
                                                  <span class="msupsub">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.3011em;">
                                                          <span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;">
                                                            <span class="pstrut" style="height:2.7em;"></span>
                                                            <span class="sizing reset-size6 size3 mtight">
                                                              <span class="mord mtight">
                                                                0
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                                <span class="mrel">
                                                  ←
                                                </span>
                                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                  σ
                                                </span>
                                                <span class="mopen">
                                                  (
                                                </span>
                                                <span class="mord">
                                                  <span class="mord mathnormal" style="margin-right:0.04398em;">
                                                    z
                                                  </span>
                                                  <span class="msupsub">
                                                    <span class="vlist-t vlist-t2">
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.3011em;">
                                                          <span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;">
                                                            <span class="pstrut" style="height:2.7em;"></span>
                                                            <span class="sizing reset-size6 size3 mtight">
                                                              <span class="mord mtight">
                                                                0
                                                              </span>
                                                            </span>
                                                          </span>
                                                        </span>
                                                        <span class="vlist-s">
                                                          ​
                                                        </span>
                                                      </span>
                                                      <span class="vlist-r">
                                                        <span class="vlist" style="height:0.15em;">
                                                          <span></span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="mclose">
                                                  )
                                                </span>
                                                <span class="mspace" style="margin-right:0.2222em;"></span>
                                                <span class="mbin">
                                                  ∪
                                                </span>
                                                <span class="mspace" style="margin-right:0.2222em;"></span>
                                              </span>
                                              <span class="base">
                                                <span class="strut" style="height:0.4306em;"></span>
                                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                                  v
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </p>
                                      </div>
                                      <p class="ps-line ps-code" dir="auto">
                                        <span class="ps-linenum" style="left:-1.5em;">
                                          8:
                                        </span>
                                        <span class="ps-keyword">
                                          end for
                                        </span>
                                      </p>
                                    </div>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        9:
                                      </span>
                                      <span class="ps-keyword">
                                        end for
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        10:
                                      </span>
                                    </p>
                                    <p class="ps-line ps-code" dir="auto">
                                      <span class="ps-linenum" style="left:-0.75em;">
                                        11:
                                      </span>
                                      <span class="ps-keyword">
                                        return
                                      </span>
                                      <span class="katex">
                                        <span class="katex-mathml">
                                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                                            <semantics>
                                              <mrow>
                                                <mi>
                                                  σ
                                                </mi>
                                              </mrow>
                                              <annotation encoding="application/x-tex">
                                                \sigma
                                              </annotation>
                                            </semantics>
                                          </math>
                                        </span>
                                        <span class="katex-html" aria-hidden="true">
                                          <span class="base">
                                            <span class="strut" style="height:0.4306em;"></span>
                                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                                              σ
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </p>
                                  </div>
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:0em;">
                                      12:
                                    </span>
                                    <span class="ps-keyword">
                                      end function
                                    </span>
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                          <a href="../thoughts/constrained-decoding" class="internal transclude-src">
                            Lien vers l'original
                          </a>
                        </blockquote>
                        <p dir="auto"></p>
                      </div>
                    </div>
                  </section>
                </div>
              </div>
            </section>
            <section data-references class="bibliography">
              <h2 id="reference-label" dir="auto">
                References
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#reference-label" class="internal">
                  <span class="indicator-hook"></span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <ul dir="auto">
                <li class="csl-entry" id="bib-280922">
                  Yu, G.-I., Jeong, J. S., Kim, G.-W., Kim, S., &amp; Chun, B.-G. (2022). Orca: A Distributed Serving System for Transformer-Based Generative Models.
                  <i>
                    16th USENIX Symposium on Operating Systems Design and Implementation (OSDI 22)
                  </i>
                  , 521–538.
                  <a href="https://www.usenix.org/conference/osdi22/presentation/yu" target="_blank" rel="noopener noreferrer" class="csl-external-link external">
                    <span class="indicator-hook"></span>
                    https://www.usenix.org/conference/osdi22/presentation/yu
                  </a>
                </li>
                <li class="csl-entry" id="bib-lew2023sequentialmontecarlosteering">
                  Lew, A. K., Zhi-Xuan, T., Grand, G., &amp; Mansinghka, V. K. (2023).
                  <i>
                    Sequential Monte Carlo Steering of Large Language Models using Probabilistic Programs
                  </i>
                  . arXiv preprint arXiv:2306.03081
                  <a href="https://arxiv.org/abs/2306.03081" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2306.03081">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-willard2023efficientguidedgenerationlarge">
                  Willard, B. T., &amp; Louf, R. (2023).
                  <i>
                    Efficient Guided Generation for Large Language Models
                  </i>
                  . arXiv preprint arXiv:2307.09702
                  <a href="https://arxiv.org/abs/2307.09702" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2307.09702">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-zheng2024sglangefficientexecutionstructured">
                  Zheng, L., Yin, L., Xie, Z., Sun, C., Huang, J., Yu, C. H., Cao, S., Kozyrakis, C., Stoica, I., Gonzalez, J. E., Barrett, C., &amp; Sheng, Y. (2024).
                  <i>
                    SGLang: Efficient Execution of Structured Language Model Programs
                  </i>
                  . arXiv preprint arXiv:2312.07104
                  <a href="https://arxiv.org/abs/2312.07104" target="_blank" rel="noopener noreferrer" class="csl-external-link internal alias" data-arxiv-id="2312.07104">
                    <span class="indicator-hook"></span>
                    arxiv
                  </a>
                </li>
                <li class="csl-entry" id="bib-kwon2023efficient">
                  Kwon, W., Li, Z., Zhuang, S., Sheng, Y., Zheng, L., Yu, C. H., Gonzalez, J. E., Zhang, H., &amp; Stoica, I. (2023). Efficient Memory Management for Large Language Model Serving with PagedAttention.
                  <i>
                    Proceedings of the ACM SIGOPS 29th Symposium on Operating Systems Principles
                  </i>
                  .
                </li>
              </ul>
            </section>
            <section data-footnotes class="footnotes">
              <h2 class="sr-only" id="footnote-label" dir="auto">
                Footnotes
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#footnote-label" class="internal">
                  <span class="indicator-hook"></span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <ol dir="auto">
                <li id="user-content-fn-paper">
                  <p dir="auto">
                    The
                    <a href="https://www.usenix.org/conference/osdi22/presentation/yu" class="external alias">
                      <span class="indicator-hook"></span>
                      paper
                    </a>
                    and
                    <a href="https://www.youtube.com/watch?v=Ob9PPLxETYU&amp;ab_channel=USENIX" class="external alias">
                      <span class="indicator-hook"></span>
                      presentation
                    </a>
                    for the paper. Most notable open source implementation is
                    <a href="../thoughts/Continuous-batching/../../thoughts/vllm" class="internal alias" data-slug="thoughts/vllm">
                      <span class="indicator-hook"></span>
                      vLLM
                    </a>
                    .
                  </p>
                  <p dir="auto">
                    p/s: Actually, I think first implemented in
                    <a href="https://github.com/huggingface/text-generation-inference" class="external alias">
                      <span class="indicator-hook"></span>
                      huggingface/tgi
                    </a>
                    <a href="#user-content-fnref-paper" data-footnote-backref aria-label="Back to reference 1" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-row-wise">
                  <p dir="auto">
                    Current implementation
                    <a href="https://github.com/vllm-project/vllm/blob/246598a6b1e22616630b7f1bf11bd9bcb31dc860/vllm/model_executor/layers/logits_processor.py#L112" class="external alias">
                      <span class="indicator-hook"></span>
                      of logits processor
                    </a>
                    mandates that we gather all logits from hidden state, scale if needed then apply the processors.
                  </p>
                  <p dir="auto">
                    <img src="../thoughts/images/vllm/pre-optimized-logit-processor-handling.webp" width="auto" height="auto" alt="flow" loading="lazy"/>
                    <em>
                      reference:
                      <a href="https://github.com/vllm-project/vllm/pull/5329" class="external alias">
                        <span class="indicator-hook"></span>
                        vllm-project/vllm#5329
                      </a>
                    </em>
                  </p>
                  <p dir="auto">
                    Note that there is also
                    <a href="https://github.com/vllm-project/vllm/pull/5006" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#5006
                    </a>
                    that improves vLLM’s own Outlines implementations of the FSM where it halves memory transition from Python list to Tensors
                    <a href="#user-content-fnref-row-wise" data-footnote-backref aria-label="Back to reference 1" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-performance">
                  <p dir="auto">
                    Benchmark script can be found at
                    <a href="https://github.com/vllm-project/vllm/pull/10046" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#10046
                    </a>
                    .
                  </p>
                  <p dir="auto">
                    Current RFC
                    <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#5423
                    </a>
                    <a href="#user-content-fnref-performance" data-footnote-backref aria-label="Back to reference 1" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-samplingpr">
                  <p dir="auto">
                    <a href="https://github.com/vllm-project/vllm/pull/6273" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#6273
                    </a>
                    proposed a sampling controller interface, but
                    <a href="https://github.com/cadedaniel" class="external">
                      <span class="indicator-hook"></span>
                      <strong>
                        @cadedaniel
                      </strong>
                    </a>
                    shares some
                    <a href="https://github.com/vllm-project/vllm/pull/6273#issuecomment-2243654991" class="external alias">
                      <span class="indicator-hook"></span>
                      concerns
                    </a>
                    wrt fast-forward tokens
                    <a href="#user-content-fnref-samplingpr" data-footnote-backref aria-label="Back to reference 2" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-coalescence">
                  <p dir="auto">
                    this phenomena is also known as
                    <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#coalescence" class="internal alias" data-slug="thoughts/constrained-decoding">
                      <span class="indicator-hook"></span>
                      coalescence
                    </a>
                    in structured generations, where it exploit deterministic structures in desired outputs to skip expensive forward pass
                    <a href="#user-content-fnref-coalescence" data-footnote-backref aria-label="Back to reference 3" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-smc">
                  <p dir="auto">
                    <cite class id="citation--lew2023sequentialmontecarlosteering--4">
                      (
                      <a href="#bib-lew2023sequentialmontecarlosteering" data-no-popover data-bib class="internal alias">
                        <span class="indicator-hook"></span>
                        Lew et al., 2023
                      </a>
                      )
                    </cite>
                    recently proposes a sequential
                    <a href="../thoughts/constrained-decoding/../../thoughts/Monte-Carlo" class="internal alias" data-slug="thoughts/Monte-Carlo">
                      <span class="indicator-hook"></span>
                      Monte Carlo steering
                    </a>
                    . The idea is to classify causal generations as a
                    <em>
                      posteriori inference
                    </em>
                    problem in a class of discrete probabilistic sequence models.
                  </p>
                  <p dir="auto">
                    See also
                    <a href="../thoughts/constrained-decoding/../../thoughts/Transformers#feynman-kac" class="internal alias" data-slug="thoughts/Transformers">
                      <span class="indicator-hook"></span>
                      Feynman-Kac transformers models
                    </a>
                    <a href="#user-content-fnref-smc" data-footnote-backref aria-label="Back to reference 4" class="data-footnote-backref internal alias">
                      <span class="indicator-hook"></span>
                      ↩
                    </a>
                  </p>
                </li>
                <li id="user-content-fn-automaton-definition">
                  <p dir="auto">
                    <a href="../thoughts/constrained-decoding/../../thoughts/university/twenty-three-twenty-four/sfwr-2fa3/DFA" class="internal alias" data-slug="thoughts/university/twenty-three-twenty-four/sfwr-2fa3/DFA">
                      <span class="indicator-hook"></span>
                      finite state machine
                    </a>
                  </p>
                  <ul dir="auto">
                    <li>
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  Q
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                Q
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                          </span>
                        </span>
                      </span>
                      is a finite set of states
                    </li>
                    <li>
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi mathvariant="normal">
                                  Σ
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \Sigma
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord">
                              Σ
                            </span>
                          </span>
                        </span>
                      </span>
                      is a finite alphabet
                    </li>
                    <li>
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  δ
                                </mi>
                                <mo>
                                  :
                                </mo>
                                <mi>
                                  Q
                                </mi>
                                <mo>
                                  ×
                                </mo>
                                <mi mathvariant="normal">
                                  Σ
                                </mi>
                                <mo>
                                  →
                                </mo>
                                <mi>
                                  Q
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \delta: Q \times \Sigma \to Q
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6944em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                              δ
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              :
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                            <span class="mspace" style="margin-right:0.2222em;"></span>
                            <span class="mbin">
                              ×
                            </span>
                            <span class="mspace" style="margin-right:0.2222em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord">
                              Σ
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              →
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                          </span>
                        </span>
                      </span>
                      is the transition function
                    </li>
                    <li>
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <msub>
                                  <mi>
                                    q
                                  </mi>
                                  <mn>
                                    0
                                  </mn>
                                </msub>
                                <mo>
                                  ∈
                                </mo>
                                <mi>
                                  Q
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                q_0 \in Q
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                q
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3011em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            0
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              ∈
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                          </span>
                        </span>
                      </span>
                      is the start state
                    </li>
                    <li>
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  F
                                </mi>
                                <mo>
                                  ⊆
                                </mo>
                                <mi>
                                  Q
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                F \subseteq Q
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                              F
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              ⊆
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                          </span>
                        </span>
                      </span>
                      is the set of all accepted states.
                    </li>
                  </ul>
                  <a href="#user-content-fnref-automaton-definition" data-footnote-backref aria-label="Back to reference 5" class="data-footnote-backref internal alias">
                    <span class="indicator-hook"></span>
                    ↩
                  </a>
                </li>
              </ol>
            </section>
          </article>
          <div class="page-footer">
            <section data-backlinks="true" class="backlinks">
              <h2 id="backlinks-label">
                Liens retour
                <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#backlinks-label" class="internal">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                </a>
              </h2>
              <div class="overflow">
                <a href="../thoughts/Attention" data-backlink="thoughts/Attention">
                  <div class="small">
                    Attention
                  </div>
                  <div class="description">
                    (Vaswani et al., 2023) Attention operates on a sequence of query Q, key K and value V vector. Attention matrix of a sequence then computed as: A(Q, K, V) = \text{softmax}(\frac{Q \cdot K^{T}}{\sqrt{d}})V \space \space \text{ for } Q_{L \times d}, K_{L \times d}, V_{L \times d} Muti-head Attention Allows the model to jointly attend to information from different representation subspaces at different positions: \begin{aligned} \text{MHA}(Q,K,V) &amp;= \text{concat}(\text{head}_1, \cdots, \text{head}_n) W^O \\ &amp;\text{where } \space \text{head}_i = \text{A}(QW_i^O, KW_i^O, VW_i^O) \\ W^O &amp; \in \mathbb{R}^{hd_v \times d_{\text{model}}} \end{aligned} Group-Query Attention by (Ainslie et al., 2023) idea: reduce number of KV heads n_k to a fraction n_k^{'} = \frac{n_q}{k} of number of query heads n_q (evenly dividing the query heads into n_k groups with r heads) RadixAttention Implemented in (Zheng et al., 2024) where they maintain a LRU eviction policy to maintain relevant KV cache for all requests within a radix tree radix tree setup: key: sequence of tokens value: KV cache tensor (stored in GPU in a paged layout) dynamic evolution of the radix tree in response to various requests.
                  </div>
                </a>
                <a href="../thoughts/Continuous-batching" data-backlink="thoughts/Continuous-batching">
                  <div class="small">
                    Continuous batching
                  </div>
                  <div class="description">
                    (Yu et al., 2022) solves the static batching to reduce cost and improve throughput by appending requests continuously into existing KV cache 1 ReferencesYu, G.-I., Jeong, J ...
                  </div>
                </a>
                <a href="../thoughts/KV-compression" data-backlink="thoughts/KV-compression">
                  <div class="small">
                    KV compression
                  </div>
                  <div class="description">
                    see also: github TLDR: Most algorithm determine importance through aggregating attentions over observed queries (Liu et al., 2023; Zhang et al., 2023) More recent work aggregated ...
                  </div>
                </a>
                <a href="../thoughts/Transformers" data-backlink="thoughts/Transformers">
                  <div class="small">
                    Transformers
                  </div>
                  <div class="description">
                    See also: LLMs, embedding, visualisation from Brendan Bycroft A multi-layer perceptron (MLP) architecture built on top of a multi-head attention mechanism (Vaswani et al., 2023) ...
                  </div>
                </a>
                <a href="../thoughts/mechanistic-interpretability" data-backlink="thoughts/mechanistic-interpretability">
                  <div class="small">
                    mechanistic interpretability
                  </div>
                  <div class="description">
                    and reverse engineering neural networks.
                  </div>
                </a>
                <a href="../thoughts/vllm" data-backlink="thoughts/vllm">
                  <div class="small">
                    vLLM
                  </div>
                  <div class="description">
                    See also Paged Attention (Kwon et al., 2023) KV-Compress variable compression rates per attention head source: github KV-compression#idea Notes A variation of Ada-SnapKV Motivation: ...
                  </div>
                </a>
                <a href="../thoughts/work" data-backlink="thoughts/work">
                  <div class="small">
                    work.
                  </div>
                  <div class="description">
                    Crafts that I have been brewing for the past while.
                  </div>
                </a>
              </div>
            </section>
            <footer class="minimal-footer">
              <ul class="icons">
                <li>
                  <a href="/" target="_self" aria-label="home">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="home" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                      <path d="M946.5 505L560.1 118.8l-25.9-25.9a31.5 31.5 0 00-44.4 0L77.5 505a63.9 63.9 0 00-18.8 46c.4 35.2 29.7 63.3 64.9 63.3h42.5V940h691.8V614.3h43.4c17.1 0 33.2-6.7 45.3-18.8a63.6 63.6 0 0018.7-45.3c0-17-6.7-33.1-18.8-45.2zM568 868H456V664h112v204zm217.9-325.7V868H632V640c0-22.1-17.9-40-40-40H432c-22.1 0-40 17.9-40 40v228H238.1V542.3h-96l370-369.7 23.1 23.1L882 542.3h-96.1z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://github.com/aarnphm" target="_blank" aria-label="github">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="var(--gray)" aria-label="true">
                      <path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0138.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/aarnphm_" target="_blank" aria-label="twitter">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="twitter" width="1em" height="1em" fill="var(--gray)" aria-hidden="true">
                      <path d="M928 254.3c-30.6 13.2-63.9 22.7-98.2 26.4a170.1 170.1 0 0075-94 336.64 336.64 0 01-108.2 41.2A170.1 170.1 0 00672 174c-94.5 0-170.5 76.6-170.5 170.6 0 13.2 1.6 26.4 4.2 39.1-141.5-7.4-267.7-75-351.6-178.5a169.32 169.32 0 00-23.2 86.1c0 59.2 30.1 111.4 76 142.1a172 172 0 01-77.1-21.7v2.1c0 82.9 58.6 151.6 136.7 167.4a180.6 180.6 0 01-44.9 5.8c-11.1 0-21.6-1.1-32.2-2.6C211 652 273.9 701.1 348.8 702.7c-58.6 45.9-132 72.9-211.7 72.9-14.3 0-27.5-.5-41.2-2.1C171.5 822 261.2 850 357.8 850 671.4 850 843 590.2 843 364.7c0-7.4 0-14.8-.5-22.2 33.2-24.3 62.3-54.4 85.5-88.2z"></path>
                    </svg>
                  </a>
                </li>
                <li>
                  <a href="https://bsky.app/profile/aarnphm.xyz" target="_blank" aria-label="bsky">
                    <svg viewBox="0 0 512 512" focusable="false" data-icon="bsky" width="1em" height="1em" aria-hidden="true">
                      <path d="M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2c42.1-31.6 110.3-56 110.3 21.8c0 15.5-8.9 130.5-14.1 149.2C478.2 298 412 314.6 353.1 304.5c102.9 17.5 129.1 75.5 72.5 133.5c-107.4 110.2-154.3-27.6-166.3-62.9l0 0c-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8l0 0c-12 35.3-59 173.1-166.3 62.9c-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1C10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z" fill="#1185fe"></path>
                    </svg>
                  </a>
                </li>
              </ul>
              <p class="info">
                Créé avec
                <a href="https://quartz.jzhao.xyz/" target="_blank" rel="noopener noreferrer" aria-label="Quartz links">
                  Quartz v4.4.0
                </a>
                © 2024
              </p>
            </footer>
          </div>
        </section>
        <section class="right sidebar">
          <div class="graph">
            <div id="global-graph-outer">
              <div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div>
            </div>
          </div>
          <div class="reader" id="reader-view">
            <div class="reader-backdrop"></div>
            <div class="reader-container">
              <div class="reader-header">
                <button class="reader-close" aria-label="Close reader">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="reader-content">
                <h1 class="reader-title">
                  vLLM
                </h1>
                <p dir="auto">
                  See also
                  <a href="../thoughts/Attention#paged-attention" class="internal" data-slug="thoughts/Attention" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    Paged Attention
                  </a>
                  <cite class id="citation--kwon2023efficient--1">
                    (
                    <a href="#bib-kwon2023efficient-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Kwon et al., 2023
                    </a>
                    )
                  </cite>
                </p>
                <h2 id="kv-compress-reader" dir="auto">
                  KV-Compress
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#kv-compress-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  <em>
                    variable compression rates per attention head
                  </em>
                </p>
                <p dir="auto">
                  source:
                  <a href="https://github.com/IsaacRe/vllm-kvcompress" class="external alias">
                    <span class="indicator-hook"></span>
                    github
                  </a>
                </p>
                <p dir="auto"></p>
                <h2 id="idea-reader" dir="auto">
                  idea.
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#idea-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  Look at past attention weights for each pair of key and value vectors
                  (a measure of the degree with which that KV’s representation has been queried during past attention operations)
                </p>
                <p dir="auto">
                  Then select the KV with the least attention to evict
                </p>
                <p dir="auto">
                  Think of LFU (least frequency used) cache management policy
                </p>
                <p dir="auto">
                  the KV cache for each sequence in a particular layer is allocated on the GPU as a
                  <em>
                    # attention heads
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                X
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              X
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.07847em;">
                            X
                          </span>
                        </span>
                      </span>
                    </span>
                    sequence length
                  </em>
                  tensor.
                </p>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Important
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      total memory allocation scales with the
                      <em>
                        maximum
                      </em>
                      sequence length for all attention heads of the KV cache
                    </p>
                  </div>
                </blockquote>
                <p dir="auto"></p>
                <blockquote class="callout notes" data-callout="notes">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Notes
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      A variation of
                      <a href="../thoughts/KV-compression#ada-kv" class="internal" data-slug="thoughts/KV-compression" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        Ada-SnapKV
                      </a>
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  Motivation:
                </p>
                <ul dir="auto">
                  <li>
                    <em>
                      group-query-compression
                    </em>
                    : compress KV-cache of
                    <a href="../thoughts/Attention#group-query-attention" class="internal" data-slug="thoughts/Attention" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      GQA
                    </a>
                    without repeating it into the dimension of
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mo>
                                ∑
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \sum
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                          <span class="mop op-symbol small-op" style="position:relative;top:0em;">
                            ∑
                          </span>
                        </span>
                      </span>
                    </span>
                    query heads.
                  </li>
                  <li>
                    Modified
                    <code>
                      PagedAttention
                    </code>
                    that compute
                    <em>
                      against
                    </em>
                    KV-cache (contains variable numbers of KVs per head)
                  </li>
                </ul>
                <p dir="auto">
                  <img src="../thoughts/images/vllm/kv-compress-vllm.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <blockquote>
                  <p dir="auto">
                    For vLLM, each cache block stores KV for every attention head of every layer
                  </p>
                  <p dir="auto">
                    For KV-Compress, each block only holds KVs for a single head.
                    Block tables are expanded
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi>
                                l
                              </mi>
                              <mo>
                                ×
                              </mo>
                              <mi>
                                H
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              l \times H
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.01968em;">
                            l
                          </span>
                          <span class="mspace" style="margin-right:0.2222em;"></span>
                          <span class="mbin">
                            ×
                          </span>
                          <span class="mspace" style="margin-right:0.2222em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathnormal" style="margin-right:0.08125em;">
                            H
                          </span>
                        </span>
                      </span>
                    </span>
                    so that unique block for each specific KV head and layer can be retrieved
                  </p>
                </blockquote>
                <h3 id="query-group-compression-qgc-reader" dir="auto">
                  Query-Group Compression (QGC)
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#query-group-compression-qgc-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  KV compression algorithm doesn’t have GQA design in mind.
                </p>
                <ul dir="auto">
                  <li>
                    <a href="../thoughts/KV-compression#pyramid-kv" class="internal" data-slug="thoughts/KV-compression" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      Pyramid-KV
                    </a>
                    cache and compress KV
                    <em>
                      after
                    </em>
                    repetition for alignment with query tensors
                  </li>
                  <li>
                    Redundancy in cache before compression
                  </li>
                </ul>
                <blockquote>
                  <p dir="auto">
                    modification of eviction-based methods per groups
                  </p>
                </blockquote>
                <h3 id="block-layout-and-allocation-reader" dir="auto">
                  Block layout and allocation
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#block-layout-and-allocation-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  idea: adapt PagedAttention to page out cache on a
                  <em>
                    per-head, per-layer–as well as per sequence–basis
                  </em>
                </p>
                <p dir="auto">
                  <img src="../thoughts/images/vllm/paged-attention-block-kv-compress.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <blockquote class="callout" data-callout="note" data-callout-fold>
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        explanation
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      A simplified example with two KV heads and a block size of two:
                    </p>
                    <ul dir="auto">
                      <li>
                        KV metrics are visualized for a given cache state, highlighting blocks of a particular sequence in the decoding batch that is scheduled to evict two blocks.
                      </li>
                      <li>
                        Logical indices are displayed under the corresponding metrics slot.
                      </li>
                    </ul>
                  </div>
                </blockquote>
                <h4 id="evict-from-paged-kv-cache-reader" dir="auto">
                  Evict from Paged KV cache
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#evict-from-paged-kv-cache-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <blockquote>
                  <p dir="auto">
                    need to evict KV blocks instead of evict single KV attention
                  </p>
                </blockquote>
                <h2 id="automatic-prefix-caching-reader" dir="auto">
                  automatic prefix caching
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#automatic-prefix-caching-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  <em>
                    excerpt from
                    <a href="https://github.com/vllm-project/vllm/blob/main/docs/source/automatic_prefix_caching/details.md" class="external alias">
                      <span class="indicator-hook"></span>
                      github
                    </a>
                  </em>
                </p>
                <h2 id="block-manager-and-evictor-reader" dir="auto">
                  block manager and evictor
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#block-manager-and-evictor-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  see also:
                  <a href="https://github.com/vllm-project/vllm/blob/main/vllm/core/block_manager.py" class="external alias">
                    <span class="indicator-hook"></span>
                    v2
                  </a>
                  and
                  <a href="https://github.com/vllm-project/vllm/blob/5eda21e773447d81ffc661ac094716420dc7b7cb/vllm/core/block_manager_v1.py" class="external alias">
                    <span class="indicator-hook"></span>
                    v1
                  </a>
                  ,
                  <a href="https://docs.google.com/document/d/1XxYUFai07ta5rE7OdtCVhLJ5J0oAxEqrGgarFdjv0Zc/edit?tab=t.0" class="external alias">
                    <span class="indicator-hook"></span>
                    benchmark
                  </a>
                </p>
                <p dir="auto">
                  Reasoning for v2:
                </p>
                <ul dir="auto">
                  <li>
                    support sliding windows attention
                  </li>
                  <li>
                    lookahead slot for
                    <a href="../thoughts/vllm#speculative-decoding" class="internal" data-slug="thoughts/vllm" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      speculative decoding
                    </a>
                  </li>
                </ul>
                <h2 id="speculative-decoding-reader" dir="auto">
                  speculative decoding
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#speculative-decoding-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  See
                  <a href="https://docs.google.com/presentation/d/1p1xE-EbSAnXpTSiSI0gmy_wdwxN5XaULO3AnCWWoRe4/edit#slide=id.p" class="external alias">
                    <span class="indicator-hook"></span>
                    slides
                  </a>
                </p>
                <blockquote class="twitter-tweet" data-lang="fr">
                  <p lang="en" dir="auto">
                    Speculative execution for LLMs is an excellent inference-time optimization.
                    <br/>
                    <br/>
                    It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on K input tokens in a batch (for larger K than you might…
                    <a href="https://t.co/FiwTwqsfho" class="external">
                      <span class="indicator-hook"></span>
                      https://t.co/FiwTwqsfho
                    </a>
                  </p>
                  — Andrej Karpathy (@karpathy)
                  <a href="https://twitter.com/karpathy/status/1697318534555336961?ref_src=twsrc%5Etfw" class="alias">
                    <span class="indicator-hook"></span>
                    31 août 2023
                  </a>
                </blockquote>
                <ul dir="auto">
                  <li>
                    not all parameters are required for generations tokens
                  </li>
                  <li>
                    constraints tokens with low information-density
                  </li>
                </ul>
                <blockquote class="callout note" data-callout="note">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Ideas
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Uses a small cheap “draft model” to generate candidate K tokens
                      <span>
                        ⇒
                      </span>
                      feed back to the large models in a batch
                    </p>
                    <ul dir="auto">
                      <li>
                        have a sort of sampling logics to get the probability of the next token, then forward passing for all later tokens.
                      </li>
                    </ul>
                  </div>
                </blockquote>
                <h2 id="continuous-batching-reader" dir="auto">
                  continuous batching
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#continuous-batching-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto"></p>
                <p dir="auto">
                  <cite class id="citation--280922--1">
                    (
                    <a href="#bib-280922-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Yu et al., 2022
                    </a>
                    )
                  </cite>
                  solves the static batching to reduce cost and improve throughput by appending requests continuously into existing KV cache
                  <sup>
                    <a href="#user-content-fn-paper-reader" id="user-content-fnref-paper-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      1
                    </a>
                  </sup>
                </p>
                <p dir="auto">
                  <img src="../thoughts/Continuous-batching/../../thoughts/images/vllm/continuous-batching.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <p dir="auto"></p>
                <h2 id="guided-decoding-reader" dir="auto">
                  guided decoding
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#guided-decoding-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  See
                  <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                    <span class="indicator-hook"></span>
                    vllm-project/vllm#5423
                  </a>
                </p>
                <ul dir="auto">
                  <li>
                    not supported from
                    <code>
                      SamplingParams
                    </code>
                  </li>
                  <li>
                    requires support batch/async logits processing
                  </li>
                  <li>
                    engine will die if failed
                  </li>
                </ul>
                <p dir="auto">
                  Benchmark script:
                  <a href="https://github.com/vllm-project/vllm/pull/10046" class="external alias">
                    <span class="indicator-hook"></span>
                    vllm-project/vllm#10046
                  </a>
                </p>
                <p dir="auto">
                  <img src="../thoughts/images/vllm/benchmark-guided-before-optimization.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <blockquote class="callout quote" data-callout="quote">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        overhead
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Currently logit_processor are happening in frontend, so we should move this to model_executor layers
                    </p>
                  </div>
                </blockquote>
                <h3 id="waterfall-reader" dir="auto">
                  waterfall
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#waterfall-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  see also
                  <a href="https://docs.google.com/presentation/d/1QL-XPFXiFpDBh86DbEegFXBXFXjix4v032GhShbKf3s/edit" class="external alias">
                    <span class="indicator-hook"></span>
                    introduction slides
                  </a>
                </p>
                <p dir="auto">
                  tldr: Bottleneck at
                  <code>
                    AsyncLogitProcessor
                  </code>
                  and
                  <code>
                    Scheduling
                  </code>
                  layer, given that this is row-wise operations
                  <sup>
                    <a href="#user-content-fn-row-wise-reader" id="user-content-fnref-row-wise-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      2
                    </a>
                  </sup>
                </p>
                <pre><code class="mermaid" data-clipboard="---
title: Initialization flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph Control Plane
    Scheduling[Scheduling]
    SequenceGroup[SequenceGroup]
    KVCache[KVCache]
    Executors
  end

  AsyncLLMEngine --> |init| C[init]
  C --> |device_type=gpu| GPU
  C --> |device_type=tpu| TPU
  C --> |device_type=xpu| XPU
  GPU --> Workers
  Workers --> |model_type=decoder| GPUModelRunner
  Workers --> |model_type=embeddings| EmbeddingModelRunner
  GPUModelRunner --> ModelClassImpl[LlamaModelForCausalLM]">---
title: Initialization flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph Control Plane
    Scheduling[Scheduling]
    SequenceGroup[SequenceGroup]
    KVCache[KVCache]
    Executors
  end

  AsyncLLMEngine --> |init| C[init]
  C --> |device_type=gpu| GPU
  C --> |device_type=tpu| TPU
  C --> |device_type=xpu| XPU
  GPU --> Workers
  Workers --> |model_type=decoder| GPUModelRunner
  Workers --> |model_type=embeddings| EmbeddingModelRunner
  GPUModelRunner --> ModelClassImpl[LlamaModelForCausalLM]</code></pre>
                <pre><code class="mermaid" data-clipboard="---
title: Request flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph control plane
    Scheduling[Scheduling]
  end

  Request[prompt, sampling_params] --> AsyncLLMEngine
  AsyncLLMEngine --> |add_request_async| AsyncLogitProcessor[AsyncLogitProcessorList]
  AsyncLogitProcessor --> Scheduling --> Executors
  GPU --> GPUWorker --> GPUModelRunner --> |.execute_model| ModelClassImpl[LlamaModelForCausalLM]">---
title: Request flow
---
graph TB
  subgraph Engine
    AsyncLLMEngine[AsyncLLMEngine]
  end

  subgraph Executors
    GPU[GPUExecutorAsync]
    TPU[TPUExecutorAsync]
    XPU[XPUExecutorAsync]
  end

  subgraph Workers
    GPUWorker[GPUWorker]
  end

  subgraph Model Runners
    EmbeddingModelRunner[EmbeddingModelRunner]
    GPUModelRunner[GPUModelRunner]
  end

  subgraph control plane
    Scheduling[Scheduling]
  end

  Request[prompt, sampling_params] --> AsyncLLMEngine
  AsyncLLMEngine --> |add_request_async| AsyncLogitProcessor[AsyncLogitProcessorList]
  AsyncLogitProcessor --> Scheduling --> Executors
  GPU --> GPUWorker --> GPUModelRunner --> |.execute_model| ModelClassImpl[LlamaModelForCausalLM]</code></pre>
                <blockquote class="callout" data-callout="note" data-callout-fold>
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        some related items
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Worker base:
                      <code>
                        vllm/worker/worker_base.py
                      </code>
                    </p>
                    <p dir="auto">
                      Initialize GPU cache and sequence group in ModelRunner step
                    </p>
                    <p dir="auto">
                      Executor will handle all KVCache, block manager, and evictor layer here during model execution
                    </p>
                    <p dir="auto">
                      broadcast SPMD with sequence groups
                    </p>
                  </div>
                </blockquote>
                <h3 id="proposal-reader" dir="auto">
                  proposal
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#proposal-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto"></p>
                <p dir="auto">
                  The following document describes and summarizes existing works in vLLM to improve general guided decoding performance.
                  <sup>
                    <a href="#user-content-fn-performance-reader" id="user-content-fnref-performance-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      3
                    </a>
                  </sup>
                </p>
                <p dir="auto">
                  This design will largely affect how
                  <code>
                    logit_processor
                  </code>
                  are currently being handle within the vLLM architecture.
                </p>
                <p dir="auto">
                  Main mega thread:
                  <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                    <span class="indicator-hook"></span>
                    vllm-project/vllm#5423
                  </a>
                </p>
                <p dir="auto">
                  Goal:
                </p>
                <ul dir="auto">
                  <li>
                    Improve general TPS when using guided decoding.
                  </li>
                  <li>
                    Standardize logit processor interface
                    <sup>
                      <a href="#user-content-fn-samplingpr-reader" id="user-content-fnref-samplingpr-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        4
                      </a>
                    </sup>
                  </li>
                  <li>
                    separate compute_logits and preparing logits into two separate steps
                  </li>
                </ul>
                <p dir="auto">
                  Orthogonal, but still goals:
                </p>
                <ul dir="auto">
                  <li>
                    <a href="https://github.com/vllm-project/vllm/pull/5006" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#5006
                    </a>
                  </li>
                  <li>
                    Logit processor plugins, similar to how vLLM plugins are handled.
                    <a href="https://github.com/vllm-project/vllm/pull/4769" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#4769
                    </a>
                  </li>
                  <li>
                    <a href="https://github.com/mlc-ai/xgrammar" class="external">
                      <span class="indicator-hook"></span>
                      https://github.com/mlc-ai/xgrammar
                    </a>
                  </li>
                </ul>
                <p dir="auto">
                  Scope:
                  <code>
                    logit_processor
                  </code>
                  ,
                  <code>
                    sampling controller interface
                  </code>
                </p>
                <h2 id="background-reader" dir="auto">
                  background
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#background-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/pre-optimized-logit-processor-handling.webp" width="auto" height="auto" alt="flow" loading="lazy"/>
                </p>
                <p dir="auto">
                  <em>
                    reference:
                    <a href="https://github.com/vllm-project/vllm/pull/5329" class="external alias">
                      <span class="indicator-hook"></span>
                      vllm-project/vllm#5329
                    </a>
                  </em>
                </p>
                <p dir="auto">
                  Currently, generations with FSM is super slow, even with warmup steps to initialize given FSM. This behaviour is further exemplified when running with context longer than 4096 tokens.
                </p>
                <p dir="auto">
                  Additionally, all outlines logit processors are considered stateful, which slows down the model executor, given in V0 logit processors are applied
                  <a href="https://github.com/vllm-project/vllm/blob/1ea291a4173a82c537ab42487e23375be4926d30/vllm/model_executor/layers/logits_processor.py#L143" class="external alias">
                    <span class="indicator-hook"></span>
                    row-by-row blocking
                  </a>
                </p>
                <p dir="auto">
                  Thus comparing to sglang, vLLM v0 is currently not up to par.
                </p>
                <h2 id="plan-reader" dir="auto">
                  plan
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#plan-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <ul dir="auto">
                  <li>
                    Implement
                    <a href="https://lmsys.org/blog/2024-02-05-compressed-fsm/#method-1-finite-state-machine-based" class="external alias">
                      <span class="indicator-hook"></span>
                      jump-ahead decoding
                    </a>
                    through a JSONWorker, we can then extend this to CFGWorker
                  </li>
                  <li>
                    similar to how spec decode is currently implemented in V0
                  </li>
                </ul>
                <p dir="auto">
                  <a href="https://github.com/cadedaniel" class="external">
                    <span class="indicator-hook"></span>
                    <strong>
                      @cadedaniel
                    </strong>
                  </a>
                  : “tree scoring in [spec decode] could use the same API as multi-path jump decoding.”
                </p>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        How should we handle FSM per requests?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <ul dir="auto">
                      <li>
                        Currently, users can specify different schemas per request, which means the FSM will be compiled per request. This is suboptimal because it slows down general TTFT.
                      </li>
                      <li>
                        For most use cases, we should assume JSON schema similar to how the system prompt is currently being handled (pass during server init)
                      </li>
                    </ul>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Why should we follow the plugins system?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <ul dir="auto">
                      <li>
                        If going with the best options, then what is the reasoning behind supporting different backends?
                      </li>
                      <li>
                        Agree for extensibility, but seems to add additional overhead.
                      </li>
                    </ul>
                  </div>
                </blockquote>
                <hr/>
                <h2 id="appendix-reader" dir="auto">
                  appendix.
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#appendix-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h2>
                <p dir="auto">
                  The following includes background information about guided generations.
                </p>
                <h3 id="batched-constrained-decoding-for-cfg-and-pda-reader" dir="auto">
                  batched constrained decoding for CFG and PDA
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#batched-constrained-decoding-for-cfg-and-pda-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  Implemented in
                  <a href="https://github.com/mlc-ai/xgrammar" class="external alias">
                    <span class="indicator-hook"></span>
                    mlc-ai/xgrammar
                  </a>
                </p>
                <blockquote class="callout quote" data-callout="quote">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Quote
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Combine bitmask in CB to send to GPU
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        IMPORTANT
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      operating on string level, not
                      <code>
                        token_id
                      </code>
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  <code>
                    GrammarMatcher
                  </code>
                  <span>
                    ⇒
                  </span>
                  FSM in xgrammar
                </p>
                <h4 id="questions-reader" dir="auto">
                  questions
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#questions-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    byte-level automaton
                  </li>
                </ul>
                <p dir="auto">
                  overhead of token_id
                  <span>
                    ⇒
                  </span>
                  string
                </p>
                <p dir="auto">
                  Token for context-independent tokens vs dependent tokens within the generation masks
                </p>
                <p dir="auto">
                  async pre-compile
                </p>
                <p dir="auto">
                  synchronize apply mask for CPU
                  <span>
                    →
                  </span>
                  GPU?
                </p>
                <p dir="auto">
                  How do we apply said masks to GPU block? Zero-overhead generations?
                </p>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        worst-case scenario for grammar compilation?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      mask gen overhead: 36
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  μ
                                </mi>
                                <mi>
                                  s
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \mu s
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                            <span class="mord mathnormal">
                              μ
                            </span>
                            <span class="mord mathnormal">
                              s
                            </span>
                          </span>
                        </span>
                      </span>
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        time linearly increase for batch size?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      parallelize for compilation.
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        do we need to parallelize on vLLM?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      no, xgrammar parallelize it, with
                      <code>
                        pthread
                      </code>
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        shape of masks?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      bitmask, tensors of vocab size
                      <span>
                        ⇒
                      </span>
                      concat with recast
                      <span>
                        ⇒
                      </span>
                      GPU
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        supported tokenizers?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      GLM yet to be supported (Nov 22nd)
                    </p>
                  </div>
                </blockquote>
                <blockquote class="callout question" data-callout="question">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        Given that detokenizer is in a separate process with vLLM, then can we stops duplicating this process?
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Currently with
                      <code>
                        xgrammar
                      </code>
                      : detokenizer included in mask generations.
                    </p>
                    <p dir="auto">
                      token_id
                      <span>
                        ⇒
                      </span>
                      tokens
                    </p>
                  </div>
                </blockquote>
                <h4 id="future-plans-reader" dir="auto">
                  future plans
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#future-plans-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    Function calling support
                  </li>
                  <li>
                    Support more grammar (CFG, Python grammar)
                  </li>
                </ul>
                <h3 id="compressed-fsm-for-jump-ahead-tokens-reader" dir="auto">
                  compressed FSM for jump-ahead tokens.
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#compressed-fsm-for-jump-ahead-tokens-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  Implemented in
                  <cite class id="citation--zheng2024sglangefficientexecutionstructured--1">
                    (
                    <a href="#bib-zheng2024sglangefficientexecutionstructured-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Zheng et al., 2024
                    </a>
                    )
                  </cite>
                </p>
                <h4 id="method-1-fsm-based-decoding-reader" dir="auto">
                  Method 1:
                  <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#guided-generations-with-fsm" class="internal" data-slug="thoughts/constrained-decoding" data-no-popover="true">
                    <span class="indicator-hook"></span>
                    FSM
                  </a>
                  -based decoding
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-1-fsm-based-decoding-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    <p dir="auto">
                      intuition: Using FSM
                      <cite class id="citation--willard2023efficientguidedgenerationlarge--2">
                        (
                        <a href="#bib-willard2023efficientguidedgenerationlarge-reader" data-no-popover="true" data-bib class="internal">
                          <span class="indicator-hook"></span>
                          Willard &amp; Louf, 2023
                        </a>
                        )
                      </cite>
                      to guide generations by increasing logit bias for tokens that conform to given JSON schema. This allows us to track the current state during decoding and filter out invalid tokens by applying logit bias to the output.
                      <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/constrained-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                    </p>
                  </li>
                  <li>
                    <p dir="auto">
                      limitation: we can see that given construction of FSM requires token-level access, it can only transition the state by only
                      <em>
                        one
                      </em>
                      token at a time, resulting in slow decoding.
                    </p>
                  </li>
                </ul>
                <h4 id="method-2-interleaved-based-reader" dir="auto">
                  Method 2: Interleaved-based
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-2-interleaved-based-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <ul dir="auto">
                  <li>
                    <p dir="auto">
                      intuition: breaks down JSON schemas, each containing either a chunk prefill part or constrained decoding part. They are then executed interleaved by inference system.
                      Faster than per-token decoding given that chunked prefill components can process multiple tokens per forward pass
                    </p>
                    <p dir="auto">
                      See also
                      <a href="https://github.com/guidance-ai/guidance#guidance-acceleration" class="external">
                        <span class="indicator-hook"></span>
                        https://github.com/guidance-ai/guidance#guidance-acceleration
                      </a>
                      using llama.cpp as backend.
                    </p>
                  </li>
                  <li>
                    <p dir="auto">
                      limitation:
                    </p>
                    <ul dir="auto">
                      <li>
                        interleaved-based require custom syntax, making it less expressive compared to regex.
                      </li>
                      <li>
                        struggles to deal with tokenization boundaries due to conflicts between decode and chunked prefill segments.
                      </li>
                      <li>
                        frequent communications between interpreter and back-end adds additional overhead.
                      </li>
                    </ul>
                  </li>
                </ul>
                <h4 id="method-3-jump-forward-decoding-with-compressed-fsm-reader" dir="auto">
                  <strong>
                    <mark>
                      Method 3: Jump-Forward Decoding with compressed FSM
                    </mark>
                  </strong>
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#method-3-jump-forward-decoding-with-compressed-fsm-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h4>
                <p dir="auto">
                  <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/jump-forward-decoding-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                </p>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        tokenization boundary handling
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      During decoding, it is preferred to combine multiple characters into a single tokens.
                    </p>
                    <p dir="auto">
                      For example, when decoding
                      <code>
                        &quot;Hello&quot;
                      </code>
                      in context of JSON decoding, LLM might output the following token
                      <code>
                        &quot;
                      </code>
                      ,
                      <code>
                        He
                      </code>
                      ,
                      <code>
                        llo
                      </code>
                      ,
                      <code>
                        &quot;,
                      </code>
                    </p>
                    <p dir="auto">
                      This may cause some strange behaviour if we combine the last
                      <code>
                        &quot;
                      </code>
                      with
                      <code>
                        ,
                      </code>
                      (this regex
                      <code>
                        &quot;[\w\d\s]*&quot;
                      </code>
                      with the last
                      <code>
                        ,
                      </code>
                      will lead to endless decoding because this token
                      <code>
                        &quot;,
                      </code>
                      is not valid even if the LM wants to stop.)
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  Fix:
                </p>
                <ul dir="auto">
                  <li>
                    implement
                    <mark>
                      re-tokenization
                    </mark>
                    mechanism during jump-forward phase (append string instead of the tokens, followed with re-tokenization of the entire text)
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mo>
                                →
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \to
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.3669em;"></span>
                          <span class="mrel">
                            →
                          </span>
                        </span>
                      </span>
                    </span>
                    add approximately 4% of overhead
                  </li>
                  <li>
                    use a comprehensive regex to guide the decoding phase, instead of employing multiple concatenated regex
                    <sup>
                      <a href="#user-content-fn-coalescence-reader" id="user-content-fnref-coalescence-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        5
                      </a>
                    </sup>
                  </li>
                </ul>
                <h3 id="coalescence-reader" dir="auto">
                  Coalescence
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#coalescence-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  intuition: Instead of expanding to
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              n
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            n
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          n
                        </span>
                      </span>
                    </span>
                  </span>
                  state, we can compress certain chunks into one state to reduce the size of said FSM.
                </p>
                <p dir="auto">
                  <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/part-of-json-fsm.webp" width="auto" height="auto" alt loading="lazy"/>
                  <em>
                    figure 1: initial FSM state
                  </em>
                </p>
                <p dir="auto">
                  <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/compressed-fsm-json.webp" width="auto" height="auto" alt loading="lazy"/>
                  <em>
                    figure 2: compressed FSM state
                  </em>
                </p>
                <p dir="auto">
                  A way to adapt character regex to work with tokens in
                  <code>
                    outlines
                  </code>
                  :
                </p>
                <figure data-rehype-pretty-code-figure>
                  <pre tabindex="0" data-language="python"><code data-language="python" style="display:grid;"><span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">import</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> outlines</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">as</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> fsm</span></span>
<span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">from</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> outlines</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">regex </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">import</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> make_deterministic_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> create_fsm_index_tokenizer</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">new_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> _ </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> make_deterministic_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">(</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">)</span></span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">idx</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> _ </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> create_fsm_index_tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">(</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">new_fsm</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">)</span></span></code></pre>
                </figure>
                <pre><code class="mermaid" data-clipboard="stateDiagram-v2
    [*] --> InputPrompt: Start

    state &quot;input prompt&quot; as InputPrompt
    state &quot;next-token probability distribution&quot; as GetProb
    state &quot;valid tokens&quot; as ListTokens {
        [*] --> CheckTransitions
        CheckTransitions --> FilterTokens: Get index[0].keys()
        FilterTokens --> [*]
    }
    state &quot;Sample Token&quot; as SampleToken
    state &quot;Update FSM State&quot; as UpdateState

    InputPrompt --> GetProb: &quot;model.generate&quot;
    GetProb --> ListTokens: Get next-token distribution
    ListTokens --> SampleToken: Use filtered token list
    SampleToken --> UpdateState: Selected token X
    UpdateState --> [*]: new_state = index[0][&quot;X&quot;]">stateDiagram-v2
    [*] --> InputPrompt: Start

    state &quot;input prompt&quot; as InputPrompt
    state &quot;next-token probability distribution&quot; as GetProb
    state &quot;valid tokens&quot; as ListTokens {
        [*] --> CheckTransitions
        CheckTransitions --> FilterTokens: Get index[0].keys()
        FilterTokens --> [*]
    }
    state &quot;Sample Token&quot; as SampleToken
    state &quot;Update FSM State&quot; as UpdateState

    InputPrompt --> GetProb: &quot;model.generate&quot;
    GetProb --> ListTokens: Get next-token distribution
    ListTokens --> SampleToken: Use filtered token list
    SampleToken --> UpdateState: Selected token X
    UpdateState --> [*]: new_state = index[0][&quot;X&quot;]</code></pre>
                <figure data-rehype-pretty-code-figure>
                  <pre tabindex="0" data-language="python"><code data-language="python" style="display:grid;"><span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">idx_with_tokens </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span></span>
<span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  state</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">tokenizer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">decode</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">([</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">key</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">]):</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> value </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">for</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> key</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> value </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">in</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> transitions</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">items</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">()}</span></span>
<span data-line><span style="--shiki-light:#286983;--shiki-dark:#31748F;">  for</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> state</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> transitions </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">in</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> idx</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">.</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">items</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">()</span></span>
<span data-line><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span></span></code></pre>
                </figure>
                <blockquote class="callout" data-callout="note" data-callout-fold>
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        example
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <pre><code class="mermaid" data-clipboard="stateDiagram-v2
    direction LR
    0 --> 2: n
    0 --> 1: t
    1 --> 2: a
    2 --> 4: na
    2 --> 3: a
    3 --> 5: am
    4 --> 6: me
    5 --> 6: me
    2 --> 6: name
    6 --> 7: e
    6 --> 8: c
    7 --> 9: p
    8 --> 9: p
    9 --> 11: Paul
    9 --> 12: Pa
    9 --> 10: Jo
    11 --> 13: aul
    12 --> 14: ul
    10 --> 26: o
    26 --> 27: h
    27 --> 14: n
    13 --> 14: l
    14 --> 16: s
    14 --> 15: s
    15 --> 17: s
    16 --> 17: s
    17 --> 18: a
    17 --> 19: ag
    18 --> 20: ge
    19 --> 20: e
    20 --> 21: 30
    20 --> 22: 20
    21 --> 24: 2
    22 --> 24: 2
    22 --> 23: 3
    24 --> 25: 0
    25 --> [*]">stateDiagram-v2
    direction LR
    0 --> 2: n
    0 --> 1: t
    1 --> 2: a
    2 --> 4: na
    2 --> 3: a
    3 --> 5: am
    4 --> 6: me
    5 --> 6: me
    2 --> 6: name
    6 --> 7: e
    6 --> 8: c
    7 --> 9: p
    8 --> 9: p
    9 --> 11: Paul
    9 --> 12: Pa
    9 --> 10: Jo
    11 --> 13: aul
    12 --> 14: ul
    10 --> 26: o
    26 --> 27: h
    27 --> 14: n
    13 --> 14: l
    14 --> 16: s
    14 --> 15: s
    15 --> 17: s
    16 --> 17: s
    17 --> 18: a
    17 --> 19: ag
    18 --> 20: ge
    19 --> 20: e
    20 --> 21: 30
    20 --> 22: 20
    21 --> 24: 2
    22 --> 24: 2
    22 --> 23: 3
    24 --> 25: 0
    25 --> [*]</code></pre>
                  </div>
                </blockquote>
                <p dir="auto">
                  <em>
                    note:
                  </em>
                  each state of FSM represents a forward pass to the LM. In vanilla generation, this is essentially necessary. Thus there is no added overhead of FSM for controlling the generated outputs.
                </p>
                <p dir="auto">
                  From state 2-6, we observer that there are eight different paths to get the same generations of
                  <code>
                    name
                  </code>
                  . We probably don’t need to do this, given that it will all give us result
                  <code>
                    name
                  </code>
                </p>
                <p dir="auto">
                  But suffice to say, we can hijack this behaviour to accelerate generations by append either of the following tokens
                  <strong>
                    word
                  </strong>
                  to currently generated sequence:
                </p>
                <ul dir="auto">
                  <li>
                    [”name”]
                  </li>
                  <li>
                    [”n”, “a”, “m”, “e”]
                  </li>
                  <li>
                    [”na”, “m”, “e”]
                  </li>
                  <li>
                    [”nam”, “e”]
                  </li>
                  <li>
                    [”n”, “am”, “e”]
                  </li>
                  <li>
                    [”n”, “ame”]
                  </li>
                  <li>
                    [”na”, “me”]
                  </li>
                  <li>
                    [”n”, “a”, “me”]
                  </li>
                </ul>
                <p dir="auto">
                  A simplified index can be shown as:
                </p>
                <figure data-rehype-pretty-code-figure>
                  <pre tabindex="0" data-language="python"><code data-language="python" style="display:grid;"><span data-line><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">simplified_index </span><span style="--shiki-light:#286983;--shiki-dark:#31748F;">=</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    0</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'{&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 2</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    2</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&quot;name&quot;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 6</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    6</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;:&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 9</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    9</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'Paul'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> 'John'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    14</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;,&quot;'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 17</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    17</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'age'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 20</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    20</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'&quot;:'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 22</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    22</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'20'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">,</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> '30'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;">    24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> {</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">'}'</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">:</span><span style="--shiki-light:#D7827E;--shiki-dark:#EBBCBA;"> 25</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">},</span></span>
<span data-line><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span></span></code></pre>
                </figure>
                <p dir="auto">
                  That’s at least a 5x speedup over structured generations, given that out of the 9 tokens, two states are single-state transitions. Therefore we only need to call the model
                  <mark>
                    twice
                  </mark>
                  !!
                </p>
                <blockquote class="callout" data-callout="tip" data-callout-fold>
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        difference in sampling distribution
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      All these paths lead to the same string and the same speedup, however they lead to potentially very different states for the LLM when it reaches state 6. That is, the strings are the same, but each path leads to a different conditional probability distribution in stage 6.
                    </p>
                    <p dir="auto">
                      <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/json-difference-in-sampling-distribution.webp" width="auto" height="auto" alt loading="lazy"/>
                    </p>
                  </div>
                </blockquote>
                <h3 id="guided-generations-with-fsm-reader" dir="auto">
                  Guided generations with FSM.
                  <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#guided-generations-with-fsm-reader" class="internal">
                    <span class="indicator-hook"></span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                  </a>
                </h3>
                <p dir="auto">
                  <cite class id="citation--willard2023efficientguidedgenerationlarge--3">
                    (
                    <a href="#bib-willard2023efficientguidedgenerationlarge-reader" data-no-popover="true" data-bib class="internal">
                      <span class="indicator-hook"></span>
                      Willard &amp; Louf, 2023
                    </a>
                    )
                  </cite>
                  , implemented at
                  <a href="https://github.com/dottxt-ai/outlines" class="external">
                    <span class="indicator-hook"></span>
                    https://github.com/dottxt-ai/outlines
                  </a>
                </p>
                <p dir="auto">
                  <em>
                    assumption: we are building against
                    <a href="../thoughts/constrained-decoding/../../thoughts/Autoregressive-models" class="internal" data-slug="thoughts/Autoregressive-models" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      autoregressive transformers models
                    </a>
                  </em>
                </p>
                <ul dir="auto">
                  <li>
                    Let
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi mathvariant="script">
                                F
                              </mi>
                              <mo>
                                ⊂
                              </mo>
                              <mi mathvariant="script">
                                P
                              </mi>
                              <mo stretchy="false">
                                (
                              </mo>
                              <mi mathvariant="script">
                                V
                              </mi>
                              <mo stretchy="false">
                                )
                              </mo>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \mathcal{F} \subset \mathcal{P}(\mathcal{V})
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                          <span class="mord mathcal" style="margin-right:0.09931em;">
                            F
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            ⊂
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                          <span class="mord mathcal" style="margin-right:0.08222em;">
                            P
                          </span>
                          <span class="mopen">
                            (
                          </span>
                          <span class="mord mathcal" style="margin-right:0.08222em;">
                            V
                          </span>
                          <span class="mclose">
                            )
                          </span>
                        </span>
                      </span>
                    </span>
                    , where
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi mathvariant="script">
                                P
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \mathcal{P}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathcal" style="margin-right:0.08222em;">
                            P
                          </span>
                        </span>
                      </span>
                    </span>
                    is the power set operator, be subset of multi-token string that ends with tokens
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mtext>
                                EOS
                              </mtext>
                              <mo>
                                ∈
                              </mo>
                              <mi mathvariant="script">
                                V
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \text{EOS} \in \mathcal{V}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                          <span class="mord text">
                            <span class="mord">
                              EOS
                            </span>
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                          <span class="mrel">
                            ∈
                          </span>
                          <span class="mspace" style="margin-right:0.2778em;"></span>
                        </span>
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathcal" style="margin-right:0.08222em;">
                            V
                          </span>
                        </span>
                      </span>
                    </span>
                    .
                  </li>
                  <li>
                    Text generation tasks is to draw samples from
                    <span class="katex">
                      <span class="katex-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <mrow>
                              <mi mathvariant="script">
                                F
                              </mi>
                            </mrow>
                            <annotation encoding="application/x-tex">
                              \mathcal{F}
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <span class="katex-html" aria-hidden="true">
                        <span class="base">
                          <span class="strut" style="height:0.6833em;"></span>
                          <span class="mord mathcal" style="margin-right:0.09931em;">
                            F
                          </span>
                        </span>
                      </span>
                    </span>
                  </li>
                </ul>
                <p dir="auto">
                  Notable
                  <mark>
                    sampling
                  </mark>
                  methods include greedy decoding (generate tokens recursively with highest probability tokens), beam search (but using heuristic to find the mode of distribution)
                  <sup>
                    <a href="#user-content-fn-smc-reader" id="user-content-fnref-smc-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                      <span class="indicator-hook"></span>
                      6
                    </a>
                  </sup>
                </p>
                <p dir="auto">
                  A pseudocode for sampling procedure is as follow:
                </p>
                <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                  <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                    <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                      <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                    </svg>
                    <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                    </svg>
                  </button>
                  <span class="ps-mathml">
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                      <semantics>
                        <annotation encoding="application/x-tex">
                          &quot;\\begin{algorithm}\n\\caption{LLM token sampling}\n\\begin{algorithmic}\n\\Function{sample}{$L$}\n    \\State $s \\gets ()$\n    \\For{$i \\gets 1, L$}\n        \\State $\\alpha \\gets \\text{LM}(s, \\theta)$\n        \\State Sample $s \\sim \\text{Categorical}(\\alpha)$\n        \\If{$s = \\text{EOS}$}\n            \\State \\textbf{break}\n        \\EndIf\n        \\State $s \\gets \\text{append}(s, s)$\n    \\EndFor\n    \\State \\Return $s$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                        </annotation>
                      </semantics>
                    </math>
                  </span>
                  <div class="ps-algorithm with-caption" dir="auto">
                    <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                      <span class="ps-keyword">
                        Algorithm 1
                      </span>
                      LLM token sampling
                    </p>
                    <div class="ps-algorithmic with-linenum" dir="auto">
                      <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            1:
                          </span>
                          <span class="ps-keyword">
                            function
                          </span>
                          <span class="ps-funcname">
                            sample
                          </span>
                          (
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      L
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    L
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathnormal">
                                  L
                                </span>
                              </span>
                            </span>
                          </span>
                          )
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              2:
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        s
                                      </mi>
                                      <mo>
                                        ←
                                      </mo>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      s \gets ()
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal">
                                    s
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    ←
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              3:
                            </span>
                            <span class="ps-keyword">
                              for
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        i
                                      </mi>
                                      <mo>
                                        ←
                                      </mo>
                                      <mn>
                                        1
                                      </mn>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        L
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      i \gets 1, L
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.6595em;"></span>
                                  <span class="mord mathnormal">
                                    i
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    ←
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                  <span class="mord">
                                    1
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord mathnormal">
                                    L
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="ps-keyword">
                              do
                            </span>
                          </p>
                          <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                4:
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          α
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mtext>
                                          LM
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          s
                                        </mi>
                                        <mo separator="true">
                                          ,
                                        </mo>
                                        <mi>
                                          θ
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \alpha \gets \text{LM}(s, \theta)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.0037em;">
                                      α
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        LM
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mpunct">
                                      ,
                                    </span>
                                    <span class="mspace" style="margin-right:0.1667em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.02778em;">
                                      θ
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                5:
                              </span>
                              Sample
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          s
                                        </mi>
                                        <mo>
                                          ∼
                                        </mo>
                                        <mtext>
                                          Categorical
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          α
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        s \sim \text{Categorical}(\alpha)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ∼
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        Categorical
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal" style="margin-right:0.0037em;">
                                      α
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                6:
                              </span>
                              <span class="ps-keyword">
                                if
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          s
                                        </mi>
                                        <mo>
                                          =
                                        </mo>
                                        <mtext>
                                          EOS
                                        </mtext>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        s = \text{EOS}
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      =
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        EOS
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="ps-keyword">
                                then
                              </span>
                            </p>
                            <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  7:
                                </span>
                                <span style="font-weight:bold;">
                                  break
                                </span>
                              </p>
                            </div>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                8:
                              </span>
                              <span class="ps-keyword">
                                end if
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                9:
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          s
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mtext>
                                          append
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          s
                                        </mi>
                                        <mo separator="true">
                                          ,
                                        </mo>
                                        <mi>
                                          s
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        s \gets \text{append}(s, s)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        append
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mpunct">
                                      ,
                                    </span>
                                    <span class="mspace" style="margin-right:0.1667em;"></span>
                                    <span class="mord mathnormal">
                                      s
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                          </div>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              10:
                            </span>
                            <span class="ps-keyword">
                              end for
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              11:
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              12:
                            </span>
                            <span class="ps-keyword">
                              return
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        s
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      s
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal">
                                    s
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            13:
                          </span>
                          <span class="ps-keyword">
                            end function
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <p dir="auto">
                  Given that we are dealing with finite discrete distribution, we can then compute an un-normalized conditional distribution by applying a boolean mask
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              m
                            </mi>
                            <mo>
                              :
                            </mo>
                            <mi mathvariant="script">
                              P
                            </mi>
                            <mo stretchy="false">
                              (
                            </mo>
                            <mi mathvariant="script">
                              V
                            </mi>
                            <mo stretchy="false">
                              )
                            </mo>
                            <mo>
                              →
                            </mo>
                            <mo stretchy="false">
                              {
                            </mo>
                            <mn>
                              0
                            </mn>
                            <mo separator="true">
                              ,
                            </mo>
                            <mn>
                              1
                            </mn>
                            <msup>
                              <mo stretchy="false">
                                }
                              </mo>
                              <mi>
                                N
                              </mi>
                            </msup>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            m: \mathcal{P}(\mathcal{V}) \to \{0,1\}^N
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal">
                          m
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          :
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                        <span class="mord mathcal" style="margin-right:0.08222em;">
                          P
                        </span>
                        <span class="mopen">
                          (
                        </span>
                        <span class="mord mathcal" style="margin-right:0.08222em;">
                          V
                        </span>
                        <span class="mclose">
                          )
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                        <span class="mrel">
                          →
                        </span>
                        <span class="mspace" style="margin-right:0.2778em;"></span>
                      </span>
                      <span class="base">
                        <span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span>
                        <span class="mopen">
                          {
                        </span>
                        <span class="mord">
                          0
                        </span>
                        <span class="mpunct">
                          ,
                        </span>
                        <span class="mspace" style="margin-right:0.1667em;"></span>
                        <span class="mord">
                          1
                        </span>
                        <span class="mclose">
                          <span class="mclose">
                            }
                          </span>
                          <span class="msupsub">
                            <span class="vlist-t">
                              <span class="vlist-r">
                                <span class="vlist" style="height:0.8413em;">
                                  <span style="top:-3.063em;margin-right:0.05em;">
                                    <span class="pstrut" style="height:2.7em;"></span>
                                    <span class="sizing reset-size6 size3 mtight">
                                      <span class="mord mathnormal mtight" style="margin-right:0.10903em;">
                                        N
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                  , which restricts the support of original distribution:
                </p>
                <span class="katex-display">
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                        <semantics>
                          <mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em">
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mi>
                                    α
                                  </mi>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      =
                                    </mo>
                                    <mtext>
                                      LM
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mover accent="true">
                                      <msub>
                                        <mi>
                                          S
                                        </mi>
                                        <mi>
                                          t
                                        </mi>
                                      </msub>
                                      <mo>
                                        ~
                                      </mo>
                                    </mover>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      θ
                                    </mi>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mover accent="true">
                                    <mi>
                                      α
                                    </mi>
                                    <mo>
                                      ~
                                    </mo>
                                  </mover>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      =
                                    </mo>
                                    <mi>
                                      m
                                    </mi>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mover accent="true">
                                      <msub>
                                        <mi>
                                          S
                                        </mi>
                                        <mi>
                                          t
                                        </mi>
                                      </msub>
                                      <mo>
                                        ~
                                      </mo>
                                    </mover>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                    <mo>
                                      ⊙
                                    </mo>
                                    <mi>
                                      α
                                    </mi>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                            <mtr>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mover accent="true">
                                    <msub>
                                      <mi>
                                        s
                                      </mi>
                                      <mrow>
                                        <mi>
                                          t
                                        </mi>
                                        <mo>
                                          +
                                        </mo>
                                        <mn>
                                          1
                                        </mn>
                                      </mrow>
                                    </msub>
                                    <mo>
                                      ~
                                    </mo>
                                  </mover>
                                </mstyle>
                              </mtd>
                              <mtd>
                                <mstyle scriptlevel="0" displaystyle="true">
                                  <mrow>
                                    <mrow></mrow>
                                    <mo>
                                      ≈
                                    </mo>
                                    <mtext>
                                      Categorial
                                    </mtext>
                                    <mo stretchy="false">
                                      (
                                    </mo>
                                    <mover accent="true">
                                      <mi>
                                        α
                                      </mi>
                                      <mo>
                                        ~
                                      </mo>
                                    </mover>
                                    <mo stretchy="false">
                                      )
                                    </mo>
                                  </mrow>
                                </mstyle>
                              </mtd>
                            </mtr>
                          </mtable>
                          <annotation encoding="application/x-tex">
                            \begin{aligned}
                            \alpha &amp;= \text{LM}(\tilde{S_t}, \theta) \\
                            \tilde{\alpha} &amp;= m(\tilde{S_t}) \odot \alpha \\
                            \tilde{s_{t+1}} &amp;\approx \text{Categorial}(\tilde{\alpha})
                            \end{aligned}
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:4.6604em;vertical-align:-2.0802em;"></span>
                        <span class="mord">
                          <span class="mtable">
                            <span class="col-align-r">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5802em;">
                                    <span style="top:-4.66em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.0037em;">
                                          α
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.0798em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.2222em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-1.5798em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord accent">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord">
                                                    <span class="mord mathnormal">
                                                      s
                                                    </span>
                                                    <span class="msupsub">
                                                      <span class="vlist-t vlist-t2">
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.3011em;">
                                                            <span style="top:-2.55em;margin-left:0em;margin-right:0.05em;">
                                                              <span class="pstrut" style="height:2.7em;"></span>
                                                              <span class="sizing reset-size6 size3 mtight">
                                                                <span class="mord mtight">
                                                                  <span class="mord mathnormal mtight">
                                                                    t
                                                                  </span>
                                                                  <span class="mbin mtight">
                                                                    +
                                                                  </span>
                                                                  <span class="mord mtight">
                                                                    1
                                                                  </span>
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span class="vlist-s">
                                                            ​
                                                          </span>
                                                        </span>
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.2083em;">
                                                            <span></span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.25em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.2083em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.0802em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="col-align-l">
                              <span class="vlist-t vlist-t2">
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.5802em;">
                                    <span style="top:-4.66em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            LM
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord accent">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.9202em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord">
                                                    <span class="mord mathnormal" style="margin-right:0.05764em;">
                                                      S
                                                    </span>
                                                    <span class="msupsub">
                                                      <span class="vlist-t vlist-t2">
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.2806em;">
                                                            <span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;">
                                                              <span class="pstrut" style="height:2.7em;"></span>
                                                              <span class="sizing reset-size6 size3 mtight">
                                                                <span class="mord mathnormal mtight">
                                                                  t
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span class="vlist-s">
                                                            ​
                                                          </span>
                                                        </span>
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.15em;">
                                                            <span></span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.6023em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.25em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.02778em;">
                                          θ
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-3.0798em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord mathnormal">
                                          m
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord accent">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.9202em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord">
                                                    <span class="mord mathnormal" style="margin-right:0.05764em;">
                                                      S
                                                    </span>
                                                    <span class="msupsub">
                                                      <span class="vlist-t vlist-t2">
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.2806em;">
                                                            <span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;">
                                                              <span class="pstrut" style="height:2.7em;"></span>
                                                              <span class="sizing reset-size6 size3 mtight">
                                                                <span class="mord mathnormal mtight">
                                                                  t
                                                                </span>
                                                              </span>
                                                            </span>
                                                          </span>
                                                          <span class="vlist-s">
                                                            ​
                                                          </span>
                                                        </span>
                                                        <span class="vlist-r">
                                                          <span class="vlist" style="height:0.15em;">
                                                            <span></span>
                                                          </span>
                                                        </span>
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span style="top:-3.6023em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.25em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                        <span class="mbin">
                                          ⊙
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.0037em;">
                                          α
                                        </span>
                                      </span>
                                    </span>
                                    <span style="top:-1.5798em;">
                                      <span class="pstrut" style="height:3em;"></span>
                                      <span class="mord">
                                        <span class="mord"></span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ≈
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            Categorial
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.2222em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="vlist-s">
                                    ​
                                  </span>
                                </span>
                                <span class="vlist-r">
                                  <span class="vlist" style="height:2.0802em;">
                                    <span></span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </span>
                        </span>
                      </span>
                    </span>
                  </span>
                </span>
                <blockquote class="callout math" data-callout="math">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        augmentation upon sampling algorithm
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                      <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                        <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                          <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                          <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                        </svg>
                        <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                          <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                        </svg>
                      </button>
                      <span class="ps-mathml">
                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                          <semantics>
                            <annotation encoding="application/x-tex">
                              &quot;\\begin{algorithm}\n\\caption{token sampling with masking}\n\\begin{algorithmic}\n\\Function{sample}{$L$}\n    \\State $s \\gets ()$\n    \\For{$i \\gets 1, L$}\n        \\State $\\alpha \\gets \\text{LM}(s, \\theta)$\n        \\State Construct the mask m($s$)\n        \\State $\\tilde{\\alpha} \\gets m \\odot \\alpha$\n        \\State Sample $\\tilde{s} \\sim \\text{Categorical}(\\tilde{\\alpha})$\n        \\If{$\\tilde{s} = \\text{EOS}$}\n            \\State \\textbf{break}\n        \\EndIf\n        \\State $s \\gets \\text{append}(s, \\tilde{s})$\n    \\EndFor\n    \\State \\Return $s$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                            </annotation>
                          </semantics>
                        </math>
                      </span>
                      <div class="ps-algorithm with-caption" dir="auto">
                        <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                          <span class="ps-keyword">
                            Algorithm 2
                          </span>
                          token sampling with masking
                        </p>
                        <div class="ps-algorithmic with-linenum" dir="auto">
                          <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:0em;">
                                1:
                              </span>
                              <span class="ps-keyword">
                                function
                              </span>
                              <span class="ps-funcname">
                                sample
                              </span>
                              (
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          L
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        L
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathnormal">
                                      L
                                    </span>
                                  </span>
                                </span>
                              </span>
                              )
                            </p>
                            <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-0.75em;">
                                  2:
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            s
                                          </mi>
                                          <mo>
                                            ←
                                          </mo>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          s \gets ()
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.4306em;"></span>
                                      <span class="mord mathnormal">
                                        s
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ←
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-0.75em;">
                                  3:
                                </span>
                                <span class="ps-keyword">
                                  for
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            i
                                          </mi>
                                          <mo>
                                            ←
                                          </mo>
                                          <mn>
                                            1
                                          </mn>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <mi>
                                            L
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          i \gets 1, L
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6595em;"></span>
                                      <span class="mord mathnormal">
                                        i
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ←
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                      <span class="mord">
                                        1
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord mathnormal">
                                        L
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="ps-keyword">
                                  do
                                </span>
                              </p>
                              <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    4:
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              α
                                            </mi>
                                            <mo>
                                              ←
                                            </mo>
                                            <mtext>
                                              LM
                                            </mtext>
                                            <mo stretchy="false">
                                              (
                                            </mo>
                                            <mi>
                                              s
                                            </mi>
                                            <mo separator="true">
                                              ,
                                            </mo>
                                            <mi>
                                              θ
                                            </mi>
                                            <mo stretchy="false">
                                              )
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \alpha \gets \text{LM}(s, \theta)
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.4306em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.0037em;">
                                          α
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            LM
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord mathnormal">
                                          s
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.02778em;">
                                          θ
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    5:
                                  </span>
                                  Construct the mask m(
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              s
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            s
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.4306em;"></span>
                                        <span class="mord mathnormal">
                                          s
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  )
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    6:
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mover accent="true">
                                              <mi>
                                                α
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                            <mo>
                                              ←
                                            </mo>
                                            <mi>
                                              m
                                            </mi>
                                            <mo>
                                              ⊙
                                            </mo>
                                            <mi>
                                              α
                                            </mi>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \tilde{\alpha} \gets m \odot \alpha
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6679em;"></span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.2222em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span>
                                        <span class="mord mathnormal">
                                          m
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                        <span class="mbin">
                                          ⊙
                                        </span>
                                        <span class="mspace" style="margin-right:0.2222em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:0.4306em;"></span>
                                        <span class="mord mathnormal" style="margin-right:0.0037em;">
                                          α
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    7:
                                  </span>
                                  Sample
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mover accent="true">
                                              <mi>
                                                s
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                            <mo>
                                              ∼
                                            </mo>
                                            <mtext>
                                              Categorical
                                            </mtext>
                                            <mo stretchy="false">
                                              (
                                            </mo>
                                            <mover accent="true">
                                              <mi>
                                                α
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                            <mo stretchy="false">
                                              )
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \tilde{s} \sim \text{Categorical}(\tilde{\alpha})
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6679em;"></span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.1944em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ∼
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            Categorical
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal" style="margin-right:0.0037em;">
                                                    α
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.2222em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    8:
                                  </span>
                                  <span class="ps-keyword">
                                    if
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mover accent="true">
                                              <mi>
                                                s
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                            <mo>
                                              =
                                            </mo>
                                            <mtext>
                                              EOS
                                            </mtext>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \tilde{s} = \text{EOS}
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.6679em;"></span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.1944em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          =
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:0.6833em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            EOS
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="ps-keyword">
                                    then
                                  </span>
                                </p>
                                <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                  <p class="ps-line ps-code" dir="auto">
                                    <span class="ps-linenum" style="left:-2.25em;">
                                      9:
                                    </span>
                                    <span style="font-weight:bold;">
                                      break
                                    </span>
                                  </p>
                                </div>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    10:
                                  </span>
                                  <span class="ps-keyword">
                                    end if
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-1.5em;">
                                    11:
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              s
                                            </mi>
                                            <mo>
                                              ←
                                            </mo>
                                            <mtext>
                                              append
                                            </mtext>
                                            <mo stretchy="false">
                                              (
                                            </mo>
                                            <mi>
                                              s
                                            </mi>
                                            <mo separator="true">
                                              ,
                                            </mo>
                                            <mover accent="true">
                                              <mi>
                                                s
                                              </mi>
                                              <mo>
                                                ~
                                              </mo>
                                            </mover>
                                            <mo stretchy="false">
                                              )
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            s \gets \text{append}(s, \tilde{s})
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.4306em;"></span>
                                        <span class="mord mathnormal">
                                          s
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                            append
                                          </span>
                                        </span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mord mathnormal">
                                          s
                                        </span>
                                        <span class="mpunct">
                                          ,
                                        </span>
                                        <span class="mspace" style="margin-right:0.1667em;"></span>
                                        <span class="mord accent">
                                          <span class="vlist-t">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.6679em;">
                                                <span style="top:-3em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="mord mathnormal">
                                                    s
                                                  </span>
                                                </span>
                                                <span style="top:-3.35em;">
                                                  <span class="pstrut" style="height:3em;"></span>
                                                  <span class="accent-body" style="left:-0.1944em;">
                                                    <span class="mord">
                                                      ~
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                              </div>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-0.75em;">
                                  12:
                                </span>
                                <span class="ps-keyword">
                                  end for
                                </span>
                              </p>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-0.75em;">
                                  13:
                                </span>
                              </p>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-0.75em;">
                                  14:
                                </span>
                                <span class="ps-keyword">
                                  return
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            s
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          s
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.4306em;"></span>
                                      <span class="mord mathnormal">
                                        s
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                            </div>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:0em;">
                                15:
                              </span>
                              <span class="ps-keyword">
                                end function
                              </span>
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </blockquote>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        finite automaton
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      We define a
                      <em>
                        finite-state machine
                      </em>
                      , given by
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <mi>
                                  Q
                                </mi>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mi mathvariant="normal">
                                  Σ
                                </mi>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mi>
                                  δ
                                </mi>
                                <mo separator="true">
                                  ,
                                </mo>
                                <msub>
                                  <mi>
                                    q
                                  </mi>
                                  <mn>
                                    0
                                  </mn>
                                </msub>
                                <mo separator="true">
                                  ,
                                </mo>
                                <mi>
                                  F
                                </mi>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                (Q, \Sigma , \delta, q_0, F)
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                            <span class="mopen">
                              (
                            </span>
                            <span class="mord mathnormal">
                              Q
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              Σ
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.03785em;">
                              δ
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord">
                              <span class="mord mathnormal" style="margin-right:0.03588em;">
                                q
                              </span>
                              <span class="msupsub">
                                <span class="vlist-t vlist-t2">
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.3011em;">
                                      <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                        <span class="pstrut" style="height:2.7em;"></span>
                                        <span class="sizing reset-size6 size3 mtight">
                                          <span class="mord mtight">
                                            0
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                    <span class="vlist-s">
                                      ​
                                    </span>
                                  </span>
                                  <span class="vlist-r">
                                    <span class="vlist" style="height:0.15em;">
                                      <span></span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="mpunct">
                              ,
                            </span>
                            <span class="mspace" style="margin-right:0.1667em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.13889em;">
                              F
                            </span>
                            <span class="mclose">
                              )
                            </span>
                          </span>
                        </span>
                      </span>
                      <sup>
                        <a href="#user-content-fn-automaton-definition-reader" id="user-content-fnref-automaton-definition-reader" data-footnote-ref aria-describedby="footnote-label" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          7
                        </a>
                      </sup>
                      where character comprising the strings in
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi mathvariant="script">
                                  V
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \mathcal{V}
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathcal" style="margin-right:0.08222em;">
                              V
                            </span>
                          </span>
                        </span>
                      </span>
                      are drawn from
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi mathvariant="normal">
                                  Σ
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \Sigma
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord">
                              Σ
                            </span>
                          </span>
                        </span>
                      </span>
                      , i.e:
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi mathvariant="script">
                                  V
                                </mi>
                                <mo>
                                  ∈
                                </mo>
                                <mi mathvariant="script">
                                  P
                                </mi>
                                <mo stretchy="false">
                                  (
                                </mo>
                                <mi mathvariant="normal">
                                  Σ
                                </mi>
                                <mo stretchy="false">
                                  )
                                </mo>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \mathcal{V} \in \mathcal{P}(\Sigma)
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span>
                            <span class="mord mathcal" style="margin-right:0.08222em;">
                              V
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                            <span class="mrel">
                              ∈
                            </span>
                            <span class="mspace" style="margin-right:0.2778em;"></span>
                          </span>
                          <span class="base">
                            <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                            <span class="mord mathcal" style="margin-right:0.08222em;">
                              P
                            </span>
                            <span class="mopen">
                              (
                            </span>
                            <span class="mord">
                              Σ
                            </span>
                            <span class="mclose">
                              )
                            </span>
                          </span>
                        </span>
                      </span>
                    </p>
                    <p dir="auto">
                      <img src="../thoughts/constrained-decoding/../../thoughts/images/vllm/fsm-iterative-generations.webp" width="auto" height="auto" alt loading="lazy"/>
                      >
                      <em>
                        FSM making for regular expression
                        <code>
                          ([0-9]*)?\.?[0-9]*
                        </code>
                      </em>
                    </p>
                    <blockquote class="callout" data-callout="note" data-callout-fold>
                      <div class="callout-title" dir="auto">
                        <div class="callout-title-inner" dir="auto">
                          <p dir="auto">
                            example illustration
                          </p>
                        </div>
                      </div>
                      <div class="callout-content" dir="auto">
                        <p dir="auto">
                          For simplicity, let the vocabulary
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi mathvariant="script">
                                      V
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \mathcal{V}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord mathcal" style="margin-right:0.08222em;">
                                  V
                                </span>
                              </span>
                            </span>
                          </span>
                          consists of strings
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mo stretchy="false">
                                      {
                                    </mo>
                                    <mi>
                                      A
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi mathvariant="normal">
                                      .
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mn>
                                      42
                                    </mn>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi mathvariant="normal">
                                      .
                                    </mi>
                                    <mn>
                                      2
                                    </mn>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mn>
                                      1
                                    </mn>
                                    <mo stretchy="false">
                                      }
                                    </mo>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \{A, ., 42, .2, 1\}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                <span class="mopen">
                                  {
                                </span>
                                <span class="mord mathnormal">
                                  A
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  .
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  42
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  .2
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord">
                                  1
                                </span>
                                <span class="mclose">
                                  }
                                </span>
                              </span>
                            </span>
                          </span>
                        </p>
                        <ul dir="auto">
                          <li>
                            generations start: FSM in state 0, so it masks “A”, since it wouldn’t accepted by the FSM. Then we only sample ”.”, “42”, “.2”, “1” in this case
                          </li>
                          <li>
                            if we sample “.2” then we advance the FSM to state 3. In this case. only “42” and “1” are valid completions, so we mask other values before sampling.
                            If we sample “1” instead, then we advance FSM to state 1, in which case ”.”, “.42”, “.2”, and “1” are valid completions
                          </li>
                        </ul>
                      </div>
                    </blockquote>
                  </div>
                </blockquote>
                <blockquote class="callout tip" data-callout="tip">
                  <div class="callout-title" dir="auto">
                    <div class="callout-title-inner" dir="auto">
                      <p dir="auto">
                        determinism
                      </p>
                    </div>
                  </div>
                  <div class="callout-content" dir="auto">
                    <p dir="auto">
                      Looping through the vocabulary is still the biggest issue. For that, we preprocess the vocabulary using Regex’s FSM and build a index.
                      Thus a proceeding for producing matches starting at any point in the FSM is required.
                    </p>
                  </div>
                </blockquote>
                <p dir="auto">
                  We define finding sub-sequences of FSM
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              M
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            M
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.6833em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.10903em;">
                          M
                        </span>
                      </span>
                    </span>
                  </span>
                  that accept string
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              v
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            v
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                          v
                        </span>
                      </span>
                    </span>
                  </span>
                  as follow:
                </p>
                <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                  <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                    <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                      <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                    </svg>
                    <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                    </svg>
                  </button>
                  <span class="ps-mathml">
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                      <semantics>
                        <annotation encoding="application/x-tex">
                          &quot;\\begin{algorithm}\n\\caption{Find sub-sequences of the FSM $M$ that accept the string $v$}\n\\begin{algorithmic}\n\\Function{FindSubSequences}{$M, v$}\n    \\State $M = (Q, \\Sigma, \\delta, q_0, F)$\n    \\State $\\texttt{res} \\gets ()$\n    \\For{$r \\in \\delta^{-1}(\\cdot, v_0)$} \\Comment{$\\text{ Loop through states that read } v_0$}\n        \\State $p \\gets (r)$\n        \\For{$i \\gets 1, |v| - 1$} \\Comment{$\\text{ Walk the FSM}$}\n            \\If{$\\delta(r, v_i) = \\emptyset$} \\Comment{$\\text{ The FSM does not read } v_i$}\n                \\State $p \\gets ()$\n                \\State \\textbf{break} \\Comment{$\\text{ Stop walking and try the next start state}$}\n            \\EndIf\n            \\State $r \\gets \\delta(r, v_i)$\n            \\State $p \\gets \\text{append}(p, r)$\n        \\EndFor\n        \\State $\\texttt{res} \\gets \\text{append}(\\texttt{res}, p)$\n    \\EndFor\n    \\State \\Return $\\texttt{res}$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                        </annotation>
                      </semantics>
                    </math>
                  </span>
                  <div class="ps-algorithm with-caption" dir="auto">
                    <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                      <span class="ps-keyword">
                        Algorithm 3
                      </span>
                      Find sub-sequences of the FSM
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  M
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                M
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.10903em;">
                              M
                            </span>
                          </span>
                        </span>
                      </span>
                      that accept the string
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi>
                                  v
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                v
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.4306em;"></span>
                            <span class="mord mathnormal" style="margin-right:0.03588em;">
                              v
                            </span>
                          </span>
                        </span>
                      </span>
                    </p>
                    <div class="ps-algorithmic with-linenum" dir="auto">
                      <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            1:
                          </span>
                          <span class="ps-keyword">
                            function
                          </span>
                          <span class="ps-funcname">
                            FindSubSequences
                          </span>
                          (
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      M
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi>
                                      v
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    M, v
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.10903em;">
                                  M
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.03588em;">
                                  v
                                </span>
                              </span>
                            </span>
                          </span>
                          )
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              2:
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        M
                                      </mi>
                                      <mo>
                                        =
                                      </mo>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mi>
                                        Q
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi mathvariant="normal">
                                        Σ
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        δ
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <msub>
                                        <mi>
                                          q
                                        </mi>
                                        <mn>
                                          0
                                        </mn>
                                      </msub>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        F
                                      </mi>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      M = (Q, \Sigma, \delta, q_0, F)
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.6833em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.10903em;">
                                    M
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    =
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mord mathnormal">
                                    Q
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    Σ
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03785em;">
                                    δ
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      q
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t vlist-t2">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.3011em;">
                                            <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mtight">
                                                  0
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="vlist-s">
                                            ​
                                          </span>
                                        </span>
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.15em;">
                                            <span></span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.13889em;">
                                    F
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              3:
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mtext mathvariant="monospace">
                                        res
                                      </mtext>
                                      <mo>
                                        ←
                                      </mo>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \texttt{res} \gets ()
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord text">
                                    <span class="mord texttt">
                                      res
                                    </span>
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    ←
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              4:
                            </span>
                            <span class="ps-keyword">
                              for
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        r
                                      </mi>
                                      <mo>
                                        ∈
                                      </mo>
                                      <msup>
                                        <mi>
                                          δ
                                        </mi>
                                        <mrow>
                                          <mo>
                                            −
                                          </mo>
                                          <mn>
                                            1
                                          </mn>
                                        </mrow>
                                      </msup>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mo>
                                        ⋅
                                      </mo>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <msub>
                                        <mi>
                                          v
                                        </mi>
                                        <mn>
                                          0
                                        </mn>
                                      </msub>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      r \in \delta^{-1}(\cdot, v_0)
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.02778em;">
                                    r
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    ∈
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span>
                                  <span class="mord">
                                    <span class="mord mathnormal" style="margin-right:0.03785em;">
                                      δ
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.8141em;">
                                            <span style="top:-3.063em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mtight">
                                                  <span class="mord mtight">
                                                    −
                                                  </span>
                                                  <span class="mord mtight">
                                                    1
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mord">
                                    ⋅
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      v
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t vlist-t2">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.3011em;">
                                            <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mtight">
                                                  0
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="vlist-s">
                                            ​
                                          </span>
                                        </span>
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.15em;">
                                            <span></span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="ps-keyword">
                              do
                            </span>
                            <span class="ps-comment">
                              ▷
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mtext>
                                           Loop through states that read
                                        </mtext>
                                        <msub>
                                          <mi>
                                            v
                                          </mi>
                                          <mn>
                                            0
                                          </mn>
                                        </msub>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \text{ Loop through states that read } v_0
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                         Loop through states that read
                                      </span>
                                    </span>
                                    <span class="mord">
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        v
                                      </span>
                                      <span class="msupsub">
                                        <span class="vlist-t vlist-t2">
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.3011em;">
                                              <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                <span class="pstrut" style="height:2.7em;"></span>
                                                <span class="sizing reset-size6 size3 mtight">
                                                  <span class="mord mtight">
                                                    0
                                                  </span>
                                                </span>
                                              </span>
                                            </span>
                                            <span class="vlist-s">
                                              ​
                                            </span>
                                          </span>
                                          <span class="vlist-r">
                                            <span class="vlist" style="height:0.15em;">
                                              <span></span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                5:
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          p
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          r
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        p \gets (r)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                    <span class="mord mathnormal">
                                      p
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal" style="margin-right:0.02778em;">
                                      r
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                6:
                              </span>
                              <span class="ps-keyword">
                                for
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          i
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mn>
                                          1
                                        </mn>
                                        <mo separator="true">
                                          ,
                                        </mo>
                                        <mi mathvariant="normal">
                                          ∣
                                        </mi>
                                        <mi>
                                          v
                                        </mi>
                                        <mi mathvariant="normal">
                                          ∣
                                        </mi>
                                        <mo>
                                          −
                                        </mo>
                                        <mn>
                                          1
                                        </mn>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        i \gets 1, |v| - 1
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6595em;"></span>
                                    <span class="mord mathnormal">
                                      i
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord">
                                      1
                                    </span>
                                    <span class="mpunct">
                                      ,
                                    </span>
                                    <span class="mspace" style="margin-right:0.1667em;"></span>
                                    <span class="mord">
                                      ∣
                                    </span>
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      v
                                    </span>
                                    <span class="mord">
                                      ∣
                                    </span>
                                    <span class="mspace" style="margin-right:0.2222em;"></span>
                                    <span class="mbin">
                                      −
                                    </span>
                                    <span class="mspace" style="margin-right:0.2222em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:0.6444em;"></span>
                                    <span class="mord">
                                      1
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="ps-keyword">
                                do
                              </span>
                              <span class="ps-comment">
                                ▷
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mtext>
                                             Walk the FSM
                                          </mtext>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \text{ Walk the FSM}
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.6944em;"></span>
                                      <span class="mord text">
                                        <span class="mord">
                                           Walk the FSM
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  7:
                                </span>
                                <span class="ps-keyword">
                                  if
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            δ
                                          </mi>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mi>
                                            r
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <msub>
                                            <mi>
                                              v
                                            </mi>
                                            <mi>
                                              i
                                            </mi>
                                          </msub>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                          <mo>
                                            =
                                          </mo>
                                          <mi mathvariant="normal">
                                            ∅
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \delta(r, v_i) = \emptyset
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03785em;">
                                        δ
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                        r
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                                          v
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3117em;">
                                                <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight">
                                                      i
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        =
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span>
                                      <span class="mord">
                                        ∅
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="ps-keyword">
                                  then
                                </span>
                                <span class="ps-comment">
                                  ▷
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mtext>
                                               The FSM does not read
                                            </mtext>
                                            <msub>
                                              <mi>
                                                v
                                              </mi>
                                              <mi>
                                                i
                                              </mi>
                                            </msub>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            \text{ The FSM does not read } v_i
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span>
                                        <span class="mord text">
                                          <span class="mord">
                                             The FSM does not read
                                          </span>
                                        </span>
                                        <span class="mord">
                                          <span class="mord mathnormal" style="margin-right:0.03588em;">
                                            v
                                          </span>
                                          <span class="msupsub">
                                            <span class="vlist-t vlist-t2">
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.3117em;">
                                                  <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                    <span class="pstrut" style="height:2.7em;"></span>
                                                    <span class="sizing reset-size6 size3 mtight">
                                                      <span class="mord mathnormal mtight">
                                                        i
                                                      </span>
                                                    </span>
                                                  </span>
                                                </span>
                                                <span class="vlist-s">
                                                  ​
                                                </span>
                                              </span>
                                              <span class="vlist-r">
                                                <span class="vlist" style="height:0.15em;">
                                                  <span></span>
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-3em;">
                                    8:
                                  </span>
                                  <span class="katex">
                                    <span class="katex-mathml">
                                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                                        <semantics>
                                          <mrow>
                                            <mi>
                                              p
                                            </mi>
                                            <mo>
                                              ←
                                            </mo>
                                            <mo stretchy="false">
                                              (
                                            </mo>
                                            <mo stretchy="false">
                                              )
                                            </mo>
                                          </mrow>
                                          <annotation encoding="application/x-tex">
                                            p \gets ()
                                          </annotation>
                                        </semantics>
                                      </math>
                                    </span>
                                    <span class="katex-html" aria-hidden="true">
                                      <span class="base">
                                        <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                        <span class="mord mathnormal">
                                          p
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                        <span class="mrel">
                                          ←
                                        </span>
                                        <span class="mspace" style="margin-right:0.2778em;"></span>
                                      </span>
                                      <span class="base">
                                        <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                        <span class="mopen">
                                          (
                                        </span>
                                        <span class="mclose">
                                          )
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                                <p class="ps-line ps-code" dir="auto">
                                  <span class="ps-linenum" style="left:-3em;">
                                    9:
                                  </span>
                                  <span style="font-weight:bold;">
                                    break
                                  </span>
                                  <span class="ps-comment">
                                    ▷
                                    <span class="katex">
                                      <span class="katex-mathml">
                                        <math xmlns="http://www.w3.org/1998/Math/MathML">
                                          <semantics>
                                            <mrow>
                                              <mtext>
                                                 Stop walking and try the next start state
                                              </mtext>
                                            </mrow>
                                            <annotation encoding="application/x-tex">
                                              \text{ Stop walking and try the next start state}
                                            </annotation>
                                          </semantics>
                                        </math>
                                      </span>
                                      <span class="katex-html" aria-hidden="true">
                                        <span class="base">
                                          <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                          <span class="mord text">
                                            <span class="mord">
                                               Stop walking and try the next start state
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </p>
                              </div>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  10:
                                </span>
                                <span class="ps-keyword">
                                  end if
                                </span>
                              </p>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  11:
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            r
                                          </mi>
                                          <mo>
                                            ←
                                          </mo>
                                          <mi>
                                            δ
                                          </mi>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mi>
                                            r
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <msub>
                                            <mi>
                                              v
                                            </mi>
                                            <mi>
                                              i
                                            </mi>
                                          </msub>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          r \gets \delta(r, v_i)
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.4306em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                        r
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ←
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03785em;">
                                        δ
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                        r
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                                          v
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3117em;">
                                                <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mathnormal mtight">
                                                      i
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  12:
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            p
                                          </mi>
                                          <mo>
                                            ←
                                          </mo>
                                          <mtext>
                                            append
                                          </mtext>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <mi>
                                            p
                                          </mi>
                                          <mo separator="true">
                                            ,
                                          </mo>
                                          <mi>
                                            r
                                          </mi>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          p \gets \text{append}(p, r)
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span>
                                      <span class="mord mathnormal">
                                        p
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ←
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord text">
                                        <span class="mord">
                                          append
                                        </span>
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord mathnormal">
                                        p
                                      </span>
                                      <span class="mpunct">
                                        ,
                                      </span>
                                      <span class="mspace" style="margin-right:0.1667em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.02778em;">
                                        r
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                            </div>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                13:
                              </span>
                              <span class="ps-keyword">
                                end for
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                14:
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mtext mathvariant="monospace">
                                          res
                                        </mtext>
                                        <mo>
                                          ←
                                        </mo>
                                        <mtext>
                                          append
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mtext mathvariant="monospace">
                                          res
                                        </mtext>
                                        <mo separator="true">
                                          ,
                                        </mo>
                                        <mi>
                                          p
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \texttt{res} \gets \text{append}(\texttt{res}, p)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.4306em;"></span>
                                    <span class="mord text">
                                      <span class="mord texttt">
                                        res
                                      </span>
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        append
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord text">
                                      <span class="mord texttt">
                                        res
                                      </span>
                                    </span>
                                    <span class="mpunct">
                                      ,
                                    </span>
                                    <span class="mspace" style="margin-right:0.1667em;"></span>
                                    <span class="mord mathnormal">
                                      p
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                          </div>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              15:
                            </span>
                            <span class="ps-keyword">
                              end for
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              16:
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              17:
                            </span>
                            <span class="ps-keyword">
                              return
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mtext mathvariant="monospace">
                                        res
                                      </mtext>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \texttt{res}
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord text">
                                    <span class="mord texttt">
                                      res
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            18:
                          </span>
                          <span class="ps-keyword">
                            end function
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <p dir="auto">
                  We can then define construction of
                  <span class="katex">
                    <span class="katex-mathml">
                      <math xmlns="http://www.w3.org/1998/Math/MathML">
                        <semantics>
                          <mrow>
                            <mi>
                              σ
                            </mi>
                          </mrow>
                          <annotation encoding="application/x-tex">
                            \sigma
                          </annotation>
                        </semantics>
                      </math>
                    </span>
                    <span class="katex-html" aria-hidden="true">
                      <span class="base">
                        <span class="strut" style="height:0.4306em;"></span>
                        <span class="mord mathnormal" style="margin-right:0.03588em;">
                          σ
                        </span>
                      </span>
                    </span>
                  </span>
                </p>
                <div class="ps-root" data-inline-macros data-settings="{&quot;code&quot;:&quot;pseudo&quot;,&quot;css&quot;:&quot;latex-pseudo&quot;,&quot;removeCaptionCount&quot;:false,&quot;renderer&quot;:{&quot;indentSize&quot;:&quot;0.6em&quot;,&quot;commentDelimiter&quot;:&quot;  ▷&quot;,&quot;lineNumberPunc&quot;:&quot;:&quot;,&quot;lineNumber&quot;:true,&quot;noEnd&quot;:false,&quot;scopeLines&quot;:false,&quot;titlePrefix&quot;:&quot;Algorithm&quot;,&quot;mathEngine&quot;:&quot;katex&quot;}}" dir="auto">
                  <button class="clipboard-button ps-clipboard" aria-label="Copy pseudocode to clipboard" tabindex="-1">
                    <svg aria-hidden="true" class="copy-icon" width="16" height="16" version="1.1" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
                      <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
                    </svg>
                    <svg aria-hidden="true" class="check-icon" version="1.1" width="16" height="16" viewBox="0 0 16 16" data-view-component>
                      <path fill-rule="evenodd" fill="rgb(63, 185, 80)" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                    </svg>
                  </button>
                  <span class="ps-mathml">
                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                      <semantics>
                        <annotation encoding="application/x-tex">
                          &quot;\\begin{algorithm}\n\\caption{Construct a map from FSM states to subsets of $\\mathcal{V}$}\n\\begin{algorithmic}\n\\Function{MapStatesToVocab}{$M, \\mathcal{V}$}\n    \\State $M = (Q, \\Sigma, \\delta, q_0, F)$\n    \\State Initialize the map $\\sigma$ with empty sets for each element in $Q$\n    \\For{$v \\in \\mathcal{V}$} \\Comment{$\\text{Loop through the vocabulary}$}\n        \\State $Z \\gets \\text{find\\_sub\\_sequences}(M, v)$\n        \\For{$z \\in Z$} \\Comment{$\\text{Loop through state sequences accepting } v$}\n            \\State $\\sigma(z_0) \\gets \\sigma(z_0) \\cup v$\n        \\EndFor\n    \\EndFor\n    \\State \\Return $\\sigma$\n\\EndFunction\n\\end{algorithmic}\n\\end{algorithm}&quot;
                        </annotation>
                      </semantics>
                    </math>
                  </span>
                  <div class="ps-algorithm with-caption" dir="auto">
                    <p class="ps-line" style="text-indent:-0.6em;padding-left:0.6em;" dir="auto">
                      <span class="ps-keyword">
                        Algorithm 4
                      </span>
                      Construct a map from FSM states to subsets of
                      <span class="katex">
                        <span class="katex-mathml">
                          <math xmlns="http://www.w3.org/1998/Math/MathML">
                            <semantics>
                              <mrow>
                                <mi mathvariant="script">
                                  V
                                </mi>
                              </mrow>
                              <annotation encoding="application/x-tex">
                                \mathcal{V}
                              </annotation>
                            </semantics>
                          </math>
                        </span>
                        <span class="katex-html" aria-hidden="true">
                          <span class="base">
                            <span class="strut" style="height:0.6833em;"></span>
                            <span class="mord mathcal" style="margin-right:0.08222em;">
                              V
                            </span>
                          </span>
                        </span>
                      </span>
                    </p>
                    <div class="ps-algorithmic with-linenum" dir="auto">
                      <div class="ps-block" style="margin-left:1.2em;" dir="auto">
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            1:
                          </span>
                          <span class="ps-keyword">
                            function
                          </span>
                          <span class="ps-funcname">
                            MapStatesToVocab
                          </span>
                          (
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      M
                                    </mi>
                                    <mo separator="true">
                                      ,
                                    </mo>
                                    <mi mathvariant="script">
                                      V
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    M, \mathcal{V}
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.10903em;">
                                  M
                                </span>
                                <span class="mpunct">
                                  ,
                                </span>
                                <span class="mspace" style="margin-right:0.1667em;"></span>
                                <span class="mord mathcal" style="margin-right:0.08222em;">
                                  V
                                </span>
                              </span>
                            </span>
                          </span>
                          )
                        </p>
                        <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              2:
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        M
                                      </mi>
                                      <mo>
                                        =
                                      </mo>
                                      <mo stretchy="false">
                                        (
                                      </mo>
                                      <mi>
                                        Q
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi mathvariant="normal">
                                        Σ
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        δ
                                      </mi>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <msub>
                                        <mi>
                                          q
                                        </mi>
                                        <mn>
                                          0
                                        </mn>
                                      </msub>
                                      <mo separator="true">
                                        ,
                                      </mo>
                                      <mi>
                                        F
                                      </mi>
                                      <mo stretchy="false">
                                        )
                                      </mo>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      M = (Q, \Sigma, \delta, q_0, F)
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.6833em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.10903em;">
                                    M
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    =
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                  <span class="mopen">
                                    (
                                  </span>
                                  <span class="mord mathnormal">
                                    Q
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    Σ
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03785em;">
                                    δ
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord">
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      q
                                    </span>
                                    <span class="msupsub">
                                      <span class="vlist-t vlist-t2">
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.3011em;">
                                            <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                              <span class="pstrut" style="height:2.7em;"></span>
                                              <span class="sizing reset-size6 size3 mtight">
                                                <span class="mord mtight">
                                                  0
                                                </span>
                                              </span>
                                            </span>
                                          </span>
                                          <span class="vlist-s">
                                            ​
                                          </span>
                                        </span>
                                        <span class="vlist-r">
                                          <span class="vlist" style="height:0.15em;">
                                            <span></span>
                                          </span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                  <span class="mpunct">
                                    ,
                                  </span>
                                  <span class="mspace" style="margin-right:0.1667em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.13889em;">
                                    F
                                  </span>
                                  <span class="mclose">
                                    )
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              3:
                            </span>
                            Initialize the map
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        σ
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \sigma
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    σ
                                  </span>
                                </span>
                              </span>
                            </span>
                            with empty sets for each element in
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        Q
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      Q
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                  <span class="mord mathnormal">
                                    Q
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              4:
                            </span>
                            <span class="ps-keyword">
                              for
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        v
                                      </mi>
                                      <mo>
                                        ∈
                                      </mo>
                                      <mi mathvariant="script">
                                        V
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      v \in \mathcal{V}
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    v
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                  <span class="mrel">
                                    ∈
                                  </span>
                                  <span class="mspace" style="margin-right:0.2778em;"></span>
                                </span>
                                <span class="base">
                                  <span class="strut" style="height:0.6833em;"></span>
                                  <span class="mord mathcal" style="margin-right:0.08222em;">
                                    V
                                  </span>
                                </span>
                              </span>
                            </span>
                            <span class="ps-keyword">
                              do
                            </span>
                            <span class="ps-comment">
                              ▷
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mtext>
                                          Loop through the vocabulary
                                        </mtext>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        \text{Loop through the vocabulary}
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        Loop through the vocabulary
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                          <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                5:
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          Z
                                        </mi>
                                        <mo>
                                          ←
                                        </mo>
                                        <mtext>
                                          find_sub_sequences
                                        </mtext>
                                        <mo stretchy="false">
                                          (
                                        </mo>
                                        <mi>
                                          M
                                        </mi>
                                        <mo separator="true">
                                          ,
                                        </mo>
                                        <mi>
                                          v
                                        </mi>
                                        <mo stretchy="false">
                                          )
                                        </mo>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        Z \gets \text{find\_sub\_sequences}(M, v)
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.07153em;">
                                      Z
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ←
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span>
                                    <span class="mord text">
                                      <span class="mord">
                                        find_sub_sequences
                                      </span>
                                    </span>
                                    <span class="mopen">
                                      (
                                    </span>
                                    <span class="mord mathnormal" style="margin-right:0.10903em;">
                                      M
                                    </span>
                                    <span class="mpunct">
                                      ,
                                    </span>
                                    <span class="mspace" style="margin-right:0.1667em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.03588em;">
                                      v
                                    </span>
                                    <span class="mclose">
                                      )
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                6:
                              </span>
                              <span class="ps-keyword">
                                for
                              </span>
                              <span class="katex">
                                <span class="katex-mathml">
                                  <math xmlns="http://www.w3.org/1998/Math/MathML">
                                    <semantics>
                                      <mrow>
                                        <mi>
                                          z
                                        </mi>
                                        <mo>
                                          ∈
                                        </mo>
                                        <mi>
                                          Z
                                        </mi>
                                      </mrow>
                                      <annotation encoding="application/x-tex">
                                        z \in Z
                                      </annotation>
                                    </semantics>
                                  </math>
                                </span>
                                <span class="katex-html" aria-hidden="true">
                                  <span class="base">
                                    <span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.04398em;">
                                      z
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                    <span class="mrel">
                                      ∈
                                    </span>
                                    <span class="mspace" style="margin-right:0.2778em;"></span>
                                  </span>
                                  <span class="base">
                                    <span class="strut" style="height:0.6833em;"></span>
                                    <span class="mord mathnormal" style="margin-right:0.07153em;">
                                      Z
                                    </span>
                                  </span>
                                </span>
                              </span>
                              <span class="ps-keyword">
                                do
                              </span>
                              <span class="ps-comment">
                                ▷
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mtext>
                                            Loop through state sequences accepting
                                          </mtext>
                                          <mi>
                                            v
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \text{Loop through state sequences accepting } v
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span>
                                      <span class="mord text">
                                        <span class="mord">
                                          Loop through state sequences accepting
                                        </span>
                                      </span>
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        v
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </span>
                            </p>
                            <div class="ps-block" style="margin-left:0.6em;" dir="auto">
                              <p class="ps-line ps-code" dir="auto">
                                <span class="ps-linenum" style="left:-2.25em;">
                                  7:
                                </span>
                                <span class="katex">
                                  <span class="katex-mathml">
                                    <math xmlns="http://www.w3.org/1998/Math/MathML">
                                      <semantics>
                                        <mrow>
                                          <mi>
                                            σ
                                          </mi>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <msub>
                                            <mi>
                                              z
                                            </mi>
                                            <mn>
                                              0
                                            </mn>
                                          </msub>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                          <mo>
                                            ←
                                          </mo>
                                          <mi>
                                            σ
                                          </mi>
                                          <mo stretchy="false">
                                            (
                                          </mo>
                                          <msub>
                                            <mi>
                                              z
                                            </mi>
                                            <mn>
                                              0
                                            </mn>
                                          </msub>
                                          <mo stretchy="false">
                                            )
                                          </mo>
                                          <mo>
                                            ∪
                                          </mo>
                                          <mi>
                                            v
                                          </mi>
                                        </mrow>
                                        <annotation encoding="application/x-tex">
                                          \sigma(z_0) \gets \sigma(z_0) \cup v
                                        </annotation>
                                      </semantics>
                                    </math>
                                  </span>
                                  <span class="katex-html" aria-hidden="true">
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        σ
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.04398em;">
                                          z
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3011em;">
                                                <span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      0
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                      <span class="mrel">
                                        ←
                                      </span>
                                      <span class="mspace" style="margin-right:0.2778em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:1em;vertical-align:-0.25em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        σ
                                      </span>
                                      <span class="mopen">
                                        (
                                      </span>
                                      <span class="mord">
                                        <span class="mord mathnormal" style="margin-right:0.04398em;">
                                          z
                                        </span>
                                        <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.3011em;">
                                                <span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;">
                                                  <span class="pstrut" style="height:2.7em;"></span>
                                                  <span class="sizing reset-size6 size3 mtight">
                                                    <span class="mord mtight">
                                                      0
                                                    </span>
                                                  </span>
                                                </span>
                                              </span>
                                              <span class="vlist-s">
                                                ​
                                              </span>
                                            </span>
                                            <span class="vlist-r">
                                              <span class="vlist" style="height:0.15em;">
                                                <span></span>
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                      </span>
                                      <span class="mclose">
                                        )
                                      </span>
                                      <span class="mspace" style="margin-right:0.2222em;"></span>
                                      <span class="mbin">
                                        ∪
                                      </span>
                                      <span class="mspace" style="margin-right:0.2222em;"></span>
                                    </span>
                                    <span class="base">
                                      <span class="strut" style="height:0.4306em;"></span>
                                      <span class="mord mathnormal" style="margin-right:0.03588em;">
                                        v
                                      </span>
                                    </span>
                                  </span>
                                </span>
                              </p>
                            </div>
                            <p class="ps-line ps-code" dir="auto">
                              <span class="ps-linenum" style="left:-1.5em;">
                                8:
                              </span>
                              <span class="ps-keyword">
                                end for
                              </span>
                            </p>
                          </div>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              9:
                            </span>
                            <span class="ps-keyword">
                              end for
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              10:
                            </span>
                          </p>
                          <p class="ps-line ps-code" dir="auto">
                            <span class="ps-linenum" style="left:-0.75em;">
                              11:
                            </span>
                            <span class="ps-keyword">
                              return
                            </span>
                            <span class="katex">
                              <span class="katex-mathml">
                                <math xmlns="http://www.w3.org/1998/Math/MathML">
                                  <semantics>
                                    <mrow>
                                      <mi>
                                        σ
                                      </mi>
                                    </mrow>
                                    <annotation encoding="application/x-tex">
                                      \sigma
                                    </annotation>
                                  </semantics>
                                </math>
                              </span>
                              <span class="katex-html" aria-hidden="true">
                                <span class="base">
                                  <span class="strut" style="height:0.4306em;"></span>
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    σ
                                  </span>
                                </span>
                              </span>
                            </span>
                          </p>
                        </div>
                        <p class="ps-line ps-code" dir="auto">
                          <span class="ps-linenum" style="left:0em;">
                            12:
                          </span>
                          <span class="ps-keyword">
                            end function
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <p dir="auto"></p>
                <section data-references class="bibliography">
                  <h2 id="reference-label-reader" dir="auto">
                    References
                    <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#reference-label-reader" class="internal">
                      <span class="indicator-hook"></span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </a>
                  </h2>
                  <ul dir="auto">
                    <li class="csl-entry" id="bib-280922-reader">
                      Yu, G.-I., Jeong, J. S., Kim, G.-W., Kim, S., &amp; Chun, B.-G. (2022). Orca: A Distributed Serving System for Transformer-Based Generative Models.
                      <i>
                        16th USENIX Symposium on Operating Systems Design and Implementation (OSDI 22)
                      </i>
                      , 521–538.
                      <a href="https://www.usenix.org/conference/osdi22/presentation/yu" target="_blank" rel="noopener noreferrer" class="csl-external-link external">
                        <span class="indicator-hook"></span>
                        https://www.usenix.org/conference/osdi22/presentation/yu
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-lew2023sequentialmontecarlosteering-reader">
                      Lew, A. K., Zhi-Xuan, T., Grand, G., &amp; Mansinghka, V. K. (2023).
                      <i>
                        Sequential Monte Carlo Steering of Large Language Models using Probabilistic Programs
                      </i>
                      . arXiv preprint arXiv:2306.03081
                      <a href="https://arxiv.org/abs/2306.03081" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2306.03081" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-willard2023efficientguidedgenerationlarge-reader">
                      Willard, B. T., &amp; Louf, R. (2023).
                      <i>
                        Efficient Guided Generation for Large Language Models
                      </i>
                      . arXiv preprint arXiv:2307.09702
                      <a href="https://arxiv.org/abs/2307.09702" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2307.09702" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-zheng2024sglangefficientexecutionstructured-reader">
                      Zheng, L., Yin, L., Xie, Z., Sun, C., Huang, J., Yu, C. H., Cao, S., Kozyrakis, C., Stoica, I., Gonzalez, J. E., Barrett, C., &amp; Sheng, Y. (2024).
                      <i>
                        SGLang: Efficient Execution of Structured Language Model Programs
                      </i>
                      . arXiv preprint arXiv:2312.07104
                      <a href="https://arxiv.org/abs/2312.07104" target="_blank" rel="noopener noreferrer" class="internal" data-arxiv-id="2312.07104" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        arxiv
                      </a>
                    </li>
                    <li class="csl-entry" id="bib-kwon2023efficient-reader">
                      Kwon, W., Li, Z., Zhuang, S., Sheng, Y., Zheng, L., Yu, C. H., Gonzalez, J. E., Zhang, H., &amp; Stoica, I. (2023). Efficient Memory Management for Large Language Model Serving with PagedAttention.
                      <i>
                        Proceedings of the ACM SIGOPS 29th Symposium on Operating Systems Principles
                      </i>
                      .
                    </li>
                  </ul>
                </section>
                <section data-footnotes class="footnotes">
                  <h2 class="sr-only" id="footnote-label-reader" dir="auto">
                    Footnotes
                    <a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#footnote-label-reader" class="internal">
                      <span class="indicator-hook"></span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </a>
                  </h2>
                  <ol dir="auto">
                    <li id="user-content-fn-paper-reader">
                      <p dir="auto">
                        The
                        <a href="https://www.usenix.org/conference/osdi22/presentation/yu" class="external alias">
                          <span class="indicator-hook"></span>
                          paper
                        </a>
                        and
                        <a href="https://www.youtube.com/watch?v=Ob9PPLxETYU&amp;ab_channel=USENIX" class="external alias">
                          <span class="indicator-hook"></span>
                          presentation
                        </a>
                        for the paper. Most notable open source implementation is
                        <a href="../thoughts/Continuous-batching/../../thoughts/vllm" class="internal" data-slug="thoughts/vllm" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          vLLM
                        </a>
                        .
                      </p>
                      <p dir="auto">
                        p/s: Actually, I think first implemented in
                        <a href="https://github.com/huggingface/text-generation-inference" class="external alias">
                          <span class="indicator-hook"></span>
                          huggingface/tgi
                        </a>
                        <a href="#user-content-fnref-paper-reader" data-footnote-backref aria-label="Back to reference 1" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-row-wise-reader">
                      <p dir="auto">
                        Current implementation
                        <a href="https://github.com/vllm-project/vllm/blob/246598a6b1e22616630b7f1bf11bd9bcb31dc860/vllm/model_executor/layers/logits_processor.py#L112" class="external alias">
                          <span class="indicator-hook"></span>
                          of logits processor
                        </a>
                        mandates that we gather all logits from hidden state, scale if needed then apply the processors.
                      </p>
                      <p dir="auto">
                        <img src="../thoughts/images/vllm/pre-optimized-logit-processor-handling.webp" width="auto" height="auto" alt="flow" loading="lazy"/>
                        <em>
                          reference:
                          <a href="https://github.com/vllm-project/vllm/pull/5329" class="external alias">
                            <span class="indicator-hook"></span>
                            vllm-project/vllm#5329
                          </a>
                        </em>
                      </p>
                      <p dir="auto">
                        Note that there is also
                        <a href="https://github.com/vllm-project/vllm/pull/5006" class="external alias">
                          <span class="indicator-hook"></span>
                          vllm-project/vllm#5006
                        </a>
                        that improves vLLM’s own Outlines implementations of the FSM where it halves memory transition from Python list to Tensors
                        <a href="#user-content-fnref-row-wise-reader" data-footnote-backref aria-label="Back to reference 1" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-performance-reader">
                      <p dir="auto">
                        Benchmark script can be found at
                        <a href="https://github.com/vllm-project/vllm/pull/10046" class="external alias">
                          <span class="indicator-hook"></span>
                          vllm-project/vllm#10046
                        </a>
                        .
                      </p>
                      <p dir="auto">
                        Current RFC
                        <a href="https://github.com/vllm-project/vllm/issues/5423" class="external alias">
                          <span class="indicator-hook"></span>
                          vllm-project/vllm#5423
                        </a>
                        <a href="#user-content-fnref-performance-reader" data-footnote-backref aria-label="Back to reference 1" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-samplingpr-reader">
                      <p dir="auto">
                        <a href="https://github.com/vllm-project/vllm/pull/6273" class="external alias">
                          <span class="indicator-hook"></span>
                          vllm-project/vllm#6273
                        </a>
                        proposed a sampling controller interface, but
                        <a href="https://github.com/cadedaniel" class="external">
                          <span class="indicator-hook"></span>
                          <strong>
                            @cadedaniel
                          </strong>
                        </a>
                        shares some
                        <a href="https://github.com/vllm-project/vllm/pull/6273#issuecomment-2243654991" class="external alias">
                          <span class="indicator-hook"></span>
                          concerns
                        </a>
                        wrt fast-forward tokens
                        <a href="#user-content-fnref-samplingpr-reader" data-footnote-backref aria-label="Back to reference 2" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-coalescence-reader">
                      <p dir="auto">
                        this phenomena is also known as
                        <a href="../thoughts/constrained-decoding/../../thoughts/constrained-decoding#coalescence" class="internal" data-slug="thoughts/constrained-decoding" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          coalescence
                        </a>
                        in structured generations, where it exploit deterministic structures in desired outputs to skip expensive forward pass
                        <a href="#user-content-fnref-coalescence-reader" data-footnote-backref aria-label="Back to reference 3" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-smc-reader">
                      <p dir="auto">
                        <cite class id="citation--lew2023sequentialmontecarlosteering--4">
                          (
                          <a href="#bib-lew2023sequentialmontecarlosteering-reader" data-no-popover="true" data-bib class="internal">
                            <span class="indicator-hook"></span>
                            Lew et al., 2023
                          </a>
                          )
                        </cite>
                        recently proposes a sequential
                        <a href="../thoughts/constrained-decoding/../../thoughts/Monte-Carlo" class="internal" data-slug="thoughts/Monte-Carlo" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          Monte Carlo steering
                        </a>
                        . The idea is to classify causal generations as a
                        <em>
                          posteriori inference
                        </em>
                        problem in a class of discrete probabilistic sequence models.
                      </p>
                      <p dir="auto">
                        See also
                        <a href="../thoughts/constrained-decoding/../../thoughts/Transformers#feynman-kac" class="internal" data-slug="thoughts/Transformers" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          Feynman-Kac transformers models
                        </a>
                        <a href="#user-content-fnref-smc-reader" data-footnote-backref aria-label="Back to reference 4" class="internal" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          ↩
                        </a>
                      </p>
                    </li>
                    <li id="user-content-fn-automaton-definition-reader">
                      <p dir="auto">
                        <a href="../thoughts/constrained-decoding/../../thoughts/university/twenty-three-twenty-four/sfwr-2fa3/DFA" class="internal" data-slug="thoughts/university/twenty-three-twenty-four/sfwr-2fa3/DFA" data-no-popover="true">
                          <span class="indicator-hook"></span>
                          finite state machine
                        </a>
                      </p>
                      <ul dir="auto">
                        <li>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      Q
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    Q
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                              </span>
                            </span>
                          </span>
                          is a finite set of states
                        </li>
                        <li>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi mathvariant="normal">
                                      Σ
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \Sigma
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord">
                                  Σ
                                </span>
                              </span>
                            </span>
                          </span>
                          is a finite alphabet
                        </li>
                        <li>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      δ
                                    </mi>
                                    <mo>
                                      :
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                    <mo>
                                      ×
                                    </mo>
                                    <mi mathvariant="normal">
                                      Σ
                                    </mi>
                                    <mo>
                                      →
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    \delta: Q \times \Sigma \to Q
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.6944em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.03785em;">
                                  δ
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  :
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                                <span class="mspace" style="margin-right:0.2222em;"></span>
                                <span class="mbin">
                                  ×
                                </span>
                                <span class="mspace" style="margin-right:0.2222em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.6833em;"></span>
                                <span class="mord">
                                  Σ
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  →
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                              </span>
                            </span>
                          </span>
                          is the transition function
                        </li>
                        <li>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <msub>
                                      <mi>
                                        q
                                      </mi>
                                      <mn>
                                        0
                                      </mn>
                                    </msub>
                                    <mo>
                                      ∈
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    q_0 \in Q
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span>
                                <span class="mord">
                                  <span class="mord mathnormal" style="margin-right:0.03588em;">
                                    q
                                  </span>
                                  <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.3011em;">
                                          <span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;">
                                            <span class="pstrut" style="height:2.7em;"></span>
                                            <span class="sizing reset-size6 size3 mtight">
                                              <span class="mord mtight">
                                                0
                                              </span>
                                            </span>
                                          </span>
                                        </span>
                                        <span class="vlist-s">
                                          ​
                                        </span>
                                      </span>
                                      <span class="vlist-r">
                                        <span class="vlist" style="height:0.15em;">
                                          <span></span>
                                        </span>
                                      </span>
                                    </span>
                                  </span>
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ∈
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                              </span>
                            </span>
                          </span>
                          is the start state
                        </li>
                        <li>
                          <span class="katex">
                            <span class="katex-mathml">
                              <math xmlns="http://www.w3.org/1998/Math/MathML">
                                <semantics>
                                  <mrow>
                                    <mi>
                                      F
                                    </mi>
                                    <mo>
                                      ⊆
                                    </mo>
                                    <mi>
                                      Q
                                    </mi>
                                  </mrow>
                                  <annotation encoding="application/x-tex">
                                    F \subseteq Q
                                  </annotation>
                                </semantics>
                              </math>
                            </span>
                            <span class="katex-html" aria-hidden="true">
                              <span class="base">
                                <span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span>
                                <span class="mord mathnormal" style="margin-right:0.13889em;">
                                  F
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                                <span class="mrel">
                                  ⊆
                                </span>
                                <span class="mspace" style="margin-right:0.2778em;"></span>
                              </span>
                              <span class="base">
                                <span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span>
                                <span class="mord mathnormal">
                                  Q
                                </span>
                              </span>
                            </span>
                          </span>
                          is the set of all accepted states.
                        </li>
                      </ul>
                      <a href="#user-content-fnref-automaton-definition-reader" data-footnote-backref aria-label="Back to reference 5" class="internal" data-no-popover="true">
                        <span class="indicator-hook"></span>
                        ↩
                      </a>
                    </li>
                  </ol>
                </section>
              </div>
            </div>
          </div>
          <div class="image-popup-modal" id="image-popup-modal">
            <div class="image-popup-backdrop"></div>
            <div class="image-popup-content">
              <button class="image-popup-close" aria-label="Close popup">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
              <img class="image-popup-img" src alt/>
            </div>
          </div>
          <div id="mermaid-container">
            <div class="mermaid-backdrop"></div>
            <div id="mermaid-space">
              <div class="mermaid-header">
                <button class="close-button" aria-label="close button">
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="mermaid-content"></div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </body>
  <script type="application/javascript">
    function i(){let l=this.parentElement;l.classList.toggle("is-collapsed");let e=l.classList.contains("is-collapsed")?this.scrollHeight:l.scrollHeight;l.style.maxHeight=e+"px";let s=l,t=l.parentElement;for(;t;){if(!t.classList.contains("callout"))return;let a=t.classList.contains("is-collapsed")?t.scrollHeight:t.scrollHeight+s.scrollHeight;t.style.maxHeight=a+"px",s=t,t=t.parentElement}}function r(l){let o=l.getBoundingClientRect(),e=1056,s=o.height;return o.top%e+s>e}function c(){let l=document.getElementsByClassName("callout is-collapsible");for(let e of l){let s=e.firstElementChild;if(s){s.addEventListener("click",i),window.addCleanup(()=>s.removeEventListener("click",i));let n=e.classList.contains("is-collapsed")?s.scrollHeight:e.scrollHeight;e.style.maxHeight=n+"px"}}let o=document.getElementsByClassName("callout");for(let e of o)r(e)&&(e.style.pageBreakBefore="always",e.classList.add("force-page-break"))}document.addEventListener("nav",c);window.addEventListener("resize",c);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script>
  <script src="../postscript.js" type="module"></script>
</html>